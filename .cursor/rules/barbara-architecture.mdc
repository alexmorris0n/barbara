# Barbara Agent Architecture

## Overview
Barbara is a SignalWire AI voice agent for reverse mortgage lead qualification and appointment booking. Uses GPT-4o-mini with 4o-mini optimized prompts.

---

## ⚠️ CRITICAL: No Cross-Node References

**NEVER mention other nodes or their responsibilities in any prompt.**

Each node's prompt must be completely self-contained. The AI should have NO idea that other nodes exist or what they do.

### ❌ FORBIDDEN in prompts:
- "Qualification (age, value, mortgage) happens in QUALIFY" 
- "The ANSWER node handles questions"
- "BOOK will schedule the appointment"
- "This is handled in another stage"
- Any description of what another node does

### ✅ ALLOWED:
- `change_context("verify")` - routing calls only (no description)
- `change_context("qualify")` - just the function call
- Tool calls that belong to THIS node only

### Why this matters:
Mentioning other nodes plants ideas. If GREET says "qualification happens in QUALIFY", the AI may start asking qualification questions in GREET. Each node must be isolated - the AI only knows what IT should do, nothing else.

---

## ⚠️ CRITICAL: Global Prompt Hygiene

**The LLM treats ANY global instruction as permission to act on it in ALL contexts.**

4o-mini especially overweights global instructions. If you mention a data field or tool globally, the AI will try to use/collect it everywhere.

### ❌ FORBIDDEN in global sections (`__init__`, Theme, Caller Context):

**Tool references:**
- "Always use calculate_reverse_mortgage()" 
- "Call check_broker_availability() when ready to book"
- "Use the calculate tool for math expressions"
- Any instruction saying when/how to use a specific tool

**Data field references:**
- "Ask for age and home value"
- "Collect info first"
- Displaying raw values: `Age: 72`, `Property Value: 2000000`
- "Numbers: natural estimates, ages as words"

**Capability declarations:**
- "You can perform mathematical calculations"
- "You can provide current date and time"
- `add_skill("math")` or `add_skill("datetime")` - these add global prompt sections

### ✅ ALLOWED in global sections:

**Theme (identity + tone only):**
```
PERSONALITY
Warm, calm, and respectful. Natural acknowledgments.
Use the caller's name sparingly.

CONVERSATIONAL STYLE
One thought at a time. One question at a time.

OUTPUT
Plain text only. Short, clear sentences.

ETHICS
Never pressure. Respect hesitation immediately.
```

**Caller Context (status only, no raw data):**
```
Name: Testy
Phone: Verified (or the number if not verified)
Address: Not yet verified (or "Verified: 123 Main St" if verified)
Status: Verified: No, Qualified: Not yet
Broker: John Smith at ABC Mortgage
```

**`conscience` param:**
```python
"conscience": "Stay in character as Barbara, a warm and friendly specialist."
# NO tool references! NO data field references!
```

### Where tool/data instructions belong:

| Instruction | Belongs In |
|-------------|-----------|
| "Call calculate_reverse_mortgage()" | QUOTE node only |
| "Ask for age and home value" | QUALIFY node only |
| "Call check_broker_availability()" | BOOK node only |
| "Verify the address" | VERIFY node only |

### Why this matters:

The LLM sees global instructions as **always-on permissions**. If the Theme says "collect info first", GREET will start collecting age and home value even though those belong in QUALIFY.

This caused bugs where GREET asked "Can you confirm your age is 72?" because global context showed `Age: 72`.

### How tool scoping works:

`step.set_functions(["tool1", "tool2"])` restricts which tools the LLM can SEE and CALL in that context. Tools not in the list are completely hidden - their descriptions and parameters are not in the SWML.

This is why GREET only sees 4 tools (`change_context`, `mark_greeted`, `mark_wrong_person`, `set_caller_goal`) even though 20+ tools are defined on the agent.

### Tool Scope Assertions (fail-fast protection):

The agent has automated assertions that verify tool scope at startup. If any context has unexpected tools, the agent **refuses to start**.

**Contract defined in `barbara_agent.py`:**
```python
EXPECTED_TOOLS = {
    "greet": {"change_context", "mark_greeted", "mark_wrong_person", "set_caller_goal"},
    "verify": {"change_context", "mark_address_verified", "update_lead_info", ...},
    "qualify": {"change_context", "mark_age_qualified", "update_lead_info", ...},
    "quote": {"calculate_reverse_mortgage", "change_context", "update_lead_info", ...},
    # ... all 8 nodes
}
```

**What happens on violation:**
```
[TOOL SCOPE VIOLATION] Context 'greet' has wrong tools!
  Unexpected: {'update_lead_info'}
  Expected: ['change_context', 'mark_greeted', 'mark_wrong_person', 'set_caller_goal']
  → Update EXPECTED_TOOLS if this change is intentional
```

**To intentionally change tool scope:**
1. Update the `tools` array in Supabase `prompt_versions` table
2. Update `EXPECTED_TOOLS` in `barbara_agent.py`
3. Both must match or agent won't start

This prevents silent tool leakage from:
- Accidental DB edits
- Merge conflicts
- Refactoring mistakes
- SDK behavior changes

---

## Prompt Architecture

### Structure (assembled by Python)
```
You are only responsible for actions explicitly listed in this stage.

=== PURPOSE ===
[role field from DB]

[instructions field from DB]
```

### Key Rules
- **NO separate ROUTING section** - routing is inline in instructions
- **NO FORBIDDEN ACTIONS section** - constraints are inline (e.g., "→ Do NOT elaborate")
- **NO WHEN COMPLETE section** - already covered in numbered steps
- Prompts end with: `Do NOT say anything after change_context().`

### Database Tables
- `prompts` - node definitions (node_name, vertical)
- `prompt_versions` - versioned content with `is_active` flag
  - `content.role` - PURPOSE (1 sentence)
  - `content.instructions` - numbered steps
  - `content.tools` - available tools array (scoped per node)
- `theme_prompts` - global personality/rules (identity + tone ONLY)
- `contexts_config` - enter/exit fillers

### Placeholder Resolution
Placeholders like `${global_data.caller_name}` are replaced in Python BEFORE sending to SignalWire. The LLM sees actual values, not placeholders.

---

## Context System

### Nodes (conversation stages)
1. `greet` - Identity + goal capture
2. `verify` - Address confirmation
3. `qualify` - Age/value/mortgage collection
4. `quote` - Calculate + present quote
5. `answer` - Answer questions from KB
6. `objections` - Handle concerns
7. `book` - Schedule appointment
8. `goodbye` - End call

### Context Isolation
- Only ONE node's instructions loaded at a time
- `change_context("node")` lazy-loads target node's instructions
- Clears previous node instructions to prevent hallucination
- Tools are scoped per-node (e.g., `calculate_reverse_mortgage` only in `quote`)

### change_context() Flow
```python
def change_context(context_name):
    # 1. Load target node instructions from DB
    # 2. Replace placeholders with actual values
    # 3. Remove old node instructions from global_data
    # 4. Set new instructions + current_context
    # 5. Call swml_change_context() for tool scoping
```

---

## 4o-mini Optimization Rules

### Prompt Format
```
1. Say: "..."
   → Wait

2. If X:
   → Call tool()
   → Do NOT elaborate
   → Call change_context("next")
```

### Key Principles
- Numbered steps (mechanical)
- Short `→ Wait` instead of "→ Wait for response"
- Constraints inline: `→ Do NOT elaborate`
- Tool calls once per path (no duplicates)
- All branches terminate (either `change_context()` or `→ Stop speaking`)
- Final line: `Do NOT say anything after change_context().`

### Avoid
- **Cross-node references** (see CRITICAL section above)
- Separate ROUTING/FORBIDDEN/WHEN COMPLETE sections
- "restart from step 1" (restate exact utterance instead)
- Vague phrases like "end call gracefully" (use explicit speech)
- Abstract instructions like "acknowledge based on goal type"
- Negative language that mentions other nodes (e.g., "Do NOT ask about age - that's in QUALIFY")

---

## Deployment

### Git-Only (NO direct Fly.io)
All deployments via git commit/push which triggers CI/CD:
```bash
git add -A
git commit -m "message"
git push
```
NEVER use `fly deploy` directly.

### Key Files
- `barbara/barbara_agent.py` - Main agent, `on_swml_request`, tools
- `barbara/services/database.py` - DB queries, prompt assembly
- `barbara/services/fallbacks.py` - Emergency fallback prompts
- `barbara/tools/booking.py` - Booking + availability
- `barbara/tools/flags.py` - State management tools
- `portal/src/views/admin/Verticals.vue` - Prompt editor UI

---

## Common Tasks

### Update a node's prompt
1. Edit in Supabase `prompt_versions` table OR Vue portal
2. Edit `role`, `instructions`, or `tools` fields
3. If changing `tools` array → also update `EXPECTED_TOOLS` in `barbara_agent.py`
4. No Python changes needed for prompt text edits

### Add a new tool
1. Add handler in `barbara/tools/`
2. Register with `@AgentBase.tool()` in `barbara_agent.py`
3. Add to node's `tools` array in Supabase `prompt_versions`
4. Update `EXPECTED_TOOLS` in `barbara_agent.py` (or agent won't start)

### Test changes
1. Commit and push
2. Wait for deploy (~2 min)
3. Trigger test call from n8n MCP

---

## Webhooks

### Manual Booking Webhook
Fires on any booking failure:
- URL: `https://n8n.instaroute.com/webhook/sw_manual_booking`
- Triggers: Nylas error, no slots, lead not found, exception

### Persona SMS Webhook
Fires after successful booking (if SMS consent):
- URL: `https://n8n.instaroute.com/webhook/persona-sms`
