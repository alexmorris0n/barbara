import{d as u,h as s,e as p,k as f,t as n,Y as d,M as h,_ as m,w as v,T as b,Z as y,o as c}from"./index-Zmiy9vUZ.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const _="+16505300051",w={name:"TestyControl",data(){return{state:null,loading:!1,callingTesty:!1,message:"",messageType:"success",supabase:y}},computed:{nodeClass(){var e;if(!((e=this.state)!=null&&e.current_node))return"badge-gray";const t=this.state.current_node.toLowerCase();return t.includes("greet")?"badge-info":t.includes("qualify")?"badge-warning":t.includes("answer")?"badge-primary":t.includes("book")?"badge-success":t.includes("goodbye")?"badge-secondary":"badge-gray"},callStatusClass(){var e;if(!((e=this.state)!=null&&e.call_status))return"badge-gray";const t=this.state.call_status.toLowerCase();return t==="active"||t==="in_progress"?"badge-success":t==="completed"?"badge-secondary":t==="fresh"||t==="new"?"badge-info":"badge-gray"}},mounted(){this.loadState()},methods:{async loadState(){this.loading=!0;try{const{data:t,error:e}=await this.supabase.from("conversation_state").select("*").eq("phone_number",_).single();e&&e.code!=="PGRST116"&&console.error("Conv state error:",e);const{data:r,error:o}=await this.supabase.from("leads").select("id, first_name, last_name, status, verified, phone_verified, email_verified, address_verified").eq("primary_phone_e164",_).single();o&&o.code!=="PGRST116"&&console.error("Lead error:",o);const a=(t==null?void 0:t.conversation_data)||{};this.state={phone_number:_,lead_id:(r==null?void 0:r.id)||(t==null?void 0:t.lead_id),lead_name:r?`${r.first_name} ${r.last_name}`:null,current_node:t==null?void 0:t.current_node,call_count:(t==null?void 0:t.call_count)??0,call_status:t==null?void 0:t.call_status,exit_reason:t==null?void 0:t.exit_reason,last_call_at:t==null?void 0:t.last_call_at,updated_at:t==null?void 0:t.updated_at,qualified:t==null?void 0:t.qualified,topics_discussed:(t==null?void 0:t.topics_discussed)||[],conversation_data:a,verified:(r==null?void 0:r.verified)||a.verified||!1,quote_presented:a.quote_presented||!1,ready_to_book:a.ready_to_book||!1,wrong_person:a.wrong_person||!1,quote_lump_sum:a.quote_lump_sum,quote_monthly:a.quote_monthly,phone_verified:(r==null?void 0:r.phone_verified)||!1,email_verified:(r==null?void 0:r.email_verified)||!1,address_verified:(r==null?void 0:r.address_verified)||!1,lead_status:r==null?void 0:r.status}}catch(t){console.error("Error loading state:",t),this.showMessage("Error loading state: "+t.message,"error")}finally{this.loading=!1}},async triggerOutboundCall(){var t;if(!((t=this.state)!=null&&t.lead_id)){this.showMessage("âŒ No lead ID found. Reset state first.","error");return}if(confirm("ðŸ“ž Trigger outbound call to Testy via SignalWire?")){this.callingTesty=!0;try{const o=await(await fetch("https://barbara-cli-testing.fly.dev/trigger-call",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to_phone:_,lead_id:this.state.lead_id})})).json();if(o.success||o.call_id)this.showMessage(`âœ… Call initiated! SID: ${o.call_id}`,"success");else throw new Error(o.message||o.error||"Call failed")}catch(e){console.error("Error triggering call:",e),this.showMessage("âŒ Failed to trigger call: "+e.message,"error")}finally{this.callingTesty=!1}}},async resetFresh(){var t,e;if(confirm("Reset Testy to fresh state (no conversation history)?")){this.loading=!0;try{const{data:r}=await this.supabase.from("conversation_state").select("id").eq("phone_number",_).single();if(r){const{error:o}=await this.supabase.from("conversation_state").update({qualified:null,current_node:null,conversation_data:{},call_count:0,call_status:"fresh",exit_reason:null,topics_discussed:[],updated_at:new Date().toISOString()}).eq("phone_number",_);if(o)throw o}else{const{error:o}=await this.supabase.from("conversation_state").insert({phone_number:_,lead_id:(t=this.state)==null?void 0:t.lead_id,qualified:null,current_node:null,conversation_data:{},call_count:0,call_status:"fresh",exit_reason:null,topics_discussed:[]});if(o)throw o}if((e=this.state)!=null&&e.lead_id){const{error:o}=await this.supabase.from("leads").update({status:"new",qualified:!1,verified:!1,phone_verified:!1,email_verified:!1,address_verified:!1,age_qualified:!1,homeowner_qualified:!1,primary_residence_qualified:!1,equity_qualified:!1,updated_at:new Date().toISOString()}).eq("id",this.state.lead_id);if(o)throw o}this.showMessage("âœ… Reset to fresh state!","success"),await this.loadState()}catch(r){console.error("Error resetting:",r),this.showMessage("Error resetting state: "+r.message,"error")}finally{this.loading=!1}}},async setQualified(){var t;this.loading=!0;try{const{error:e}=await this.supabase.from("conversation_state").update({qualified:!0,current_node:"answer",conversation_data:{greeted:!0,verified:!0,qualified:!0}}).eq("phone_number",_);if(e)throw e;if((t=this.state)!=null&&t.lead_id){const{error:r}=await this.supabase.from("leads").update({status:"qualified",verified:!0,phone_verified:!0,email_verified:!0,address_verified:!0}).eq("id",this.state.lead_id);if(r)throw r}this.showMessage("âœ… Set as qualified!","success"),await this.loadState()}catch(e){console.error("Error:",e),this.showMessage("Error setting qualified state: "+e.message,"error")}finally{this.loading=!1}},async setReadyToBook(){var t;this.loading=!0;try{const{error:e}=await this.supabase.from("conversation_state").update({qualified:!0,current_node:"book",conversation_data:{greeted:!0,verified:!0,qualified:!0,questions_answered:!0,ready_to_book:!0,quote_presented:!0,quote_lump_sum:516666,quote_monthly:2152}}).eq("phone_number",_);if(e)throw e;if((t=this.state)!=null&&t.lead_id){const{error:r}=await this.supabase.from("leads").update({status:"qualified",verified:!0,phone_verified:!0,email_verified:!0,address_verified:!0}).eq("id",this.state.lead_id);if(r)throw r}this.showMessage("âœ… Set ready to book!","success"),await this.loadState()}catch(e){console.error("Error:",e),this.showMessage("Error setting ready to book: "+e.message,"error")}finally{this.loading=!1}},async clearAppointment(){var t;this.loading=!0;try{const e={...this.state.conversation_data};delete e.appointment_booked,delete e.appointment_id,delete e.ready_to_book;const{error:r}=await this.supabase.from("conversation_state").update({conversation_data:e,current_node:"answer"}).eq("phone_number",_);if(r)throw r;if((t=this.state)!=null&&t.lead_id){const{error:o}=await this.supabase.from("leads").update({status:"qualified"}).eq("id",this.state.lead_id);if(o)throw o}this.showMessage("âœ… Appointment cleared!","success"),await this.loadState()}catch(e){console.error("Error:",e),this.showMessage("Error clearing appointment: "+e.message,"error")}finally{this.loading=!1}},async deleteState(){if(confirm("âš ï¸ Delete ALL state for Testy? This cannot be undone!")){this.loading=!0;try{const{error:t}=await this.supabase.from("conversation_state").delete().eq("phone_number",_);if(t)throw t;this.showMessage("âœ… State deleted!","success"),this.state=null}catch(t){console.error("Error:",t),this.showMessage("Error deleting state: "+t.message,"error")}finally{this.loading=!1}}},async applyPreset(t){var o,a;if(this.loading)return;const r={new_caller:{qualified:null,current_node:null,conversation_data:{},call_count:0,call_status:"fresh",lead_status:"new",verified:!1},has_questions:{qualified:!0,current_node:"answer",conversation_data:{greeted:!0,verified:!0,qualified:!0},lead_status:"qualified",verified:!0},ready_to_book:{qualified:!0,current_node:"book",conversation_data:{greeted:!0,verified:!0,qualified:!0,questions_answered:!0,ready_to_book:!0,quote_presented:!0,quote_lump_sum:516666,quote_monthly:2152},lead_status:"qualified",verified:!0},returning_caller:{qualified:!0,current_node:"answer",conversation_data:{greeted:!0,verified:!0,qualified:!0,quote_presented:!0,quote_reaction:"positive",quote_lump_sum:516666,quote_monthly:2152},lead_status:"qualified",verified:!0},wrong_person:{qualified:null,current_node:"greet",conversation_data:{wrong_person:!0,right_person_available:!0},lead_status:"new",verified:!1},quote_presented:{qualified:!0,current_node:"answer",conversation_data:{greeted:!0,verified:!0,qualified:!0,quote_presented:!0,quote_lump_sum:516666,quote_monthly:2152},lead_status:"qualified",verified:!0}}[t];if(r){this.loading=!0;try{const{error:i}=await this.supabase.from("conversation_state").update({qualified:r.qualified,current_node:r.current_node,conversation_data:r.conversation_data,call_count:r.call_count??((o=this.state)==null?void 0:o.call_count)??0,call_status:r.call_status||"completed"}).eq("phone_number",_);if(i)throw i;if((a=this.state)!=null&&a.lead_id){const{error:l}=await this.supabase.from("leads").update({status:r.lead_status,qualified:r.qualified??!1,verified:r.verified,phone_verified:r.verified,email_verified:r.verified,address_verified:r.verified}).eq("id",this.state.lead_id);if(l)throw l}this.showMessage(`âœ… Applied ${t.replace(/_/g," ")} preset!`,"success"),await this.loadState()}catch(i){console.error("Error:",i),this.showMessage("Error applying preset: "+i.message,"error")}finally{this.loading=!1}}},showMessage(t,e="success"){this.message=t,this.messageType=e,setTimeout(()=>{this.message=""},4e3)},formatDate(t){return t?new Date(t).toLocaleString():"N/A"},formatValue(t){return typeof t=="boolean"?t?"Yes":"No":t==null?"null":typeof t=="object"?JSON.stringify(t):String(t)},getFlagClass(t){return typeof t=="boolean"?t?"flag-true":"flag-false":""}}},k={class:"testy-control"},C={class:"card state-card"},E={class:"card-header"},T={class:"header-actions"},S=["disabled"],N={key:0},R={key:1},M=["disabled"],A={key:0},L={key:1},P={key:0,class:"state-grid-full"},D={class:"state-row"},x={class:"state-item"},O={class:"value mono"},B={class:"state-item"},I={class:"value"},Q={class:"state-item"},F={class:"value mono small"},V={class:"state-row"},G={class:"state-item"},W={class:"state-item"},j={class:"value"},H={class:"state-item"},J={class:"state-item"},U={class:"value"},Y={class:"state-row"},z={class:"state-item"},K={class:"value"},Z={class:"state-item"},X={class:"value"},$={class:"state-row flags-row"},ee={key:0,class:"quote-details"},se={class:"value quote-value"},te={class:"verification-details"},ae={key:1,class:"flags-section"},re={class:"flags-grid"},ie={class:"flag-key"},oe={key:2,class:"empty-state"},le={class:"card actions-card"},ne={class:"actions-grid"},de=["disabled"],ue=["disabled"],ce=["disabled"],_e=["disabled"],fe=["disabled"],ge={class:"card presets-card"},pe={class:"presets-grid"};function he(t,e,r,o,a,i){return c(),u("div",k,[e[34]||(e[34]=s("div",{class:"header"},[s("h1",null,"ðŸ§ª Testy McTesterson - Test Control Panel"),s("p",{class:"subtitle"},"Manage test lead state for call testing")],-1)),s("div",C,[s("div",E,[e[13]||(e[13]=s("h2",null,"Current State",-1)),s("div",T,[s("button",{onClick:e[0]||(e[0]=(...l)=>i.triggerOutboundCall&&i.triggerOutboundCall(...l)),class:"btn-call",disabled:a.loading||a.callingTesty},[a.callingTesty?(c(),u("span",R,"ðŸ“ž Calling...")):(c(),u("span",N,"ðŸ“ž Call Testy"))],8,S),s("button",{onClick:e[1]||(e[1]=(...l)=>i.loadState&&i.loadState(...l)),class:"btn-secondary",disabled:a.loading},[a.loading?(c(),u("span",L,"Loading...")):(c(),u("span",A,"ðŸ”„ Refresh"))],8,M)])]),a.state?(c(),u("div",P,[s("div",D,[s("div",x,[e[14]||(e[14]=s("span",{class:"label"},"Phone:",-1)),s("span",O,n(a.state.phone_number),1)]),s("div",B,[e[15]||(e[15]=s("span",{class:"label"},"Lead Name:",-1)),s("span",I,n(a.state.lead_name||"N/A"),1)]),s("div",Q,[e[16]||(e[16]=s("span",{class:"label"},"Lead ID:",-1)),s("span",F,n(a.state.lead_id||"N/A"),1)])]),s("div",V,[s("div",G,[e[17]||(e[17]=s("span",{class:"label"},"Current Node:",-1)),s("span",{class:d(["value badge",i.nodeClass])},n(a.state.current_node||"null"),3)]),s("div",W,[e[18]||(e[18]=s("span",{class:"label"},"Call Count:",-1)),s("span",j,n(a.state.call_count??0),1)]),s("div",H,[e[19]||(e[19]=s("span",{class:"label"},"Call Status:",-1)),s("span",{class:d(["value badge",i.callStatusClass])},n(a.state.call_status||"N/A"),3)]),s("div",J,[e[20]||(e[20]=s("span",{class:"label"},"Exit Reason:",-1)),s("span",U,n(a.state.exit_reason||"N/A"),1)])]),s("div",Y,[s("div",z,[e[21]||(e[21]=s("span",{class:"label"},"Last Call:",-1)),s("span",K,n(i.formatDate(a.state.last_call_at)),1)]),s("div",Z,[e[22]||(e[22]=s("span",{class:"label"},"Last Updated:",-1)),s("span",X,n(i.formatDate(a.state.updated_at)),1)])]),s("div",$,[s("div",{class:d(["flag-badge",a.state.qualified?"flag-yes":"flag-no"])},n(a.state.qualified?"âœ…":"âŒ")+" Qualified ",3),s("div",{class:d(["flag-badge",a.state.verified?"flag-yes":"flag-no"])},n(a.state.verified?"âœ…":"âŒ")+" Verified ",3),s("div",{class:d(["flag-badge",a.state.quote_presented?"flag-yes":"flag-no"])},n(a.state.quote_presented?"âœ…":"âŒ")+" Quote Presented ",3),s("div",{class:d(["flag-badge",a.state.ready_to_book?"flag-yes":"flag-no"])},n(a.state.ready_to_book?"âœ…":"âŒ")+" Ready to Book ",3),s("div",{class:d(["flag-badge",a.state.wrong_person?"flag-warn":"flag-neutral"])},n(a.state.wrong_person?"âš ï¸":"âœ“")+" Wrong Person ",3)]),a.state.quote_lump_sum||a.state.quote_monthly?(c(),u("div",ee,[e[23]||(e[23]=s("span",{class:"label"},"Quote:",-1)),s("span",se,n(a.state.quote_lump_sum?`$${Number(a.state.quote_lump_sum).toLocaleString()} lump sum`:"")+" "+n(a.state.quote_lump_sum&&a.state.quote_monthly?" / ":"")+" "+n(a.state.quote_monthly?`$${Number(a.state.quote_monthly).toLocaleString()}/mo`:""),1)])):f("",!0),s("div",te,[e[24]||(e[24]=s("span",{class:"label"},"Verification:",-1)),s("span",{class:d(["mini-badge",a.state.phone_verified?"mini-yes":"mini-no"])},"ðŸ“± Phone",2),s("span",{class:d(["mini-badge",a.state.email_verified?"mini-yes":"mini-no"])},"ðŸ“§ Email",2),s("span",{class:d(["mini-badge",a.state.address_verified?"mini-yes":"mini-no"])},"ðŸ  Address",2)])])):f("",!0),a.state&&a.state.conversation_data&&Object.keys(a.state.conversation_data).length>0?(c(),u("div",ae,[e[25]||(e[25]=s("h3",null,"Conversation Data (JSON)",-1)),s("div",re,[(c(!0),u(h,null,m(a.state.conversation_data,(l,g)=>(c(),u("div",{key:g,class:"flag-item"},[s("span",ie,n(g)+":",1),s("span",{class:d(["flag-value",i.getFlagClass(l)])},n(i.formatValue(l)),3)]))),128))])])):f("",!0),!a.state&&!a.loading?(c(),u("div",oe,' No state found. Click "Reset to Fresh State" to initialize. ')):f("",!0)]),s("div",le,[e[26]||(e[26]=s("h2",null,"Quick Actions",-1)),s("div",ne,[s("button",{onClick:e[2]||(e[2]=(...l)=>i.resetFresh&&i.resetFresh(...l)),class:"btn-primary",disabled:a.loading}," ðŸ”„ Reset to Fresh (Empty State) ",8,de),s("button",{onClick:e[3]||(e[3]=(...l)=>i.setQualified&&i.setQualified(...l)),class:"btn-success",disabled:a.loading}," âœ… Set as Qualified ",8,ue),s("button",{onClick:e[4]||(e[4]=(...l)=>i.setReadyToBook&&i.setReadyToBook(...l)),class:"btn-info",disabled:a.loading}," ðŸ“… Set Ready to Book ",8,ce),s("button",{onClick:e[5]||(e[5]=(...l)=>i.clearAppointment&&i.clearAppointment(...l)),class:"btn-warning",disabled:a.loading}," ðŸ—‘ï¸ Clear Appointment ",8,_e),s("button",{onClick:e[6]||(e[6]=(...l)=>i.deleteState&&i.deleteState(...l)),class:"btn-danger",disabled:a.loading}," âŒ Delete All State ",8,fe)])]),s("div",ge,[e[33]||(e[33]=s("h2",null,"Test Scenarios",-1)),s("div",pe,[s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[7]||(e[7]=l=>i.applyPreset("new_caller"))},[...e[27]||(e[27]=[s("div",{class:"preset-icon"},"ðŸ†•",-1),s("div",{class:"preset-title"},"New Caller",-1),s("div",{class:"preset-desc"},"No history, start from GREET",-1)])],2),s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[8]||(e[8]=l=>i.applyPreset("has_questions"))},[...e[28]||(e[28]=[s("div",{class:"preset-icon"},"â“",-1),s("div",{class:"preset-title"},"Has Questions",-1),s("div",{class:"preset-desc"},"Start from ANSWER context",-1)])],2),s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[9]||(e[9]=l=>i.applyPreset("ready_to_book"))},[...e[29]||(e[29]=[s("div",{class:"preset-icon"},"ðŸ“…",-1),s("div",{class:"preset-title"},"Ready to Book",-1),s("div",{class:"preset-desc"},"Start from BOOK context",-1)])],2),s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[10]||(e[10]=l=>i.applyPreset("returning_caller"))},[...e[30]||(e[30]=[s("div",{class:"preset-icon"},"ðŸ”",-1),s("div",{class:"preset-title"},"Returning Caller",-1),s("div",{class:"preset-desc"},"Already qualified, skip to ANSWER",-1)])],2),s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[11]||(e[11]=l=>i.applyPreset("wrong_person"))},[...e[31]||(e[31]=[s("div",{class:"preset-icon"},"ðŸ‘¤",-1),s("div",{class:"preset-title"},"Wrong Person",-1),s("div",{class:"preset-desc"},"Test wrong person flow",-1)])],2),s("div",{class:d(["preset-card",{disabled:a.loading}]),onClick:e[12]||(e[12]=l=>i.applyPreset("quote_presented"))},[...e[32]||(e[32]=[s("div",{class:"preset-icon"},"ðŸ’°",-1),s("div",{class:"preset-title"},"Quote Presented",-1),s("div",{class:"preset-desc"},"Has seen quote, not yet booked",-1)])],2)])]),p(b,{name:"fade"},{default:v(()=>[a.message?(c(),u("div",{key:0,class:d(["message",a.messageType])},n(a.message),3)):f("",!0)]),_:1})])}const be=q(w,[["render",he],["__scopeId","data-v-18f02bb8"]]);export{be as default};
