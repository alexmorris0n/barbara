import{aY as li,aZ as qd,a_ as Fd,c as st,d as I,o as M,au as L,h as a,aF as Pn,Y as Ie,t as B,r as j,V as lt,an as Bd,k as X,l as et,e as ls,i as Le,Z as V,U as zd,ap as Hd,a$ as ye,M as fe,_ as be,b0 as K,b1 as An,$ as qt,b2 as ft,a0 as Uo,ae as ht}from"./index-Zmiy9vUZ.js";import{_ as di}from"./_plugin-vue_export-helper-DlAUqK2U.js";var ds={exports:{}};(function(t){(function(e,r){t.exports?t.exports=r():e.log=r()})(qd,function(){var e=function(){},r="undefined",o=typeof window!==r&&typeof window.navigator!==r&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],s={},l=null;function c(k,C){var E=k[C];if(typeof E.bind=="function")return E.bind(k);try{return Function.prototype.bind.call(E,k)}catch{return function(){return Function.prototype.apply.apply(E,[k,arguments])}}}function v(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function m(k){return k==="debug"&&(k="log"),typeof console===r?!1:k==="trace"&&o?v:console[k]!==void 0?c(console,k):console.log!==void 0?c(console,"log"):e}function p(){for(var k=this.getLevel(),C=0;C<n.length;C++){var E=n[C];this[E]=C<k?e:this.methodFactory(E,k,this.name)}if(this.log=this.debug,typeof console===r&&k<this.levels.SILENT)return"No console available for logging"}function h(k){return function(){typeof console!==r&&(p.call(this),this[k].apply(this,arguments))}}function y(k,C,E){return m(k)||h.apply(this,arguments)}function b(k,C){var E=this,$,O,q,H="loglevel";typeof k=="string"?H+=":"+k:typeof k=="symbol"&&(H=void 0);function de(oe){var D=(n[oe]||"silent").toUpperCase();if(!(typeof window===r||!H)){try{window.localStorage[H]=D;return}catch{}try{window.document.cookie=encodeURIComponent(H)+"="+D+";"}catch{}}}function Me(){var oe;if(!(typeof window===r||!H)){try{oe=window.localStorage[H]}catch{}if(typeof oe===r)try{var D=window.document.cookie,ie=encodeURIComponent(H),U=D.indexOf(ie+"=");U!==-1&&(oe=/^([^;]+)/.exec(D.slice(U+ie.length+1))[1])}catch{}return E.levels[oe]===void 0&&(oe=void 0),oe}}function ce(){if(!(typeof window===r||!H)){try{window.localStorage.removeItem(H)}catch{}try{window.document.cookie=encodeURIComponent(H)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function Q(oe){var D=oe;if(typeof D=="string"&&E.levels[D.toUpperCase()]!==void 0&&(D=E.levels[D.toUpperCase()]),typeof D=="number"&&D>=0&&D<=E.levels.SILENT)return D;throw new TypeError("log.setLevel() called with invalid level: "+oe)}E.name=k,E.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},E.methodFactory=C||y,E.getLevel=function(){return q??O??$},E.setLevel=function(oe,D){return q=Q(oe),D!==!1&&de(q),p.call(E)},E.setDefaultLevel=function(oe){O=Q(oe),Me()||E.setLevel(oe,!1)},E.resetLevel=function(){q=null,ce(),p.call(E)},E.enableAll=function(oe){E.setLevel(E.levels.TRACE,oe)},E.disableAll=function(oe){E.setLevel(E.levels.SILENT,oe)},E.rebuild=function(){if(l!==E&&($=Q(l.getLevel())),p.call(E),l===E)for(var oe in s)s[oe].rebuild()},$=Q(l?l.getLevel():"WARN");var ge=Me();ge!=null&&(q=Q(ge)),p.call(E)}l=new b,l.getLogger=function(C){if(typeof C!="symbol"&&typeof C!="string"||C==="")throw new TypeError("You must supply a name when creating a logger.");var E=s[C];return E||(E=s[C]=new b(C,l.methodFactory)),E};var S=typeof window!==r?window.log:void 0;return l.noConflict=function(){return typeof window!==r&&window.log===l&&(window.log=S),l},l.getLoggers=function(){return s},l.default=l,l})})(ds);var Gd=ds.exports;const Kd=li(Gd);let Hr;const Jd=new Uint8Array(16);function Yd(){if(!Hr&&(Hr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Hr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Hr(Jd)}const Oe=[];for(let t=0;t<256;++t)Oe.push((t+256).toString(16).slice(1));function Xd(t,e=0){return Oe[t[e+0]]+Oe[t[e+1]]+Oe[t[e+2]]+Oe[t[e+3]]+"-"+Oe[t[e+4]]+Oe[t[e+5]]+"-"+Oe[t[e+6]]+Oe[t[e+7]]+"-"+Oe[t[e+8]]+Oe[t[e+9]]+"-"+Oe[t[e+10]]+Oe[t[e+11]]+Oe[t[e+12]]+Oe[t[e+13]]+Oe[t[e+14]]+Oe[t[e+15]]}const Qd=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),xn={randomUUID:Qd};function xt(t,e,r){if(xn.randomUUID&&!t)return xn.randomUUID();t=t||{};const o=t.random||(t.rng||Yd)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Xd(o)}function mr(t){"@babel/helpers - typeof";return mr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},mr(t)}function Zd(t,e){if(mr(t)!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var o=r.call(t,e);if(mr(o)!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function ec(t){var e=Zd(t,"string");return mr(e)=="symbol"?e:e+""}function tc(t,e,r){return(e=ec(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function Rn(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),r.push.apply(r,o)}return r}function Ln(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?Rn(Object(r),!0).forEach(function(o){tc(t,o,r[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Rn(Object(r)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(r,o))})}return t}function Ve(t){return"Minified Redux error #"+t+"; visit https://redux.js.org/Errors?code="+t+" for the full message or use the non-minified dev environment for full errors. "}var On=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),jo=function(){return Math.random().toString(36).substring(7).split("").join(".")},pr={INIT:"@@redux/INIT"+jo(),REPLACE:"@@redux/REPLACE"+jo(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+jo()}};function rc(t){if(typeof t!="object"||t===null)return!1;for(var e=t;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}function so(t,e,r){var o;if(typeof e=="function"&&typeof r=="function"||typeof r=="function"&&typeof arguments[3]=="function")throw new Error(Ve(0));if(typeof e=="function"&&typeof r>"u"&&(r=e,e=void 0),typeof r<"u"){if(typeof r!="function")throw new Error(Ve(1));return r(so)(t,e)}if(typeof t!="function")throw new Error(Ve(2));var n=t,s=e,l=[],c=l,v=!1;function m(){c===l&&(c=l.slice())}function p(){if(v)throw new Error(Ve(3));return s}function h(k){if(typeof k!="function")throw new Error(Ve(4));if(v)throw new Error(Ve(5));var C=!0;return m(),c.push(k),function(){if(C){if(v)throw new Error(Ve(6));C=!1,m();var $=c.indexOf(k);c.splice($,1),l=null}}}function y(k){if(!rc(k))throw new Error(Ve(7));if(typeof k.type>"u")throw new Error(Ve(8));if(v)throw new Error(Ve(9));try{v=!0,s=n(s,k)}finally{v=!1}for(var C=l=c,E=0;E<C.length;E++){var $=C[E];$()}return k}function b(k){if(typeof k!="function")throw new Error(Ve(10));n=k,y({type:pr.REPLACE})}function S(){var k,C=h;return k={subscribe:function($){if(typeof $!="object"||$===null)throw new Error(Ve(11));function O(){$.next&&$.next(p())}O();var q=C(O);return{unsubscribe:q}}},k[On]=function(){return this},k}return y({type:pr.INIT}),o={dispatch:y,subscribe:h,getState:p,replaceReducer:b},o[On]=S,o}var oc=so;function ic(t){Object.keys(t).forEach(function(e){var r=t[e],o=r(void 0,{type:pr.INIT});if(typeof o>"u")throw new Error(Ve(12));if(typeof r(void 0,{type:pr.PROBE_UNKNOWN_ACTION()})>"u")throw new Error(Ve(13))})}function cs(t){for(var e=Object.keys(t),r={},o=0;o<e.length;o++){var n=e[o];typeof t[n]=="function"&&(r[n]=t[n])}var s=Object.keys(r),l;try{ic(r)}catch(c){l=c}return function(v,m){if(v===void 0&&(v={}),l)throw l;for(var p=!1,h={},y=0;y<s.length;y++){var b=s[y],S=r[b],k=v[b],C=S(k,m);if(typeof C>"u")throw m&&m.type,new Error(Ve(14));h[b]=C,p=p||C!==k}return p=p||s.length!==Object.keys(v).length,p?h:v}}function Vn(t,e){return function(){return e(t.apply(this,arguments))}}function nc(t,e){if(typeof t=="function")return Vn(t,e);if(typeof t!="object"||t===null)throw new Error(Ve(16));var r={};for(var o in t){var n=t[o];typeof n=="function"&&(r[o]=Vn(n,e))}return r}function fr(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.length===0?function(o){return o}:e.length===1?e[0]:e.reduce(function(o,n){return function(){return o(n.apply(void 0,arguments))}})}function us(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return function(o){return function(){var n=o.apply(void 0,arguments),s=function(){throw new Error(Ve(15))},l={getState:n.getState,dispatch:function(){return s.apply(void 0,arguments)}},c=e.map(function(v){return v(l)});return s=fr.apply(void 0,c)(n.dispatch),Ln(Ln({},n),{},{dispatch:s})}}}const sc=Object.freeze(Object.defineProperty({__proto__:null,__DO_NOT_USE__ActionTypes:pr,applyMiddleware:us,bindActionCreators:nc,combineReducers:cs,compose:fr,createStore:so,legacy_createStore:oc},Symbol.toStringTag,{value:"Module"}));var ut=function(e){return"@@redux-saga/"+e},ac=ut("CANCEL_PROMISE"),vs=ut("CHANNEL_END"),ms=ut("IO"),Dn=ut("MATCH"),ps=ut("MULTICAST"),fs=ut("SAGA_ACTION"),lc=ut("SELF_CANCELLATION"),dc=ut("TASK"),Zt=ut("TASK_CANCEL"),hs=ut("TERMINATE"),cc=ut("LOCATION");function hr(){return hr=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)({}).hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},hr.apply(null,arguments)}function uc(t,e){if(t==null)return{};var r={};for(var o in t)if({}.hasOwnProperty.call(t,o)){if(e.indexOf(o)!==-1)continue;r[o]=t[o]}return r}var gs=function(e){return e==null},Gr=function(e){return e!=null},Ye=function(e){return typeof e=="function"},ci=function(e){return typeof e=="string"},Lt=Array.isArray,ao=function(e){return e&&Ye(e.then)},ui=function(e){return e&&Ye(e.next)&&Ye(e.throw)},Ho=function(e){return e&&(ci(e)||ys(e)||Ye(e)||Lt(e)&&e.every(Ho))},_s=function(e){return e&&Ye(e.take)&&Ye(e.close)},vc=function(e){return Ye(e)&&e.hasOwnProperty("toString")},ys=function(e){return!!e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype},mc=function(e){return _s(e)&&e[ps]},pc=function(e){return function(){return e}},bs=pc(!0),Ne=function(){},ws=function(e){return e},vi=function(e,r){hr(e,r),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(r).forEach(function(o){e[o]=r[o]})},fc=function(e,r){var o;return(o=[]).concat.apply(o,r.map(e))};function lo(t,e){var r=t.indexOf(e);r>=0&&t.splice(r,1)}function Ss(t){var e=!1;return function(){e||(e=!0,t())}}var hc=function(e){throw e},gc=function(e){return{value:e,done:!0}};function Nn(t,e,r){e===void 0&&(e=hc),r===void 0&&(r="iterator");var o={meta:{name:r},next:t,throw:e,return:gc,isSagaIterator:!0};return typeof Symbol<"u"&&(o[Symbol.iterator]=function(){return o}),o}function _c(t,e){var r=e.sagaStack;console.error(t),console.error(r)}var ks=function(e){return Array.apply(null,new Array(e))},yc=function(e){return function(r){return e(Object.defineProperty(r,fs,{value:!0}))}},Cs=function(e){return e===hs},Ts=function(e){return e===Zt},Es=function(e){return Cs(e)||Ts(e)};function Is(t,e){var r=Object.keys(t),o=r.length,n=0,s,l=Lt(t)?ks(o):{},c={};function v(){n===o&&(s=!0,e(l))}return r.forEach(function(m){var p=function(y,b){s||(b||Es(y)?(e.cancel(),e(y,b)):(l[m]=y,n++,v()))};p.cancel=Ne,c[m]=p}),e.cancel=function(){s||(s=!0,r.forEach(function(m){return c[m].cancel()}))},c}function mi(t){return{name:t.name||"anonymous",location:Ms(t)}}function Ms(t){return t[cc]}function bc(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.length===0?function(o){return o}:e.length===1?e[0]:e.reduce(function(o,n){return function(){return o(n.apply(void 0,arguments))}})}var wc="Channel's Buffer overflow!",Sc=1,kc=3,Ps=4,Cc={isEmpty:bs,put:Ne,take:Ne};function Tc(t,e){t===void 0&&(t=10);var r=new Array(t),o=0,n=0,s=0,l=function(p){r[n]=p,n=(n+1)%t,o++},c=function(){if(o!=0){var p=r[s];return r[s]=null,o--,s=(s+1)%t,p}},v=function(){for(var p=[];o;)p.push(c());return p};return{isEmpty:function(){return o==0},put:function(p){if(o<t)l(p);else{var h;switch(e){case Sc:throw new Error(wc);case kc:r[n]=p,n=(n+1)%t,s=n;break;case Ps:h=2*t,r=v(),o=r.length,n=r.length,s=0,r.length=h,t=h,l(p);break}}},take:c,flush:v}}var Ec=function(){return Cc},Ic=function(e){return Tc(e,Ps)},Kr="TAKE",As="PUT",xs="ALL",Mc="RACE",Rs="CALL",Pc="CPS",pi="FORK",Ls="JOIN",Ac="CANCEL",Os="SELECT",xc="ACTION_CHANNEL",Vs="CANCELLED",Rc="FLUSH",Lc="GET_CONTEXT",Oc="SET_CONTEXT",dt=function(e,r){var o;return o={},o[ms]=!0,o.combinator=!1,o.type=e,o.payload=r,o},Vc=function(e){return dt(pi,hr({},e.payload,{detached:!0}))};function Te(t,e){if(t===void 0&&(t="*"),Ho(t))return Gr(e)&&console.warn("take(pattern) takes one argument but two were provided. Consider passing an array for listening to several action types"),dt(Kr,{pattern:t});if(mc(t)&&Gr(e)&&Ho(e))return dt(Kr,{channel:t,pattern:e});if(_s(t))return Gr(e)&&console.warn("take(channel) takes one argument but two were provided. Second argument is ignored."),dt(Kr,{channel:t})}function tt(t,e){return gs(e)&&(e=t,t=void 0),dt(As,{channel:t,action:e})}function Dc(t){var e=dt(xs,t);return e.combinator=!0,e}function Ds(t,e){var r=null,o;return Ye(t)?o=t:(Lt(t)?(r=t[0],o=t[1]):(r=t.context,o=t.fn),r&&ci(o)&&Ye(r[o])&&(o=r[o])),{context:r,fn:o,args:e}}function Ue(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return dt(Rs,Ds(t,r))}function se(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return dt(pi,Ds(t,r))}function Nc(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return Vc(se.apply(void 0,[t].concat(r)))}function $c(t){return dt(Ls,t)}function Ns(t){t===void 0&&(t=ws);for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return dt(Os,{selector:t,args:r})}function fi(){return dt(Vs,{})}function Wc(){var t={};return t.promise=new Promise(function(e,r){t.resolve=e,t.reject=r}),t}var $s=[],co=0;function Uc(t){try{hi(),t()}finally{js()}}function Ws(t){$s.push(t),co||(hi(),qs())}function Us(t){try{return hi(),t()}finally{qs()}}function hi(){co++}function js(){co--}function qs(){js();for(var t;!co&&(t=$s.shift())!==void 0;)Uc(t)}var jc=function(e){return function(r){return e.some(function(o){return gi(o)(r)})}},qc=function(e){return function(r){return e(r)}},$n=function(e){return function(r){return r.type===String(e)}},Fc=function(e){return function(r){return r.type===e}},Fs=function(){return bs};function gi(t){var e=t==="*"?Fs:ci(t)?$n:Lt(t)?jc:vc(t)?$n:Ye(t)?qc:ys(t)?Fc:null;if(e===null)throw new Error("invalid pattern: "+t);return e(t)}var ur={type:vs},uo=function(e){return e&&e.type===vs};function vo(t){t===void 0&&(t=Ic());var e=!1,r=[];function o(c){if(!e){if(r.length===0)return t.put(c);var v=r.shift();v(c)}}function n(c){e&&t.isEmpty()?c(ur):t.isEmpty()?(r.push(c),c.cancel=function(){lo(r,c)}):c(t.take())}function s(c){if(e&&t.isEmpty()){c(ur);return}c(t.flush())}function l(){if(!e){e=!0;var c=r;r=[];for(var v=0,m=c.length;v<m;v++){var p=c[v];p(ur)}}}return{take:n,put:o,flush:s,close:l}}function Bs(t,e){e===void 0&&(e=Ec());var r=!1,o,n=vo(e),s=function(){r||(r=!0,Ye(o)&&o(),n.close())};return o=t(function(l){if(uo(l)){s();return}n.put(l)}),o=Ss(o),r&&o(),{take:n.take,flush:n.flush,close:s}}function _i(){var t,e=!1,r=[],o=r,n=function(){o===r&&(o=r.slice())},s=function(){e=!0;var c=r=o;o=[],c.forEach(function(v){v(ur)})};return t={},t[ps]=!0,t.put=function(c){if(!e){if(uo(c)){s();return}for(var v=r=o,m=0,p=v.length;m<p;m++){var h=v[m];h[Dn](c)&&(h.cancel(),h(c))}}},t.take=function(c,v){if(v===void 0&&(v=Fs),e){c(ur);return}c[Dn]=v,n(),o.push(c),c.cancel=Ss(function(){n(),lo(o,c)})},t.close=s,t}function zs(){var t=_i(),e=t.put;return t.put=function(r){if(r[fs]){e(r);return}Ws(function(){e(r)})},t}var Ft=0,wt=1,Jr=2,Hs=3;function yi(t,e){var r=t[ac];Ye(r)&&(e.cancel=r),t.then(e,function(o){e(o,!0)})}var Sr=0,Gs=function(){return++Sr},Re;function Bc(t,e){return t.isSagaIterator?{name:t.meta.name}:mi(e)}function zc(t){var e=t.context,r=t.fn,o=t.args;try{var n=r.apply(e,o);if(ui(n))return n;var s=!1,l=function(v){return s?{value:v,done:!0}:(s=!0,{value:n,done:!ao(n)})};return Nn(l)}catch(c){return Nn(function(){throw c})}}function Hc(t,e,r){var o=e.channel,n=e.action,s=e.resolve;Ws(function(){var l;try{l=(o?o.put:t.dispatch)(n)}catch(c){r(c,!0);return}s&&ao(l)?yi(l,r):r(l)})}function Gc(t,e,r){var o=e.channel,n=o===void 0?t.channel:o,s=e.pattern,l=e.maybe,c=function(m){if(m instanceof Error){r(m,!0);return}if(uo(m)&&!l){r(hs);return}r(m)};try{n.take(c,Gr(s)?gi(s):null)}catch(v){r(v,!0);return}r.cancel=c.cancel}function Kc(t,e,r,o){var n=e.context,s=e.fn,l=e.args,c=o.task;try{var v=s.apply(n,l);if(ao(v)){yi(v,r);return}if(ui(v)){mo(t,v,c.context,Sr,mi(s),!1,r);return}r(v)}catch(m){r(m,!0)}}function Jc(t,e,r){var o=e.context,n=e.fn,s=e.args;try{var l=function(v,m){gs(v)?r(m):r(v,!0)};n.apply(o,s.concat(l)),l.cancel&&(r.cancel=l.cancel)}catch(c){r(c,!0)}}function Yc(t,e,r,o){var n=e.context,s=e.fn,l=e.args,c=e.detached,v=o.task,m=zc({context:n,fn:s,args:l}),p=Bc(m,s);Us(function(){var h=mo(t,m,v.context,Sr,p,c,void 0);c?r(h):h.isRunning()?(v.queue.addTask(h),r(h)):h.isAborted()?v.queue.abort(h.error()):r(h)})}function Xc(t,e,r,o){var n=o.task,s=function(v,m){if(v.isRunning()){var p={task:n,cb:m};m.cancel=function(){v.isRunning()&&lo(v.joiners,p)},v.joiners.push(p)}else v.isAborted()?m(v.error(),!0):m(v.result())};if(Lt(e)){if(e.length===0){r([]);return}var l=Is(e,r);e.forEach(function(c,v){s(c,l[v])})}else s(e,r)}function qo(t){t.isRunning()&&t.cancel()}function Qc(t,e,r,o){var n=o.task;e===lc?qo(n):Lt(e)?e.forEach(qo):qo(e),r()}function Zc(t,e,r,o){var n=o.digestEffect,s=Sr,l=Object.keys(e);if(l.length===0){r(Lt(e)?[]:{});return}var c=Is(e,r);l.forEach(function(v){n(e[v],s,c[v],v)})}function eu(t,e,r,o){var n=o.digestEffect,s=Sr,l=Object.keys(e),c=Lt(e)?ks(l.length):{},v={},m=!1;l.forEach(function(p){var h=function(b,S){m||(S||Es(b)?(r.cancel(),r(b,S)):(r.cancel(),m=!0,c[p]=b,r(c)))};h.cancel=Ne,v[p]=h}),r.cancel=function(){m||(m=!0,l.forEach(function(p){return v[p].cancel()}))},l.forEach(function(p){m||n(e[p],s,v[p],p)})}function tu(t,e,r){var o=e.selector,n=e.args;try{var s=o.apply(void 0,[t.getState()].concat(n));r(s)}catch(l){r(l,!0)}}function ru(t,e,r){var o=e.pattern,n=e.buffer,s=vo(n),l=gi(o),c=function(p){uo(p)||t.channel.take(c,l),s.put(p)},v=s.close;s.close=function(){c.cancel(),v()},t.channel.take(c,l),r(s)}function ou(t,e,r,o){var n=o.task;r(n.isCancelled())}function iu(t,e,r){e.flush(r)}function nu(t,e,r,o){var n=o.task;r(n.context[e])}function su(t,e,r,o){var n=o.task;vi(n.context,e),r()}var au=(Re={},Re[Kr]=Gc,Re[As]=Hc,Re[xs]=Zc,Re[Mc]=eu,Re[Rs]=Kc,Re[Pc]=Jc,Re[pi]=Yc,Re[Ls]=Xc,Re[Ac]=Qc,Re[Os]=tu,Re[xc]=ru,Re[Vs]=ou,Re[Rc]=iu,Re[Lc]=nu,Re[Oc]=su,Re);function lu(t,e,r){var o=[],n,s=!1;v(t);var l=function(){return o};function c(p){e(),m(),r(p,!0)}function v(p){o.push(p),p.cont=function(h,y){s||(lo(o,p),p.cont=Ne,y?c(h):(p===t&&(n=h),o.length||(s=!0,r(n))))}}function m(){s||(s=!0,o.forEach(function(p){p.cont=Ne,p.cancel()}),o=[])}return{addTask:v,cancelAll:m,abort:c,getTasks:l}}function Ks(t,e){return t+"?"+e}function du(t){var e=Ms(t);if(e){var r=e.code,o=e.fileName,n=e.lineNumber,s=r+"  "+Ks(o,n);return s}return""}function Wn(t){var e=t.name,r=t.location;return r?e+"  "+Ks(r.fileName,r.lineNumber):e}function cu(t){var e=fc(function(r){return r.cancelledTasks},t);return e.length?["Tasks cancelled due to error:"].concat(e).join(`
`):""}var bi=null,vr=[],uu=function(e){e.crashedEffect=bi,vr.push(e)},Js=function(){bi=null,vr.length=0},vu=function(e){bi=e},mu=function(){var e=vr[0],r=vr.slice(1),o=e.crashedEffect?du(e.crashedEffect):null,n="The above error occurred in task "+Wn(e.meta)+(o?` 
 when executing effect `+o:"");return[n].concat(r.map(function(s){return"    created by "+Wn(s.meta)}),[cu(vr)]).join(`
`)};function pu(t,e,r,o,n,s,l){var c;l===void 0&&(l=Ne);var v=Ft,m,p,h=null,y=[],b=Object.create(r),S=lu(e,function(){y.push.apply(y,S.getTasks().map(function(H){return H.meta.name}))},C);function k(){v===Ft&&(v=wt,S.cancelAll(),C(Zt,!1))}function C(q,H){if(!H)q===Zt?v=wt:v!==wt&&(v=Hs),m=q,h&&h.resolve(q);else{if(v=Jr,uu({meta:n,cancelledTasks:y}),O.isRoot){var de=mu();Js(),t.onError(q,{sagaStack:de})}p=q,h&&h.reject(q)}O.cont(q,H),O.joiners.forEach(function(Me){Me.cb(q,H)}),O.joiners=null}function E(q){vi(b,q)}function $(){return h||(h=Wc(),v===Jr?h.reject(p):v!==Ft&&h.resolve(m)),h.promise}var O=(c={},c[dc]=!0,c.id=o,c.meta=n,c.isRoot=s,c.context=b,c.joiners=[],c.queue=S,c.cancel=k,c.cont=l,c.end=C,c.setContext=E,c.toPromise=$,c.isRunning=function(){return v===Ft},c.isCancelled=function(){return v===wt||v===Ft&&e.status===wt},c.isAborted=function(){return v===Jr},c.result=function(){return m},c.error=function(){return p},c);return O}function mo(t,e,r,o,n,s,l){var c=t.finalizeRunEffect(b);y.cancel=Ne;var v={meta:n,cancel:h,status:Ft},m=pu(t,v,r,o,n,s,l),p={task:m,digestEffect:S};function h(){v.status===Ft&&(v.status=wt,y(Zt))}return l&&(l.cancel=m.cancel),y(),m;function y(k,C){try{var E;C?(E=e.throw(k),Js()):Ts(k)?(v.status=wt,y.cancel(),E=Ye(e.return)?e.return(Zt):{done:!0,value:Zt}):Cs(k)?E=Ye(e.return)?e.return():{done:!0}:E=e.next(k),E.done?(v.status!==wt&&(v.status=Hs),v.cont(E.value)):S(E.value,o,y)}catch($){if(v.status===wt)throw $;v.status=Jr,v.cont($,!0)}}function b(k,C,E){if(ao(k))yi(k,E);else if(ui(k))mo(t,k,m.context,C,n,!1,E);else if(k&&k[ms]){var $=au[k.type];$(t,k.payload,E,p)}else E(k)}function S(k,C,E,$){$===void 0&&($="");var O=Gs();t.sagaMonitor&&t.sagaMonitor.effectTriggered({effectId:O,parentEffectId:C,label:$,effect:k});var q;function H(de,Me){q||(q=!0,E.cancel=Ne,t.sagaMonitor&&(Me?t.sagaMonitor.effectRejected(O,de):t.sagaMonitor.effectResolved(O,de)),Me&&vu(k),E(de,Me))}H.cancel=Ne,E.cancel=function(){q||(q=!0,H.cancel(),H.cancel=Ne,t.sagaMonitor&&t.sagaMonitor.effectCancelled(O))},c(k,O,H)}}function fu(t,e){for(var r=t.channel,o=r===void 0?zs():r,n=t.dispatch,s=t.getState,l=t.context,c=l===void 0?{}:l,v=t.sagaMonitor,m=t.effectMiddlewares,p=t.onError,h=p===void 0?_c:p,y=arguments.length,b=new Array(y>2?y-2:0),S=2;S<y;S++)b[S-2]=arguments[S];var k=e.apply(void 0,b),C=Gs();v&&(v.rootSagaStarted=v.rootSagaStarted||Ne,v.effectTriggered=v.effectTriggered||Ne,v.effectResolved=v.effectResolved||Ne,v.effectRejected=v.effectRejected||Ne,v.effectCancelled=v.effectCancelled||Ne,v.actionDispatched=v.actionDispatched||Ne,v.rootSagaStarted({effectId:C,saga:e,args:b}));var E;if(m){var $=bc.apply(void 0,m);E=function(H){return function(de,Me,ce){var Q=function(oe){return H(oe,Me,ce)};return $(Q)(de)}}}else E=ws;var O={channel:o,dispatch:yc(n),getState:s,sagaMonitor:v,onError:h,finalizeRunEffect:E};return Us(function(){var q=mo(O,k,c,C,mi(e),!0,void 0);return v&&v.effectResolved(C,q),q})}var hu=["context","channel","sagaMonitor"];function gu(t){var e=t===void 0?{}:t,r=e.context,o=r===void 0?{}:r,n=e.channel,s=n===void 0?zs():n,l=e.sagaMonitor,c=uc(e,hu),v;function m(p){var h=p.getState,y=p.dispatch;return v=fu.bind(null,hr({},c,{context:o,channel:s,dispatch:y,getState:h,sagaMonitor:l})),function(b){return function(S){l&&l.actionDispatched&&l.actionDispatched(S);var k=b(S);return s.put(S),k}}}return m.run=function(){return v.apply(void 0,arguments)},m.setContext=function(p){vi(o,p)},m}var Ys={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,r="~";function o(){}Object.create&&(o.prototype=Object.create(null),new o().__proto__||(r=!1));function n(v,m,p){this.fn=v,this.context=m,this.once=p||!1}function s(v,m,p,h,y){if(typeof p!="function")throw new TypeError("The listener must be a function");var b=new n(p,h||v,y),S=r?r+m:m;return v._events[S]?v._events[S].fn?v._events[S]=[v._events[S],b]:v._events[S].push(b):(v._events[S]=b,v._eventsCount++),v}function l(v,m){--v._eventsCount===0?v._events=new o:delete v._events[m]}function c(){this._events=new o,this._eventsCount=0}c.prototype.eventNames=function(){var m=[],p,h;if(this._eventsCount===0)return m;for(h in p=this._events)e.call(p,h)&&m.push(r?h.slice(1):h);return Object.getOwnPropertySymbols?m.concat(Object.getOwnPropertySymbols(p)):m},c.prototype.listeners=function(m){var p=r?r+m:m,h=this._events[p];if(!h)return[];if(h.fn)return[h.fn];for(var y=0,b=h.length,S=new Array(b);y<b;y++)S[y]=h[y].fn;return S},c.prototype.listenerCount=function(m){var p=r?r+m:m,h=this._events[p];return h?h.fn?1:h.length:0},c.prototype.emit=function(m,p,h,y,b,S){var k=r?r+m:m;if(!this._events[k])return!1;var C=this._events[k],E=arguments.length,$,O;if(C.fn){switch(C.once&&this.removeListener(m,C.fn,void 0,!0),E){case 1:return C.fn.call(C.context),!0;case 2:return C.fn.call(C.context,p),!0;case 3:return C.fn.call(C.context,p,h),!0;case 4:return C.fn.call(C.context,p,h,y),!0;case 5:return C.fn.call(C.context,p,h,y,b),!0;case 6:return C.fn.call(C.context,p,h,y,b,S),!0}for(O=1,$=new Array(E-1);O<E;O++)$[O-1]=arguments[O];C.fn.apply(C.context,$)}else{var q=C.length,H;for(O=0;O<q;O++)switch(C[O].once&&this.removeListener(m,C[O].fn,void 0,!0),E){case 1:C[O].fn.call(C[O].context);break;case 2:C[O].fn.call(C[O].context,p);break;case 3:C[O].fn.call(C[O].context,p,h);break;case 4:C[O].fn.call(C[O].context,p,h,y);break;default:if(!$)for(H=1,$=new Array(E-1);H<E;H++)$[H-1]=arguments[H];C[O].fn.apply(C[O].context,$)}}return!0},c.prototype.on=function(m,p,h){return s(this,m,p,h,!1)},c.prototype.once=function(m,p,h){return s(this,m,p,h,!0)},c.prototype.removeListener=function(m,p,h,y){var b=r?r+m:m;if(!this._events[b])return this;if(!p)return l(this,b),this;var S=this._events[b];if(S.fn)S.fn===p&&(!y||S.once)&&(!h||S.context===h)&&l(this,b);else{for(var k=0,C=[],E=S.length;k<E;k++)(S[k].fn!==p||y&&!S[k].once||h&&S[k].context!==h)&&C.push(S[k]);C.length?this._events[b]=C.length===1?C[0]:C:l(this,b)}return this},c.prototype.removeAllListeners=function(m){var p;return m?(p=r?r+m:m,this._events[p]&&l(this,p)):(this._events=new o,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=r,c.EventEmitter=c,t.exports=c})(Ys);var _u=Ys.exports;const kr=li(_u);var wi=Object.defineProperty,yu=Object.defineProperties,bu=Object.getOwnPropertyDescriptor,wu=Object.getOwnPropertyDescriptors,Su=Object.getOwnPropertyNames,Xr=Object.getOwnPropertySymbols,Si=Object.prototype.hasOwnProperty,Xs=Object.prototype.propertyIsEnumerable,Go=(t,e,r)=>e in t?wi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,G=(t,e)=>{for(var r in e||(e={}))Si.call(e,r)&&Go(t,r,e[r]);if(Xr)for(var r of Xr(e))Xs.call(e,r)&&Go(t,r,e[r]);return t},ve=(t,e)=>yu(t,wu(e)),ct=(t,e)=>{var r={};for(var o in t)Si.call(t,o)&&e.indexOf(o)<0&&(r[o]=t[o]);if(t!=null&&Xr)for(var o of Xr(t))e.indexOf(o)<0&&Xs.call(t,o)&&(r[o]=t[o]);return r},vt=(t,e)=>{for(var r in e)wi(t,r,{get:e[r],enumerable:!0})},ku=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Su(e))!Si.call(t,n)&&n!==r&&wi(t,n,{get:()=>e[n],enumerable:!(o=bu(e,n))||o.enumerable});return t},Qs=(t,e,r)=>(ku(t,e,"default"),r),te=(t,e,r)=>Go(t,typeof e!="symbol"?e+"":e,r),Cu="wss://relay.signalwire.com",Zs=":",ki="__local__",ea="__synthetic__",Tu="video",Eu="chat",Yt="chat",Ci=Symbol.for("sw-execute-connection-closed"),Ti=Symbol.for("sw-execute-timeout"),Iu=Symbol.for("sw-connect-error"),Mu=()=>new Date().toISOString(),Cr=Kd.getLogger("signalwire"),Pu=Cr.methodFactory;Cr.methodFactory=(t,e,r)=>{const o=Pu(t,e,r);return function(...n){n.unshift(Mu(),"-"),o.apply(void 0,n)}};var Au=Cr.getLevel();Cr.setLevel(Au);var Ko,xu=t=>{Ko=t},Jo={},Ru=t=>{if(t==null){Jo={};return}Object.assign(Jo,t)},ta=()=>Ko??Cr,Lu=t=>!("method"in t&&t.method==="signalwire.ping"),Ou=({type:t,payload:e})=>{const r=ta(),{logWsTraffic:o}=Jo||{};if(!o)return;const n=Lu(e)?JSON.stringify(e,null,2):e;return r.info(`${t.toUpperCase()}: 
`,n,`
`)},w=()=>{const t=ta();return new Proxy(t,{get(e,r,o){return r==="wsTraffic"?Ou:Reflect.get(e,r,o)}})},Vu=/[A-Z]/g,ra=t=>t.replace(Vu,e=>`_${e.toLowerCase()}`),Du=["webrtc.message"],Ei=t=>Du.includes(t),Nu=({response:t,request:e})=>{const{result:r={},error:o}=t;if(o)return{error:o};switch(e.method){case"signalwire.connect":return{result:r};default:return oa(t)}},$u=/^2[0-9][0-9]$/,oa=(t,e)=>{const{result:r={},error:o}=t;if(o)return{error:o};const{code:n,node_id:s,result:l=null}=r;return n&&!$u.test(n)?{error:r}:l===null?(e&&(r.node_id=e),{result:r}):l?l.jsonrpc?oa(l,s):{result:l}:{result:r}},Wu=t=>{if(typeof t>"u")return t;const e=new Date(t*1e3);return isNaN(e.getTime())?t:e},Uu={propsToUpdateValue:["updated","layers","members","recordings","playbacks"]},ju=t=>t.endsWith("At"),rt=(t,e=Uu)=>t!=null&&t.__sw_symbol||t!=null&&t.__sw_proxy?t:Object.entries(t).reduce((r,[o,n])=>{const s=Yo(o);return typeof n==="object"&&n?Array.isArray(n)?e.propsToUpdateValue.includes(o)?r[s]=n.map(c=>typeof c=="string"?Yo(c):rt(c)):r[s]=n:r[s]=rt(n):ju(s)?r[s]=Wu(n):r[s]=n,r},{}),Yo=t=>t.includes("_")?t.split("_").reduce((e,r,o)=>{const n=r.trim().charAt(0),s=r.substr(1).toLowerCase();return`${e}${o===0?n.toLowerCase():n.toUpperCase()}${s}`},""):t,qu=({event:t,namespace:e})=>(typeof t=="string"&&(t=Fu({event:t,namespace:e}),t=ra(t)),t),Fu=({namespace:t,event:e})=>!t||e.startsWith(t)?e:`${t}${Zs}${e}`,Bu=t=>{const{event_type:e,params:r,node_id:o}=t;if(e==="queuing.relay.tasks")return{type:e,payload:t};if(Ei(e)&&(r!=null&&r.jsonrpc)){const n=r;return n.params&&(n.params.nodeId=o),{type:e,payload:n}}return{type:e,payload:r}},Xo=(t,e=o=>o,r={})=>(Array.isArray(t)?r=t.map((o,n)=>typeof o=="object"?Xo(o,e,r[n]):o):Object.keys(t).forEach(o=>{const n=ra(o);t[o]&&typeof t[o]=="object"?r[n]=Xo(t[o],e,r[n]):r[n]=e(t[o])}),r),po=(t,e)=>(Object.keys(e).forEach(r=>{if(t.prototype.hasOwnProperty(r))throw new Error(`[extendComponent] Duplicated method name: ${r}`)}),Object.defineProperties(t.prototype,e),t);function zu(t,e=0,r){let o=null,n=null;const s=function(){o&&(clearTimeout(o),n=null,o=null)},l=function(){const v=n;s(),v&&v()},c=function(){if(!e)return t.apply(this,arguments);const v=this,m=arguments;s(),n=function(){t.apply(v,m)},o=setTimeout(function(){o=null;{const p=n;return n=null,p==null?void 0:p()}},e)};return c.cancel=s,c.flush=l,c}var Hu=class{constructor(t,e={}){this.type=t,te(this,"code"),te(this,"reason"),te(this,"wasClean"),this.code=e.code===void 0?0:e.code,this.reason=e.reason===void 0?"":e.reason,this.wasClean=e.wasClean===void 0?!1:e.wasClean}},Ot=(t,e)=>{if(e&&typeof e=="string"){const o=new RegExp(`^${e}.`);return t.replace(o,"")}const r=t.split(".");return r.length>1?(r.shift(),r.join(".")):t},Gu=10,ia=100,Ku=1,na=({delayLimit:t=Number.MAX_SAFE_INTEGER,initialDelay:e=ia,variation:r=Ku})=>{if(e<0||t<0||r<0)throw new Error("No Negative Numbers");if(e>t)throw new Error("initialDelay must be lte delayLimit");let o=Math.min(e,t);return()=>{if(o===t)return t;const n=o;return o=Math.min(o+r,t),n}},Ju=({initialDelay:t=ia})=>{if(t<0)throw new Error("No Negative Numbers");return()=>t},Ii=async({asyncCallable:t,maxRetries:e=Gu,delayFn:r,validator:o,expectedErrorHandler:n})=>{let s=e-1,l=0;const c=async()=>{var v;try{let m;return l<=0?m=await t():m=await new Promise((p,h)=>setTimeout(()=>{t().then(p).catch(h)},l)),s&&(o==null||o(m)),m}catch(m){if(s-- >0&&!(n!=null&&n(m)))return l=(v=r==null?void 0:r())!=null?v:0,w().debug(`Retrying request: ${e-s} of ${e}`),c();throw m}};return c()},Yu=t=>{if(typeof t!="string")return t;try{return JSON.parse(t)}catch{return t}},Xu=/^(ws|wss):\/\//,Qu=t=>`${Xu.test(t)?"":"wss://"}${t}`,sa=(t,e,r)=>{let o=null;return Promise.race([t,new Promise((n,s)=>o=setTimeout(s,e,r))]).finally(()=>clearTimeout(o))},Zu=t=>t.includes(ea),ev=t=>t.includes("session."),tv=t=>{const e=t.split(Zs);return e[e.length-1]},rv=["video.member.updated","video.member.talking"],ov=["video.room.joined","video.track","video.active","video.answering","video.destroy","video.early","video.hangup","video.held","video.new","video.purge","video.recovering","video.requesting","video.ringing","video.trying","video.media.connected","video.media.reconnecting","video.media.disconnected","video.microphone.updated","video.camera.updated","video.speaker.updated","video.microphone.disconnected","video.camera.disconnected","video.speaker.disconnected"],Tr=t=>{const e=t.map(r=>{if(typeof r=="string"){const o=tv(r);return ov.includes(o)||Zu(o)||iv(o)||ev(o)?null:rv.find(s=>o.startsWith(s))||o}return r});return Array.from(new Set(e)).filter(Boolean)},iv=t=>t.includes(ki),nv=t=>{const r=t.split(".")[0];return t.split(".").reduce((o,n)=>(o.push(n),n===r&&o.push(ea),o),[]).join(".")},Mi=t=>!!t.method,sv=t=>!Mi(t),aa=t=>typeof t<"u"&&"jti"in t,la=t=>Mi(t)&&t.method=="signalwire.connect",av=t=>{var e;return Mi(t)&&t.method=="webrtc.verto"&&((e=t.params)==null?void 0:e.message.method)==="verto.invite"},fo=t=>{var e;return G({jsonrpc:"2.0",id:(e=t.id)!=null?e:xt()},t)},ho=t=>G({jsonrpc:"2.0"},t),da={major:3,minor:0,revision:0},lv={major:4,minor:0,revision:0},ca=t=>fo({method:"signalwire.connect",params:G({version:da,event_acks:!0},t)}),ua=t=>fo({method:"signalwire.reauthenticate",params:{authentication:t}}),dv=(t,e)=>ho({id:t,result:{timestamp:e||Date.now()/1e3}}),cv=({method:t,params:e})=>fo({method:t,params:e}),uv=t=>ho({id:t,result:{}}),Un={id:"callID",destinationNumber:"destination_number",remoteCallerName:"remote_caller_id_name",remoteCallerNumber:"remote_caller_id_number",callerName:"caller_id_name",callerNumber:"caller_id_number",fromFabricAddressId:"from_fabric_address_id"},vv=t=>{if(t.hasOwnProperty("dialogParams")){const e=t.dialogParams,{remoteSdp:r,localStream:o,remoteStream:n}=e,s=ct(e,["remoteSdp","localStream","remoteStream"]);for(const l in Un)l&&s.hasOwnProperty(l)&&(s[Un[l]]=s[l],delete s[l]);t.dialogParams=s}return t},Bt=t=>(e={})=>fo({method:t,params:vv(e)}),mv=Bt("verto.invite"),Qo=Bt("verto.bye"),Fo=Bt("verto.modify"),pv=Bt("verto.info"),fv=Bt("verto.answer"),hv=Bt("verto.subscribe"),gv=Bt("verto.pong"),jn=(t,e)=>ho({id:t,result:{method:e}}),_v=t=>ho({id:t,result:{}}),ze={};vt(ze,{authErrorAction:()=>tr,authExpiringAction:()=>_r,authSuccessAction:()=>gr,createAction:()=>He,destroyAction:()=>Ir,getCustomSagaActionType:()=>pa,initAction:()=>Er,makeCustomSagaAction:()=>Pi,reauthAction:()=>er,sessionDisconnectedAction:()=>yo,sessionForceCloseAction:()=>Qr,sessionReconnectingAction:()=>yr,socketMessageAction:()=>_o});var go={};vt(go,{configureStore:()=>va,createAction:()=>He});Qs(go,sc);function He(t,e){function r(...o){if(e){let n=e(...o);if(!n)throw new Error("prepareAction did not return an object");return G(G({type:t,payload:n.payload},"meta"in n&&{meta:n.meta}),"error"in n&&{error:n.error})}return{type:t,payload:o[0]}}return r.toString=()=>`${t}`,r.type=t,r.match=o=>o.type===t,r}var yv=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?fr:fr.apply(null,arguments)};function bv(t){if(typeof t!="object"||t===null)return!1;let e=Object.getPrototypeOf(t);if(e===null)return!0;let r=e;for(;Object.getPrototypeOf(r)!==null;)r=Object.getPrototypeOf(r);return e===r}function wv(){return function(){return[]}}function va(t){const e=wv(),{reducer:r=void 0,middleware:o=e(),devTools:n=!0,preloadedState:s=void 0,enhancers:l=void 0}=t||{};let c;if(typeof r=="function")c=r;else if(bv(r))c=cs(r);else throw new Error('"reducer" is a required argument, and must be a function or an object of functions that can be passed to combineReducers');let v=o;typeof v=="function"&&(v=v(e));const m=us(...v);let p=fr;n&&(p=yv(G({trace:!1},typeof n=="object"&&n)));let h=[m];Array.isArray(l)?h=[m,...l]:typeof l=="function"&&(h=l(h));const y=p(...h);return so(c,s,y)}var Er=He("swSdk/init"),Ir=He("swSdk/destroy"),er=He("swSdk/reauth"),tr=He("auth/error"),gr=He("auth/success"),_r=He("auth/expiring"),_o=He("socket/message"),yo=He("session.disconnected"),yr=He("session.reconnecting"),Qr=He("session.forceClose"),ma=(t,e)=>`${e.type}/${t}`,Pi=(t,e)=>ve(G({},e),{type:ma(t,e)}),pa=(t,e)=>ma(t,e);function fa(t){const e={},r=[];let o;const n={addCase(s,l){const c=typeof s=="string"?s:s.type;if(c in e)throw new Error("addCase cannot be called with two reducers for the same action type");return e[c]=l,n},addMatcher(s,l){return r.push({matcher:s,reducer:l}),n},addDefaultCase(s){return o=s,n}};return t(n),[e,r,o]}function Sv(t){return typeof t=="function"}function kv(t,e,r=[],o){let[n,s,l]=typeof e=="function"?fa(e):[e,r,o],c;Sv(t)?c=()=>t():c=()=>t;function v(m=c(),p){let h=[n[p.type],...s.filter(({matcher:y})=>y(p)).map(({reducer:y})=>y)];return h.filter(y=>!!y).length===0&&(h=[l]),h.reduce((y,b)=>b?b(y,p):y,m)}return v.getInitialState=c,v}function Cv(t,e){return`${t}/${e}`}function Tv(t){const{name:e}=t;if(!e)throw new Error("`name` is a required option for createSlice");const r=t.initialState,o=t.reducers||{},n=Object.keys(o),s={},l={},c={};n.forEach(p=>{const h=o[p],y=Cv(e,p);let b,S;"reducer"in h?(b=h.reducer,S=h.prepare):b=h,s[p]=b,l[y]=b,c[p]=S?He(y,S):He(y)});function v(){const[p={},h=[],y=void 0]=typeof t.extraReducers=="function"?fa(t.extraReducers):[t.extraReducers],b=G(G({},p),l);return kv(r,b,h,y)}let m;return{name:e,reducer(p,h){return m||(m=v()),m(p,h)},actions:c,caseReducers:s,getInitialState(){return m||(m=v()),m.getInitialState()}}}var ha=({name:t="",initialState:e,reducers:r,extraReducers:o})=>Tv({name:t,initialState:e,reducers:r,extraReducers:n=>{n.addCase(Ir.type,()=>e),typeof o=="function"&&o(n)}}),Ev={protocol:"",iceServers:[],authStatus:"unknown",authorization:void 0,authorizationState:void 0,authError:void 0,authCount:0};function Iv(t){return[Er.type,er.type].includes(t.type)}var Mv=ha({name:"session",initialState:Ev,reducers:{connected:(t,{payload:e})=>{var r,o;return ve(G({},t),{authStatus:"authorized",authorization:e==null?void 0:e.authorization,authCount:t.authCount+1,protocol:(r=e==null?void 0:e.protocol)!=null?r:"",iceServers:(o=e==null?void 0:e.ice_servers)!=null?o:[]})},authStatus:(t,{payload:e})=>ve(G({},t),{authStatus:e}),updateAuthorization:(t,{payload:e})=>ve(G({},t),{authorization:e}),updateAuthorizationState:(t,{payload:e})=>ve(G({},t),{authorizationState:e})},extraReducers:t=>{t.addCase(tr.type,(e,{payload:r})=>ve(G({},e),{authStatus:"unauthorized",authError:r.error})),t.addMatcher(Iv,e=>ve(G({},e),{authStatus:"authorizing"}))}}),{actions:Mr,reducer:Pv}=Mv,Av=Symbol("BaseSession"),xv=(t,e)=>Math.floor(Math.random()*(e-t+1)+t),Rv=()=>xv(1,4)*1e3,ga=class{constructor(t){this.options=t,te(this,"__sw_symbol",Av),te(this,"uuid",xt()),te(this,"WebSocketConstructor"),te(this,"CloseEventConstructor"),te(this,"agent"),te(this,"connectVersion",da),te(this,"_rpcConnectResult"),te(this,"_requests",new Map),te(this,"_socket",null),te(this,"_host",Cu),te(this,"_executeTimeoutMs",10*1e3),te(this,"_executeTimeoutError",Ti),te(this,"_executeQueue",new Set),te(this,"_swConnectError",Iu),te(this,"_executeConnectionClosed",Ci),te(this,"_checkPingDelay",15*1e3),te(this,"_checkPingTimer",null),te(this,"_reconnectTimer"),te(this,"_status","unknown"),te(this,"_resolveWaitConnected",null),te(this,"_sessionChannel"),te(this,"wsOpenHandler"),te(this,"wsCloseHandler"),te(this,"wsErrorHandler");var e,r;const{host:o,logLevel:n="info",sessionChannel:s}=t;o&&(this._host=Qu(o)),s&&(this._sessionChannel=s),n&&((r=(e=this.logger).setLevel)==null||r.call(e,n)),this._onSocketOpen=this._onSocketOpen.bind(this),this._onSocketError=this._onSocketError.bind(this),this._onSocketClose=this._onSocketClose.bind(this),this._onSocketMessage=this._onSocketMessage.bind(this),this.execute=this.execute.bind(this),this.connect=this.connect.bind(this),this.wsOpenHandler=l=>{var c;(c=this._socket)==null||c.removeEventListener("open",this.wsOpenHandler),this._onSocketOpen(l)},this.wsCloseHandler=l=>{var c;(c=this._socket)==null||c.removeEventListener("close",this.wsCloseHandler),this._onSocketClose(l)},this.wsErrorHandler=l=>{var c;(c=this._socket)==null||c.removeEventListener("error",this.wsErrorHandler),this._onSocketError(l)}}get host(){return this._host}get rpcConnectResult(){return this._rpcConnectResult}get relayProtocol(){var t,e;return(e=(t=this._rpcConnectResult)==null?void 0:t.protocol)!=null?e:""}get signature(){if(this._rpcConnectResult){const{authorization:t}=this._rpcConnectResult;return t.signature}}get logger(){return w()}get connecting(){var t;return((t=this._socket)==null?void 0:t.readyState)===0}get connected(){var t;return((t=this._socket)==null?void 0:t.readyState)===1}get closing(){var t;return((t=this._socket)==null?void 0:t.readyState)===2}get closed(){return this._socket?this._socket.readyState===3:!0}get status(){return this._status}get idle(){return this._status==="idle"}get ready(){return!(this.idle||!this.connected)}async _waitConnected(){return new Promise(t=>{this.connected?t():this._resolveWaitConnected=t})}set token(t){this.options.token=t}connect(){if(!(this!=null&&this.WebSocketConstructor))throw new Error("Missing WebSocketConstructor");if(!(this!=null&&this.CloseEventConstructor))throw new Error("Missing CloseEventConstructor");if(this._clearTimers(),this.connecting||this.connected){this.logger.warn("Session already connected.");return}this._removeSocketListeners(),this.destroySocket(),this._clearCheckPingTimer(),this._socket=this._createSocket(),this._addSocketListeners()}_createSocket(){return new this.WebSocketConstructor(this._host)}destroySocket(){this._socket&&(this._socket.close(),this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"})),this._socket=null)}_addSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to add listeners");this._removeSocketListeners(),this._socket.addEventListener("open",this.wsOpenHandler),this._socket.addEventListener("close",this.wsCloseHandler),this._socket.addEventListener("error",this.wsErrorHandler),this._socket.addEventListener("message",this._onSocketMessage)}_removeSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to remove listeners");this._socket.removeEventListener("open",this.wsOpenHandler),this._socket.removeEventListener("close",this.wsCloseHandler),this._socket.removeEventListener("error",this.wsErrorHandler),this._socket.removeEventListener("message",this._onSocketMessage)}disconnect(){if(!this._socket||this.closing){this.logger.debug("Session not connected or already in closing state.");return}this._status="disconnecting",this._checkCurrentStatus()}execute(t){if(this._status==="disconnecting")return this.logger.warn("Reject request because the session is disconnecting",t),Promise.reject({code:"400",message:"The SDK session is disconnecting"});if(this._status==="disconnected")return Promise.reject({code:"400",message:"The SDK is disconnected"});let e=Promise.resolve();return"params"in t&&(e=new Promise((r,o)=>{this._requests.set(t.id,{rpcRequest:t,resolve:r,reject:o})})),this.ready?(this._send(t),sa(e,this._executeTimeoutMs,this._executeTimeoutError).catch(r=>{if(r===this._executeConnectionClosed)throw this._executeConnectionClosed;if(r===this._executeTimeoutError){if(la(t))throw this._swConnectError;if(this._checkCurrentStatus(),this.logger.error("Request Timeout",t),this.status==="disconnected")return this.logger.debug("Request failed because the session is disconnected",this.status,this._socket);this._closeConnection("reconnecting")}else throw r})):(this._addToExecuteQueue(t),this.connect(),e)}get _connectParams(){return{agent:this.agent,version:this.connectVersion,authentication:{project:this.options.project,token:this.options.token}}}async authenticate(){var t,e;const r=this._connectParams;this._relayProtocolIsValid()&&(r.protocol=this.relayProtocol),(t=this.options.topics)!=null&&t.length?r.contexts=this.options.topics:(e=this.options.contexts)!=null&&e.length&&(r.contexts=this.options.contexts),this._rpcConnectResult=await this.execute(ca(r))}authError(t){this._removeSocketListeners(),this.dispatch(tr({error:t}))}forceClose(){return this._removeSocketListeners(),this._closeConnection("reconnecting")}async _onSocketOpen(t){var e;this.logger.debug("_onSocketOpen",t.type);try{this._status="unknown",this._clearTimers(),await this.authenticate(),this._status="connected",(e=this._resolveWaitConnected)==null||e.call(this),this._flushExecuteQueue(),this.dispatch(gr())}catch(r){if(r===this._swConnectError||r===this._executeConnectionClosed){this.logger.debug("Invalid connect or connection closed. Waiting for retry.");return}this.logger.error("Auth Error",r),this.authError(r)}}_onSocketError(t){this.logger.debug("_onSocketError",t)}_onSocketClose(t){this.logger.debug("_onSocketClose",t.type,t.code,t.reason),this._status!=="disconnected"&&(this._status="reconnecting",this.dispatch(yr()),this._clearTimers(),this._clearPendingRequests(),this._reconnectTimer=setTimeout(()=>{this.connect()},Rv())),this._socket=null}_clearTimers(){clearTimeout(this._reconnectTimer)}_clearPendingRequests(){this.logger.debug("_clearPendingRequests",this._requests.size),this._requests.forEach(({reject:t})=>{t(this._executeConnectionClosed)}),this._requests.clear()}_onSocketMessage(t){const e=this.decode(t.data);if(this.logger.wsTraffic({type:"recv",payload:e}),sv(e)){const r=this._requests.get(e.id);if(r){const{rpcRequest:o,resolve:n,reject:s}=r;this._requests.delete(e.id);const{result:l,error:c}=Nu({response:e,request:o});return this._checkCurrentStatus(),c?s(c):n(l)}return this.logger.warn("Unknown request for",e)}switch(e.method){case"signalwire.ping":return this._pingHandler(e);case"signalwire.disconnect":{this.execute(uv(e.id)).catch(r=>{this.logger.error("SwDisconnect Error",r)}).finally(()=>{this._status="idle"});break}default:this._eventAcknowledgingHandler(e).catch(r=>this.logger.error("Event Acknowledging Error",r)),this.dispatch(_o(e))}}dispatch(t){if(!this._sessionChannel)throw new Error("Session channel does not exist");this._sessionChannel.put(t)}_relayProtocolIsValid(){var t;return this.signature&&((t=this==null?void 0:this.relayProtocol)==null?void 0:t.split("_")[1])===this.signature}encode(t){return JSON.stringify(t)}decode(t){return Yu(t)}async onSwAuthorizationState(t){this.persistSwAuthorizationState(t)}async retrieveSwAuthorizationState(){return""}async persistSwAuthorizationState(t){}_send(t){this.logger.wsTraffic({type:"send",payload:t}),this._socket.send(this.encode(t))}_addToExecuteQueue(t){this.logger.warn("Request queued waiting for session to reconnect",t),this._executeQueue.add(t)}_flushExecuteQueue(){if(this._executeQueue.size){if(!this.ready){this.logger.warn("Session not ready to flush the queue."),this._closeConnection("reconnecting");return}this.logger.debug(`${this._executeQueue.size} messages to flush`),this._executeQueue.forEach(t=>{this._send(t),this._executeQueue.delete(t)}),this._executeQueue.clear()}}_clearCheckPingTimer(){clearTimeout(this._checkPingTimer)}async _pingHandler(t){var e;this._clearCheckPingTimer(),this._checkPingTimer=setTimeout(()=>{this.logger.debug("Timeout waiting for ping"),this._closeConnection("reconnecting")},this._checkPingDelay),await this.execute(dv(t.id,(e=t==null?void 0:t.params)==null?void 0:e.timestamp))}async _eventAcknowledgingHandler(t){const{method:e,id:r}=t;return e==="signalwire.event"?this.execute(_v(r)):Promise.resolve()}_checkCurrentStatus(){switch(this._status){case"disconnecting":if(this._requests.size>0)return;this._requests.clear(),this._closeConnection("disconnected");break;case"disconnected":this.dispatch(yo());break;case"reconnecting":this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"}));break}}_closeConnection(t){this._clearCheckPingTimer(),this.logger.debug("Close Connection:",t),this._status=t,this.dispatch(Mr.authStatus(t==="disconnected"?"unauthorized":"unknown")),this._removeSocketListeners(),this.destroySocket(),this._checkCurrentStatus()}},Lv=class extends ga{constructor(t){super(t),this.options=t,te(this,"_expiredDiffSeconds",0),te(this,"_refreshTokenNotificationDiff",120),te(this,"_checkTokenExpirationDelay",20*1e3),te(this,"_checkTokenExpirationTimer",null),this._checkTokenExpiration=this._checkTokenExpiration.bind(this),this.reauthenticate=this.reauthenticate.bind(this)}get expiresAt(){var t;if(!(this!=null&&this._rpcConnectResult))return 0;const{authorization:e}=this._rpcConnectResult,r=(t=aa(e)?e.fabric_subscriber.expires_at:e==null?void 0:e.expires_at)!=null?t:0;if(typeof r=="string"){const o=Date.parse(r);if(!isNaN(o))return Math.floor(o/1e3)}return r}get expiresIn(){const t=Math.floor(Date.now()/1e3);return this.expiresAt-t}get expired(){return this.expiresAt>0&&this.expiresIn<=this._expiredDiffSeconds}async authenticate(){const t=ve(G({},this._connectParams),{authentication:{jwt_token:this.options.token}});if(this._relayProtocolIsValid())t.protocol=this.relayProtocol;else{const e=await this.retrieveRelayProtocol();e&&(t.protocol=e)}if(t.protocol){const e=await this.retrieveSwAuthorizationState();e&&(t.authorization_state=e)}try{this._rpcConnectResult=await this.execute(ca(t)),await this.persistRelayProtocol(),await this._checkTokenExpiration()}catch(e){if(this.logger.debug("BaseJWTSession authenticate error",e),e.message==="Requester validation failed"){this.removeRelayProtocol(),this.removeSwAuthorizationState(),this.removePrevCallId(),await this.authenticate();return}throw e}}async retrieveRelayProtocol(){return""}async persistRelayProtocol(){}removeRelayProtocol(){}removeSwAuthorizationState(){}removePrevCallId(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const t={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{this._rpcConnectResult=await this.execute(ua(t))}catch(e){throw clearTimeout(this._checkTokenExpirationTimer),e}}_onSocketClose(t){clearTimeout(this._checkTokenExpirationTimer),super._onSocketClose(t)}async _checkTokenExpiration(){if(!this.expiresAt)return;const t=this.options.onRefreshToken;if(this.expiresIn<=this._refreshTokenNotificationDiff)if(this.dispatch(_r()),typeof t=="function")try{const e=await t();this.dispatch(er({token:e}))}catch(e){this.logger.error(e)}else this.logger.warn("The token is going to expire!");clearTimeout(this._checkTokenExpirationTimer),this.expired||(this._checkTokenExpirationTimer=setTimeout(this._checkTokenExpiration,this._checkTokenExpirationDelay))}},_a={};vt(_a,{authErrorAction:()=>tr,authExpiringAction:()=>_r,authSuccessAction:()=>gr,configureStore:()=>Pr,connect:()=>ot,createAction:()=>He,createCatchableSaga:()=>Ri,createRestartableSaga:()=>xi,destroyAction:()=>Ir,eventChannel:()=>Bs,getCustomSagaActionType:()=>pa,initAction:()=>Er,makeCustomSagaAction:()=>Pi,reauthAction:()=>er,sessionDisconnectedAction:()=>yo,sessionForceCloseAction:()=>Qr,sessionReconnectingAction:()=>yr,socketMessageAction:()=>_o});var Ov={byId:{}},Vv=ha({name:"components",initialState:Ov,reducers:{upsert:(t,{payload:e})=>e.id in t.byId?ve(G({},t),{byId:ve(G({},t.byId),{[e.id]:G(G({},t.byId[e.id]),e)})}):ve(G({},t),{byId:ve(G({},t.byId),{[e.id]:e})}),cleanup:(t,{payload:e})=>ve(G({},t),{byId:Object.entries(t.byId).reduce((r,[o,n])=>(e.ids.includes(o)||(r[o]=n),r),{})})}}),{actions:Ai,reducer:Dv}=Vv,Nv=(0,go.combineReducers)({components:Dv,session:Pv}),ya={};vt(ya,{createCatchableSaga:()=>Ri,createRestartableSaga:()=>xi,eventChannel:()=>Bs});var xi=t=>function*(){Nc(function*(){for(;;)try{w().debug("Run a restartable saga"),yield Ue(t),w().debug("One of the restartable saga has ended. Restarting..")}catch(e){w().error("Restartable Saga Error",e)}})},$v=t=>w().error("Catchable Saga Error",t),Ri=(t,e=$v)=>function*(...r){try{yield Ue(t,...r)}catch(o){e(o)}},Wv=t=>Ei(t==null?void 0:t.event_type),Uv=t=>{var e;return!!((e=t==null?void 0:t.event_type)!=null&&e.startsWith("video."))},jv=t=>(t==null?void 0:t.event_type)==="signalwire.authorization.state";function*qv({sessionChannel:t,swEventChannel:e,session:r}){w().debug("sessionChannelWatcher [started]");function*o(l){if(yield tt(e,Bu(l)),!(Wv(l)||Uv(l))){if(jv(l)){r.onSwAuthorizationState(l.params.authorization_state),yield tt(Mr.updateAuthorizationState(l.params.authorization_state));return}yield tt({type:l.event_type,payload:l})}}function*n(l){if(l.type!==_o.type){yield tt(l);return}const{method:c,params:v}=l.payload;switch(c){case"signalwire.event":yield se(o,v);break;default:return w().debug(`Unknown message: ${c}`,l)}}const s=Ri(n,l=>{w().error("Channel Error",l)});for(;;)try{for(;;){const l=yield Te(t);yield se(s,l)}}catch(l){w().error("sessionChannelWorker error:",l)}finally{w().debug("sessionChannelWorker [finally]")}}var Li=class ba extends Error{constructor(e,r){super(r),this.code=e,this.message=r,te(this,"name","AuthError"),Object.setPrototypeOf(this,ba.prototype)}},Zo=class wa extends Error{constructor(e,r,o){super(r),this.code=e,this.message=r,this.response=o,te(this,"name","HttpError"),Object.setPrototypeOf(this,wa.prototype)}},$e=class extends Error{constructor(t){super(t),this.name="CapabilityError"}};function*Fv({initSession:t,sessionEmitter:e,userOptions:r,channels:o}){var n;w().debug("sessionSaga [started]");const s=t(),l=o.swEventChannel,c=o.sessionChannel;let v=[];if((n=r.workers)!=null&&n.length)try{const h=r.workers.map(y=>Ue(xi(y)));v=yield Dc(h)}catch(h){w().error("Error running custom workers",h)}const m=yield se(qv,{session:s,sessionChannel:c,swEventChannel:l}),p=yield se(zv,{session:s,sessionEmitter:e,sessionChannel:c,userOptions:r});s.connect(),yield Te(Ir.type),s.disconnect(),yield Te(yo.type),e.emit("session.disconnected"),p.cancel(),m.cancel(),v.forEach(h=>h.cancel()),l.close(),c.close(),w().debug("sessionSaga [ended]")}function*Bv({session:t,token:e,sessionEmitter:r}){try{t.reauthenticate&&(t.token=e,yield Ue(t.reauthenticate),yield tt(Mr.connected(t.rpcConnectResult)),r.emit("session.connected"))}catch(o){w().error("Reauthenticate Error",o),t.authError(o)}}function*zv(t){w().debug("sessionStatusWatcher [started]");const{session:e,sessionEmitter:r}=t;try{for(;;){const o=yield Te([gr.type,tr.type,_r.type,er.type,yr.type,Qr.type]);switch(w().debug("sessionStatusWatcher",o.type,o.payload),o.type){case gr.type:{yield tt(Mr.connected(e.rpcConnectResult)),r.emit("session.connected");break}case tr.type:{yield se(Hv,ve(G({},t),{action:o}));break}case _r.type:{r.emit("session.expiring");break}case er.type:{yield se(Bv,{session:e,token:o.payload.token,sessionEmitter:r});break}case yr.type:{r.emit("session.reconnecting");break}case Qr.type:{e.forceClose();break}}}}finally{(yield fi())&&w().debug("sessionStatusWatcher [cancelled]")}}function*Hv(t){w().debug("sessionAuthErrorSaga [started]");try{const{action:e,sessionEmitter:r}=t,{error:o}=e.payload,n=o?new Li(o.code,o.message):new Error("Unauthorized");r.emit("session.auth_error",n)}finally{(yield fi())&&w().debug("sessionAuthErrorSaga [cancelled]")}}var Gv=t=>function*({userOptions:r,channels:o}){for(w().debug("rootSaga [started]"),r.logger&&xu(r.logger),r.debug&&Ru(r.debug);;){yield Te(Er.type);try{yield Ue(Fv,ve(G({},t),{userOptions:r,channels:o}));break}catch(n){w().error("RootSaga Error:",n)}finally{(yield fi())&&w().debug("rootSaga [cancelled]"),w().debug("Reboot rootSaga")}}w().debug("rootSaga [finished]")},Sa={};vt(Sa,{getAuthError:()=>Ca,getAuthStatus:()=>Zr,getAuthorization:()=>Oi,getAuthorizationState:()=>Jv,getIceServers:()=>Kv,getProtocol:()=>Yv,getSession:()=>ka});var Kv=({session:t})=>{var e;return(e=t==null?void 0:t.iceServers)!=null?e:[]},ka=t=>t.session,Zr=({session:t})=>t.authStatus,Ca=({session:t})=>t.authError,Oi=({session:t})=>t.authorization,Jv=({session:t})=>t.authorizationState,Yv=({session:t})=>t.protocol,ot=t=>{const{sessionListeners:e={},store:r,Component:o,customSagas:n=[]}=t,s=Object.keys(e);return l=>{const c=new o(ve(G({},l),{store:r})),v=new Map;let m=!0;const p=r.subscribe(()=>{const y=r.getState(),b=ka(y);for(const S of s){if(m===!1)return;const k=`session.${S}`,C=v.get(k),E=b[S];if(E!==void 0&&C!==E){v.set(k,E);const $=e[S];typeof $=="string"?c[$](b):typeof $=="function"&&$(b)}}}),h=n==null?void 0:n.map(y=>r.runSaga(y,{instance:c,runSaga:r.runSaga}));return c.destroyer=()=>{m=!1,p(),v.clear(),h!=null&&h.length&&h.forEach(y=>y.cancel())},c}},Ta=()=>new kr,Xv=t=>{const{SessionConstructor:e,userOptions:r,sessionChannel:o}=t,n=Ta();let s=null;return{session:s,initSession:()=>(s=new e(ve(G({},r),{sessionChannel:o})),s),getSession:()=>(s||w().warn("Session does not exist!"),s),sessionEmitter:n}},Qv=()=>{const t=new Map;return{get:l=>t.get(l),set:(l,c)=>(t.set(l,c),t),remove:l=>(t.delete(l),t),getAll:()=>Array.from(t.entries()),deleteAll:()=>(t.clear(),t)}};Qs(_a,go);var Pr=t=>{var e;const{userOptions:r,SessionConstructor:o,preloadedState:n={},runRootSaga:s=!0}=t,l=gu({sagaMonitor:r.sagaMonitor}),c=_i(),v=vo(),m={swEventChannel:c,sessionChannel:v},p=va({devTools:(e=r==null?void 0:r.devTools)!=null?e:!0,reducer:Nv,preloadedState:n,middleware:C=>C().concat(l)}),h=Qv(),{initSession:y,getSession:b,sessionEmitter:S}=Xv({userOptions:r,sessionChannel:v,SessionConstructor:o}),k=(C,E)=>l.run(C,ve(G({},E),{channels:m,getSession:b,instanceMap:h}));if(s){const C=Gv({initSession:y,sessionEmitter:S});l.run(C,{userOptions:r,channels:m})}return ve(G({},p),{runSaga:k,channels:m,instanceMap:h,sessionEmitter:S})},Zv=function*(t){const{initialState:e,onDone:r,onFail:o,getSession:n}=t,{requestId:s,method:l,params:c}=e,v=n();if(!v){const m=new Error("Session does not exist!");w().error(m),o==null||o(m);return}try{let m=cv({id:s,method:l,params:c});const p=yield Ue(v.execute,m);r==null||r(p)}catch(m){w().warn("Execute error: ",m),o==null||o(m)}},Jt=t=>t,em=Symbol("BaseComponent"),zt=class{constructor(t){this.options=t,te(this,"__sw_symbol",em),te(this,"uuid",xt()),te(this,"_customSagaTriggers",new Map),te(this,"_destroyer"),te(this,"eventEmitter"),te(this,"_runningWorkers",[]),te(this,"_workers",new Map),this.eventEmitter=new kr}get __uuid(){return this.uuid}get logger(){return w()}set destroyer(t){this._destroyer=t}get store(){return this.options.store}get instanceMap(){return this.store.instanceMap}get emitter(){return this.eventEmitter}get sessionEmitter(){return this.store.sessionEmitter}get session(){return this.sessionEmitter}on(t,e){return this.emitter.on(t,e)}once(t,e){return this.emitter.once(t,e)}off(t,e){return this.emitter.off(t,e)}removeAllListeners(t){return t?this.off(t):(this.eventNames().forEach(e=>{this.off(e)}),this.emitter)}eventNames(){return this.emitter.eventNames()}sessionEventNames(){return this.sessionEmitter.eventNames()}getSubscriptions(){return Tr(this.eventNames())}emit(t,...e){return this.emitter.emit(t,...e)}listenerCount(t){return this.emitter.listenerCount(t)}destroy(){var t;(t=this._destroyer)==null||t.call(this),this.removeAllListeners(),this.detachWorkers()}execute({method:t,params:e},{transformParams:r=Jt,transformResolve:o=Jt,transformReject:n=Jt}={transformParams:Jt,transformResolve:Jt,transformReject:Jt}){return new Promise((s,l)=>{const c=xt();this.runWorker("executeActionWorker",{worker:Zv,onDone:v=>s(o(v)),onFail:v=>l(n(v)),initialState:{requestId:c,componentId:this.__uuid,method:t,params:r(e)}})})}triggerCustomSaga(t){return new Promise((e,r)=>{const o=xt();this._customSagaTriggers.set(o,{resolve:e,reject:r}),this.store.dispatch(G({dispatchId:o},Pi(this.__uuid,t)))})}settleCustomSagaTrigger({dispatchId:t,payload:e,kind:r}){const o=this._customSagaTriggers.get(t);o&&(o[r](e),this._customSagaTriggers.delete(t))}select(t){return t(this.store.getState())}getStateProperty(t){return this[t]}get _sessionAuthStatus(){return this.select(Zr)}get _sessionAuthorization(){return this.select(Oi)}_waitUntilSessionAuthorized(){switch(this._sessionAuthStatus){case"authorized":return Promise.resolve(this);case"unknown":case"authorizing":return new Promise((e,r)=>{const o=this.store.subscribe(()=>{const n=this.select(Zr),s=this.select(Ca);if(n==="authorized")e(this),o();else if(n==="unauthorized"){const l=s?new Li(s.code,s.message):new Error("Unauthorized");r(l),o()}})});case"unauthorized":return Promise.reject(new Error("Unauthorized"))}}runWorker(t,e){return this._workers.has(t)?w().warn(`[runWorker] Worker with name ${t} has already been registerd.`):this._setWorker(t,e),this._attachWorker(t,e)}cancelWorker(t){const e=this._runningWorkers.findIndex(r=>r===t);e>-1&&(this._runningWorkers.splice(e,1),t.cancel())}_setWorker(t,e){this._workers.set(t,e)}_attachWorker(t,e){var r=e,{worker:o}=r,n=ct(r,["worker"]);const s=this.store.runSaga(o,G({instance:this,runSaga:this.store.runSaga},n));return this._runningWorkers.push(s),this._workers.delete(t),s}detachWorkers(){this._runningWorkers.forEach(t=>{t.cancel()}),this._runningWorkers=[]}},Ea=class extends zt{constructor(t){super(t),this.options=t}connect(){const t=Zr(this.store.getState());return(t==="unknown"||t==="unauthorized")&&this.store.dispatch(Er()),this._waitUntilSessionAuthorized()}disconnect(){this.store.dispatch(Ir())}removeAllListeners(t){return this.sessionEventNames().forEach(e=>{this.sessionEmitter.off(e)}),super.removeAllListeners(t)}},Ia=class extends zt{constructor(t){super(t),this.options=t,te(this,"subscribeMethod","signalwire.subscribe"),te(this,"subscribeParams",{}),te(this,"_latestExecuteParams");const e=()=>{this._latestExecuteParams=void 0};super.session.on("session.connected",e),super.session.on("session.disconnected",e),super.session.on("session.reconnecting",e)}shouldExecuteSubscribe(t){return!this._latestExecuteParams||JSON.stringify(t)!==JSON.stringify(this._latestExecuteParams)}async subscribe(){await this._waitUntilSessionAuthorized();const t=this.getSubscriptions();if(t.length===0){this.logger.debug("`subscribe()` was called without any listeners attached.");return}const e={method:this.subscribeMethod,params:ve(G({},this.subscribeParams),{event_channel:this.getStateProperty("eventChannel"),events:t})};if(!this.shouldExecuteSubscribe(e)){this.logger.debug("BaseConsumer.subscribe() - Skipped .execute() since the execParams are exactly the same as last time");return}return this._latestExecuteParams=e,new Promise(async(r,o)=>{try{return await this.execute(e),r(void 0)}catch(n){return o(n)}})}},Vi={audio_muted:!0,video_muted:!0,deaf:!0,visible:!0,input_volume:1,output_volume:1,input_sensitivity:1};Object.keys(Vi).map(t=>`${Tu}.member.updated.${t}`);var tm=rt(Vi);Object.keys(tm).map(t=>`member.updated.${t}`);var Di={};vt(Di,{getComponent:()=>rm,getComponentsById:()=>Ma,getComponentsToCleanup:()=>om});var rm=({components:t},e)=>{var r;return(r=t.byId)==null?void 0:r[e]},Ma=({components:t})=>t.byId,om=t=>{const e=Ma(t);let r=[];return Object.keys(e).forEach(o=>{(e[o].responses||e[o].errors)&&r.push(o)}),r},Pa={audio_muted:!0,video_muted:!0,deaf:!0,visible:!0,input_volume:1,output_volume:1,input_sensitivity:1,handraised:!0,echo_cancellation:!0,auto_gain:!0,noise_suppression:!0};Object.keys(Pa).map(t=>`member.updated.${t}`);var im=rt(Pa);Object.keys(im).map(t=>`member.updated.${t}`);var z={};vt(z,{RoomSessionPlaybackAPI:()=>Ra,RoomSessionRecordingAPI:()=>xa,RoomSessionStreamAPI:()=>La,audioMuteMember:()=>Tm,audioUnmuteMember:()=>Em,createRoomSessionPlaybackObject:()=>$i,createRoomSessionRecordingObject:()=>Ni,createRoomSessionStreamObject:()=>Wi,deafMember:()=>Pm,deleteMemberMeta:()=>Fm,deleteMeta:()=>wm,demote:()=>Dm,getLayouts:()=>nm,getMemberMeta:()=>Um,getMembers:()=>sm,getMeta:()=>_m,getPlaybacks:()=>hm,getRecordings:()=>pm,getStreams:()=>Sm,hideVideoMuted:()=>dm,lock:()=>um,play:()=>gm,promote:()=>Vm,removeAllMembers:()=>Wm,removeMember:()=>$m,setDeaf:()=>xm,setHideVideoMuted:()=>mm,setInputSensitivityMember:()=>Om,setInputVolumeMember:()=>Rm,setLayout:()=>am,setMemberMeta:()=>jm,setMemberPosition:()=>Nm,setMeta:()=>ym,setOutputVolumeMember:()=>Lm,setPositions:()=>lm,setPrioritizeHandraise:()=>Cm,setRaisedHand:()=>Bm,showVideoMuted:()=>cm,startRecording:()=>fm,startStream:()=>km,undeafMember:()=>Am,unlock:()=>vm,updateMemberMeta:()=>qm,updateMeta:()=>bm,videoMuteMember:()=>Im,videoUnmuteMember:()=>Mm});var he=()=>{},gt=(t,e={})=>({value:function(r={}){return this.execute({method:t,params:G({room_session_id:this.roomSessionId},r)},e)}}),Xe=(t,e={})=>({value:function(r={}){var o=r,{memberId:n}=o,s=ct(o,["memberId"]);return this.execute({method:t,params:G({room_session_id:this.roomSessionId,member_id:n||this.memberId},s)},e)}}),nm=gt("video.list_available_layouts",{transformResolve:t=>({layouts:t.layouts})}),sm=gt("video.members.get",{transformResolve:t=>({members:t.members})}),am=gt("video.set_layout",{transformResolve:he}),lm=gt("video.set_position",{transformResolve:he}),dm=gt("video.hide_video_muted",{transformResolve:he}),cm=gt("video.show_video_muted",{transformResolve:he}),um=gt("video.lock",{transformResolve:he}),vm=gt("video.unlock",{transformResolve:he}),mm={value:function(t){return this.execute({method:t?"video.hide_video_muted":"video.show_video_muted",params:{room_session_id:this.roomSessionId}},{transformResolve:he})}},pm={value:function(){return new Promise(async(t,e)=>{try{const{recordings:r}=await this.execute({method:"video.recording.list",params:{room_session_id:this.roomSessionId}}),o=[];r.forEach(n=>{let s=this.instanceMap.get(n.id);s?s.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,recording:n}):s=Ni({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:n}}),o.push(s),this.instanceMap.set(s.id,s)}),t({recordings:o})}catch(r){e(r)}})}},fm={value:function(){return new Promise(async(t,e)=>{try{const{recording:r}=await this.execute({method:"video.recording.start",params:{room_session_id:this.roomSessionId}}),o=Ni({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:r}});this.instanceMap.set(o.id,o),t(o)}catch(r){e(r)}})}},hm={value:function(){return new Promise(async(t,e)=>{try{const{playbacks:r}=await this.execute({method:"video.playback.list",params:{room_session_id:this.roomSessionId}}),o=[];r.forEach(n=>{let s=this.instanceMap.get(n.id);s?s.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,playback:n}):s=$i({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:n}}),o.push(s),this.instanceMap.set(s.id,s)}),t({playbacks:o})}catch(r){e(r)}})}},gm={value:function(t){var e=t,{seekPosition:r,currentTimecode:o}=e,n=ct(e,["seekPosition","currentTimecode"]);return new Promise(async(s,l)=>{try{const c=r||o,{playback:v}=await this.execute({method:"video.playback.start",params:G({room_session_id:this.roomSessionId,seek_position:c},n)}),m=$i({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:v}});this.instanceMap.set(m.id,m),s(m)}catch(c){l(c)}})}},Aa=t=>gt(t,{transformResolve:he,transformParams:e=>{const r=e,{room_session_id:o}=r,n=ct(r,["room_session_id"]);return{room_session_id:o,meta:n}}}),_m=gt("video.get_meta",{transformResolve:({meta:t})=>({meta:t})}),ym=Aa("video.set_meta"),bm=Aa("video.update_meta"),wm={value:function(t){return this.execute({method:"video.delete_meta",params:{room_session_id:this.roomSessionId,keys:t}})}},Sm={value:function(){return new Promise(async(t,e)=>{try{const{streams:r}=await this.execute({method:"video.stream.list",params:{room_session_id:this.roomSessionId}}),o=[];r.forEach(n=>{let s=this.instanceMap.get(n.id);s?s.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,stream:n}):s=Wi({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:n}}),o.push(s),this.instanceMap.set(s.id,s)}),t({streams:o})}catch(r){e(r)}})}},km={value:function(t){return new Promise(async(e,r)=>{try{const{stream:o}=await this.execute({method:"video.stream.start",params:G({room_session_id:this.roomSessionId},t)}),n=Wi({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:o}});this.instanceMap.set(n.id,n),e({stream:n})}catch(o){r(o)}})}},Cm={value:function(t){return this.execute({method:"video.prioritize_handraise",params:{room_session_id:this.roomSessionId,enable:t}})}},Tm=Xe("video.member.audio_mute",{transformResolve:he}),Em=Xe("video.member.audio_unmute",{transformResolve:he}),Im=Xe("video.member.video_mute",{transformResolve:he}),Mm=Xe("video.member.video_unmute",{transformResolve:he}),Pm=Xe("video.member.deaf",{transformResolve:he}),Am=Xe("video.member.undeaf",{transformResolve:he}),xm={value:function(t){return this.execute({method:t?"video.member.deaf":"video.member.undeaf",params:{room_session_id:this.roomSessionId,member_id:this.memberId}},{transformResolve:he})}},Rm=Xe("video.member.set_input_volume",{transformResolve:he}),Lm=Xe("video.member.set_output_volume",{transformResolve:he}),Om=Xe("video.member.set_input_sensitivity",{transformResolve:he}),Vm={value:function(t){var e=t,{memberId:r,mediaAllowed:o,joinAudioMuted:n,joinVideoMuted:s}=e,l=ct(e,["memberId","mediaAllowed","joinAudioMuted","joinVideoMuted"]);return this.execute({method:"video.member.promote",params:G({room_session_id:this.roomSessionId,member_id:r,media_allowed:o,join_audio_muted:n,join_video_muted:s},l)},{transformResolve:he})}},Dm={value:function({memberId:t,mediaAllowed:e}){return this.execute({method:"video.member.demote",params:{room_session_id:this.roomSessionId,member_id:t,media_allowed:e}},{transformResolve:he})}},Nm=Xe("video.member.set_position",{transformResolve:he}),$m={value:function(t){var e=t,{memberId:r}=e,o=ct(e,["memberId"]);if(!r)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:"video.member.remove",params:G({room_session_id:this.roomSessionId,member_id:r},o)},{transformResolve:he})}},Wm={value:function(){return this.execute({method:"video.member.remove",params:{room_session_id:this.roomSessionId,member_id:"all"}},{transformResolve:he})}},Um=Xe("video.member.get_meta",{transformResolve:({meta:t})=>({meta:t})}),jm=Xe("video.member.set_meta",{transformResolve:he}),qm=Xe("video.member.update_meta",{transformResolve:he}),Fm=Xe("video.member.delete_meta",{transformResolve:he}),Bm={value:function(t){const{raised:e=!0,memberId:r=this.memberId}=t||{};if(!r)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:e?"video.member.raisehand":"video.member.lowerhand",params:{room_session_id:this.roomSessionId,member_id:r}},{transformResolve:he})}},xa=class extends zt{constructor(t){super(t),te(this,"_payload"),this._payload=t.payload}get id(){return this._payload.recording.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.recording.state}get duration(){return this._payload.recording.duration}get startedAt(){if(this._payload.recording.started_at)return new Date(this._payload.recording.started_at*1e3)}get endedAt(){if(this._payload.recording.ended_at)return new Date(this._payload.recording.ended_at*1e3)}setPayload(t){this._payload=t}async pause(){await this.execute({method:"video.recording.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.recording.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.recording.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}},Ni=t=>ot({store:t.store,Component:xa})(t),Ra=class extends zt{constructor(t){super(t),te(this,"_payload"),this._payload=t.payload}get id(){return this._payload.playback.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get url(){return this._payload.playback.url}get state(){return this._payload.playback.state}get volume(){return this._payload.playback.volume}get startedAt(){if(this._payload.playback.started_at)return new Date(this._payload.playback.started_at*1e3)}get endedAt(){if(this._payload.playback.ended_at)return new Date(this._payload.playback.ended_at*1e3)}get position(){return this._payload.playback.position}get seekable(){return this._payload.playback.seekable}setPayload(t){this._payload=t}async pause(){await this.execute({method:"video.playback.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.playback.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.playback.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async setVolume(t){await this.execute({method:"video.playback.set_volume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),volume:t}})}async seek(t){await this.execute({method:"video.playback.seek_absolute",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(t)}})}async forward(t=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(t)}})}async rewind(t=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:-Math.abs(t)}})}},$i=t=>ot({store:t.store,Component:Ra})(t),La=class extends zt{constructor(t){super(t),te(this,"_payload"),this._payload=t.payload}get id(){return this._payload.stream.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.stream.state}get duration(){return this._payload.stream.duration}get url(){return this._payload.stream.url}get startedAt(){if(this._payload.stream.started_at)return new Date(this._payload.stream.started_at*1e3)}get endedAt(){if(this._payload.stream.ended_at)return new Date(this._payload.stream.ended_at*1e3)}setPayload(t){this._payload=t}async stop(){await this.execute({method:"video.stream.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),stream_id:this.getStateProperty("id")}})}},Wi=t=>ot({store:t.store,Component:La})(t),Oa={};vt(Oa,{BaseChatAPI:()=>Ha,BaseChatConsumer:()=>za,ChatMember:()=>zi,ChatMessage:()=>Bi,applyCommonMethods:()=>Xm,createBaseChatObject:()=>Jm,getMemberState:()=>Ba,getMembers:()=>ja,getMessages:()=>Ua,publish:()=>Wa,setMemberState:()=>Fa});var Va=t=>{const e=!t||Array.isArray(t)?t:[t];return Array.isArray(e)?e.map(r=>({name:r})):[]},Da=t=>Array.isArray(t)||typeof t=="string",Na=()=>{},Ui=(t,e={})=>({value:function(r={}){return this.execute({method:t,params:r},e)}}),$a=(t,e={})=>({value:function(r={}){var o=r,{memberId:n}=o,s=ct(o,["memberId"]);return this.execute({method:t,params:G({member_id:n},s)},e)}}),Wa=Ui("chat.publish",{transformResolve:Na}),Ua=Ui("chat.messages.get",{transformResolve:t=>({messages:t.messages.map(e=>rt(e)),cursor:t.cursor})}),ja=Ui("chat.members.get",{transformResolve:t=>({members:t.members.map(e=>rt(e))})}),qa=t=>{const e=Da(t==null?void 0:t.channels)?Va(t.channels):void 0;return ve(G({},t),{channels:e})},Fa=$a("chat.member.set_state",{transformResolve:Na,transformParams:qa}),Ba=$a("chat.member.get_state",{transformResolve:t=>({channels:t.channels}),transformParams:qa}),ji={};vt(ji,{BasePubSubConsumer:()=>qi,PubSubMessage:()=>Fi,createBasePubSubObject:()=>Gm});var zm=function*(t){w().trace("pubSubWorker started");const{instance:e,channels:{swEventChannel:r}}=t;function*o(s){const{type:l,payload:c}=s;switch(l){case`${Yt}.channel.message`:{const{channel:v,message:m}=c,p=m,{member:h}=p,y=ct(p,["member"]),b=rt(ve(G({},y),{channel:v})),S=new Fi(b);e.emit("message",S);break}default:w().warn(`Unknown pubsub event: "${l}"`);break}}const n=s=>s.type.startsWith(`${Yt}.`);for(;;){const s=yield Te(r,n);yield se(o,s)}w().trace("pubSubWorker ended")},Hm=t=>t.map(e=>({name:e})),qi=class extends Ia{constructor(t){super(t),te(this,"subscribeMethod",`${Yt}.subscribe`),this.initWorker()}initWorker(){this.runWorker("pubSub",{worker:zm})}_getChannelsParam(t,e){const r=!t||Array.isArray(t)?t:[t];if(!Array.isArray(r)||r.length===0)throw new Error(`Please specify one or more channels when calling .${e}()`);return{channels:Hm(r)}}_setSubscribeParams(t){this.subscribeParams=G(G({},this.subscribeParams),t)}_getSubscribeParams({channels:t}){return G({},this._getChannelsParam(t,"subscribe"))}_getUnsubscribeParams({channels:t}){const e=this._getChannelsParam(t,"unsubscribe");return G({},e)}_checkMissingSubscriptions(){this.getSubscriptions().length===0&&(this.logger.info("Subscribe was called before any listeners were attached. Move `.subscribe()` right after your event listeners to suppress this message."),this.once("message",()=>{}))}getSubscriptions(){const t=this.eventNames().map(e=>`${Yt}.${String(e)}`);return Tr(t)}async subscribe(t){this._checkMissingSubscriptions();const e=this._getSubscribeParams({channels:t});return this._setSubscribeParams(e),super.subscribe()}async unsubscribe(t){if(this._sessionAuthStatus==="unknown"||this._sessionAuthStatus==="unauthorized")throw new Error("You must be authenticated to unsubscribe from a channel");const e=this._getUnsubscribeParams({channels:t});return new Promise(async(r,o)=>{const n=this.getSubscriptions();if(n.length>0){const s={method:`${Yt}.unsubscribe`,params:ve(G({},e),{events:n})};try{await this.execute(s)}catch(l){return o(l)}}else this.logger.warn("`unsubscribe()` was called without any listeners attached.");return r()})}updateToken(t){return new Promise((e,r)=>{this.session.once("session.auth_error",o=>{r(o)}),this.session.once("session.connected",()=>{e()}),this.store.dispatch(ze.reauthAction({token:t}))})}publish(t){return this.execute({method:`${Yt}.publish`,params:t})}async getAllowedChannels(){await this._waitUntilSessionAuthorized();const t=this.select(Oi);return t&&"channels"in t&&t.channels?t.channels:{}}},Gm=t=>ot({store:t.store,Component:qi})(t),Fi=class{constructor(e){this.payload=e}get id(){return this.payload.id}get channel(){return this.payload.channel}get content(){return this.payload.content}get meta(){return this.payload.meta}get publishedAt(){return this.payload.publishedAt}},Km=function*(t){w().trace("chatWorker started");const{instance:e,channels:{swEventChannel:r}}=t;function*o(s){const{type:l,payload:c}=s;switch(l){case"chat.channel.message":{const{channel:v,message:m}=c,p=rt(ve(G({},m),{channel:v})),h=new Bi(p);e.emit("message",h);break}case"chat.member.joined":case"chat.member.updated":case"chat.member.left":{const{member:v}=c,m=rt(v),p=new zi(m),h=Ot(l);e.emit(h,p);break}default:w().warn(`Unknown chat event: "${l}"`);break}}const n=s=>s.type.startsWith("chat.");for(;;){const s=yield Te(r,n);yield se(o,s)}w().trace("chatWorker ended")},za=class extends qi{constructor(t){super(t),te(this,"subscribeMethod",`${Eu}.subscribe`)}initWorker(){this.runWorker("chat",{worker:Km})}},Ha=po(za,{publish:Wa,getMembers:ja,getMessages:Ua,setMemberState:Fa,getMemberState:Ba}),Jm=t=>ot({store:t.store,Component:Ha})(t),Bi=class extends Fi{get member(){return this.payload.member}},zi=class{constructor(t){this.payload=t}get id(){return this.payload.id}get channel(){return this.payload.channel}get state(){var t;return(t=this.payload.state)!=null?t:{}}},qn=t=>{const e=Da(t==null?void 0:t.channels)?Va(t.channels):void 0;return ve(G({},t),{channels:e})},Ym=()=>{};function Xm(t){return class extends t{getMembers(e){return this._client.execute({method:"chat.members.get",params:e},{transformResolve:r=>({members:r.members.map(o=>rt(o))})})}getMessages(e){return this._client.execute({method:"chat.messages.get",params:e},{transformResolve:r=>({messages:r.messages.map(o=>rt(o)),cursor:r.cursor})})}setMemberState(e={}){var r=e,{memberId:o}=r,n=ct(r,["memberId"]);return this._client.execute({method:"chat.member.set_state",params:G({member_id:o},n)},{transformResolve:Ym,transformParams:qn})}getMemberState(e={}){var r=e,{memberId:o}=r,n=ct(r,["memberId"]);return this._client.execute({method:"chat.member.get_state",params:G({member_id:o},n)},{transformResolve:s=>({channels:s.channels}),transformParams:qn})}}}var Hi={};vt(Hi,{memberPositionWorker:()=>Zm,memberUpdatedWorker:()=>Ga});var Gi=function*(t,e,r){const o=Ot(t);r.emit(o,e)};function*Qm(t){const{action:e,memberList:r,instance:o,dispatcher:n=Gi}=t,s=e.payload.layout.layers,l={};s.forEach(c=>{var v;const m=c.member_id;if(!m)return;const p=r.get(m);p&&c.position!==((v=p.member)==null?void 0:v.current_position)?(ei({memberList:r,memberId:m,currentPosition:c.position}),l[m]=!0):l[m]=!1});for(const[c,v]of r)if(l[c])yield n==null?void 0:n("video.member.updated",v,o);else if(l[c]===void 0){const m=ei({memberList:r,memberId:c,currentPosition:"off-canvas"});if(!m)return;yield n==null?void 0:n("video.member.updated",m,o)}}function*Ga({action:t,memberList:e,instance:r,dispatcher:o=Gi}){var n,s;const l=t.payload.member.id,c=ei({memberList:e,memberId:l,currentPosition:(s=(n=e.get(l))==null?void 0:n.member)==null?void 0:s.current_position});if(!c)return;const{member:{updated:v=[]}}=t.payload,m=ve(G({},c),{member:G(G({},c.member),t.payload.member)});e.set(l,m);for(const p of v){const h=`${t.type}.${p}`;yield o==null?void 0:o(h,m,r)}yield o==null?void 0:o(t.type,m,r)}var Zm=function*({instance:e,channels:r,initialState:o,getSession:n,instanceMap:s,dispatcher:l=Gi}){if(!o)return;const{swEventChannel:c}=r;let v=ep(o);const m=p=>{v.has(p.member.id)||v.set(p.member.id,p)};for(;;){const p=yield Te(c,h=>h.type==="video.member.joined"||h.type==="video.member.updated"||h.type==="video.member.left"||h.type==="video.layout.changed");switch(p.type){case"video.member.joined":{m(p.payload);break}case"video.member.updated":{m(p.payload),yield se(Ga,{action:p,channels:r,memberList:v,instance:e,getSession:n,instanceMap:s,dispatcher:l});break}case"video.member.left":{const h=p.payload.member;v.delete(h.id);break}case"video.layout.changed":{yield se(Qm,{action:p,channels:r,memberList:v,instance:e,dispatcher:l});break}}}},ei=({memberList:t,memberId:e,currentPosition:r})=>{const o=t.get(e);if(o){if(!r)return o}else return;const n=ve(G({},o),{member:ve(G({},o==null?void 0:o.member),{current_position:r})});return t.set(e,n),n},ep=t=>{const e=t.room_session.members,r=new Map;return e.forEach(o=>{const n=o.id,s=t.room_session.id||t.room_session.room_session_id;r.set(n,{room_id:t.room_session.room_id,room_session_id:s,member:o})}),r},tp={};vt(tp,{configureFullStack:()=>ip,configureJestStore:()=>op,createMockedLogger:()=>rp,createSessionChannel:()=>lp,createSwEventChannel:()=>ap,rpcConnectResultVRT:()=>sp,wait:()=>np});var Ka="8f0a119a-cda7-4497-a47d-c81493b824d4",Ja="<VRT>",rp=()=>({fatal:jest.fn(),error:jest.fn(),warn:jest.fn(),info:jest.fn(),debug:jest.fn(),trace:jest.fn(),wsTraffic:jest.fn()}),op=t=>Pr(G({userOptions:{project:Ka,token:Ja,devTools:!1},SessionConstructor:ga,runRootSaga:!1},t)),ip=()=>{const t={dispatch:console.log,connect:jest.fn(),disconnect:jest.fn(),execute:jest.fn()},e=new kr,r=Pr({userOptions:{project:Ka,token:Ja,devTools:!1},SessionConstructor:jest.fn().mockImplementation(()=>t)});return r.dispatch(ze.initAction()),r.dispatch(ze.authSuccessAction()),{store:r,session:t,emitter:e,destroy:()=>r.dispatch(ze.destroyAction())}},np=t=>new Promise(e=>{setTimeout(e,t)}),sp={identity:"f3bc99df-2c3d-4fa4-b1dc-e8a8ffc579e6@e3fefa44-1bad-4be9-ad9b-1cbb9abd60c7.west-us",authorization:{type:"video",project_id:"8f0a119a-cda7-4497-a47d-c81493b824d4",project:"8f0a119a-cda7-4497-a47d-c81493b824d4",scopes:["video"],scope_id:"26675883-8499-4ee9-85eb-691c4aa209f8",resource:"9c80f1e8-9430-4070-a043-937eb3a96b38",join_as:"member",user_name:"Joe",room:{name:"lobby",display_name:"Lobby",scopes:["room.self.audio_mute","room.self.audio_unmute"],meta:{}},signature:"SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q",media_allowed:"all",audio_allowed:"both",video_allowed:"both",meta:{}},protocol:"signalwire_SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q_03e8c927-8ea3-4661-86d5-778c3e03296a_8f0a119a-cda7-4497-a47d-c81493b824d4",ice_servers:[{urls:"turn.swire.io:443",credential:"sFTwvi8ShXcYNOcyYjFy3ATIUpQ=",credentialType:"password",username:"1619521908:8f0a119a-cda7-4497-a47d-c81493b824d4"}]},ap=()=>_i(),lp=()=>vo(),ti=G({},Sa);const Ya=t=>new window.RTCPeerConnection(t),Xa=()=>typeof navigator<"u"&&!!navigator.mediaDevices,Ht=()=>{if(!Xa())throw new Error("The media devices API isn't supported in this environment");return navigator.mediaDevices},dp=()=>typeof Ht().getUserMedia=="function",cp=()=>typeof Ht().getDisplayMedia=="function",Qa=()=>Ht().getSupportedConstraints(),Xt=t=>t&&t instanceof MediaStream,bo=()=>"sinkId"in HTMLMediaElement.prototype,Ki=async(t,e)=>{if(t===null){w().warn("No HTMLMediaElement to attach the speakerId");return}else if(typeof e!="string"){w().warn(`Invalid speaker deviceId: '${e}'`);return}else if(!bo()){w().warn("Browser does not support output device selection.");return}try{return await t.setSinkId(e)}catch(r){throw r.name==="SecurityError"?w().error(`You need to use HTTPS for selecting audio output device: ${r}`):w().error(`Error: ${r}`),r}},up=t=>t,Ji=t=>{var e;Xt(t)&&((e=t==null?void 0:t.getTracks())===null||e===void 0||e.forEach(At))},At=t=>{t&&t.readyState==="live"&&(t.stop(),t.dispatchEvent(new Event("ended")))},vp={camera:"videoinput",microphone:"audioinput",speaker:"audiooutput"},Yi=t=>{if(t)return vp[t]},eo=()=>Ht().enumerateDevices(),Xi=async t=>{let e=await eo().catch(r=>[]);return t&&(e=e.filter(({kind:r})=>r===t)),e},mp=async t=>{const e=await Xi(t);return e.length?e.every(({deviceId:r,label:o})=>!!(r&&o)):(w().warn(`No ${t} devices to check for permissions!`),null)},Ar=async t=>{if("permissions"in navigator&&typeof navigator.permissions.query=="function"&&t)try{return(await navigator.permissions.query({name:t})).state==="granted"}catch{}return mp(Yi(t))},Qi=()=>Ar("camera"),Zi=()=>Ar("microphone"),Za=()=>Ar("speaker"),pp=5e3,fp=async t=>{const e=[];return t!=null&&t.audio&&e.push(Zi()),t!=null&&t.video&&e.push(Qi()),e.length?(await Promise.all(e)).every(Boolean):!1},rr=async(t={audio:!0,video:!0})=>{var e;try{const r=Ht().getUserMedia(t);if(await fp(t)){const n=new Error("Timeout reading from your devices");return await sa(r,pp,n)}return await r}catch(r){switch(r.name){case"Error":{w().error((e=r==null?void 0:r.message)!==null&&e!==void 0?e:"navigator.mediaDevices.getUserMedia doesn't seem to be supported.");break}case"NotFoundError":{w().error("No media tracks of the type specified were found that satisfy the given constraints.");break}case"NotReadableError":{w().error("Hardware error occurred at the operating system, browser, or Web page level which prevented access to the device. This could have been caused by having the Camera or Mic being user by another application.");break}case"OverconstrainedError":{w().error(`The constraint: ${r.constraint} cannot be met by the selected device.`),w().info("List of available constraints:",Qa());break}case"NotAllowedError":{w().error("The user has mostly likely denied access to the device. This could also happen if the browsing context is insecure (using HTTP rather than HTTPS)");break}case"TypeError":{Object.keys(t).length===0?w().error(`Constraints can't be empty nor have "video" and "audio" set to false.`):w().error("Please check that you are calling this method from a secure context (using HTTPS rather than HTTP).");break}case"SecurityError":{w().error("User media support is disabled on the Document on which getUserMedia() was called. The mechanism by which user media support is enabled and disabled is left up to the individual user agent.");break}}throw r}},el=t=>Ht().getDisplayMedia(t),hp=async t=>{try{const e=await rr(t);Ji(e)}catch(e){throw e}},gp=t=>({audio:!t||t==="all"||t==="microphone"||t==="speaker",video:!t||t==="all"||t==="camera"}),wo=async(t,e=!1)=>or(t,e),_p=()=>wo("camera"),yp=()=>wo("microphone"),bp=()=>wo("speaker"),ri=(t,e={})=>{const r=[];return t.filter(({deviceId:o,kind:n,groupId:s})=>{var l;if(!o||e.targets&&!(!((l=e.targets)===null||l===void 0)&&l.includes(n)))return!1;if(!s)return!0;const c=`${n}-${s}`,v=e!=null&&e.excludeDefault?o!=="default":!0;return!r.includes(c)&&v?(r.push(c),!0):!1})},or=async(t,e=!1)=>{const r=await Ar(t);let o;if(r===!1){const s=gp(t);o=await rr(s)}const n=await Xi(Yi(t));return o&&Ji(o),e===!0?n:ri(n)},wp=()=>or("camera"),Sp=()=>or("microphone"),tl=()=>or("speaker"),Fn=async(t,e,r)=>{const o=await or(r,!0);for(let n=0;n<o.length;n++){const{deviceId:s,label:l}=o[n];if(t===s||e===l)return s}return null},Bn=t=>{const e=new Map;return t.forEach(r=>{r.deviceId&&e.set(r.deviceId,r)}),e},kp=(t,e)=>{const r=Bn(t),o=Bn(t),n=[];w().debug("[_getDeviceListDiff] <- oldDevices",t),w().debug("[_getDeviceListDiff] -> newDevices",e);const s=e.filter(l=>{const c=l.deviceId,v=r.get(c);return v&&(o.delete(c),l.label!==v.label&&n.push(l)),v===void 0});return{updated:n.map(l=>({type:"updated",payload:l})),removed:Array.from(o,([l,c])=>c).map(l=>({type:"removed",payload:l})),added:s.map(l=>({type:"added",payload:l}))}},Cp={camera:Qi,microphone:Zi,speaker:Za},oi=["camera","microphone","speaker"],zn=`Allowed targets are: '${oi.join("', '")}'`,Bo={speaker:bo},Tp=async t=>{const e=t.targets;return(await Promise.all(e.map(o=>Cp[o]()))).reduce((o,n,s)=>{var l;const c=e[s],m=(c in Bo?(l=Bo[c])===null||l===void 0?void 0:l.call(Bo):!0)?"supported":"unsupported";return o[m].push([c,!!n]),o},{supported:[],unsupported:[]})},Ep=async t=>{var e;const r=((e=t.targets)!==null&&e!==void 0?e:oi).filter(l=>oi.includes(l)?!0:(w().warn(`We'll ignore the "${l}" target as it is not allowed. ${zn}.`),!1));if(!r.length)throw new Error(`At least one "target" is required for createDeviceWatcher(). ${zn}.`);const o=await Tp({targets:r});if(o.unsupported.length>0&&r.length===o.unsupported.length)throw new Error(`The platform doesn't support "${r.join(", ")}" as target/s, which means it's not possible to watch for changes on those devices.`);if(o.supported.every(([l,c])=>!c))throw new Error("You must ask the user for permissions before being able to listen for device changes. Try calling getUserMedia() before calling `createDeviceWatcher()`.");let n=[];const s=o.supported.reduce((l,[c,v])=>(v?l.push(c):n.push(c),l),[]);if(s.length!==r.length){const l=o.unsupported.length>0?`The platform doesn't support "${o.unsupported.map(([v])=>v).join(", ")}" as target/s, which means it's not possible to watch for changes on those devices. `:"",c=n.length>0?`The user hasn't granted permissions for the following targets: ${n.join(", ")}. `:"";w().warn(`${l}${c}We'll be watching for the following targets instead: "${s.join(", ")}"`)}return w().debug(`Watching these targets: "${s.join(", ")}"`),s},So=async(t={})=>{const e=await Ep({targets:t.targets}),r=new kr,o=await eo(),n=e==null?void 0:e.reduce((c,v)=>{const m=Yi(v);return m&&c.push(m),c},[]);let s=ri(o,{excludeDefault:!0,targets:n});const l=async()=>{const c=await eo(),v=s,m=ri(c,{excludeDefault:!0,targets:n});s=m;const p=kp(v,m),h=p.added.length>0,y=p.removed.length>0,b=p.updated.length>0;(h||y||b)&&r.emit("changed",{changes:p,devices:m}),h&&r.emit("added",{changes:p.added,devices:m}),y&&r.emit("removed",{changes:p.removed,devices:m}),b&&r.emit("updated",{changes:p.updated,devices:m})};return Ht().addEventListener("devicechange",l),r},Ip=()=>So({targets:["microphone"]}),rl=()=>So({targets:["speaker"]}),Mp=()=>So({targets:["camera"]}),ol=t=>typeof(t==null?void 0:t.getTracks)=="function",Pp=async t=>{if(ol(t))return t;let e;return typeof t=="string"?e={audio:{deviceId:t}}:e={audio:t},rr(e)},Ap=t=>{const e=t.createAnalyser();return e.fftSize=64,e.minDecibels=-90,e.maxDecibels=-10,e.smoothingTimeConstant=.85,e},xp=100,Rp=async t=>{const e=await Pp(t);if(!e)throw new Error("Failed to get the audio stream");const r=new kr,o=new(window.AudioContext||window.webkitAudioContext),n=Ap(o);let s,l;try{o.createMediaStreamSource(e).connect(n)}catch{throw new Error("No audio track found")}e.getAudioTracks().forEach(m=>{m.addEventListener("ended",()=>{r.emit("destroyed","disconnected")})});const c=()=>{try{const m=new Uint8Array(n.frequencyBinCount);n.getByteFrequencyData(m);const p=m.reduce((h,y)=>h+y,0)/20;l!==p&&(l=p,r.emit("volumeChanged",Math.min(l,xp))),s=requestAnimationFrame(c)}catch{r.emit("destroyed","error")}};s=requestAnimationFrame(c);const v=()=>{s&&cancelAnimationFrame(s),o.state!=="closed"&&o.close().catch(m=>{w().error("Error closing the AudioContext",m)}),ol(t)||e.getTracks().forEach(m=>m.stop()),r.emit("destroyed",null),r.removeAllListeners()};return new Proxy(r,{get(m,p,h){return p==="destroy"?v:Reflect.get(m,p,h)}})},zo=async t=>(await tl()).find(r=>r.deviceId===t||r.deviceId==="default"&&t===""||r.deviceId===""&&t==="default"),Hn=t=>{w().info("RTCService.getUserMedia",t);const{audio:e,video:r}=t;if(!(!e&&!r))return rr(t)},Gn=async t=>{var e,r;const{micLabel:o="",micId:n}=t;let s=(e=t.audio)!==null&&e!==void 0?e:!0;if(n&&s){const m=await Fn(n,o,"microphone").catch(p=>null);m&&(typeof s=="boolean"&&(s={}),s.deviceId={exact:m})}const{camLabel:l="",camId:c}=t;let v=(r=t.video)!==null&&r!==void 0?r:!0;if(c&&v){const m=await Fn(c,l,"camera").catch(p=>null);m&&(typeof v=="boolean"&&(v={}),v.deviceId={exact:m})}return{audio:s,video:v}},Lp=(t,e)=>{const{disableUdpIceServers:r=!1}=e,o=n=>{const s="transport=udp";return Array.isArray(n)?n.filter(l=>!l.includes(s)):n.includes(s)?"":n};return t.map(n=>Object.assign(Object.assign({},n),{urls:r?o(n.urls):n.urls}))};var il={exports:{}};(function(t){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(r){return r.trim().split(`
`).map(o=>o.trim())},e.splitSections=function(r){return r.split(`
m=`).map((n,s)=>(s>0?"m="+n:n).trim()+`\r
`)},e.getDescription=function(r){const o=e.splitSections(r);return o&&o[0]},e.getMediaSections=function(r){const o=e.splitSections(r);return o.shift(),o},e.matchPrefix=function(r,o){return e.splitLines(r).filter(n=>n.indexOf(o)===0)},e.parseCandidate=function(r){let o;r.indexOf("a=candidate:")===0?o=r.substring(12).split(" "):o=r.substring(10).split(" ");const n={foundation:o[0],component:{1:"rtp",2:"rtcp"}[o[1]]||o[1],protocol:o[2].toLowerCase(),priority:parseInt(o[3],10),ip:o[4],address:o[4],port:parseInt(o[5],10),type:o[7]};for(let s=8;s<o.length;s+=2)switch(o[s]){case"raddr":n.relatedAddress=o[s+1];break;case"rport":n.relatedPort=parseInt(o[s+1],10);break;case"tcptype":n.tcpType=o[s+1];break;case"ufrag":n.ufrag=o[s+1],n.usernameFragment=o[s+1];break;default:n[o[s]]===void 0&&(n[o[s]]=o[s+1]);break}return n},e.writeCandidate=function(r){const o=[];o.push(r.foundation);const n=r.component;n==="rtp"?o.push(1):n==="rtcp"?o.push(2):o.push(n),o.push(r.protocol.toUpperCase()),o.push(r.priority),o.push(r.address||r.ip),o.push(r.port);const s=r.type;return o.push("typ"),o.push(s),s!=="host"&&r.relatedAddress&&r.relatedPort&&(o.push("raddr"),o.push(r.relatedAddress),o.push("rport"),o.push(r.relatedPort)),r.tcpType&&r.protocol.toLowerCase()==="tcp"&&(o.push("tcptype"),o.push(r.tcpType)),(r.usernameFragment||r.ufrag)&&(o.push("ufrag"),o.push(r.usernameFragment||r.ufrag)),"candidate:"+o.join(" ")},e.parseIceOptions=function(r){return r.substring(14).split(" ")},e.parseRtpMap=function(r){let o=r.substring(9).split(" ");const n={payloadType:parseInt(o.shift(),10)};return o=o[0].split("/"),n.name=o[0],n.clockRate=parseInt(o[1],10),n.channels=o.length===3?parseInt(o[2],10):1,n.numChannels=n.channels,n},e.writeRtpMap=function(r){let o=r.payloadType;r.preferredPayloadType!==void 0&&(o=r.preferredPayloadType);const n=r.channels||r.numChannels||1;return"a=rtpmap:"+o+" "+r.name+"/"+r.clockRate+(n!==1?"/"+n:"")+`\r
`},e.parseExtmap=function(r){const o=r.substring(9).split(" ");return{id:parseInt(o[0],10),direction:o[0].indexOf("/")>0?o[0].split("/")[1]:"sendrecv",uri:o[1],attributes:o.slice(2).join(" ")}},e.writeExtmap=function(r){return"a=extmap:"+(r.id||r.preferredId)+(r.direction&&r.direction!=="sendrecv"?"/"+r.direction:"")+" "+r.uri+(r.attributes?" "+r.attributes:"")+`\r
`},e.parseFmtp=function(r){const o={};let n;const s=r.substring(r.indexOf(" ")+1).split(";");for(let l=0;l<s.length;l++)n=s[l].trim().split("="),o[n[0].trim()]=n[1];return o},e.writeFmtp=function(r){let o="",n=r.payloadType;if(r.preferredPayloadType!==void 0&&(n=r.preferredPayloadType),r.parameters&&Object.keys(r.parameters).length){const s=[];Object.keys(r.parameters).forEach(l=>{r.parameters[l]!==void 0?s.push(l+"="+r.parameters[l]):s.push(l)}),o+="a=fmtp:"+n+" "+s.join(";")+`\r
`}return o},e.parseRtcpFb=function(r){const o=r.substring(r.indexOf(" ")+1).split(" ");return{type:o.shift(),parameter:o.join(" ")}},e.writeRtcpFb=function(r){let o="",n=r.payloadType;return r.preferredPayloadType!==void 0&&(n=r.preferredPayloadType),r.rtcpFeedback&&r.rtcpFeedback.length&&r.rtcpFeedback.forEach(s=>{o+="a=rtcp-fb:"+n+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),o},e.parseSsrcMedia=function(r){const o=r.indexOf(" "),n={ssrc:parseInt(r.substring(7,o),10)},s=r.indexOf(":",o);return s>-1?(n.attribute=r.substring(o+1,s),n.value=r.substring(s+1)):n.attribute=r.substring(o+1),n},e.parseSsrcGroup=function(r){const o=r.substring(13).split(" ");return{semantics:o.shift(),ssrcs:o.map(n=>parseInt(n,10))}},e.getMid=function(r){const o=e.matchPrefix(r,"a=mid:")[0];if(o)return o.substring(6)},e.parseFingerprint=function(r){const o=r.substring(14).split(" ");return{algorithm:o[0].toLowerCase(),value:o[1].toUpperCase()}},e.getDtlsParameters=function(r,o){return{role:"auto",fingerprints:e.matchPrefix(r+o,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(r,o){let n="a=setup:"+o+`\r
`;return r.fingerprints.forEach(s=>{n+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),n},e.parseCryptoLine=function(r){const o=r.substring(9).split(" ");return{tag:parseInt(o[0],10),cryptoSuite:o[1],keyParams:o[2],sessionParams:o.slice(3)}},e.writeCryptoLine=function(r){return"a=crypto:"+r.tag+" "+r.cryptoSuite+" "+(typeof r.keyParams=="object"?e.writeCryptoKeyParams(r.keyParams):r.keyParams)+(r.sessionParams?" "+r.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(r){if(r.indexOf("inline:")!==0)return null;const o=r.substring(7).split("|");return{keyMethod:"inline",keySalt:o[0],lifeTime:o[1],mkiValue:o[2]?o[2].split(":")[0]:void 0,mkiLength:o[2]?o[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(r){return r.keyMethod+":"+r.keySalt+(r.lifeTime?"|"+r.lifeTime:"")+(r.mkiValue&&r.mkiLength?"|"+r.mkiValue+":"+r.mkiLength:"")},e.getCryptoParameters=function(r,o){return e.matchPrefix(r+o,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(r,o){const n=e.matchPrefix(r+o,"a=ice-ufrag:")[0],s=e.matchPrefix(r+o,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(r){let o="a=ice-ufrag:"+r.usernameFragment+`\r
a=ice-pwd:`+r.password+`\r
`;return r.iceLite&&(o+=`a=ice-lite\r
`),o},e.parseRtpParameters=function(r){const o={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(r)[0].split(" ");o.profile=s[2];for(let c=3;c<s.length;c++){const v=s[c],m=e.matchPrefix(r,"a=rtpmap:"+v+" ")[0];if(m){const p=e.parseRtpMap(m),h=e.matchPrefix(r,"a=fmtp:"+v+" ");switch(p.parameters=h.length?e.parseFmtp(h[0]):{},p.rtcpFeedback=e.matchPrefix(r,"a=rtcp-fb:"+v+" ").map(e.parseRtcpFb),o.codecs.push(p),p.name.toUpperCase()){case"RED":case"ULPFEC":o.fecMechanisms.push(p.name.toUpperCase());break}}}e.matchPrefix(r,"a=extmap:").forEach(c=>{o.headerExtensions.push(e.parseExtmap(c))});const l=e.matchPrefix(r,"a=rtcp-fb:* ").map(e.parseRtcpFb);return o.codecs.forEach(c=>{l.forEach(v=>{c.rtcpFeedback.find(p=>p.type===v.type&&p.parameter===v.parameter)||c.rtcpFeedback.push(v)})}),o},e.writeRtpDescription=function(r,o){let n="";n+="m="+r+" ",n+=o.codecs.length>0?"9":"0",n+=" "+(o.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=o.codecs.map(l=>l.preferredPayloadType!==void 0?l.preferredPayloadType:l.payloadType).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,o.codecs.forEach(l=>{n+=e.writeRtpMap(l),n+=e.writeFmtp(l),n+=e.writeRtcpFb(l)});let s=0;return o.codecs.forEach(l=>{l.maxptime>s&&(s=l.maxptime)}),s>0&&(n+="a=maxptime:"+s+`\r
`),o.headerExtensions&&o.headerExtensions.forEach(l=>{n+=e.writeExtmap(l)}),n},e.parseRtpEncodingParameters=function(r){const o=[],n=e.parseRtpParameters(r),s=n.fecMechanisms.indexOf("RED")!==-1,l=n.fecMechanisms.indexOf("ULPFEC")!==-1,c=e.matchPrefix(r,"a=ssrc:").map(y=>e.parseSsrcMedia(y)).filter(y=>y.attribute==="cname"),v=c.length>0&&c[0].ssrc;let m;const p=e.matchPrefix(r,"a=ssrc-group:FID").map(y=>y.substring(17).split(" ").map(S=>parseInt(S,10)));p.length>0&&p[0].length>1&&p[0][0]===v&&(m=p[0][1]),n.codecs.forEach(y=>{if(y.name.toUpperCase()==="RTX"&&y.parameters.apt){let b={ssrc:v,codecPayloadType:parseInt(y.parameters.apt,10)};v&&m&&(b.rtx={ssrc:m}),o.push(b),s&&(b=JSON.parse(JSON.stringify(b)),b.fec={ssrc:v,mechanism:l?"red+ulpfec":"red"},o.push(b))}}),o.length===0&&v&&o.push({ssrc:v});let h=e.matchPrefix(r,"b=");return h.length&&(h[0].indexOf("b=TIAS:")===0?h=parseInt(h[0].substring(7),10):h[0].indexOf("b=AS:")===0?h=parseInt(h[0].substring(5),10)*1e3*.95-50*40*8:h=void 0,o.forEach(y=>{y.maxBitrate=h})),o},e.parseRtcpParameters=function(r){const o={},n=e.matchPrefix(r,"a=ssrc:").map(c=>e.parseSsrcMedia(c)).filter(c=>c.attribute==="cname")[0];n&&(o.cname=n.value,o.ssrc=n.ssrc);const s=e.matchPrefix(r,"a=rtcp-rsize");o.reducedSize=s.length>0,o.compound=s.length===0;const l=e.matchPrefix(r,"a=rtcp-mux");return o.mux=l.length>0,o},e.writeRtcpParameters=function(r){let o="";return r.reducedSize&&(o+=`a=rtcp-rsize\r
`),r.mux&&(o+=`a=rtcp-mux\r
`),r.ssrc!==void 0&&r.cname&&(o+="a=ssrc:"+r.ssrc+" cname:"+r.cname+`\r
`),o},e.parseMsid=function(r){let o;const n=e.matchPrefix(r,"a=msid:");if(n.length===1)return o=n[0].substring(7).split(" "),{stream:o[0],track:o[1]};const s=e.matchPrefix(r,"a=ssrc:").map(l=>e.parseSsrcMedia(l)).filter(l=>l.attribute==="msid");if(s.length>0)return o=s[0].value.split(" "),{stream:o[0],track:o[1]}},e.parseSctpDescription=function(r){const o=e.parseMLine(r),n=e.matchPrefix(r,"a=max-message-size:");let s;n.length>0&&(s=parseInt(n[0].substring(19),10)),isNaN(s)&&(s=65536);const l=e.matchPrefix(r,"a=sctp-port:");if(l.length>0)return{port:parseInt(l[0].substring(12),10),protocol:o.fmt,maxMessageSize:s};const c=e.matchPrefix(r,"a=sctpmap:");if(c.length>0){const v=c[0].substring(10).split(" ");return{port:parseInt(v[0],10),protocol:v[1],maxMessageSize:s}}},e.writeSctpDescription=function(r,o){let n=[];return r.protocol!=="DTLS/SCTP"?n=["m="+r.kind+" 9 "+r.protocol+" "+o.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+o.port+`\r
`]:n=["m="+r.kind+" 9 "+r.protocol+" "+o.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+o.port+" "+o.protocol+` 65535\r
`],o.maxMessageSize!==void 0&&n.push("a=max-message-size:"+o.maxMessageSize+`\r
`),n.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(r,o,n){let s;const l=o!==void 0?o:2;return r?s=r:s=e.generateSessionId(),`v=0\r
o=`+(n||"thisisadapterortc")+" "+s+" "+l+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(r,o){const n=e.splitLines(r);for(let s=0;s<n.length;s++)switch(n[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[s].substring(2)}return o?e.getDirection(o):"sendrecv"},e.getKind=function(r){return e.splitLines(r)[0].split(" ")[0].substring(2)},e.isRejected=function(r){return r.split(" ",2)[1]==="0"},e.parseMLine=function(r){const n=e.splitLines(r)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},e.parseOLine=function(r){const n=e.matchPrefix(r,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},e.isValidSDP=function(r){if(typeof r!="string"||r.length===0)return!1;const o=e.splitLines(r);for(let n=0;n<o.length;n++)if(o[n].length<2||o[n].charAt(1)!=="=")return!1;return!0},t.exports=e})(il);var Op=il.exports;const to=li(Op),Kn=t=>/^m=audio/.test(t),Jn=t=>/^m=video/.test(t),Vp=t=>{const e=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),r=t.match(e);return r&&r.length==2?r[1]:null},Dp=t=>t.replace(/\r\n/g,`
`).replace(/\r/g,`
`),Yn=t=>{const e=`\r
`,r=t.split(e),o=r.findIndex(c=>/^a=rtpmap/.test(c)&&/opus\/48000/.test(c));if(o<0)return t;const n=Vp(r[o]),s=new RegExp(`a=fmtp:${n}`),l=r.findIndex(c=>s.test(c));return l>=0?/stereo=1;/.test(r[l])||(r[l]+="; stereo=1; sprop-stereo=1"):r[o]+=`${e}a=fmtp:${n} stereo=1; sprop-stereo=1`,r.join(e)},Np=(t,e)=>{const r=`\r
`,o=e.split(r),n=o.findIndex(Kn),s=o.findIndex(Jn);if(s==-1||n==-1||n<s)return t;const l=t.split(r),c=l.findIndex(Kn),v=l.findIndex(Jn),m=l.slice(c,v),p=l.slice(v,l.length-1);return[...l.slice(0,c),...p,...m,""].join(r)},$p=(t,e,r,o)=>{const n=`\r
`,s=t.split(n);return s.forEach((l,c)=>{/^a=fmtp:\d*/.test(l)?s[c]+=`;x-google-max-bitrate=${e};x-google-min-bitrate=${r};x-google-start-bitrate=${o}`:/^a=mid:(1|video)/.test(l)&&(s[c]+=`\r
b=AS:${e}`)}),s.join(n)},Xn=t=>{try{const e=/typ (?:srflx|prflx|relay)/,r=to.getMediaSections(t);for(const o of r)if(!to.splitLines(o).some(l=>l.indexOf("a=candidate")===0&&e.test(l)))return!1;return!0}catch(e){return w().error("Error checking SDP",e),!1}},Wp=t=>{try{const e=to.getMediaSections(t);for(const r of e)if(!to.splitLines(r).some(s=>s.indexOf("a=candidate")===0))return!1;return!0}catch(e){return w().error("Error checking SDP",e),!1}},Up=t=>{const e=/^a=candidate.*.local\ .*/,r=`\r
`;return t.split(r).filter(o=>!e.test(o)).join(r)},Qn=(t,e)=>{const r=Dp(t).split(`
`);let o=!1;const n=["inactive","recvonly","sendonly","sendrecv","stopped"];for(let s of r)if(s.startsWith("m="))o=s.startsWith(`m=${e}`);else if(o&&s.startsWith("a=")){const l=s.substring(2);if(n.includes(l))return l}return o?"sendrecv":"stopped"},jp=t=>{switch(t){case"sendrecv":return"sendrecv";case"sendonly":return"recvonly";case"recvonly":return"sendonly";case"inactive":return"inactive";default:return"inactive"}},Zn=({localSdp:t,remoteSdp:e,media:r})=>{const o=Qn(t,r),n=jp(o);return Qn(e,r)===n},qp=t=>{if(!t.hasAudioReceiver&&!t.hasVideoReceiver){w().warn(`Missing receivers to inspect media for RTCPeer "${t.uuid}"`);return}w().debug(`Start watching media for RTCPeer "${t.uuid}"`);let e=0,r=0,o=!0,n;const s=()=>{clearTimeout(n)},l=async()=>{var c,v;let m=0,p=0;try{const h=await t.instance.getStats(null),y=(c=t.remoteAudioTrack)===null||c===void 0?void 0:c.id,b=(v=t.remoteVideoTrack)===null||v===void 0?void 0:v.id;h.forEach(S=>{S.type==="inbound-rtp"&&S.kind==="audio"&&S.trackIdentifier===y&&(w().trace(`audio inbound-rtp: packetsReceived: ${S.packetsReceived} (at ${S.lastPacketReceivedTimestamp})`),m=S.packetsReceived),S.type==="inbound-rtp"&&S.kind==="video"&&S.trackIdentifier===b&&(w().trace(`video inbound-rtp: packetsReceived: ${S.packetsReceived} (at ${S.lastPacketReceivedTimestamp})`),p=S.packetsReceived)})}catch(h){w().warn("getStats error",h)}finally{const h=m&&m<=e,y=p&&p<=r;h&&y?(w().warn(`audioPacketsReceived: ${m} - previousAudioValue: ${e}`),w().warn(`videoPacketsReceived: ${p} - previousVideoValue: ${r}`),t.triggerResume()):(e=m??e,r=p??r,s(),o&&t.instance.connectionState!=="closed"&&(n=setTimeout(()=>l(),t.watchMediaPacketsTimeout)))}};return{start:()=>{s(),l()},stop:()=>{o=!1,s()}}};function Fp(){const t=window.AudioContext||window.webkitAudioContext,e=new t,r=e.createOscillator(),o=e.createMediaStreamDestination();r.frequency.value=0,r.connect(o),r.start();const n=o.stream.getAudioTracks()[0];return n._mockContext=e,n._mockOscillator=r,n}function Bp(){const t=document.createElement("canvas");if(!t.captureStream)return console.warn("canvas.captureStream not supported, using audio-only mock"),null;t.width=320,t.height=240;const e=t.getContext("2d");e&&(e.fillStyle="#000000",e.fillRect(0,0,t.width,t.height));const o=t.captureStream(1).getVideoTracks()[0];return o._mockCanvas=t,o}function es(t){t.readyState==="live"&&t.stop(),t._mockOscillator&&(t._mockOscillator.stop(),t._mockOscillator.disconnect(),delete t._mockOscillator),t._mockContext&&(t._mockContext.close(),delete t._mockContext)}function ts(t){t&&(t.readyState==="live"&&t.stop(),t._mockCanvas&&(t._mockCanvas.remove(),delete t._mockCanvas))}const rs=4,os=20;class zp{constructor(e,r=3,o=!1){this.pool=new Map,this.turnRefreshInterval=24e4,this.logger=w();const n=e.iceCandidatePoolSize||10;this.config=Object.assign(Object.assign({},e),{iceCandidatePoolSize:n>os?os:n}),this.poolSize=r>rs?rs:r,this.forceRefresh=o}async initializePool(){this.logger.info(`Initializing RTCPeerConnection pool with size ${this.poolSize}`);const e=[];for(let o=0;o<this.poolSize;o++)e.push(this.createPooledConnection());(await Promise.all(e)).forEach(o=>{o&&this.pool.set(o.id,o)}),this.logger.info(`Pool initialized with ${this.pool.size} connections`),this.forceRefresh&&(this.logger.info("Manual force refresh mode enabled, TURN allocations will not be refreshed by this manager."),this.startMaintenanceWorker())}getConnection(){for(const[e,r]of this.pool.entries())if(this.logger.debug(`Checking pooled connection ${e}`),this.logger.debug(`Connection state: ${r.pc.connectionState}`),this.logger.debug(`Signaling state: ${r.pc.signalingState}`),this.logger.debug(`ICE connection state: ${r.pc.iceConnectionState}`),this.isConnectionValid(r))return this.logger.info(`Providing pooled connection ${e}`),this.pool.delete(e),this.cleanupMockTracks(r),this.replenishPool().catch(o=>{this.logger.error("Failed to replenish pool:",o)}),r.pc;return this.logger.warn("No valid pooled connections available"),null}cleanup(){this.logger.info("Cleaning up RTCPeerConnectionManager"),this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=void 0);for(const[,e]of this.pool.entries())this.closeConnection(e);this.pool.clear()}async createPooledConnection(){var e;try{const r=Ya(this.config),o=`conn_${Date.now()}_${Math.random().toString(36).substring(2,11)}`;this.logger.debug(`Creating pooled connection ${o}`);const n=Fp(),s=Bp(),l=[],c=r.addTrack(n);l.push(c);let v=null;s&&(v=r.addTrack(s),l.push(v));const m=await r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await r.setLocalDescription(m),await this.waitForIceGathering(r);const p={id:o,pc:r,createdAt:Date.now(),lastRefreshed:Date.now(),iceGatheringComplete:!0,mockTracks:{audio:n,video:s||void 0},senders:l};return this.logger.debug(`Pooled connection ${o} created successfully`),this.logger.debug(`ICE candidates gathered for connection ${o}:`,(e=r.localDescription)===null||e===void 0?void 0:e.sdp),p}catch(r){return this.logger.error("Failed to create pooled connection:",r),null}}waitForIceGathering(e){return new Promise(r=>{if(e.iceGatheringState==="complete"){r();return}const o=()=>{e.iceGatheringState==="complete"&&(n(),r())},n=()=>{e.removeEventListener("icegatheringstatechange",o),clearTimeout(s)};e.addEventListener("icegatheringstatechange",o);const s=setTimeout(()=>{this.logger.warn("ICE gathering timeout, proceeding anyway"),n(),r()},1e4)})}cleanupMockTracks(e){this.logger.debug(`Cleaning up mock tracks for connection ${e.id}`),e.mockTracks.audio&&es(e.mockTracks.audio),e.mockTracks.video&&ts(e.mockTracks.video),e.senders.forEach(r=>{try{e.pc.removeTrack(r)}catch(o){this.logger.warn("Error removing track:",o)}}),this.cleanupEventListeners(e.pc),e.mockTracks={},e.senders=[]}cleanupEventListeners(e){["icecandidate","icegatheringstatechange","iceconnectionstatechange","connectionstatechange","signalingstatechange","negotiationneeded","track","datachannel","addstream","removestream"].forEach(o=>{e[`on${o}`]=null})}isConnectionValid(e){if(e.pc.connectionState==="closed"||e.pc.connectionState==="failed")return this.logger.debug(`Pooled connection ${e.id} is not valid: ${e.pc.connectionState}`),!1;if(e.pc.signalingState==="closed")return this.logger.debug(`Pooled connection ${e.id} signalingState is not valid: ${e.pc.signalingState}`),!1;if(e.pc.iceConnectionState==="failed"||e.pc.iceConnectionState==="disconnected")return this.logger.debug(`Pooled connection ${e.id} iceConnectionState is not valid: ${e.pc.iceConnectionState}`),!1;const r=Date.now()-e.lastRefreshed;return this.forceRefresh&&r>this.turnRefreshInterval?(this.logger.debug(`Pooled connection ${e.id} is not valid: TURN allocation age ${r}`),!1):!0}async replenishPool(){const e=this.poolSize-this.pool.size;if(!(e<=0)){this.logger.debug(`Replenishing pool with ${e} connections`);for(let r=0;r<e;r++){const o=await this.createPooledConnection();o&&this.pool.set(o.id,o)}}}startMaintenanceWorker(){this.refreshTimer&&clearInterval(this.refreshTimer),this.refreshTimer=setInterval(()=>{this.refreshTurnAllocations().catch(e=>{this.logger.error("TURN refresh error:",e)})},this.turnRefreshInterval)}async refreshTurnAllocations(){const e=Date.now();for(const[r,o]of this.pool.entries())if(e-o.lastRefreshed>this.turnRefreshInterval)try{await this.refreshConnection(o)}catch(s){this.logger.error(`Failed to refresh connection ${r}:`,s),this.pool.delete(r),this.closeConnection(o)}this.replenishPool().catch(r=>{this.logger.error("Failed to replenish after refresh:",r)})}async refreshConnection(e){var r;this.logger.debug(`Refreshing TURN allocation for connection ${e.id}`),e.pc.restartIce();const o=await e.pc.createOffer({iceRestart:!0});await e.pc.setLocalDescription(o),await this.waitForIceGathering(e.pc),e.lastRefreshed=Date.now(),this.logger.debug(`TURN allocation refreshed for connection ${e.id}`),this.logger.debug(`New ICE candidates for connection ${e.id}:`,(r=e.pc.localDescription)===null||r===void 0?void 0:r.sdp)}closeConnection(e){try{e.mockTracks.audio&&es(e.mockTracks.audio),e.mockTracks.video&&ts(e.mockTracks.video),e.pc.connectionState!=="closed"&&e.pc.close()}catch(r){this.logger.error(`Error closing connection ${e.id}:`,r)}}}class Hp{constructor(){this.logger=w()}async initializePool(e,r={}){var o,n;if(this.manager){this.logger.warn("Connection pool already initialized");return}this.logger.info("Initializing connection pool");const s={iceServers:e,iceCandidatePoolSize:(o=r.iceCandidatePoolSize)!==null&&o!==void 0?o:10};this.manager=new zp(s,(n=r.poolSize)!==null&&n!==void 0?n:2),await this.manager.initializePool()}getConnection(){return this.manager?this.manager.getConnection():(this.logger.warn("Connection pool not initialized"),null)}cleanup(){this.manager&&(this.logger.info("Cleaning up connection pool"),this.manager.cleanup(),this.manager=void 0)}get isInitialized(){return!!this.manager}}const cr=new Hp,Gp=12e3;class Kp{get logger(){return w()}constructor(e,r){this.call=e,this.type=r,this.uuid=xt(),this._negotiating=!1,this._processingRemoteSDP=!1,this._restartingIce=!1,this._candidatesSnapshot=[],this._allCandidates=[],this._processingLocalSDP=!1,this.logger.debug("New Peer with type:",this.type,"Options:",this.options),this._onIce=this._onIce.bind(this),this._onEndedTrackHandler=this._onEndedTrackHandler.bind(this),this.options.prevCallId&&(this.uuid=this.options.prevCallId),this.options.prevCallId=void 0,this.options.localStream&&Xt(this.options.localStream)&&(this._localStream=this.options.localStream),this.rtcConfigPolyfill=this.config}get options(){return this.call.options}get watchMediaPacketsTimeout(){var e;return(e=this.options.watchMediaPacketsTimeout)!==null&&e!==void 0?e:2e3}get isNegotiating(){return this._negotiating}get localStream(){return this._localStream}set localStream(e){this._localStream=e}get remoteStream(){return this._remoteStream}get isOffer(){return this.type==="offer"}get isAnswer(){return this.type==="answer"}get isSimulcast(){return this.options.simulcast===!0}get isSfu(){return this.options.sfu===!0}get localVideoTrack(){const e=this._getSenderByKind("video");return(e==null?void 0:e.track)||null}get localAudioTrack(){const e=this._getSenderByKind("audio");return(e==null?void 0:e.track)||null}get remoteVideoTrack(){const e=this._getReceiverByKind("video");return(e==null?void 0:e.track)||null}get remoteAudioTrack(){const e=this._getReceiverByKind("audio");return(e==null?void 0:e.track)||null}get hasAudioSender(){return!!this._getSenderByKind("audio")}get hasVideoSender(){return!!this._getSenderByKind("video")}get hasAudioReceiver(){return!!this._getReceiverByKind("audio")}get hasVideoReceiver(){return!!this._getReceiverByKind("video")}get config(){const{rtcPeerConfig:e={}}=this.options,r=Object.assign({bundlePolicy:"max-compat",iceServers:Lp(this.call.iceServers,{disableUdpIceServers:this.options.disableUdpIceServers}),sdpSemantics:"unified-plan"},e);return this.logger.debug("RTC config",r),r}get localSdp(){var e,r;return(r=(e=this.instance)===null||e===void 0?void 0:e.localDescription)===null||r===void 0?void 0:r.sdp}get remoteSdp(){var e,r;return(r=(e=this.instance)===null||e===void 0?void 0:e.remoteDescription)===null||r===void 0?void 0:r.sdp}get hasIceServers(){if(this.instance){const{iceServers:e=[]}=this.getConfiguration();return!!(e!=null&&e.length)}return!1}stopTrackSender(e){var r;try{const o=this._getSenderByKind(e);if(!o)return this.logger.info(`There is not a '${e}' sender to stop.`);o.track&&(At(o.track),(r=this._localStream)===null||r===void 0||r.removeTrack(o.track))}catch(o){this.logger.error("RTCPeer stopTrackSender error",e,o)}}stopTrackReceiver(e){var r;try{const o=this._getReceiverByKind(e);if(!o)return this.logger.info(`There is not a '${e}' receiver to stop.`);o.track&&(At(o.track),(r=this._remoteStream)===null||r===void 0||r.removeTrack(o.track))}catch(o){this.logger.error("RTCPeer stopTrackReceiver error",e,o)}}async restoreTrackSender(e){var r;try{const o=this._getSenderByKind(e);if(!o)return this.logger.info(`There is not a '${e}' sender to restore.`);if(o.track&&o.track.readyState!=="ended")return this.logger.info(`There is already an active ${e} track.`);const n=await Gn(this.options),s=await Hn({[e]:n[e]});if(s&&Xt(s)){const l=s.getTracks().find(c=>c.kind===e);l&&(await o.replaceTrack(l),(r=this._localStream)===null||r===void 0||r.addTrack(l))}}catch(o){this.logger.error("RTCPeer restoreTrackSender error",e,o)}}getDeviceId(e){try{const r=this._getSenderByKind(e);if(!r||!r.track)return null;const{deviceId:o=null}=r.track.getSettings();return o}catch(r){return this.logger.error("RTCPeer getDeviceId error",e,r),null}}getTrackSettings(e){try{const r=this._getSenderByKind(e);return!r||!r.track?null:r.track.getSettings()}catch(r){return this.logger.error("RTCPeer getTrackSettings error",e,r),null}}getTrackConstraints(e){try{const r=this._getSenderByKind(e);return!r||!r.track?null:r.track.getConstraints()}catch(r){return this.logger.error("RTCPeer getTrackConstraints error",e,r),null}}getDeviceLabel(e){try{const r=this._getSenderByKind(e);return!r||!r.track?null:r.track.label}catch(r){return this.logger.error("RTCPeer getDeviceLabel error",e,r),null}}restartIceWithRelayOnly(){var e,r;try{if(this.isAnswer)return this.logger.warn("Skip restartIceWithRelayOnly since we need to generate answer");const o=this.getConfiguration();if(o.iceTransportPolicy==="relay")return this.logger.warn("RTCPeer already with iceTransportPolicy relay only");const n=Object.assign(Object.assign({},o),{iceTransportPolicy:"relay"});this.setConfiguration(n),this.restartIce()}catch(o){this.logger.error("restartIceWithRelayOnly",o),(e=this._rejectStartMethod)===null||e===void 0||e.call(this,o),(r=this._pendingNegotiationPromise)===null||r===void 0||r.reject(o)}}restartIce(){if(this._negotiating||this._restartingIce)return this.logger.warn("Skip restartIce");this._restartingIce=!0,this.logger.debug("Restart ICE"),this.type="offer",this.instance.restartIce()}triggerResume(){if(this.logger.info("Probably half-open so force close from client"),this._resumeTimer){this.logger.info('[skipped] Already in "resume" state');return}this.call.emit("media.disconnected"),this.call.emit("media.reconnecting"),this.clearTimers(),this._resumeTimer=setTimeout(()=>{this.logger.warn("Disconnecting due to RECONNECTION_ATTEMPT_TIMEOUT"),this.call.emit("media.disconnected"),this.call.leaveReason="RECONNECTION_ATTEMPT_TIMEOUT",this.call.setState("hangup")},Gp),this.call._closeWSConnection()}resetNeedResume(){this.clearResumeTimer(),this.options.watchMediaPackets&&this.startWatchMediaPackets()}stopWatchMediaPackets(){this._mediaWatcher&&this._mediaWatcher.stop()}startWatchMediaPackets(){var e;this.stopWatchMediaPackets(),this._mediaWatcher=qp(this),(e=this._mediaWatcher)===null||e===void 0||e.start()}async applyMediaConstraints(e,r){try{const o=this._getSenderByKind(e);if(!o||!o.track)return this.logger.info("No sender to apply constraints",e,r);if(o.track.readyState==="live"){const n=Object.assign(Object.assign({},o.track.getConstraints()),r),s=this.getDeviceId(e);s&&!this.options.screenShare&&(n.deviceId={exact:s}),this.logger.info(`Apply ${e} constraints`,this.call.id,n),await o.track.applyConstraints(n)}}catch{this.logger.error("Error applying constraints",e,r)}}_getSenderByKind(e){var r;return!((r=this.instance)===null||r===void 0)&&r.getSenders?this.instance.getSenders().find(({track:o})=>o&&o.kind===e):(this.logger.warn("RTCPeerConnection.getSenders() not available."),null)}_getReceiverByKind(e){var r;return!((r=this.instance)===null||r===void 0)&&r.getReceivers?this.instance.getReceivers().find(({track:o})=>o&&o.kind===e):(this.logger.warn("RTCPeerConnection.getReceivers() not available."),null)}async startNegotiation(e=!1){var r,o,n;if(this._negotiating)return this.logger.warn("Skip twice onnegotiationneeded!");this._negotiating=!0;try{if((this.options.additionalDevice||this.options.screenShare)&&((o=(r=this.instance)===null||r===void 0?void 0:r.getTransceivers)===null||o===void 0||o.call(r).forEach(s=>{s.direction="sendonly"})),this.instance.removeEventListener("icecandidate",this._onIce),this.instance.addEventListener("icecandidate",this._onIce),this.isOffer){this.logger.debug("Trying to generate offer");const s={voiceActivityDetection:!1};this._supportsAddTransceiver()||(s.offerToReceiveAudio=this.options.negotiateAudio,s.offerToReceiveVideo=this.options.negotiateVideo);const l=await this.instance.createOffer(s);await this._setLocalDescription(l)}if(this.isAnswer){this.logger.debug("Trying to generate answer"),await this._setRemoteDescription({sdp:this.options.remoteSdp,type:"offer"});const s=await this.instance.createAnswer({voiceActivityDetection:!1});await this._setLocalDescription(s)}e&&this.instance.signalingState==="have-local-offer"&&this._sdpReady(),this.logger.info("iceGatheringState",this.instance.iceGatheringState),this.instance.iceGatheringState==="gathering"&&(this._iceTimeout=setTimeout(()=>{this._onIceTimeout()},this.options.maxIceGatheringTimeout))}catch(s){this.logger.error(`Error creating ${this.type}:`,s),(n=this._pendingNegotiationPromise)===null||n===void 0||n.reject(s)}}onRemoteBye({code:e,message:r}){var o,n;const s={code:e,message:r};(o=this._rejectStartMethod)===null||o===void 0||o.call(this,s),(n=this._pendingNegotiationPromise)===null||n===void 0||n.reject(s),this.stop()}async onRemoteSdp(e){var r,o;if(this._processingRemoteSDP||this.remoteSdp&&this.remoteSdp===e){this.logger.warn("Ignore same remote SDP",e);return}try{const n=this.isOffer?"answer":"offer";if(n==="answer"&&this.instance.signalingState!=="have-local-offer"){this.logger.warn("Ignoring offer SDP as signaling state is not have-local-offer");return}this._processingRemoteSDP=!0,await this._setRemoteDescription({sdp:e,type:n}),this._processingRemoteSDP=!1,this.isOffer&&(this._resolveStartMethod(),(r=this._pendingNegotiationPromise)===null||r===void 0||r.resolve()),this.resetNeedResume()}catch(n){this._processingRemoteSDP=!1,this.logger.error(`Error handling remote SDP on call ${this.call.id}:`,n),this.call.hangup(),this._rejectStartMethod(n),(o=this._pendingNegotiationPromise)===null||o===void 0||o.reject(n)}}_setupRTCPeerConnection(){if(!this.instance){let e=null;try{e=cr.getConnection()}catch(r){this.logger.debug("Could not access session connection pool",r)}e?(this.logger.info("Using pre-warmed connection from session pool with ICE candidates ready"),this.instance=e):(this.logger.debug("Creating new RTCPeerConnection (no pooled connection available)"),this.instance=Ya(this.config)),this._attachListeners()}}async start(){return new Promise(async(e,r)=>{var o,n,s;this._resolveStartMethod=e,this._rejectStartMethod=r;try{this._localStream=await this._retrieveLocalStream()}catch(c){return this._rejectStartMethod(c),(o=this._pendingNegotiationPromise)===null||o===void 0||o.reject(c),this.call.setState("hangup")}this._setupRTCPeerConnection();let l=!1;if(this._localStream&&Xt(this._localStream)){const c=this._localStream.getAudioTracks();this.logger.debug("Local audio tracks: ",c);const v=this._localStream.getVideoTracks();if(this.logger.debug("Local video tracks: ",v),l=!!(c.length||v.length),this.isOffer&&this._supportsAddTransceiver()){const m={direction:this.options.negotiateAudio?"sendrecv":"sendonly",streams:[this._localStream]};this.logger.debug("Applying audioTransceiverParams",m);const p=this.instance.getTransceivers().filter(b=>{var S,k;return((S=b.receiver.track)===null||S===void 0?void 0:S.kind)==="audio"||!b.sender.track&&!b.receiver.track&&((k=b.mid)===null||k===void 0?void 0:k.includes("audio"))});c.forEach((b,S)=>{var k;if(S<p.length){const C=p[S];this.logger.debug("Reusing existing audio transceiver",C.mid),C.sender.replaceTrack(b),C.direction=m.direction||"sendrecv",!((k=m.streams)===null||k===void 0)&&k[0]&&(C.sender.streams=m.streams)}else this.logger.debug("Creating new audio transceiver"),this.instance.addTransceiver(b,m)});const h={direction:this.options.negotiateVideo?"sendrecv":"sendonly",streams:[this._localStream]};if(this.isSimulcast){const b=["0","1","2"];h.sendEncodings=b.map(S=>({active:!0,rid:S,scaleResolutionDownBy:Number(S)*6||1}))}this.logger.debug("Applying videoTransceiverParams",h);const y=this.instance.getTransceivers().filter(b=>{var S,k;return((S=b.receiver.track)===null||S===void 0?void 0:S.kind)==="video"||!b.sender.track&&!b.receiver.track&&((k=b.mid)===null||k===void 0?void 0:k.includes("video"))});if(v.forEach((b,S)=>{var k;if(S<y.length){const C=y[S];if(this.logger.debug("Reusing existing video transceiver",C.mid),C.sender.replaceTrack(b),C.direction=h.direction||"sendrecv",!((k=h.streams)===null||k===void 0)&&k[0]&&(C.sender.streams=h.streams),h.sendEncodings){const E=C.sender.getParameters();E.encodings=h.sendEncodings,C.sender.setParameters(E)}}else this.logger.debug("Creating new video transceiver"),this.instance.addTransceiver(b,h)}),this.isSfu){const{msStreamsNumber:b=5}=this.options;this.logger.debug("Add ",b,"recvonly MS Streams"),h.direction="recvonly";for(let S=0;S<Number(b);S++)this.instance.addTransceiver("video",h)}}else if(typeof this.instance.addTrack=="function"){const m=this._localStream;c.forEach(p=>this.instance.addTrack(p,m)),v.forEach(p=>this.instance.addTrack(p,m))}else this.instance.addStream(this._localStream)}if(this.isOffer){if(this.instance.signalingState==="have-local-offer"){this.logger.debug("Reusing pooled connection, managing transceivers");const c=((n=this._localStream)===null||n===void 0?void 0:n.getAudioTracks())||[],v=((s=this._localStream)===null||s===void 0?void 0:s.getVideoTracks())||[];this.instance.getTransceivers().forEach(p=>{var h,y,b,S;const k=((h=p.receiver.track)===null||h===void 0?void 0:h.kind)==="audio"||!p.sender.track&&!p.receiver.track&&((y=p.mid)===null||y===void 0?void 0:y.includes("audio")),C=((b=p.receiver.track)===null||b===void 0?void 0:b.kind)==="video"||!p.sender.track&&!p.receiver.track&&((S=p.mid)===null||S===void 0?void 0:S.includes("video"));k&&c.length===0&&(this.logger.debug("Setting unused audio transceiver to inactive",p.mid),p.direction="inactive"),C&&v.length===0&&(this.logger.debug("Setting unused video transceiver to inactive",p.mid),p.direction="inactive")})}this.options.negotiateAudio&&this._checkMediaToNegotiate("audio"),this.options.negotiateVideo&&this._checkMediaToNegotiate("video"),this.instance.signalingState==="have-local-offer"&&(this.logger.debug("Reusing pooled connection with local offer"),this.startNegotiation(!0)),!this._supportsAddTransceiver()&&!l&&this.startNegotiation()}else this.startNegotiation()})}detachAndStop(){var e;typeof((e=this.instance)===null||e===void 0?void 0:e.getTransceivers)=="function"&&this.instance.getTransceivers().forEach(r=>{r.sender.track&&r.sender.track.stop(),r.receiver.track&&r.receiver.track.stop()}),this.stop()}stop(){var e,r,o;(e=this._localStream)===null||e===void 0||e.getTracks().forEach(n=>n.stop()),(r=this._remoteStream)===null||r===void 0||r.getTracks().forEach(n=>n.stop()),(o=this.instance)===null||o===void 0||o.close(),this.stopWatchMediaPackets()}_supportsAddTransceiver(){return typeof this.instance.addTransceiver=="function"}_checkMediaToNegotiate(e){if(!this._getSenderByKind(e)&&this._supportsAddTransceiver()){const o=this.instance.getTransceivers().find(n=>{var s,l;return((s=n.receiver.track)===null||s===void 0?void 0:s.kind)===e||!n.sender.track&&!n.receiver.track&&((l=n.mid)===null||l===void 0?void 0:l.includes(e))});if(o)this.logger.debug("Found existing transceiver for",e,o.mid),(o.direction==="inactive"||o.direction==="sendonly")&&(o.direction="recvonly");else{const n=this.instance.addTransceiver(e,{direction:"recvonly"});this.logger.debug("Add transceiver",e,n)}}}async _sdpReady(){var e,r;if(this._processingLocalSDP){this.logger.debug("Already processing local SDP, skipping");return}if(this.type==="offer"&&!["have-local-offer","have-local-pranswer"].includes(this.instance.signalingState)){this.logger.warn(`_sdpReady called in wrong state: ${this.instance.signalingState}`);return}if(this._processingLocalSDP=!0,clearTimeout(this._iceTimeout),!this.instance.localDescription){this.logger.error("Missing localDescription",this.instance);return}const{sdp:o}=this.instance.localDescription;if(!Wp(o)){this.logger.info(`No candidate - retry 
`),this._processingLocalSDP=!1,this.startNegotiation(!0);return}if(!this._sdpIsValid()){this.logger.info("SDP ready but not valid"),this._processingLocalSDP=!1,this._onIceTimeout();return}try{await this.call.onLocalSDPReady(this),this._processingLocalSDP=!1,this.isAnswer&&(this._resolveStartMethod(),(e=this._pendingNegotiationPromise)===null||e===void 0||e.resolve())}catch(n){this._rejectStartMethod(n),(r=this._pendingNegotiationPromise)===null||r===void 0||r.reject(n),this._processingLocalSDP=!1}}_sdpIsValid(){return this.localSdp&&this.hasIceServers?Xn(this.localSdp):!!this.localSdp}_forceNegotiation(){this.logger.info("Force negotiation again"),this._negotiating=!1,this.startNegotiation()}_onIceTimeout(){var e;if(this._sdpIsValid()){this._sdpReady();return}this.logger.info("ICE gathering timeout");const r=this.getConfiguration();if(r.iceTransportPolicy==="relay"){this.logger.info('RTCPeer already with "iceTransportPolicy: relay"');const o={code:"ICE_GATHERING_FAILED",message:"Ice gathering timeout"};this._rejectStartMethod(o),(e=this._pendingNegotiationPromise)===null||e===void 0||e.reject(o),this.call.setState("destroy");return}this.setConfiguration(Object.assign(Object.assign({},r),{iceTransportPolicy:"relay"})),this._forceNegotiation()}_onIce(e){var r,o;if(this._iceTimeout&&clearTimeout(this._iceTimeout),!e.candidate){this.instance.removeEventListener("icecandidate",this._onIce),this._candidatesSnapshot.length>0&&(this.logger.debug("No more candidates, calling _sdpReady"),this._sdpReady());return}this._allCandidates.push(e.candidate),this.logger.debug("RTCPeer Candidate:",e.candidate),e.candidate.type==="host"?this._iceTimeout=setTimeout(()=>{this.instance.removeEventListener("icecandidate",this._onIce),this._onIceTimeout()},this.options.maxIceGatheringTimeout):!((r=this.instance.localDescription)===null||r===void 0)&&r.sdp&&(Xn(this.instance.localDescription.sdp)?this._candidatesSnapshot.length===0&&this.type==="offer"&&(this._candidatesSnapshot=[...this._allCandidates],this.logger.info("SDP has candidates for all media sections, calling _sdpReady for early invite"),setTimeout(()=>this._sdpReady(),0)):(this.logger.info("SDP does not have candidates for all media sections, waiting for more candidates"),this.logger.debug((o=this.instance.localDescription)===null||o===void 0?void 0:o.sdp)))}_retryWithMoreCandidates(){this._hasMoreCandidates()&&this.instance.connectionState!=="connected"&&(this.logger.info("More candidates found after ICE gathering complete, triggering renegotiation"),this._negotiating=!1,this._candidatesSnapshot=[],this._allCandidates=[],this.type="offer",this.instance.signalingState==="stable"?this.startNegotiation(!0):(this.logger.warn("Signaling state is not stable, cannot start negotiation immediately"),this.restartIce()))}_hasMoreCandidates(){return this._allCandidates.length>this._candidatesSnapshot.length}_setLocalDescription(e){const{useStereo:r,googleMaxBitrate:o,googleMinBitrate:n,googleStartBitrate:s}=this.options;return e.sdp&&r&&(e.sdp=Yn(e.sdp)),e.sdp&&o&&n&&s&&(e.sdp=$p(e.sdp,o,n,s)),this.instance.setLocalDescription(e)}_setRemoteDescription(e){e.sdp&&this.options.useStereo&&(e.sdp=Yn(e.sdp)),e.sdp&&this.instance.localDescription&&(e.sdp=Np(e.sdp,this.instance.localDescription.sdp));const r=up(e);return this.logger.debug(`REMOTE SDP 
`,`Type: ${e.type}`,`

`,e.sdp),this.instance.setRemoteDescription(r)}async _retrieveLocalStream(){if(Xt(this.options.localStream))return this.options.localStream;const e=await Gn(this.options);return Hn(e)}_attachListeners(){this.instance.addEventListener("signalingstatechange",()=>{switch(this.logger.debug("signalingState:",this.instance.signalingState),this.instance.signalingState){case"stable":this._negotiating=!1,this._restartingIce=!1,this.resetNeedResume(),this.instance.connectionState==="connected"&&this.emitMediaConnected();break;case"have-local-offer":{this.instance.iceGatheringState==="complete"&&(this.instance.removeEventListener("icecandidate",this._onIce),this._sdpReady());break}case"closed":delete this.instance;break;default:this._negotiating=!0}}),this.instance.addEventListener("connectionstatechange",()=>{switch(this.logger.debug("connectionState:",this.instance.connectionState),this.instance.connectionState){case"connecting":this._connectionStateTimer=setTimeout(()=>{this.logger.warn("connectionState timed out"),this._hasMoreCandidates()?this._retryWithMoreCandidates():this.restartIceWithRelayOnly()},this.options.maxConnectionStateTimeout);break;case"connected":this.clearConnectionStateTimer(),this.emitMediaConnected();break;case"disconnected":this.logger.debug("[test] Prevent reattach!");break;case"failed":{this.triggerResume();break}}}),this.instance.addEventListener("negotiationneeded",()=>{this.logger.debug("Negotiation needed event"),this.startNegotiation()}),this.instance.addEventListener("iceconnectionstatechange",()=>{this.logger.debug("iceConnectionState:",this.instance.iceConnectionState)}),this.instance.addEventListener("icegatheringstatechange",()=>{this.logger.debug("iceGatheringState:",this.instance.iceGatheringState),this.instance.iceGatheringState==="complete"&&(this.logger.debug("ICE gathering complete"),this._sdpReady())}),this.instance.addEventListener("track",e=>{this.call.emit("track",e),this.isSfu,this._remoteStream=e.streams[0]}),this.instance.addEventListener("addstream",e=>{e.stream&&(this._remoteStream=e.stream)}),this._attachAudioTrackListener(),this._attachVideoTrackListener()}clearTimers(){this.clearResumeTimer(),this.clearWatchMediaPacketsTimer(),this.clearConnectionStateTimer()}clearConnectionStateTimer(){clearTimeout(this._connectionStateTimer)}clearWatchMediaPacketsTimer(){clearTimeout(this._watchMediaPacketsTimer)}clearResumeTimer(){clearTimeout(this._resumeTimer),this._resumeTimer=void 0}emitMediaConnected(){this.call.emit("media.connected")}_onEndedTrackHandler(e){const r=e.target,o=r.kind==="audio"?"microphone":"camera";this.call.emit(`${o}.disconnected`,{deviceId:r.id,label:r.label})}_attachAudioTrackListener(){var e;(e=this.localStream)===null||e===void 0||e.getAudioTracks().forEach(r=>{r.addEventListener("ended",this._onEndedTrackHandler)})}_attachVideoTrackListener(){var e;(e=this.localStream)===null||e===void 0||e.getVideoTracks().forEach(r=>{r.addEventListener("ended",this._onEndedTrackHandler)})}_detachAudioTrackListener(){var e;(e=this.localStream)===null||e===void 0||e.getAudioTracks().forEach(r=>{r.removeEventListener("ended",this._onEndedTrackHandler)})}_detachVideoTrackListener(){var e;(e=this.localStream)===null||e===void 0||e.getVideoTracks().forEach(r=>{r.removeEventListener("ended",this._onEndedTrackHandler)})}setConfiguration(e){var r;this.rtcConfigPolyfill=e,this.instance&&typeof((r=this.instance)===null||r===void 0?void 0:r.setConfiguration)=="function"&&this.instance.setConfiguration(e)}getConfiguration(){var e;return this.instance&&typeof((e=this.instance)===null||e===void 0?void 0:e.getConfiguration)=="function"?this.instance.getConfiguration():this.rtcConfigPolyfill||this.config}}const Jp=t=>Ei(t.type),Yp=function*(t){w().debug("vertoEventWorker started");const{channels:e,instance:r,initialState:o}=t,{swEventChannel:n}=e,{rtcPeerId:s}=o;if(!s)throw new Error("Missing rtcPeerId for roomSubscribedWorker");const l=function*(v){var m,p;const{id:h,method:y,params:b={}}=v.payload,{callID:S,nodeId:k}=b,C=r.getRTCPeerById(S);if(!C){w().warn(`RTCPeer '${S}' not found for method: '${y}'`,b);return}const E=r.peer;switch(y){case"verto.media":case"verto.answer":{if(C.uuid===(E==null?void 0:E.uuid)){const $=y==="verto.media"?"early":"active";r.setState($)}b!=null&&b.sdp&&C.onRemoteSdp(b.sdp),yield tt(Ai.upsert({id:(m=v.payload.params)===null||m===void 0?void 0:m.callID,nodeId:(p=v.payload.params)===null||p===void 0?void 0:p.nodeId})),yield Ue([r,r.execute],{method:r._getRPCMethod(),params:{message:jn(h,y),node_id:k}});break}case"verto.bye":{yield Ue([r,r.onVertoBye],{rtcPeerId:S,byeCause:b==null?void 0:b.cause,byeCauseCode:b==null?void 0:b.causeCode,redirectDestination:b==null?void 0:b.redirectDestination}),yield Ue([r,r.execute],{method:r._getRPCMethod(),params:{message:jn(h,y),node_id:k}});break}case"verto.ping":{const{nodeId:$}=b,O=Fd(b,["nodeId"]);yield Ue([r,r.execute],{method:r._getRPCMethod(),params:{message:gv(O),node_id:$}});break}case"verto.mediaParams":{if(!S||!b.mediaParams){w().warn("Invalid mediaParams event",b);break}const{audio:$,video:O}=b.mediaParams;C&&O&&C.applyMediaConstraints("video",O),C&&$&&C.applyMediaConstraints("audio",$);break}case"verto.display":{r.setActiveRTCPeer(s),r.emit("verto.display",v.payload.params);break}default:return w().warn(`Unknown Verto method: ${y}`,b)}},c=ya.createCatchableSaga(l,v=>{w().error("Verto Error",v)});try{for(;;){const v=yield Te(n,m=>{var p;return w().debug(`vertoEventWorker for: ${s} checking action...`),Jp(m)?((p=m.payload.params)===null||p===void 0?void 0:p.callID)===s:!1});yield se(c,v)}}finally{w().debug(`vertoEventWorker for ${s} [cancelled]`)}},Xp=function*(t){var e;w().debug("roomSubscribedWorker started");const{channels:r,instance:o,initialState:n}=t,{swEventChannel:s}=r,{rtcPeerId:l}=n;if(!l)throw new Error("Missing rtcPeerId for roomSubscribedWorker");try{const c=yield Te(s,p=>p.type==="video.room.subscribed"||p.type==="call.joined"?p.payload.call_id===l:!1),v=JSON.parse(JSON.stringify(c.payload));o.setActiveRTCPeer(l);const m=c.payload.room_session.id||c.payload.room_session.room_session_id;yield tt(Ai.upsert({id:c.payload.call_id,roomId:(e=c.payload.room_session)===null||e===void 0?void 0:e.room_id,roomSessionId:m,memberId:c.payload.member_id,previewUrl:c.payload.room_session.preview_url})),o.emit("room.subscribed",c.payload),o.emit("room.joined",Qp.call(o,v)),w().debug("roomSubscribedWorker ended",l)}finally{w().debug(`roomSubscribedWorker for ${l} [cancelled]`)}};function Qp(t){return["room_session","room"].forEach(r=>{t[r]&&t[r].recordings&&(t[r].recordings=(t[r].recordings||[]).map(o=>{let n=this.instanceMap.get(o.id);return n?n.setPayload({room_id:t.room.room_id,room_session_id:t.room_session.id,recording:o}):n=z.createRoomSessionRecordingObject({store:this.store,payload:{room_id:t.room.room_id,room_session_id:t.room_session.id,recording:o}}),this.instanceMap.set(o.id,n),n})),t[r]&&t[r].playbacks&&(t[r].playbacks=(t[r].playbacks||[]).map(o=>{let n=this.instanceMap.get(o.id);return n?n.setPayload({room_id:t.room.room_id,room_session_id:t.room_session.id,playback:o}):n=z.createRoomSessionPlaybackObject({store:this.store,payload:{room_id:t.room.room_id,room_session_id:t.room_session.id,playback:o}}),this.instanceMap.set(o.id,n),n})),t[r]&&t[r].streams&&(t[r].streams=(t[r].streams||[]).map(o=>{let n=this.instanceMap.get(o.id);return n?n.setPayload({room_id:t.room.room_id,room_session_id:t.room_session.id,stream:o}):n=z.createRoomSessionStreamObject({store:this.store,payload:{room_id:t.room.room_id,room_session_id:t.room_session.id,stream:o}}),this.instanceMap.set(o.id,n),n}))}),t}const Zp=function*(t){w().debug("promoteDemoteWorker started");const{channels:e,instance:r,initialState:o}=t,{swEventChannel:n}=e,{rtcPeerId:s}=o;if(!s)throw new Error("Missing rtcPeerId for promoteDemoteWorker");try{const l=yield Te(n,p=>p.type==="video.member.promoted"||p.type==="video.member.demoted"?p.payload.member_id===r.memberId:!1);w().debug("promoteDemoteWorker:",l.type,l.payload),yield tt(Mr.updateAuthorization(l.payload.authorization));const c=yield Ns(ti.getAuthorization);if(!c)throw new Error(`Invalid authorization for '${l.type}'`);const{audio_allowed:v,video_allowed:m}=c;switch(l.type){case"video.member.promoted":r.updateMediaOptions({audio:v==="both",video:m==="both",negotiateAudio:v!=="none",negotiateVideo:m!=="none"});break;case"video.member.demoted":r.updateMediaOptions({audio:!1,video:!1,negotiateAudio:v!=="none",negotiateVideo:m!=="none"});break}r._triggerNewRTCPeer(),w().debug("promoteDemoteWorker ended",s)}finally{w().debug(`promoteDemoteWorker for ${s} [cancelled]`)}},ef=function*(t){w().debug("sessionAuthWorker started");const{instance:e}=t;switch((yield Te([ze.authSuccessAction.type,ze.authErrorAction.type])).type){case ze.authSuccessAction.type:yield Ue([e,e.resume]);break;case ze.authErrorAction.type:yield Ue([e,e.setState],"hangup");break}w().debug("sessionAuthWorker ended")},tf=function*(t){var e;const r=w();r.debug("sessionConnectionPoolWorker started");const o=t.initialState||{};try{r.debug("Waiting for session/connected action");const s=((e=(yield Te("session/connected")).payload)===null||e===void 0?void 0:e.ice_servers)||[];if(!s||s.length===0){r.warn("No ICE servers available, cannot initialize connection pool");return}r.info("Session authorized, initializing connection pool"),yield Ue([cr,cr.initializePool],s,o),r.info("Connection pool initialized successfully"),yield Te(ze.sessionDisconnectedAction.type),r.info("Session disconnected, cleaning up connection pool"),yield Ue([cr,cr.cleanup])}catch(n){r.error("Error in sessionConnectionPoolWorker",n)}finally{r.debug("sessionConnectionPoolWorker ended")}},rf=1e3,en={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},of=Object.assign(Object.assign({},en),{noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1}),nl={width:{ideal:1280,min:320},height:{ideal:720,min:180},aspectRatio:{ideal:16/9}},nf={destinationNumber:"room",remoteCallerName:"Outbound Call",remoteCallerNumber:"",callerName:"",callerNumber:"",audio:en,video:nl,useStereo:!1,attach:!1,screenShare:!1,additionalDevice:!1,userVariables:{},requestTimeout:10*1e3,autoApplyMediaParams:!0,iceGatheringTimeout:2*1e3,maxIceGatheringTimeout:5*1e3,maxConnectionStateTimeout:3*1e3,watchMediaPackets:!0,watchMediaPacketsTimeout:2*1e3};class tn extends zt{constructor(e){super(e),this.leaveReason=void 0,this.gotEarly=!1,this.state="new",this.prevState="new",this.rtcPeerMap=new Map,this.resuming=!1,this._myWorkers=[],this.onVertoBye=r=>{this.logger.debug("onVertoBye",r);const{rtcPeerId:o,byeCause:n="NORMAL_CLEARING",byeCauseCode:s="16",redirectDestination:l}=r;this.cause=String(n),this.causeCode=String(s);const c=this.getRTCPeerById(o);if(!c)return this.logger.warn("Invalid RTCPeer to hangup",r);if(l&&c.localSdp){this.logger.debug("Redirect Destination to:",l,"for RTCPeer:",c.uuid),this.executeInvite(c.localSdp,c.uuid,l);return}c.onRemoteBye({code:this.causeCode,message:this.cause}),this.activeRTCPeerId===(c==null?void 0:c.uuid)&&(this.logger.debug("onVertoBye go hangup"),this.setState("hangup"))},this.options=Object.assign(Object.assign({},nf),e),this._checkDefaultMediaConstraints(),this.setState("new"),this.logger.trace("New Call with Options:",this.options),this._initPeer()}get id(){return this.__uuid}get active(){return this.state==="active"}get requesting(){return this.state==="requesting"}get trying(){return this.state==="trying"}get memberId(){return this.component.memberId}get previewUrl(){return this.component.previewUrl}get roomId(){return this.component.roomId}get roomSessionId(){return this.component.roomSessionId}get nodeId(){return this.component.nodeId||this.options.nodeId}get callId(){var e;return((e=this.peer)===null||e===void 0?void 0:e.uuid)||""}get localStream(){var e;return(e=this.peer)===null||e===void 0?void 0:e.localStream}set localStream(e){this.peer&&(this.peer.localStream=e)}get remoteStream(){var e;return(e=this.peer)===null||e===void 0?void 0:e.remoteStream}get iceServers(){var e,r;return(r=(e=this.options)===null||e===void 0?void 0:e.iceServers)!==null&&r!==void 0?r:this.select(ti.getIceServers)}get component(){return this.select(e=>Di.getComponent(e,this.callId))||{}}get cameraId(){return this.peer?this.peer.getDeviceId("video"):null}get cameraLabel(){return this.peer?this.peer.getDeviceLabel("video"):null}get cameraConstraints(){return this.peer?this.peer.getTrackConstraints("video"):null}get microphoneId(){return this.peer?this.peer.getDeviceId("audio"):null}get microphoneLabel(){return this.peer?this.peer.getDeviceLabel("audio"):null}get microphoneConstraints(){return this.peer?this.peer.getTrackConstraints("audio"):null}get withAudio(){var e;return!!(!((e=this.peer)===null||e===void 0)&&e.hasAudioReceiver)}get withVideo(){var e;return!!(!((e=this.peer)===null||e===void 0)&&e.hasVideoReceiver)}get localAudioTrack(){return this.peer?this.peer.localAudioTrack:null}get localVideoTrack(){return this.peer?this.peer.localVideoTrack:null}get peer(){return this.getRTCPeerById(this.activeRTCPeerId)}set peer(e){if(!e){this.logger.warn("Invalid RTCPeer",e);return}if(this.logger.debug("Set RTCPeer",e.uuid,e),this.rtcPeerMap.set(e.uuid,e),this.peer&&this.peer.instance&&this.callId!==e.uuid){const r=this.peer.uuid;this.logger.debug(">>> Stop old RTCPeer",r),this.hangup(r).catch(console.error),this.peer.detachAndStop()}this.logger.debug(">>> Replace RTCPeer with",e.uuid),this.activeRTCPeerId=e.uuid}emit(e,...r){return super.emit(e,...r)}dialogParams(e){const{destinationNumber:r,attach:o,callerName:n,callerNumber:s,remoteCallerName:l,remoteCallerNumber:c,userVariables:v,screenShare:m,additionalDevice:p,fromFabricAddressId:h,pingSupported:y=!0}=this.options;return{dialogParams:{id:e,destinationNumber:r,attach:o,reattaching:o,callerName:n,callerNumber:s,remoteCallerName:l,remoteCallerNumber:c,userVariables:v,screenShare:m,additionalDevice:p,fromFabricAddressId:h,pingSupported:y,version:rf}}}getRTCPeerById(e){return this.rtcPeerMap.get(e)}appendRTCPeer(e){return this.rtcPeerMap.set(e.uuid,e)}removeRTCPeer(e){return this.rtcPeerMap.delete(e)}setActiveRTCPeer(e){this.peer=this.getRTCPeerById(e)}setLocalStream(e){return new Promise(async(r,o)=>{try{if(!this.peer||!this.localStream)return o(new Error("Invalid RTCPeerConnection."));if(!Xt(e))return o(new Error("Invalid stream provided."));const n=this.localStream.getAudioTracks(),s=e.getAudioTracks();s.length<=0?this.logger.info("No audio track found in the stream provided. Audio will be unaffected."):(n.forEach(v=>{var m;At(v),(m=this.localStream)===null||m===void 0||m.removeTrack(v)}),s.forEach(v=>{var m;(m=this.localStream)===null||m===void 0||m.addTrack(v)}));const l=this.localStream.getVideoTracks(),c=e.getVideoTracks();c.length<=0?this.logger.info("No video track found in the stream provided. Video will be unaffected."):(l.forEach(v=>{var m;At(v),(m=this.localStream)===null||m===void 0||m.removeTrack(v)}),c.forEach(v=>{var m;(m=this.localStream)===null||m===void 0||m.addTrack(v)})),await this.updateStream(this.localStream),this.logger.debug("setLocalStream done"),r(this.localStream)}catch(n){this.logger.error("setLocalStream",n),o(n)}})}vertoExecute(e){return this.execute({method:this._getRPCMethod(),params:e})}_getRPCMethod(){const e=this.select(ti.getAuthorization);return e&&aa(e)?"webrtc.verto":"video.message"}async _triggerNewRTCPeer(){this.logger.debug("_triggerNewRTCPeer Start");try{this.logger.debug("Build a new RTCPeer");const e=this._buildPeer("offer");this.logger.debug("Trigger start for the new RTCPeer!"),await e.start()}catch(e){this.logger.error("Error building new RTCPeer to promote/demote",e)}}updateCamera(e){return this.applyConstraintsAndRefreshStream({video:Object.assign({aspectRatio:16/9},e)})}updateMicrophone(e){return this.applyConstraintsAndRefreshStream({audio:e})}_getTransceiverDirection(e){let r="inactive";return e==="audio"&&(this.options.audio&&this.options.negotiateAudio?r="sendrecv":this.options.audio&&!this.options.negotiateAudio?r="sendonly":!this.options.audio&&this.options.negotiateAudio?r="recvonly":r="inactive"),e==="video"&&(this.options.video&&this.options.negotiateVideo?r="sendrecv":this.options.video&&!this.options.negotiateVideo?r="sendonly":!this.options.video&&this.options.negotiateVideo?r="recvonly":r="inactive"),r}manageSendersWithConstraints(e){return e.audio===!1&&(this.logger.info("Switching off the microphone"),this.stopOutboundAudio()),e.video===!1&&(this.logger.info("Switching off the camera"),this.stopOutboundVideo()),e.audio||e.video}updateConstraints(e,{attempt:r=0}={}){return r>1?Promise.reject(new Error("Failed to update constraints")):new Promise(async(o,n)=>{var s;try{if(!this.peer)return n(new Error("Invalid RTCPeerConnection."));if(!Object.keys(e).length)return n(new Error("Invalid audio/video constraints."));if(this.logger.debug("updateConstraints trying constraints",this.__uuid,e),!this.manageSendersWithConstraints(e))return this.logger.debug("Either `video` and `audio` (or both) constraints were set to `false` so their corresponding senders (if any) were stopped"),o();let c={};(s=this.localStream)===null||s===void 0||s.getTracks().forEach(m=>{var p;c[m.kind]=m.getConstraints(),e[m.kind]!==void 0&&(this.logger.debug("updateConstraints stop old tracks first?"),this.logger.debug("Track readyState:",m.kind,m.readyState),At(m),m.stop(),(p=this.localStream)===null||p===void 0||p.removeTrack(m))});let v;try{this.logger.info("updateConstraints with",e),v=await rr(e)}catch(m){return this.logger.error("Error updating device constraints:",m.name,m.message,m),this.logger.info("Restoring previous constraints",c),await this.updateConstraints(c,{attempt:r+1}),n(m)}this.logger.debug("updateConstraints done"),o(v)}catch(l){this.logger.error("updateConstraints",l),n(l)}})}async updateStream(e){try{if(!this.peer)throw new Error("Invalid RTCPeerConnection.");const r=this.localVideoTrack,o=this.localAudioTrack;this.logger.debug("updateStream got stream",e),this.localStream||(this.localStream=new MediaStream);const n=e.getTracks();this.logger.debug(`updateStream got ${n.length} tracks`);for(const s of n)this.logger.debug("updateStream apply track: ",s),await this.handleTransceiverForTrack(s),this.emitDeviceUpdatedEvents({newTrack:s,prevAudioTrack:o,prevVideoTrack:r});this.logger.debug("updateStream done")}catch(r){throw this.logger.error("updateStream error",r),r}}async handleTransceiverForTrack(e){var r,o;if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");const n=this.peer.instance.getTransceivers().find(({mid:s,sender:l,receiver:c})=>l.track&&l.track.kind===e.kind?(this.logger.debug("Found transceiver by sender"),!0):c.track&&c.track.kind===e.kind?(this.logger.debug("Found transceiver by receiver"),!0):s===null?(this.logger.debug("Found disassociated transceiver"),!0):!1);if(n){this.logger.debug("handleTransceiverForTrack got transceiver",n.currentDirection,n.mid),((r=n.sender.track)===null||r===void 0?void 0:r.id)!==e.id&&(await n.sender.replaceTrack(e),this.logger.debug(`handleTransceiverForTrack replaceTrack for ${e.kind}`));const s=this._getTransceiverDirection(e.kind);n.direction!==s&&(n.direction=s,this.logger.debug(`handleTransceiverForTrack set direction to ${s}`)),this.replaceOldTrack(e)}else{this.logger.debug("handleTransceiverForTrack no transceiver found; addTransceiver and start dancing!");const s=this._getTransceiverDirection(e.kind);this.peer.type="offer",(o=this.localStream)===null||o===void 0||o.addTrack(e),this.peer.instance.addTransceiver(e,{direction:s,streams:[this.localStream]})}}replaceOldTrack(e){if(!this.peer||!this.localStream)return this.logger.error("Invalid RTCPeerConnection");this.peer._detachAudioTrackListener(),this.peer._detachVideoTrackListener(),this.localStream.getTracks().forEach(r=>{var o;r.kind===e.kind&&r.id!==e.id&&(this.logger.debug("replaceOldTrack stop old track and apply new one"),At(r),(o=this.localStream)===null||o===void 0||o.removeTrack(r))}),this.localStream.addTrack(e),e.kind==="audio"&&(this.options.micId=e.getSettings().deviceId),e.kind==="video"&&(this.options.camId=e.getSettings().deviceId),this.peer._attachAudioTrackListener(),this.peer._attachVideoTrackListener()}emitDeviceUpdatedEvents({newTrack:e,prevAudioTrack:r,prevVideoTrack:o}){e.kind==="audio"?this.emit("microphone.updated",{previous:{deviceId:r==null?void 0:r.id,label:r==null?void 0:r.label},current:{deviceId:e.id,label:e.label}}):e.kind==="video"&&this.emit("camera.updated",{previous:{deviceId:o==null?void 0:o.id,label:o==null?void 0:o.label},current:{deviceId:e.id,label:e.label}})}async applyConstraintsAndRefreshStream(e){const r=await this.updateConstraints(e);r&&await this.updateStream(r)}runRTCPeerWorkers(e){const r=this.runWorker("vertoEventWorker",{worker:Yp,initialState:{rtcPeerId:e}});if(this._myWorkers.push(r),!(this.options.additionalDevice||this.options.screenShare)){const n=this.runWorker("roomSubscribedWorker",{worker:Xp,initialState:{rtcPeerId:e}});this._myWorkers.push(n);const s=this.runWorker("promoteDemoteWorker",{worker:Zp,initialState:{rtcPeerId:e}});this._myWorkers.push(s)}}removeRTCWorkers(){for(const e of this._myWorkers)this.cancelWorker(e);this._myWorkers=[]}_destroyPeer(){this.peer&&(this.peer.detachAndStop(),this.removeRTCWorkers(),this.removeRTCPeer(this.peer.uuid),this.peer=void 0)}invite(){return Ii({asyncCallable:async()=>new Promise(async(e,r)=>{await this._waitUntilSessionAuthorized(),this.direction="outbound",this.peer=this._buildPeer("offer");try{await this.peer.start(),e(this)}catch(o){this.logger.error("Invite error",o),this._destroyPeer(),r(o)}}),maxRetries:5,delayFn:Ju({initialDelay:0}),expectedErrorHandler:e=>this.requesting&&[Ci,Ti].includes(e)?(this.logger.debug("Retrying verto.invite with new RTCPeer"),!1):!0})}answer(){return new Promise(async(e,r)=>{this.direction="inbound",this.peer||(this.peer=this._buildPeer("answer"));try{await this.peer.start(),e(this)}catch(o){this.logger.error("Answer error",o),r(o)}})}async onLocalSDPReady(e){if(!e.instance.localDescription)throw this.logger.error("Missing localDescription",e),new Error("Invalid RTCPeerConnection localDescription");const{type:r,sdp:o}=e.instance.localDescription,n=this._mungeSDP(o);switch(this.logger.debug(`LOCAL SDP 
`,`Type: ${r}`,`

`,n),r){case"offer":return this._watchSessionAuth(),!this.resuming&&e.instance.remoteDescription?this.executeUpdateMedia(n,e.uuid):this.executeInvite(n,e.uuid);case"answer":return this.executeAnswer(n,e.uuid);default:return this.logger.error(`Unknown SDP type: '${r}' on call ${this.id}`)}}_closeWSConnection(){this._watchSessionAuth(),this.store.dispatch(ze.sessionForceCloseAction())}_watchSessionAuth(){this.sessionAuthTask&&this.sessionAuthTask.cancel(),this.sessionAuthTask=this.runWorker("sessionAuthWorker",{worker:ef})}async resume(){var e;if(this.logger.warn(`[resume] Call ${this.id}`),!((e=this.peer)===null||e===void 0)&&e.instance){const{connectionState:r}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${r}'`),r!=="closed"&&(this.resuming=!0,this.peer.restartIce())}}async executeInvite(e,r,o){const n=this.getRTCPeerById(r);if(!n||n.instance.remoteDescription&&!this.resuming)throw new Error(`RTCPeer '${r}' already has a remoteDescription. Invalid invite.`);this.state==="new"&&this.setState("requesting");try{const s=this.options.screenShare?{layout:this.options.layout,positions:this.options.positions}:{},l=mv(Object.assign(Object.assign(Object.assign({},this.dialogParams(r)),s),{sdp:e}));let c=[];this.options.screenShare?c=["video.room.screenshare"]:this.options.additionalDevice?c=["video.room.additionaldevice"]:c=this.getSubscriptions(),this.logger.debug("Subscribing to",c);const v=await this.vertoExecute({message:l,callID:r,node_id:o??this.options.nodeId,subscribe:c});this.state==="requesting"&&this.setState("trying"),this.logger.debug("Invite response",v),this.resuming=!1}catch(s){throw this.setState("hangup"),s}}async executeAnswer(e,r,o){this.state==="new"&&this.setState("answering");try{const n=fv(Object.assign(Object.assign({},this.dialogParams(r)),{sdp:e})),s=await this.vertoExecute({message:n,callID:r,node_id:o??this.options.nodeId,subscribe:this.getSubscriptions()});this.logger.debug("Answer response",s),this.resuming=!1,this.setActiveRTCPeer(r)}catch(n){throw this.setState("hangup"),n}}async executeUpdateMedia(e,r){var o,n;try{const s=Fo(Object.assign(Object.assign({},this.dialogParams(r)),{sdp:e,action:"updateMedia"})),l=await this.vertoExecute({message:s,callID:r,node_id:this.nodeId});if(this.logger.debug("UpdateMedia response",l),!this.peer)return this.logger.error("Invalid RTCPeer to updateMedia");if(!l.sdp)return this.logger.error("UpdateMedia invalid SDP answer",l);await this.peer.onRemoteSdp(l.sdp)}catch(s){throw this.logger.error("UpdateMedia error",s),(n=(o=this.peer)===null||o===void 0?void 0:o._pendingNegotiationPromise)===null||n===void 0||n.reject(s),s}}async hangup(e){const r=e??this.callId;if(!r)throw new Error("Invalid RTCPeer ID to hangup");try{const o=Qo(this.dialogParams(r));await this.vertoExecute({message:o,callID:r,node_id:this.nodeId})}catch(o){this.logger.error("Hangup error:",o)}finally{if(r!==this.callId)return this.logger.warn("Prevent setState hangup",r,this.callId);this.setState("hangup")}}async hangupAll(){const e=this.callId;if(!e)throw new Error("Invalid RTCPeer ID to hangup");try{const r=Qo(Object.assign({cause:"REJECT_ALL",causeCode:"825"},this.dialogParams(e)));await this.vertoExecute({message:r,callID:e,node_id:this.nodeId})}catch(r){this.logger.error("HangupAll error:",r)}finally{this.setState("hangup")}}async sendDigits(e){const r=this.callId;if(!r)throw new Error("Invalid RTCPeer ID to send DTMF");const o=pv(Object.assign(Object.assign({},this.dialogParams(r)),{dtmf:e}));await this.vertoExecute({message:o,callID:r,node_id:this.nodeId})}doReinviteWithRelayOnly(){this.peer&&this.active&&this.peer.restartIceWithRelayOnly()}stopOutboundAudio(){this.peer&&this.active&&this.peer.stopTrackSender("audio")}restoreOutboundAudio(){this.peer&&this.active&&this.peer.restoreTrackSender("audio")}stopOutboundVideo(){this.peer&&this.active&&this.peer.stopTrackSender("video")}restoreOutboundVideo(){this.peer&&this.active&&this.peer.restoreTrackSender("video")}setState(e){switch(this.prevState=this.state,this.state=e,this.logger.trace(`Call ${this.id} state change from ${this.prevState} to ${this.state}`),this.emit(this.state,this),e){case"purge":{this._finalize();break}case"hangup":{this.setState("destroy");break}case"destroy":this._finalize();break}}updateMediaOptions(e){this.logger.debug("updateMediaOptions",Object.assign({},e)),this.options=Object.assign(Object.assign({},this.options),e),this._checkDefaultMediaConstraints()}_mungeSDP(e){return Up(e)}_checkDefaultMediaConstraints(){this.options.video===!0&&(this.options.video=nl),this.options.audio===!0&&(this.options.audio=this.options.screenShare?of:en)}_initPeer(){this.options.remoteSdp&&(this.peer=this._buildPeer("answer"))}_buildPeer(e){const r=new Kp(this,e);return this.appendRTCPeer(r),this.runRTCPeerWorkers(r.uuid),r}_finalize(){this.rtcPeerMap.forEach(e=>{e.stop()}),this.rtcPeerMap.clear()}_upsertTransceiverByKind(e,r){if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");let o=this.peer.instance.getTransceivers().find(n=>{var s,l;return((s=n.sender.track)===null||s===void 0?void 0:s.kind)===r||((l=n.receiver.track)===null||l===void 0?void 0:l.kind)===r});if(o){if(o.direction===e){this.logger.info(`Transceiver ${r} has the same direction "${e}".`);return}o.direction=e,this.logger.info(`Updated ${r} transceiver to "${e}" mode.`)}else e!=="inactive"&&(this.peer.type="offer",o=this.peer.instance.addTransceiver(r,{direction:e}),this.logger.info(`Added ${r} transceiver in "${e}" mode.`));e==="stopped"||e==="inactive"?(this.peer.stopTrackReceiver(r),this.peer.stopTrackSender(r)):e==="sendonly"?this.peer.stopTrackReceiver(r):e==="recvonly"&&this.peer.stopTrackSender(r)}async updateMedia(e){var r,o,n,s,l,c;try{const{audio:v,video:m}=e;if(!this.peer)throw new Error("Invalid RTCPeerConnection");if(this.peer.isNegotiating)throw new Error("The peer is already negotiating the media!");const p=this.peer,h=new Promise((C,E)=>{p._pendingNegotiationPromise={resolve:C,reject:E}}),y=["sendonly","sendrecv"].includes((v==null?void 0:v.direction)||""),b=["sendonly","sendrecv"].includes((m==null?void 0:m.direction)||""),S=["sendrecv","receive"].includes((v==null?void 0:v.direction)||""),k=["sendrecv","receive"].includes((m==null?void 0:m.direction)||"");if(this.updateMediaOptions(Object.assign(Object.assign(Object.assign(Object.assign({},v&&{audio:(r=v==null?void 0:v.constraints)!==null&&r!==void 0?r:y}),m&&{video:(o=m==null?void 0:m.constraints)!==null&&o!==void 0?o:b}),v&&{negotiateAudio:S}),m&&{negotiateVideo:k})),await this.applyConstraintsAndRefreshStream(Object.assign(Object.assign({},v&&{audio:(n=v==null?void 0:v.constraints)!==null&&n!==void 0?n:y}),m&&{video:(s=m==null?void 0:m.constraints)!==null&&s!==void 0?s:b})),v&&!y&&this._upsertTransceiverByKind(v.direction,"audio"),m&&!b&&this._upsertTransceiverByKind(m.direction,"video"),await this.peer.startNegotiation(),await h,!Zn({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"audio"}))throw new Error("The server did not set the audio direction correctly");if(!Zn({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"video"}))throw new Error("The server did not set the video direction correctly")}catch(v){throw(c=(l=this.peer)===null||l===void 0?void 0:l._pendingNegotiationPromise)===null||c===void 0||c.reject(v),v}}async setAudioDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({audio:{direction:e}})}async setVideoDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({video:{direction:e}})}async hold(){const e=Fo(Object.assign(Object.assign({},this.dialogParams(this.callId)),{action:"hold"}));await this.vertoExecute({message:e,callID:this.callId,node_id:this.nodeId})}async unhold(){const e=Fo(Object.assign(Object.assign({},this.dialogParams(this.callId)),{action:"unhold"}));this.vertoExecute({message:e,callID:this.callId,node_id:this.nodeId})}}function ii(t){this.message=t}ii.prototype=new Error,ii.prototype.name="InvalidCharacterError";var is=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new ii("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,o,n=0,s=0,l="";o=e.charAt(s++);~o&&(r=n%4?64*r+o:o,n++%4)?l+=String.fromCharCode(255&r>>(-2*n&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return l};function sf(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(r){return decodeURIComponent(is(r).replace(/(.)/g,function(o,n){var s=n.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch{return is(e)}}function ro(t){this.message=t}function oo(t,e){if(typeof t!="string")throw new ro("Invalid token specified");var r=(e=e||{}).header===!0?0:1;try{return JSON.parse(sf(t.split(".")[r]))}catch(o){throw new ro("Invalid token specified: "+o.message)}}ro.prototype=new Error,ro.prototype.name="InvalidTokenError";var sl=Object.defineProperty,af=Object.defineProperties,lf=Object.getOwnPropertyDescriptors,io=Object.getOwnPropertySymbols,al=Object.prototype.hasOwnProperty,ll=Object.prototype.propertyIsEnumerable,ni=(t,e,r)=>e in t?sl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,J=(t,e)=>{for(var r in e||(e={}))al.call(e,r)&&ni(t,r,e[r]);if(io)for(var r of io(e))ll.call(e,r)&&ni(t,r,e[r]);return t},le=(t,e)=>af(t,lf(e)),Rt=(t,e)=>{var r={};for(var o in t)al.call(t,o)&&e.indexOf(o)<0&&(r[o]=t[o]);if(t!=null&&io)for(var o of io(t))e.indexOf(o)<0&&ll.call(t,o)&&(r[o]=t[o]);return r},xr=(t,e)=>{for(var r in e)sl(t,r,{get:e[r],enumerable:!0})},ne=(t,e,r)=>ni(t,typeof e!="symbol"?e+"":e,r),df={};xr(df,{ChatMember:()=>zi,ChatMessage:()=>Bi,Client:()=>Oh});var cf=({track:t,element:e})=>(e.autoplay=!0,e.playsinline=!0,e.srcObject=new MediaStream([t]),t.addEventListener("ended",()=>{e.srcObject=null,e.remove()}),e),dl=ze.createAction("swJs/audioSetSpeakerAction"),cl=({speakerId:t})=>function*({instance:r,runSaga:o}){if(typeof Audio>"u"){w().warn("`Audio` is not supported on this environment.");return}try{const n=r.getAudioEl();let s;const l=function(c){switch(c.track.kind){case"audio":{s=o(vf,{track:c.track,element:n,speakerId:t,room:r});break}}};r.on("track",l),r.once("destroy",()=>{s==null||s.cancel()})}catch(n){w().error("audioElementSaga",n)}};function*uf({element:t,room:e}){const r=ze.getCustomSagaActionType(e.__uuid,dl);for(;;){const o=yield Te([r]);try{switch(o.type){case r:const n=yield Ue(Ki,t,o.payload);e.emit(`${ki}.speaker.updated`,o.payload),e.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:n,kind:"resolve"});break}}catch(n){e.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:n,kind:"reject"}),w().error(n)}}}function*vf({track:t,element:e,speakerId:r,room:o}){cf({track:t,element:e}),r&&Ki(e,r).catch(()=>{}),yield se(uf,{element:e,room:o})}var mf=function*(t){w().trace("videoManagerRoomsWorker started");const{instance:e,action:{type:r,payload:o}}=t,n={rooms:o.rooms.map(s=>rt(s))};e.emit(Ot(r),n),w().trace("videoManagerRoomsWorker ended")},pf=function*(t){w().trace("videoManagerRoomWorker started");const{instance:e,action:{type:r,payload:o}}=t;e.emit(Ot(r),rt(o)),w().trace("videoManagerRoomWorker ended")},ff=function*(t){w().trace("videoManagerWorker started");const{channels:{swEventChannel:e}}=t;function*r(o){const{type:n}=o;switch(n){case"video-manager.rooms.subscribed":yield se(mf,J({action:o},t));break;case"video-manager.room.added":case"video-manager.room.deleted":case"video-manager.room.ended":case"video-manager.room.started":case"video-manager.room.updated":yield se(pf,J({action:o},t));break;default:w().warn(`Unknown video-manager event: "${n}"`);break}}for(;;){const o=yield Te(e,n=>n.type.startsWith("video-manager."));yield se(r,o)}w().trace("videoManagerWorker ended")},hf=class extends Ia{constructor(t){super(t),this.runWorker("videoManagerWorker",{worker:ff})}getSubscriptions(){const t=this.eventNames().map(e=>`video-manager.${e}`);return Tr(t)}},gf=t=>{const e=ot({store:t.store,Component:hf})(t);return new Proxy(e,{get(o,n,s){return n==="_eventsNamespace"?"":n==="eventChannel"?"video-manager.rooms":Reflect.get(o,n,s)}})},_f={echoCancellation:!0,noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1},yf=t=>{const{authorization:e,audio:r=!0,video:o=!0,sendAudio:n,sendVideo:s,receiveAudio:l,receiveVideo:c}=t;w().debug("getJoinMediaParams options",J({},t));const{audio_allowed:v,video_allowed:m,join_as:p}=e,y=(p??"member")==="member",b=y&&v==="both",S=y&&m==="both",k=v!=="none",C=m!=="none",E=!!(n??r),$=!!(s??o),O=!!(l??r),q=!!(c??o);return!b&&E&&w().info("Not allowed to send audio on this room. Default values will be used."),!S&&$&&w().info("Not allowed to send video on this room. Default values will be used."),!k&&O&&w().info("Not allowed to receive video from the room. Default values will be used."),!C&&q&&w().info("Not allowed to receive video from the room. Default values will be used."),{mustSendAudio:b&&E,mustSendVideo:S&&$,mustRecvAudio:k&&O,mustRecvVideo:C&&q}},bf=t=>Object.values(t).some(Boolean),ul="sw-sdk-",wf=t=>`${ul}${t}`,vl="sw-overlay-",ml=t=>`${vl}${t}`,Sf=class extends tn{join(){return super.invite()}leave(){return super.hangup()}},kf=po(Sf,{audioMute:z.audioMuteMember,audioUnmute:z.audioUnmuteMember,videoMute:z.videoMuteMember,videoUnmute:z.videoUnmuteMember,setMicrophoneVolume:z.setInputVolumeMember,setInputVolume:z.setInputVolumeMember,setInputSensitivity:z.setInputSensitivityMember}),Cf=()=>{},rn="memberList.updated",Tf=qu({event:rn}),si=nv(Tf),pl=["video.room.joined","video.member.joined","video.member.left","video.member.updated"],Ef=t=>pl.includes(t),If=t=>Tr(pl).filter(e=>!t.includes(e)),Mf=t=>t.some(e=>e.includes(rn)),Pf=t=>t.type==="video.room.joined"?t.payload.room_session.members:[t.payload.member],Af=({action:t,memberList:e})=>{const r=Pf(t);switch(t.type){case"video.member.left":r.forEach(o=>{e.delete(o.id)});break;default:r.forEach(o=>{e.set(o.id,o)})}return Array.from(e.values())},xf=(t,e)=>{If(e).forEach(s=>{t.once(s,Cf)});const o=({members:s})=>{t.emit(rn,{members:s})};return t.on(si,o),{cleanup:()=>{t.off(si,o)}}};function*Rf({swEventChannel:t,instance:e}){const r=new Map;function*o(n){const s=n.type==="video.room.joined"?n.payload.room_session.id:n.payload.room_session_id,l=Af({action:n,memberList:r}),c={room_session_id:s,members:l};e.emit(si,c)}for(;;){const n=yield Te(t,({type:s})=>Ef(s));yield se(o,n)}}var Lf=function*({channels:{swEventChannel:e},instance:r}){const o=r.getSubscriptions();if(!Mf(o))return;const{cleanup:n}=xf(r,o);yield se(Rf,{swEventChannel:e,instance:r}),r.once("destroy",()=>{n()})},fl=function*(t){w().trace("childMemberJoinedWorker started");const{channels:e,instance:r,initialState:o,onDone:n,onFail:s}=t,{swEventChannel:l}=e,{parentId:c}=o;if(!c)throw new Error("Missing parentId for childMemberJoinedWorker");const v=yield Te(l,p=>p.type==="video.member.joined"?p.payload.member.parent_id===c:!1),{member:m}=v.payload;if(m!=null&&m.parent_id){const p=yield Ns(Di.getComponentsById);Object.values(p).find(y=>"memberId"in y&&y.memberId===m.parent_id)?(yield tt(Ai.upsert({id:r.callId,roomId:v.payload.room_id,roomSessionId:v.payload.room_session_id,memberId:m.id})),n==null||n()):s==null||s({error:new Error("Unknown parent_id")})}w().trace("childMemberJoinedWorker ended")},Of=function*(t){w().trace("videoStreamWorker started");const{instance:e,action:{type:r,payload:o},instanceMap:{get:n,set:s,remove:l}}=t;let c=n(o.stream.id);switch(c?c.setPayload(o):c=z.createRoomSessionStreamObject({store:e.store,payload:o}),s(o.stream.id,c),r){case"video.stream.started":e.emit("stream.started",c);break;case"video.stream.ended":e.emit("stream.ended",c),l(o.stream.id);break;default:w().warn(`Unknown video.stream event: "${r}"`);break}w().trace("videoStreamWorker ended")},Vf=function*(t){w().trace("videoRecordWorker started");const{instance:e,action:{type:r,payload:o},instanceMap:{get:n,set:s,remove:l}}=t;let c=n(o.recording.id);c?c.setPayload(o):c=z.createRoomSessionRecordingObject({store:e.store,payload:o}),s(o.recording.id,c);const v=Ot(r);switch(r){case"video.recording.started":case"video.recording.updated":{e.emit(v,c);break}case"video.recording.ended":e.emit(v,c),l(o.recording.id);break;default:w().warn(`Unknown video.stream event: "${r}"`);break}w().trace("videoRecordWorker ended")},Df=function*(t){w().trace("videoPlaybackWorker started");const{instance:e,action:{type:r,payload:o},instanceMap:{get:n,set:s,remove:l}}=t;let c=n(o.playback.id);c?c.setPayload(o):c=z.createRoomSessionPlaybackObject({store:e.store,payload:o}),s(o.playback.id,c);const v=Ot(r);switch(r){case"video.playback.started":case"video.playback.updated":{e.emit(v,c);break}case"video.playback.ended":e.emit(v,c),l(o.playback.id);break;default:w().warn(`Unknown video.stream event: "${r}"`);break}w().trace("videoPlaybackWorker ended")},Nf=function*(t){w().trace("videoWorker started");const{channels:e,instance:r}=t,{swEventChannel:o}=e;function*n(l){const{type:c,payload:v}=l;switch(c){case"video.room.subscribed":yield se(Hi.memberPositionWorker,le(J({},t),{instance:r,initialState:v}));return;case"video.playback.started":case"video.playback.updated":case"video.playback.ended":yield se(Df,J({action:l},t));return;case"video.recording.started":case"video.recording.updated":case"video.recording.ended":yield se(Vf,J({action:l},t));return;case"video.stream.ended":case"video.stream.started":yield se(Of,J({action:l},t));return;case"video.room.audience_count":{r.emit("room.audienceCount",v);return}case"video.member.talking":{const{member:p}=v;if("talking"in p){const h=p.talking?"started":"ended";r.emit(`member.talking.${h}`,v);const y=p.talking?"start":"stop";r.emit(`member.talking.${y}`,v)}break}case"video.layout.changed":{r.currentLayoutEvent=l.payload;break}}const m=Ot(c,"video");r.emit(m,v)}const s=l=>l.type.startsWith("video.");for(;;){const l=yield Te(o,s);yield se(n,l)}w().trace("videoWorker ended")},hl=class extends tn{constructor(){super(...arguments),ne(this,"_screenShareList",new Set),ne(this,"_audioEl"),ne(this,"_overlayMap"),ne(this,"_localVideoOverlay")}get audioEl(){return this._audioEl}set overlayMap(t){this._overlayMap=t}get overlayMap(){return this._overlayMap}set localVideoOverlay(t){this._localVideoOverlay=t}get localVideoOverlay(){return this._localVideoOverlay}get screenShareList(){return Array.from(this._screenShareList)}_attachSpeakerTrackListener(){bo()&&rl().then(t=>{t.on("removed",async e=>{var r,o;const n=this._audioEl.sinkId,s=e.changes.find(l=>{const c=l.payload.deviceId;return c===n||c===""&&n==="default"||c==="default"&&n===""});if(s){this.emit("speaker.disconnected",{deviceId:s.payload.deviceId,label:s.payload.label}),await((o=(r=this._audioEl).setSinkId)==null?void 0:o.call(r,""));const l=await zo("default");if(!(l!=null&&l.deviceId))return;this.emit("speaker.updated",{previous:{deviceId:s.payload.deviceId,label:s.payload.label},current:{deviceId:l.deviceId,label:l.label}})}})})}_finalize(){this._screenShareList.clear(),super._finalize()}async hangup(t){return this._screenShareList.forEach(e=>{e.leave()}),super.hangup(t)}leave(){return this.hangup()}attachPreConnectWorkers(){this.runWorker("memberListUpdated",{worker:Lf})}getAudioEl(){return this._audioEl?this._audioEl:(this._audioEl=new Audio,this._attachSpeakerTrackListener(),this._audioEl)}getMemberOverlay(t){return this.overlayMap.get(ml(t))}async startScreenShare(t={}){return new Promise(async(e,r)=>{var o;const{autoJoin:n=!0,audio:s=!1,video:l=!0,layout:c,positions:v}=t;try{const m=await el({audio:s===!0?_f:s,video:l}),p=le(J({},this.options),{screenShare:!0,recoverCall:!1,localStream:m,remoteStream:void 0,userVariables:le(J({},((o=this.options)==null?void 0:o.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId}),layout:c,positions:v}),h=ot({store:this.store,Component:kf})(p);return m.getVideoTracks().forEach(y=>{y.addEventListener("ended",()=>{h&&h.active&&h.leave()})}),h.once("destroy",()=>{h.emit("room.left"),this._screenShareList.delete(h)}),h.runWorker("childMemberJoinedWorker",{worker:fl,onDone:()=>e(h),onFail:r,initialState:{parentId:this.memberId}}),this._screenShareList.add(h),n?await h.join():e(h)}catch(m){this.logger.error("ScreenShare Error",m),r(m)}})}updateSpeaker({deviceId:t}){const e=this.audioEl.sinkId;return this.once(`${ki}.speaker.updated`,async r=>{const o=await zo(e),n=await zo(r),s=(n==null?void 0:n.deviceId)===(o==null?void 0:o.deviceId);!(n!=null&&n.deviceId)||s||this.emit("speaker.updated",{previous:{deviceId:o==null?void 0:o.deviceId,label:o==null?void 0:o.label},current:{deviceId:n.deviceId,label:n.label}})}),this.triggerCustomSaga(dl(t))}},$f=class extends tn{join(){return super.invite()}leave(){return super.hangup()}},Wf=po($f,{audioMute:z.audioMuteMember,audioUnmute:z.audioUnmuteMember,videoMute:z.videoMuteMember,videoUnmute:z.videoUnmuteMember,setInputVolume:z.setInputVolumeMember,setMicrophoneVolume:z.setInputVolumeMember,setInputSensitivity:z.setInputSensitivityMember}),gl=class extends hl{constructor(t){super(t),ne(this,"_deviceList",new Set),ne(this,"_currentLayoutEvent"),this.initWorker()}set currentLayoutEvent(t){this._currentLayoutEvent=t}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var t;return(t=this._currentLayoutEvent)==null?void 0:t.layout}get currentPosition(){var t,e;return(e=(t=this._currentLayoutEvent)==null?void 0:t.layout.layers.find(r=>r.member_id===this.memberId))==null?void 0:e.position}get deviceList(){return Array.from(this._deviceList)}get interactivityMode(){return this.select(({session:t})=>{var e;const{authorization:r}=t;return(e=r==null?void 0:r.join_as)!=null?e:""})}get permissions(){return this.select(({session:t})=>{var e,r;const{authorization:o}=t;return(r=(e=o==null?void 0:o.room)==null?void 0:e.scopes)!=null?r:[]})}initWorker(){this.runWorker("videoWorker",{worker:Nf})}getSubscriptions(){const t=this.eventNames().map(e=>`video.${String(e)}`);return Tr(t)}_finalize(){this._deviceList.clear(),super._finalize()}async hangup(t){return this._deviceList.forEach(e=>{e.leave()}),super.hangup(t)}join(){return super.invite()}getLayoutList(){return this.getLayouts()}getMemberList(){return this.getMembers()}async createScreenShareObject(t={}){return this.startScreenShare(t)}addCamera(t={}){const e=t,{autoJoin:r=!0}=e,o=Rt(e,["autoJoin"]);return this.addDevice({autoJoin:r,video:o})}addMicrophone(t={}){const e=t,{autoJoin:r=!0}=e,o=Rt(e,["autoJoin"]);return this.addDevice({autoJoin:r,audio:o})}async addDevice(t={}){return new Promise(async(e,r)=>{var o;const{autoJoin:n=!0,audio:s=!1,video:l=!1}=t;if(!s&&!l)throw new TypeError("At least one of `audio` or `video` must be requested.");const c=le(J({},this.options),{localStream:void 0,remoteStream:void 0,audio:s,video:l,additionalDevice:!0,recoverCall:!1,userVariables:le(J({},((o=this.options)==null?void 0:o.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId})}),v=ot({store:this.store,Component:Wf})(c);v.once("destroy",()=>{v.emit("room.left"),this._deviceList.delete(v)});try{return v.runWorker("childMemberJoinedWorker",{worker:fl,onDone:()=>e(v),onFail:r,initialState:{parentId:this.memberId}}),this._deviceList.add(v),n?await v.join():e(v)}catch(m){this.logger.error("RoomDevice Error",m),r(m)}})}},Uf=po(gl,{audioMute:z.audioMuteMember,audioUnmute:z.audioUnmuteMember,videoMute:z.videoMuteMember,videoUnmute:z.videoUnmuteMember,deaf:z.deafMember,undeaf:z.undeafMember,setInputVolume:z.setInputVolumeMember,setOutputVolume:z.setOutputVolumeMember,setMicrophoneVolume:z.setInputVolumeMember,setSpeakerVolume:z.setOutputVolumeMember,setInputSensitivity:z.setInputSensitivityMember,removeMember:z.removeMember,removeAllMembers:z.removeAllMembers,getMembers:z.getMembers,getLayouts:z.getLayouts,setLayout:z.setLayout,setPositions:z.setPositions,setMemberPosition:z.setMemberPosition,hideVideoMuted:z.hideVideoMuted,showVideoMuted:z.showVideoMuted,getRecordings:z.getRecordings,startRecording:z.startRecording,getPlaybacks:z.getPlaybacks,play:z.play,setHideVideoMuted:z.setHideVideoMuted,getMeta:z.getMeta,setMeta:z.setMeta,updateMeta:z.updateMeta,deleteMeta:z.deleteMeta,getMemberMeta:z.getMemberMeta,setMemberMeta:z.setMemberMeta,updateMemberMeta:z.updateMemberMeta,deleteMemberMeta:z.deleteMemberMeta,promote:z.promote,demote:z.demote,getStreams:z.getStreams,startStream:z.startStream,lock:z.lock,unlock:z.unlock,setRaisedHand:z.setRaisedHand,setPrioritizeHandraise:z.setPrioritizeHandraise}),br=t=>t instanceof gl,jf=t=>ot({store:t.store,customSagas:t.customSagas,Component:Uf})(t),De=()=>{if(window&&window.sessionStorage)return window.sessionStorage},bt=t=>{var e;let r="";try{const n=oo(t);r=(e=n==null?void 0:n.r)!=null?e:""}catch{try{r=oo(t,{header:!0}).typ||""}catch{r=""}}const o=!!r;return{authStateKey:o&&`as-${r}`,protocolKey:o&&`pt-${r}`,callIdKey:o&&`ci-${r}`}},Yr="ci-SAT",qf=10,Ff=300,Bf=100,zf=function*(t){w().debug("wsClientWorker started");const{channels:e,initialState:r,instance:o}=t,{swEventChannel:n}=e,{handleIncomingInvite:s}=r;function*l(m){o.emit(m.type,m.payload)}function*c(m){s(m.payload.params)}const v=m=>m.type==="webrtc.message"?m.payload.method==="verto.invite":!1;try{for(;;){const m=yield Te(n,()=>!0);yield se(l,m),v(m)&&(w().debug("Receiving a call over WebSocket",m),yield se(c,m))}}finally{w().trace("wsClientWorker ended")}},_l=class extends zt{constructor(t){super(t),ne(this,"_payload"),this._payload=t.payload}get id(){return this._payload.member.member_id}get callId(){return this._payload.member.call_id}get nodeId(){return this._payload.member.node_id}get memberId(){return this.id}get roomSessionId(){return this._payload.room_session_id}get roomId(){return this._payload.room_id}get parentId(){return this._payload.member.parent_id}get subscriberId(){return this._payload.member.subscriber_id}get addressId(){return this._payload.member.address_id}get name(){return this._payload.member.name}get type(){return this._payload.member.type}get requestedPosition(){return this._payload.member.requested_position}get currentPosition(){return this._payload.member.current_position}get meta(){return this._payload.member.meta}get handraised(){return this._payload.member.handraised}get talking(){return this._payload.member.talking}get audioMuted(){return this._payload.member.audio_muted}get videoMuted(){return this._payload.member.video_muted}get deaf(){return this._payload.member.deaf}get visible(){return this._payload.member.visible}get inputVolume(){return this._payload.member.input_volume}get outputVolume(){return this._payload.member.output_volume}get inputSensitivity(){return this._payload.member.input_sensitivity}get echoCancellation(){return this._payload.member.echo_cancellation}get autoGain(){return this._payload.member.auto_gain}get noiseSuppression(){return this._payload.member.noise_suppression}setPayload(t){const e=le(J(J({},this._payload),t),{member:J(J({},this._payload.member),t.member)});this._payload=e}},on=t=>ot({store:t.store,Component:_l})(t),Hf=function*(t){w().trace("callLeftWorker started");const{action:{payload:e},instance:r,instanceMap:o}=t,{room_session_id:n}=e;o.getAll().forEach(([s,l])=>{l instanceof _l&&l.roomSessionId===n&&o.remove(s)}),r.emit("call.left",e),r.emit("room.left",e),w().trace("callLeftWorker ended")},ai=function*(t){w().trace("fabricMemberWorker started");const{instance:e,action:{type:r,payload:o},instanceMap:{get:n,set:s,remove:l}}=t,c=o.member.member_id;let v=n(c);if(!v&&r!=="member.talking"&&(v=on({store:e.store,payload:o})),v&&v.setPayload(o),s(c,v),r.startsWith("member.updated.")){const m=Yo(r);e.emit(m,o)}switch(r){case"member.joined":e.emit(r,o);break;case"member.updated":e.emit(r,o);break;case"member.left":e.emit(r,o),l(c);break;case"member.talking":e.emit(r,o);break}w().trace("fabricMemberWorker ended")},Qt=class{constructor(t){this._flags=t}get on(){return this._flags.some(t=>!t.endsWith(".off"))}get off(){return this._flags.some(t=>!t.endsWith(".on"))}},Gf=class{constructor(t,e){this._flags=t,this._memberType=e,ne(this,"_muteAudio"),ne(this,"_muteVideo"),ne(this,"_deaf"),ne(this,"_raisehand")}get muteAudio(){var t;return this._muteAudio=(t=this._muteAudio)!=null?t:new Qt(this._flags.filter(e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.audio`))),this._muteAudio}get muteVideo(){var t;return this._muteVideo=(t=this._muteVideo)!=null?t:new Qt(this._flags.filter(e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.video`))),this._muteVideo}get microphoneVolume(){return this._flags.some(t=>t===this._memberType||t===`${this._memberType}.microphone`||t.startsWith(`${this._memberType}.microphone.volume`))}get microphoneSensitivity(){return this._flags.some(t=>t===this._memberType||t===`${this._memberType}.microphone`||t.startsWith(`${this._memberType}.microphone.sensitivity`))}get speakerVolume(){return this._flags.some(t=>t===this._memberType||t===`${this._memberType}.speaker`||t.startsWith(`${this._memberType}.speaker.volume`))}get deaf(){var t;return this._deaf=(t=this._deaf)!=null?t:new Qt(this._flags.filter(e=>e===this._memberType||e.startsWith(`${this._memberType}.deaf`))),this._deaf}get raisehand(){var t;return this._raisehand=(t=this._raisehand)!=null?t:new Qt(this._flags.filter(e=>e===this._memberType||e.startsWith(`${this._memberType}.raisehand`))),this._raisehand}get position(){return this._flags.some(t=>t===this._memberType||t.startsWith(`${this._memberType}.position`))}get meta(){return this._flags.some(t=>t===this._memberType||t.startsWith(`${this._memberType}.meta`))}get remove(){return this._flags.some(t=>t===this._memberType||t.startsWith(`${this._memberType}.remove`))}get audioFlags(){return this._flags.some(t=>t===this._memberType||t.startsWith(`${this._memberType}.audioflags.set`))}},Kf=class{constructor(t){this._flags=t,ne(this,"_self"),ne(this,"_member"),ne(this,"_vmutedHide"),ne(this,"_lock")}_buildMemberCapability(t){return new Gf(this._flags.filter(e=>e.startsWith(t)),t)}get self(){var t;return this._self=(t=this._self)!=null?t:this._buildMemberCapability("self"),this._self}get member(){var t;return this._member=(t=this._member)!=null?t:this._buildMemberCapability("member"),this._member}get end(){return this._flags.some(t=>t==="end")}get setLayout(){return this._flags.some(t=>t.startsWith("layout"))}get sendDigit(){return this._flags.some(t=>t.startsWith("digit"))}get vmutedHide(){var t;return this._vmutedHide=(t=this._vmutedHide)!=null?t:new Qt(this._flags.filter(e=>e.startsWith("vmuted"))),this._vmutedHide}get lock(){var t;return this._lock=(t=this._lock)!=null?t:new Qt(this._flags.filter(e=>e.startsWith("lock"))),this._lock}get device(){return this._flags.some(t=>t==="device")}get screenshare(){return this._flags.some(t=>t==="screenshare")}},Jf=t=>new Kf(t),no=t=>le(J({},t),{id:t.member_id}),Yf=t=>le(J({},no(t)),{updated:t.updated.map(e=>e==="member_id"?"id":e)}),Xf=t=>le(J({},t),{room:le(J({},t.room_session),{members:t.room_session.members.map(no)}),room_session:le(J({},t.room_session),{members:t.room_session.members.map(no)})}),Qf=t=>({room_session_id:t.room_session_id,room_id:t.room_id,member:no(t.member)}),Zf=t=>({type:`video.${t.type}`,payload:Qf(t.payload)}),eh=t=>({room_session_id:t.room_session_id,room_id:t.room_id,member:Yf(t.member)}),th=t=>({type:`video.${t.type}`,payload:eh(t.payload)}),rh=t=>({type:`video.${t.type}`,payload:t.payload}),oh=function*(t){var e;w().trace("callJoinWorker started");const{action:r,instanceMap:o,instance:n}=t,{payload:s}=r,{get:l,set:c}=o;yield se(Hi.memberPositionWorker,le(J({},t),{initialState:Xf(s),dispatcher:function*(m,p){const h=Ot(m,"video"),y=le(J({},p),{member:le(J({},p.member),{member_id:p.member.id})});yield se(ai,le(J({},t),{action:{type:h,payload:y}}))}})),(e=s.room_session.members)==null||e.forEach(m=>{let p=l(m.member_id);p?p.setPayload({member:m,room_id:s.room_id,room_session_id:s.room_session_id}):p=on({store:n.store,payload:{member:m,room_id:s.room_id,room_session_id:s.room_session_id}}),c(m.member_id,p)}),n.member=l(s.member_id),n.capabilities=Jf(s.capabilities);const v=le(J({},s),{capabilities:n.capabilities});n.emit("call.joined",v),w().trace("callJoinWorker ended")},ih=function*(t){const{action:e,channels:{swEventChannel:r},instance:o}=t,n=e.payload.call_id,s=e.payload.room_session_id;w().debug(`callSegmentWorker started for: callId ${n}, roomSessionId ${s}`),yield se(oh,le(J({},t),{action:e}));function*l(v){const{type:m,payload:p}=v;switch(m){case"call.joined":break;case"call.left":return yield Ue(Hf,le(J({},t),{action:v})),!0;case"call.updated":o.emit(m,p),o.emit("room.updated",p);break;case"call.play":o.emit(m,p);break;case"call.connect":o.emit(m,p);break;case"call.room":o.emit(m,p);break;case"member.joined":case"member.left":{yield se(ai,le(J({},t),{action:v}));const h=Zf(v);yield tt(r,h);break}case"member.updated":{const h=th(v);yield tt(r,h);break}case"layout.changed":{o.currentLayoutEvent=v.payload,o.emit(m,p);const h=rh(v);yield tt(r,h);break}case"member.talking":{yield se(ai,le(J({},t),{action:v}));break}default:w().warn("Got an unknown fabric event",v)}return!1}const c=v=>{const{type:m,payload:p}=v,h=m.startsWith("call.")||m.startsWith("member.")||m.startsWith("layout."),y="call_id"in p&&n===p.call_id,b=s===p.room_session_id;return!!(h&&(y||b))};for(;;){const v=yield Te(r,c),m=yield se(l,v);if(yield $c(m))return}},nh=function*(t){w().trace("fabricWorker started");const{channels:{swEventChannel:e},instance:r}=t;function*o(l){const{type:c,payload:v}=l;switch(c){case"call.joined":{if(!r.selfMember){const m=on({store:r.store,payload:{member:l.payload.room_session.members.find(p=>p.member_id===l.payload.member_id),room_id:l.payload.room_id,room_session_id:l.payload.room_session_id}});r.selfMember=m}yield se(ih,le(J({},t),{instance:r,action:l}));break}case"call.state":r.emit(c,v);break}}let n=!1;const s=l=>{if(l.type==="call.state")return!0;if(l.type!=="call.joined")return!1;if(!n){const c=l.payload.call_id,v=l.payload.origin_call_id;return c===v?(n=!0,!0):!1}return!0};for(;;){const l=yield Te(e,s);yield se(o,l)}w().trace("fabricWorker ended")},mt=(t,e)=>!(t!=null&&t.memberId)||t.memberId===e.member.id;function sh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.muteAudio.off:(r=this.capabilities)==null?void 0:r.member.muteAudio.off))throw new $e("Missing audio mute capability")}function ah(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.muteAudio.on:(r=this.capabilities)==null?void 0:r.member.muteAudio.on))throw new $e("Missing audio unmute capability")}function lh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.muteVideo.off:(r=this.capabilities)==null?void 0:r.member.muteVideo.off))throw new $e("Missing video mute capability")}function dh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.muteVideo.on:(r=this.capabilities)==null?void 0:r.member.muteVideo.on))throw new $e("Missing video unmute capability")}function ch(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.deaf.on:(r=this.capabilities)==null?void 0:r.member.deaf.on))throw new $e("Missing deaf capability")}function uh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.deaf.off:(r=this.capabilities)==null?void 0:r.member.deaf.off))throw new $e("Missing undeaf capability")}function vh(t){var e;if(!(t!=null&&t.memberId))throw new TypeError('Invalid or missing "memberId" argument');if(!((e=this.capabilities)==null?void 0:e.member.remove))throw new $e("Missing remove member capability")}function mh(t){var e,r,o,n;const{raised:s=!0}=t||{},l=mt(t,this),c=l?(e=this.capabilities)==null?void 0:e.self.raisehand.on:(r=this.capabilities)==null?void 0:r.member.raisehand.on,v=l?(o=this.capabilities)==null?void 0:o.self.raisehand.off:(n=this.capabilities)==null?void 0:n.member.raisehand.off;if(s&&!c)throw new $e("Missing raisehand capability");if(!s&&!v)throw new $e("Missing lowerhand capability")}function ph(){var t;if(!((t=this.capabilities)!=null&&t.setLayout))throw new $e("Missing setLayout capability")}function fh(t){var e,r,o,n;if(!(mt(t,this)?(r=(e=this.capabilities)==null?void 0:e.self)==null?void 0:r.microphoneVolume:(n=(o=this.capabilities)==null?void 0:o.member)==null?void 0:n.microphoneVolume))throw new $e("Missing setInputVolume capability");if(t.volume<-50||t.volume>50)throw new RangeError("The volume ranges from -50 to 50")}function hh(t){var e,r,o,n;if(!(mt(t,this)?(r=(e=this.capabilities)==null?void 0:e.self)==null?void 0:r.speakerVolume:(n=(o=this.capabilities)==null?void 0:o.member)==null?void 0:n.speakerVolume))throw new $e("Missing setOutputVolume capability");if(t.volume<-50||t.volume>50)throw new RangeError("The volume ranges from -50 to 50")}function gh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.microphoneSensitivity:(r=this.capabilities)==null?void 0:r.member.microphoneSensitivity))throw new $e("Missing setInputSensitivity capability");if(t.value<0||t.value>100)throw new RangeError("The sensitivity value ranges from 0 to 100")}function _h(t){var e,r;if(t.positions&&!Object.keys(t.positions).length)throw new TypeError("Invalid positions specified");if(!(Object.keys(t.positions).some(s=>["self",`${this.memberId}`].includes(s))?(e=this.capabilities)==null?void 0:e.self.position:(r=this.capabilities)==null?void 0:r.member.position))throw new $e("Missing setPositions capability")}function yh(){var t;if(!((t=this.capabilities)!=null&&t.lock.on))throw new $e("Missing lock capability")}function bh(){var t;if(!((t=this.capabilities)!=null&&t.lock.off))throw new $e("Missing unlock capability")}function wh(t){var e,r;if(!(mt(t,this)?(e=this.capabilities)==null?void 0:e.self.audioFlags:(r=this.capabilities)==null?void 0:r.member.audioFlags))throw new $e("Missing audio flags capability");const{echoCancellation:s,autoGain:l,noiseSuppression:c}=t||{};if(s===void 0&&l===void 0&&c===void 0)throw new TypeError("Invalid parameters: you must specify at least one of `echoCancellation`, `autoGain`, or `noiseSuppression`")}var ns={audioMute:sh,audioUnmute:ah,videoMute:lh,videoUnmute:dh,deaf:ch,undeaf:uh,removeMember:vh,setRaisedHand:mh,setLayout:ph,setInputVolume:fh,setOutputVolume:hh,setInputSensitivity:gh,setPositions:_h,lock:yh,unlock:bh,setAudioFlags:wh};function Sh(t){return new Proxy(t,{get(e,r,o){if(typeof r=="string"&&r in ns){const n=e,s=n[r];if(typeof s=="function")return async function(...l){const c=ns[r];return c&&c.apply(n,l),s.apply(n,l)}}return Reflect.get(e,r,o)}})}var yl=class extends hl{constructor(t){super(t),ne(this,"_self"),ne(this,"_member"),ne(this,"_currentLayoutEvent"),ne(this,"_capabilities"),this.initWorker()}get memberId(){var t;return(t=this._member)==null?void 0:t.memberId}dialogParams(t){const e=super.dialogParams(t);return e.dialogParams.attach=this.options.attach||this.resuming,e.dialogParams.reattaching=this.options.attach||this.resuming,e}set currentLayoutEvent(t){this._currentLayoutEvent=t}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var t;return(t=this._currentLayoutEvent)==null?void 0:t.layout}get currentPosition(){var t,e;return(e=(t=this._currentLayoutEvent)==null?void 0:t.layout.layers.find(r=>r.member_id===this.memberId))==null?void 0:e.position}get capabilities(){return this._capabilities}set capabilities(t){this._capabilities=t}get selfMember(){return this._self}set selfMember(t){this._self=t}set member(t){this._member=t}get member(){return this._member}initWorker(){this.runWorker("fabricWorker",{worker:nh}),this.runWorker("makeAudioElement",{worker:cl({speakerId:this.options.speakerId})})}async join(){var t,e;return this.options.attach&&(this.options.prevCallId=(e=(t=De())==null?void 0:t.getItem(Yr))!=null?e:void 0,this.logger.debug(`Tying to reattach to previuos call? ${!!this.options.prevCallId} - prevCallId: ${this.options.prevCallId}`)),super.invite()}executeAction(t,e={}){var r,o,n;const{method:s,channel:l,memberId:c,extraParams:v={}}=t,m=!c||c==="all"?this.member:this.instanceMap.get(c);if(!m)throw new Error(c&&c!=="all"?`Member ${c} not found`:"No target member available");return this.execute({method:s,params:J(le(J({},l&&{channels:[l]}),{self:{member_id:(r=this.selfMember)==null?void 0:r.id,call_id:(o=this.selfMember)==null?void 0:o.callId,node_id:(n=this.selfMember)==null?void 0:n.nodeId},target:{member_id:c==="all"?c:m.id,call_id:m.callId,node_id:m.nodeId}}),v)},e)}async resume(){var t;if(this.logger.warn(`[resume] Call ${this.id}`),(t=this.peer)!=null&&t.instance){const{connectionState:e}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${e}'`),["closed","failed","disconnected"].includes(e)&&(this.resuming=!this.selfMember,this.peer.restartIce())}}async start(){return new Promise(async(t,e)=>{try{this.once("room.subscribed",r=>{var o;(o=De())==null||o.setItem(Yr,r.call_id),t()}),this.once("destroy",()=>{var r;(r=De())==null||r.removeItem(Yr)}),await this.join()}catch(r){this.logger.error("WSClient call start",r),e(r)}})}async audioMute(t){return this.executeAction({method:"call.mute",channel:"audio",memberId:t==null?void 0:t.memberId})}async audioUnmute(t){return this.executeAction({method:"call.unmute",channel:"audio",memberId:t==null?void 0:t.memberId})}async videoMute(t){return this.executeAction({method:"call.mute",channel:"video",memberId:t==null?void 0:t.memberId})}async videoUnmute(t){return this.executeAction({method:"call.unmute",channel:"video",memberId:t==null?void 0:t.memberId})}async deaf(t){return this.executeAction({method:"call.deaf",memberId:t==null?void 0:t.memberId})}async undeaf(t){return this.executeAction({method:"call.undeaf",memberId:t==null?void 0:t.memberId})}async getLayouts(){return this.executeAction({method:"call.layout.list"},{transformResolve:t=>({layouts:t.layouts})})}async getMembers(){return this.executeAction({method:"call.member.list"},{transformResolve:t=>({members:t.members})})}async removeMember(t){return this.executeAction({method:"call.member.remove",memberId:t.memberId})}async setRaisedHand(t){const{raised:e=!0,memberId:r}=t||{};return this.executeAction({method:e?"call.raisehand":"call.lowerhand",memberId:r})}async setLayout(t){const e={layout:t.name,positions:t.positions};return this.executeAction({method:"call.layout.set",extraParams:e})}async setInputVolume(t){return this.executeAction({method:"call.microphone.volume.set",memberId:t.memberId,extraParams:{volume:t.volume}})}async setOutputVolume(t){return this.executeAction({method:"call.speaker.volume.set",memberId:t.memberId,extraParams:{volume:t.volume}})}async setInputSensitivity(t){return this.executeAction({method:"call.microphone.sensitivity.set",memberId:t.memberId,extraParams:{sensitivity:t.value}})}async setPositions(t){var e,r,o;const n=[];if(Object.entries(t.positions).forEach(([s,l])=>{const c=s==="self"?this.member:this.instanceMap.get(s);c&&n.push({target:{member_id:c.id,call_id:c.callId,node_id:c.nodeId},position:l})}),!n.length)throw new Error("Invalid targets");return this.execute({method:"call.member.position.set",params:{self:{member_id:(e=this.selfMember)==null?void 0:e.id,call_id:(r=this.selfMember)==null?void 0:r.callId,node_id:(o=this.selfMember)==null?void 0:o.nodeId},targets:n}})}async lock(){return this.executeAction({method:"call.lock"})}async unlock(){return this.executeAction({method:"call.unlock"})}async setAudioFlags(t){const e=t,{memberId:r}=e,o=Rt(e,["memberId"]);return this.executeAction({method:"call.audioflags.set",memberId:r,extraParams:Xo(o)})}},wr=t=>t instanceof yl,kh=t=>{const e=ot({store:t.store,Component:yl})(t);return Sh(e)},bl=class{constructor(t){ne(this,"id"),ne(this,"_domElement"),ne(this,"_status"),this.id=t.id,this._status="hidden"}get userId(){return this.id.split(vl)[1]}get domElement(){return this._domElement}set domElement(t){w().debug("Setting domElement for ",this.id),this._domElement=t}get status(){return this._status}set status(t){this._status=t}hide(){if(!this.domElement)return w().warn("Missing overlay to hide");this.domElement.style.opacity="0",this.status="hidden"}show(){if(!this.domElement)return w().warn("Missing overlay to show");this.domElement.style.opacity="1",this.status="visible"}},Ch=class extends bl{constructor(t){super(t),ne(this,"_mirrored"),ne(this,"_room"),this._mirrored=t.mirrorLocalVideoOverlay,this._room=t.room,this.fabricMemberVideoMutedHandler=this.fabricMemberVideoMutedHandler.bind(this),this.videoMemberVideoMutedHandler=this.videoMemberVideoMutedHandler.bind(this),this.attachListeners()}get userId(){return this.id.split(ul)[1]}get mirrored(){return this._mirrored}attachListeners(){wr(this._room)?this._room.on("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):br(this._room)&&this._room.on("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}detachListeners(){wr(this._room)?this._room.off("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):br(this._room)&&this._room.off("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}memberVideoMutedHandler(t,e){try{t===this._room.memberId&&(e?this.hide():this.show())}catch(r){w().error("Error handling videoMuted in LocalVideoOverlay",r)}}fabricMemberVideoMutedHandler(t){this.memberVideoMutedHandler(t.member.member_id,t.member.video_muted)}videoMemberVideoMutedHandler(t){this.memberVideoMutedHandler(t.member.id,t.member.video_muted)}setMediaStream(t){if(!this.domElement)return w().warn("Missing local overlay to set the stream");const e=this.domElement.querySelector("video");e&&(e.srcObject=t)}setMirror(t=this._mirrored){if(!this.domElement||!this.domElement.firstChild)return w().warn("Missing local overlay to set the mirror");const e=this.domElement.firstChild;e.style.transform=t?"scale(-1, 1)":"scale(1, 1)",e.style.webkitTransform=t?"scale(-1, 1)":"scale(1, 1)",this._mirrored=t}},wl=()=>{const t=document.createElement("video");return t.muted=!0,t.autoplay=!0,t.playsInline=!0,t.addEventListener("pause",()=>{t.play().catch(e=>{w().error("Video Element Paused",t,e)})}),t},Th=({element:t})=>new Promise(e=>{t.addEventListener("canplay",function r(){t.removeEventListener("canplay",r),e()}),t.addEventListener("resize",function r(){t.removeEventListener("resize",r),e()})}),Sl=({x:t,y:e,width:r,height:o})=>({top:`${e}%`,left:`${t}%`,width:`${r}%`,height:`${o}%`}),ss=({location:t})=>{const{top:e,left:r,width:o,height:n}=Sl(t),s=document.createElement("div");return s.style.position="absolute",s.style.overflow="hidden",s.style.top=e,s.style.left=r,s.style.width=o,s.style.height=n,s},as=({location:t,element:e})=>{const{top:r,left:o,width:n,height:s}=Sl(t);return e.style.top=r,e.style.left=o,e.style.width=n,e.style.height=s,e},Eh=t=>{const{applyLocalVideoOverlay:e,applyMemberOverlay:r,overlayMap:o,localVideoOverlay:n,mirrorLocalVideoOverlay:s,rootElement:l}=t;return async c=>{w().debug("Process layout.changed");try{const{layout:v,memberId:m,localStream:p}=c,{layers:h=[]}=v,y=l.querySelector(".mcuLayers"),b=document.createDocumentFragment(),S=new Set;if(e){const k=h.find(({member_id:$})=>$===m),C=n.id;let E=n.domElement;if(S.add(C),!k)w().warn("Local video overlay location not found"),n.status="hidden",E&&n.hide();else{if(E)w().debug("Update local video overlay"),as({location:k,element:E});else{w().debug("Build local video overlay"),E=ss({location:k}),E.id=C;const O=wl();O.srcObject=p,O.disablePictureInPicture=!0,O.style.width="100%",O.style.height="100%",O.style.pointerEvents="none",O.style.objectFit="cover",E.appendChild(O),n.domElement=E,s&&n.setMirror()}p.getVideoTracks().filter(O=>O.enabled&&O.readyState==="live").length>0&&k.visible?(n.setMediaStream(p),n.show()):n.hide(),b.appendChild(E)}}r&&h.forEach(k=>{const C=k.member_id;if(!C)return;const E=ml(C);S.add(E);let $=o.get(E);if($&&$.domElement)w().debug("Update an overlay for ",C),as({location:k,element:$.domElement});else{w().debug("Build an overlay for ",C),$=new bl({id:E}),o.set(E,$);const O=ss({location:k});O.id=`${E}-${xt()}`,$.domElement=O}k.visible?$.show():$.hide(),b.appendChild($.domElement)}),o.forEach((k,C)=>{S.has(C)||(k.domElement&&k.domElement.parentNode&&k.domElement.parentNode.removeChild(k.domElement),o.delete(C))}),y&&(y.innerHTML="",y.appendChild(b))}catch(v){w().error("Layout Changed Error",v)}}},Ih=t=>{for(;t.firstChild;)t.removeChild(t.firstChild)},Mh=({track:t,element:e})=>{e.srcObject=new MediaStream([t]),t.addEventListener("ended",()=>{e.srcObject=null,e.remove()})},Ph=({video:t,rootElement:e,paddingWrapper:r})=>{const o=(c,v)=>{const m=t.videoWidth/t.videoHeight,p=c/v;return m>p?"100%":`${v*m}px`},n=zu(({width:c,height:v})=>{const m=t.videoHeight/t.videoWidth*100;if(r){const p=v/c*100;r.style.paddingBottom=`${p>m?m:p}%`,r.style.width=o(c,v)}},100),s=new ResizeObserver(c=>{c.forEach(v=>{if(v.contentBoxSize){const{inlineSize:m,blockSize:p}=Array.isArray(v.contentBoxSize)?v.contentBoxSize[0]:v.contentBoxSize;n({width:m,height:p})}else v.contentRect&&n({width:v.contentRect.width,height:v.contentRect.height})})}),l=()=>{const c=e.clientWidth,v=e.clientHeight;n({width:c,height:v})};return{start:()=>{s.observe(e),t.addEventListener("resize",l)},stop:()=>{s.disconnect(),t.removeEventListener("resize",l)}}},kl=async t=>{var e;try{const{room:r,rootElement:o,applyLocalVideoOverlay:n=!0,applyMemberOverlay:s=!0,mirrorLocalVideoOverlay:l=!0}=t;let c=!1;const v=new Map,m=xt();let p;o?p=o:(p=document.createElement("div"),p.id=`rootElement-${m}`);const h=wf(m),y=new Ch({id:h,mirrorLocalVideoOverlay:l,room:r});n&&v.set(h,y);const b=Eh({applyLocalVideoOverlay:n,applyMemberOverlay:s,overlayMap:v,localVideoOverlay:y,mirrorLocalVideoOverlay:l,rootElement:p}),S=q=>{var H;(H=r.peer)!=null&&H.hasVideoSender&&r.localStream?b({layout:q.layout,localStream:r.localStream,memberId:r.memberId}):y.hide()},k=q=>{if(w().debug("Received layout.changed - videoTrack",c),c){S(q);return}},C=async q=>{c=!0,await Ah({applyLocalVideoOverlay:n,applyMemberOverlay:s,rootElement:p,track:q});const H=r.currentLayoutEvent;H&&S(H)},E=(e=r.peer)==null?void 0:e.remoteVideoTrack;E&&await C(E);const $=async function(q){q.track.kind==="video"&&await C(q.track)},O=()=>{Ih(p),v.clear(),r.overlayMap=v,(wr(r)||br(r))&&(r.off("track",$),r.off("layout.changed",k),r.off("destroy",O)),y.detachListeners()};return(wr(r)||br(r))&&(r.on("track",$),r.on("layout.changed",k),r.once("destroy",O)),r.overlayMap=v,r.localVideoOverlay=y,{element:p,overlayMap:v,localVideoOverlay:y,unsubscribe:O}}catch(r){throw w().error("Unable to build the video element"),r}},Ah=async t=>{try{const{applyLocalVideoOverlay:e,applyMemberOverlay:r,track:o,rootElement:n}=t,s=wl();if(Mh({element:s,track:o}),s.style.width="100%",s.style.maxHeight="100%",n.querySelector(".mcuContent")){w().debug("MCU Content already there");return}const l=document.createElement("div");l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.right="0",l.style.bottom="0",l.appendChild(s);const c=document.createElement("div");c.classList.add("paddingWrapper"),c.style.paddingBottom="56.25%",c.style.position="relative",c.style.width="100%",c.appendChild(l);let v=null;(e||r)&&(v=document.createElement("div"),v.classList.add("mcuLayers"),v.style.display="none",c.appendChild(v));const m=document.createElement("div");m.classList.add("mcuContent"),m.style.position="relative",m.style.width="100%",m.style.height="100%",m.style.margin="0 auto",m.style.display="flex",m.style.alignItems="center",m.style.justifyContent="center",m.appendChild(c),n.style.width="100%",n.style.height="100%",n.appendChild(m),w().debug("MCU readyState 1 >>",s.readyState),s.readyState===HTMLMediaElement.HAVE_NOTHING&&(w().debug("Wait for the MCU to be ready"),await Th({element:s})),w().debug("MCU is ready..");const p=Ph({rootElement:n,video:s,paddingWrapper:c});p.start(),o.addEventListener("ended",()=>{p&&p.stop()}),v&&(v.style.display="block")}catch(e){w().error("Handle video track error",e)}},xh=class extends Ea{constructor(){super(...arguments),ne(this,"_videoManager"),ne(this,"_chat"),ne(this,"_pubSub")}get rooms(){return{makeRoomObject:t=>{const e=t,{rootElement:r,applyLocalVideoOverlay:o=!0,applyMemberOverlay:n=!0,mirrorLocalVideoOverlay:s=!0,stopCameraWhileMuted:l=!0,stopMicrophoneWhileMuted:c=!0}=e,v=Rt(e,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted"]),m=[];m.push(cl({speakerId:v.speakerId}));const p=jf(le(J({},v),{store:this.store,customSagas:m}));if(r)try{kl({applyLocalVideoOverlay:o,applyMemberOverlay:n,mirrorLocalVideoOverlay:s,room:p,rootElement:r})}catch{this.logger.error("Unable to build the video element automatically")}return p.on("room.subscribed",h=>{var y;const b=(y=h.room_session.members)==null?void 0:y.find(S=>S.id===p.memberId);if(b!=null&&b.audio_muted)try{p.stopOutboundAudio()}catch(S){this.logger.error("Error handling audio_muted",S)}if(b!=null&&b.video_muted)try{p.stopOutboundVideo()}catch(S){this.logger.error("Error handling video_muted",S)}}),c&&p.on("member.updated.audio_muted",({member:h})=>{try{h.id===p.memberId&&"audio_muted"in h&&(h.audio_muted?p.stopOutboundAudio():p.restoreOutboundAudio())}catch(y){this.logger.error("Error handling audio_muted",y)}}),l&&p.on("member.updated.video_muted",({member:h})=>{try{h.id===p.memberId&&"video_muted"in h&&(h.video_muted?p.stopOutboundVideo():p.restoreOutboundVideo())}catch(y){this.logger.error("Error handling video_muted",y)}}),p}}}get chat(){return this._chat||(this._chat=Oa.createBaseChatObject({store:this.store})),this._chat}get pubSub(){return this._pubSub||(this._pubSub=ji.createBasePubSubObject({store:this.store})),this._pubSub}get videoManager(){return this._videoManager||(this._videoManager=gf(this.options)),this._videoManager}reauthenticate(t){this.store.dispatch(ze.reauthAction({token:t}))}},Rh=typeof CloseEvent=="function"?CloseEvent:Hu,Cl=class extends Lv{constructor(t){var e;let r={};try{r=oo(t.token,{header:!0})}catch{}super(le(J({},t),{host:(r==null?void 0:r.ch)||t.host})),this.options=t,ne(this,"WebSocketConstructor",WebSocket),ne(this,"CloseEventConstructor",Rh),ne(this,"agent","@signalwire/js/browser/3.29.1"),ne(this,"tokenTyp"),this.tokenTyp=(e=r.typ)!=null?e:"VRT"}get allowReattach(){var t;return((t=this.options)==null?void 0:t.reattach)!==!1&&(this.isVRT()||this.isSAT())}async retrieveRelayProtocol(){var t,e;if(!this.allowReattach)return"";const{protocolKey:r}=bt(this.options.token);return r?(this.logger.trace("Search protocol for",r),(e=(t=De())==null?void 0:t.getItem(r))!=null?e:""):""}async persistRelayProtocol(){var t;if(!this.allowReattach)return;const{protocolKey:e}=bt(this.options.token);e&&(this.logger.trace("Persist protocol",e,this.relayProtocol),(t=De())==null||t.setItem(e,this.relayProtocol))}removeRelayProtocol(){var t;const{protocolKey:e}=bt(this.options.token);e&&(this.logger.debug("Remove protocol",e,this.relayProtocol),(t=De())==null||t.removeItem(e))}removePrevCallId(){var t;const{callIdKey:e}=bt(this.options.token);e&&(this.logger.debug("Remove Call",e),(t=De())==null||t.removeItem(e))}async retrieveSwAuthorizationState(){var t,e;const{authStateKey:r}=bt(this.options.token);return r&&(e=(t=De())==null?void 0:t.getItem(r))!=null?e:""}async persistSwAuthorizationState(t){var e;if(!this.allowReattach)return;const{authStateKey:r}=bt(this.options.token);r&&(this.logger.trace("Persist auth state",r,t),(e=De())==null||e.setItem(r,t))}removeSwAuthorizationState(){var t;const{authStateKey:e}=bt(this.options.token);e&&(this.logger.trace("Remove auth state",e),(t=De())==null||t.removeItem(e))}_onSocketClose(t){var e,r,o;if(this.status==="disconnected"){const{protocolKey:n,authStateKey:s,callIdKey:l}=bt(this.options.token);this.logger.debug("Cleaning up storage"),n&&(this.logger.debug("Remove protocolKey",n),(e=De())==null||e.removeItem(n)),s&&(this.logger.debug("Remove authStateKey",s),(r=De())==null||r.removeItem(s)),l&&(this.logger.debug("Remove callIdKey",l),(o=De())==null||o.removeItem(l))}super._onSocketClose(t)}isVRT(){return this.tokenTyp==="VRT"}isSAT(){return this.tokenTyp==="SAT"}},Rr=t=>{const e=le(J({},t),{emitter:Ta()}),r=Pr({userOptions:e,SessionConstructor:Cl});return ot({store:r,Component:xh})(e)},Lh=["subscribe","publish","getMessages","getMembers","getMemberState","getAllowedChannels","setMemberState"],Oh=function(t){const e=Rr(t),r=n=>async(...s)=>(await e.connect(),e.chat[n](...s)),o={_session:e,disconnect:()=>e.disconnect()};return new Proxy(e.chat,{get(n,s,l){return s in o?o[s]:Lh.includes(s)?r(s):Reflect.get(n,s,l)}})},Vh={};xr(Vh,{Client:()=>Nh,PubSubMessage:()=>$h});Object.keys(Vi).map(t=>`member.updated.${t}`);var Dh=["getAllowedChannels","subscribe","publish"],Nh=function(t){const e=Rr(t),r=n=>async(...s)=>(await e.connect(),e.pubSub[n](...s)),o={_session:e,disconnect:()=>e.disconnect()};return new Proxy(e.pubSub,{get(n,s,l){return s in o?o[s]:Dh.includes(s)?r(s):Reflect.get(n,s,l)}})},$h=ji.PubSubMessage,Wh={};xr(Wh,{SignalWire:()=>El,isFabricRoomSession:()=>wr});var Uh=0,jh=0,qh=0,Fh=3e4;async function Bh(t,e,r,o,n){const s=await Ii({asyncCallable:()=>fetch(t,e),maxRetries:r,validator:l=>{if(!l.ok&&l.status>=500)throw new Zo(l.status,l.statusText)},delayFn:na({initialDelay:o,variation:n})});if(!s.ok){if(s.status===401)throw new Li(s.status,"Unauthorized");let l;try{l=await s.json()}catch{}const c=l!=null&&l.errors?JSON.stringify(l.errors):"Not Found";throw new Zo(s.status,c,l)}try{s.parsedBody=await s.json()}catch{}return s}var zh=(t,e=Bh)=>{var r=t,{baseUrl:o,maxApiRequestRetries:n=Uh,apiRequestRetriesDelay:s=jh,apiRequestRetriesDelayIncrement:l=qh,timeout:c=Fh}=r,v=Rt(r,["baseUrl","maxApiRequestRetries","apiRequestRetriesDelay","apiRequestRetriesDelayIncrement","timeout"]);return async(p,h)=>{const y=J(J(J({},h!=null&&h.body?{"Content-Type":"application/json"}:{}),v.headers),h==null?void 0:h.headers),b=Gh(le(J(J({},v),h),{headers:y}));let S;if(c){const k=new AbortController,C=k.signal;b.signal=C,S=setTimeout(()=>{k.abort()},c)}try{return{body:(await e(Kh({path:p,baseUrl:o,searchParams:h==null?void 0:h.searchParams}),b,n,s,l)).parsedBody}}catch(k){throw k}finally{S&&clearTimeout(S)}}},Hh=t=>typeof t=="string"?t:JSON.stringify(t),Gh=t=>Object.entries(t).reduce((e,[r,o])=>r==="body"?le(J({},e),{body:Hh(o)}):o!=null?le(J({},e),{[r]:o}):e,{}),Kh=({path:t,baseUrl:e,searchParams:r})=>{const o=new URL(t,e);return r&&Object.entries(r).forEach(([n,s])=>{s!=null&&o.searchParams.append(n,s)}),o.toString()};function Tl(t,e){const r=async o=>{if(!o)return Promise.resolve(void 0);const{body:n}=await e(o);return Tl(n,e)};return{data:t.data,self:async()=>{const{self:o}=t.links;return r(o)},nextPage:async()=>{const{next:o}=t.links;return r(o)},prevPage:async()=>{const{prev:o}=t.links;return r(o)},firstPage:async()=>{const{first:o}=t.links;return r(o)},hasNext:!!t.links.next,hasPrev:!!t.links.prev}}function Jh(t,e){const r=e.toString();return r?`${t}?${r}`:t}var Yh=t=>t&&"name"in t,Xh=t=>t&&"id"in t,Qh=t=>t&&"data"in t,Zh=class{constructor(t){this.options=t,ne(this,"httpClient"),this.httpClient=zh({baseUrl:`https://${this.httpHost}`,headers:{Authorization:`Bearer ${this.options.token}`},maxApiRequestRetries:this.options.maxApiRequestRetries,apiRequestRetriesDelay:this.options.apiRequestRetriesDelay,apiRequestRetriesDelayIncrement:this.options.apiRequestRetriesDelayIncrement})}get fetch(){return this.httpClient}get httpHost(){let t={};try{t=oo(this.options.token,{header:!0})}catch{}const e=this.options.host||(t==null?void 0:t.ch);return e?`fabric.${e.split(".").splice(1).join(".")}`:"fabric.signalwire.com"}async getAddress(t){let e="/api/fabric/addresses";Yh(t)?e=`${e}?name=${t.name}`:Xh(t)&&(e=`${e}/${t.id}`);const{body:r}=await this.httpClient(e);if(Qh(r)){if(!r.data[0])throw new Zo(404,"Not Found");return r.data[0]}return r}async getAddresses(t){const{type:e,displayName:r,pageSize:o,sortBy:n,sortOrder:s}=t||{};let l="/api/fabric/addresses";const c=new URLSearchParams;e&&c.append("type",e),r&&c.append("display_name",r),o&&c.append("page_size",o.toString()),n&&c.append("sort_by",n),s&&c.append("sort_order",s);const v=Jh(l,c);w().debug(`[getAddresses] query URL ${v}`);const{body:m}=await this.httpClient(v);return Tl(m,this.httpClient)}async registerDevice(t){const{deviceType:e,deviceToken:r}=t,o="/subscriber/devices",{body:n}=await this.httpClient(o,{method:"POST",body:{device_type:e,device_token:r}});return n}async unregisterDevice(t){const{id:e}=t,r=`/subscriber/devices/${e}`;await this.httpClient(r,{method:"DELETE"})}async getSubscriberInfo(){let t="/api/fabric/subscriber/info";const{body:e}=await this.httpClient(t);return e}},eg=class{constructor(t){this.options=t,ne(this,"_client"),ne(this,"_pendingInvites",{}),ne(this,"_handlers",{}),this._client=t.client}_buildNotification(t){const e=async o=>new Promise((n,s)=>{delete this._pendingInvites[t.callID];try{const l=this.options.buildInboundCall(t,o);l.answer(),n(l)}catch(l){s(l)}}),r=()=>(delete this._pendingInvites[t.callID],this.options.executeVertoBye(t.callID,t.nodeId));return{invite:{details:t,accept:o=>e(o),reject:()=>r()}}}setNotificationHandlers(t){this._handlers.all=t.all,(t.pushNotification&&this._handlers.all!=t.pushNotification||!t.pushNotification)&&(this._handlers.pushNotification=t.pushNotification),(t.websocket&&this._handlers.all!=t.websocket||!t.websocket)&&(this._handlers.websocket=t.websocket)}handleIncomingInvite(t){var e,r;if(t.callID in this._pendingInvites){this._client.logger.debug(`skiping nottification for pending invite to callID: ${t.callID}`);return}if(this._pendingInvites[t.callID]=t,!(this._handlers.all||this._handlers[t.source])){this._client.logger.warn("Skiping nottification due to no listeners");return}const o=this._buildNotification(t);(r=(e=this._handlers).all)==null||r.call(e,o);const n=this._handlers[t.source];n==null||n(o)}},tg=class extends Cl{constructor(t){super(t),this.options=t,ne(this,"connectVersion",lv)}get signature(){if(this._rpcConnectResult){const{authorization:t}=this._rpcConnectResult;return t.jti}}async _checkTokenExpiration(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const t={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{const e=await this.execute(ua(t));this._rpcConnectResult=J(J({},this._rpcConnectResult),e)}catch(e){throw e}}async execute(t){return Ii({asyncCallable:async()=>(await this._waitConnected(),super.execute(t)),maxRetries:this.options.maxApiRequestRetries,delayFn:na({initialDelay:this.options.apiRequestRetriesDelay,variation:this.options.apiRequestRetriesDelayIncrement}),expectedErrorHandler:e=>(w().warn(e),la(t)?!0:av(t)&&![Ci,Ti].includes(e)?(w().debug("skip verto.invite retry on error:",e),!0):!1)})}},rg=t=>{const e=Pr({userOptions:t,SessionConstructor:tg});return le(J({},t),{store:e})},og=class extends Ea{constructor(t){const e=rg(t);super(e),this.wsClientOptions=t,ne(this,"_incomingCallManager"),ne(this,"_disconnected",!1),this._incomingCallManager=new eg({client:this,buildInboundCall:this.buildInboundCall.bind(this),executeVertoBye:this.executeVertoBye.bind(this)}),this.runWorker("wsClientWorker",{worker:zf,initialState:{handleIncomingInvite:r=>{this._incomingCallManager.handleIncomingInvite(J({source:"websocket"},r))}}}),this.initializeSessionConnectionPool()}makeFabricObject(t){const e=t,{rootElement:r,applyLocalVideoOverlay:o=!0,applyMemberOverlay:n=!0,stopCameraWhileMuted:s=!0,stopMicrophoneWhileMuted:l=!0,mirrorLocalVideoOverlay:c=!0}=e,v=Rt(e,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","mirrorLocalVideoOverlay"]),m=kh(le(J({},v),{store:this.store}));if(r)try{kl({applyLocalVideoOverlay:o,applyMemberOverlay:n,mirrorLocalVideoOverlay:c,room:m,rootElement:r})}catch{this.logger.error("Unable to build the video element automatically")}const p=h=>{var y;const b=(y=h.room_session.members)==null?void 0:y.find(S=>S.member_id===m.memberId);if(b!=null&&b.audio_muted)try{m.stopOutboundAudio()}catch(S){this.logger.error("Error handling audio_muted",S)}if(b!=null&&b.video_muted)try{m.stopOutboundVideo()}catch(S){this.logger.error("Error handling video_muted",S)}};return m.on("room.subscribed",p),l&&m.on("member.updated.audioMuted",({member:h})=>{try{h.member_id===m.memberId&&"audio_muted"in h&&(h.audio_muted?m.stopOutboundAudio():m.restoreOutboundAudio())}catch(y){this.logger.error("Error handling audio_muted",y)}}),s&&m.on("member.updated.videoMuted",({member:h})=>{try{h.member_id===m.memberId&&"video_muted"in h&&(h.video_muted?m.stopOutboundVideo():m.restoreOutboundVideo())}catch(y){this.logger.error("Error handling video_muted",y)}}),m}buildOutboundCall(t){var e,r,o,n,s,l;let c=!1,v=!1;if(t.to){const[p,h]=t.to.split("?");if(!p)throw new Error("Invalid destination address");new URLSearchParams(h).get("channel")==="video"&&(c=!0,v=!0)}const m=this.makeFabricObject({audio:(e=t.audio)!=null?e:!0,video:(r=t.video)!=null?r:c,negotiateAudio:(o=t.negotiateAudio)!=null?o:!0,negotiateVideo:(n=t.negotiateVideo)!=null?n:v,rootElement:t.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:t.applyLocalVideoOverlay,applyMemberOverlay:t.applyMemberOverlay,stopCameraWhileMuted:t.stopCameraWhileMuted,stopMicrophoneWhileMuted:t.stopMicrophoneWhileMuted,mirrorLocalVideoOverlay:t.mirrorLocalVideoOverlay,watchMediaPackets:!1,destinationNumber:(s=t.to)!=null?s:"",nodeId:t.nodeId,attach:(l=t.attach)!=null?l:!1,disableUdpIceServers:t.disableUdpIceServers||!1,userVariables:t.userVariables||this.wsClientOptions.userVariables,fromFabricAddressId:t.fromFabricAddressId});return m.once("destroy",()=>{this.logger.debug("RTC Connection Destroyed"),m.destroy()}),this.session.once("session.disconnected",()=>{this.logger.debug("Session Disconnected"),m.destroy(),this.destroy()}),m.attachPreConnectWorkers(),m}buildInboundCall(t,e){var r,o,n,s;const l=this.makeFabricObject({audio:(r=e.audio)!=null?r:!0,video:(o=e.video)!=null?o:!0,negotiateAudio:(n=e.negotiateAudio)!=null?n:!0,negotiateVideo:(s=e.negotiateVideo)!=null?s:!0,rootElement:e.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:!0,applyMemberOverlay:!0,stopCameraWhileMuted:!0,stopMicrophoneWhileMuted:!0,watchMediaPackets:!1,nodeId:t.nodeId,remoteSdp:t.sdp,prevCallId:t.callID,disableUdpIceServers:e.disableUdpIceServers||!1,userVariables:e.userVariables||this.wsClientOptions.userVariables});return l.once("destroy",()=>{this.logger.debug("RTC Connection Destroyed"),l.destroy()}),this.session.once("session.disconnected",()=>{this.logger.debug("Session Disconnected"),l.destroy(),this.destroy()}),l.attachPreConnectWorkers(),l}async executeVertoBye(t,e){try{return await this.execute({method:"webrtc.verto",params:{callID:t,node_id:e,message:Qo({cause:"USER_BUSY",causeCode:"17",dialogParams:{callID:t}})}})}catch(r){throw this.logger.warn("The call is not available anymore",t),r}}async executeVertoSubscribe(t,e){try{return await this.execute({method:"webrtc.verto",params:{callID:t,node_id:e,subscribe:[],message:hv({sessid:t,eventChannel:[]})}})}catch(r){throw this.logger.warn("The call is not available anymore",t),r}}disconnect(){return new Promise((t,e)=>{this._disconnected&&t(),this.session.once("session.disconnected",()=>{this.destroy(),t(),this._disconnected=!0}),super.disconnect()})}async dial(t){return new Promise(async(e,r)=>{var o;try{(o=De())==null||o.removeItem(Yr);const n=this.buildOutboundCall(t);e(n)}catch(n){this.logger.error("Unable to connect and dial a call",n),r(n)}})}async reattach(t){return new Promise(async(e,r)=>{try{const o=this.buildOutboundCall(le(J({},t),{attach:!0}));e(o)}catch(o){this.logger.error("Unable to connect and reattach a call",o),r(o)}})}handlePushNotification(t){const{incomingCallHandler:e}=t;return this._incomingCallManager.setNotificationHandlers({pushNotification:e}),new Promise(async(r,o)=>{const{decrypted:n,type:s}=t;s!=="call_invite"&&(this.logger.warn("Unknown notification type",t),o("Unknown notification type")),this.logger.debug("handlePushNotification",t);const{params:{params:l},node_id:c}=n;try{try{await this.executeVertoSubscribe(l.callID,c)}catch(v){this.logger.warn("Verto Subscribe",v)}this._incomingCallManager.handleIncomingInvite(J({source:"pushNotification",nodeId:c},l)),r({resultType:"inboundCall"})}catch(v){o(v)}})}updateToken(t){return new Promise((e,r)=>{this.session.once("session.auth_error",o=>{r(o)}),this.session.once("session.connected",()=>{e()}),this.store.dispatch(ze.reauthAction({token:t}))})}async online({incomingCallHandlers:t}){return(t.all||t.pushNotification)&&this.logger.warn("Make sure the device is not registered to receive Push Notifications while it is online"),this._incomingCallManager.setNotificationHandlers(t),this.execute({method:"subscriber.online",params:{}})}offline(){return this._incomingCallManager.setNotificationHandlers({}),this.execute({method:"subscriber.offline",params:{}})}initializeSessionConnectionPool(){this.runWorker("sessionConnectionPoolWorker",{worker:tf,initialState:{poolSize:1,iceCandidatePoolSize:10}})}},El=(()=>{let t=null;return e=>(t||(t=new Promise(async(r,o)=>{try{const n=J({maxApiRequestRetries:qf,apiRequestRetriesDelay:Ff,apiRequestRetriesDelayIncrement:Bf},e),s=new og(n),l=new Zh(n),c=v=>()=>{throw new Error(`This version Conversation.${v} is unsupported by the backend. Use @signalwire/client instead.`)};await s.connect(),r({registerDevice:l.registerDevice.bind(l),unregisterDevice:l.unregisterDevice.bind(l),getSubscriberInfo:l.getSubscriberInfo.bind(l),disconnect:async()=>{await s.disconnect(),t=null},online:s.online.bind(s),offline:s.offline.bind(s),dial:s.dial.bind(s),reattach:s.reattach.bind(s),handlePushNotification:s.handlePushNotification.bind(s),updateToken:s.updateToken.bind(s),address:{getAddresses:l.getAddresses.bind(l),getAddress:l.getAddress.bind(l)},conversation:{getConversations:c("getConversations"),getMessages:c("getMessages"),getConversationMessages:c("getConversationMessages"),subscribe:c("subscribe"),sendMessage:c("sendMessage"),join:c("join")},chat:{getMessages:c("getMessages"),subscribe:c("subscribe"),sendMessage:c("sendMessage"),join:c("join")},on:s.on.bind(s),off:s.off.bind(s),__httpClient:l,__wsClient:s})}catch(n){o(n)}}).catch(r=>{throw t=null,r})),t)})(),ig={};xr(ig,{RoomSession:()=>cg,createClient:()=>Rr,createRoomObject:()=>Il,isVideoRoomSession:()=>br,joinRoom:()=>sg});var ng={aspectRatio:{ideal:16/9}},Il=t=>new Promise(async(e,r)=>{const o=t,{audio:n=!0,video:s=!0,iceServers:l,rootElementId:c,applyLocalVideoOverlay:v=!0,autoJoin:m=!1,stopCameraWhileMuted:p=!0,stopMicrophoneWhileMuted:h=!0,speakerId:y}=o,b=Rt(o,["audio","video","iceServers","rootElementId","applyLocalVideoOverlay","autoJoin","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId"]),S=Rr(J({},b));if(await S.connect(),!S)return;let k;if(c){const O=document.getElementById(c);O?k=O:(k=document.body,w().warn(`We couldn't find an element with id: ${c}: using 'document.body' instead.`))}const C=S.rooms.makeRoomObject({audio:n,video:s===!0?ng:s,negotiateAudio:!0,negotiateVideo:!0,iceServers:l,rootElement:k,applyLocalVideoOverlay:v,stopCameraWhileMuted:p,stopMicrophoneWhileMuted:h,speakerId:y});C.once("destroy",()=>{C.emit("room.left"),S.disconnect()});const E=()=>new Promise(async(O,q)=>{try{C.once("room.subscribed",H=>{O(C)}),await C.join()}catch(H){w().error("Join",H),S.disconnect(),q(H)}}),$=new Proxy(C,{get(O,q,H){return q==="join"?E:Reflect.get(O,q,H)}});if(m)try{await $.join(),e($)}catch(O){r(O)}else e($)}),sg=t=>Il(le(J({},t),{autoJoin:!0})),ag=["audioMute","audioUnmute","deaf","getLayouts","getMembers","getRecordings","hideVideoMuted","leave","removerMember","restoreOutboundAudio","restoreOutboundVideo","setInputSensitivity","setInputVolume","setLayout","setPositions","setMemberPosition","setOutputVolume","showVideoMuted","startRecording","stopOutboundAudio","stopOutboundVideo","undeaf","videoMute","videoUnmute","setMicrophoneVolume","setSpeakerVolume","getMeta","setMeta","updateMeta","deleteMeta","getMemberMeta","setMemberMeta","updateMemberMeta","deleteMemberMeta","promote","demote","lock","unlock"],lg=["member.joined","layout.changed"],dg=()=>{},cg=function(t){const e=t,{audio:r=!0,video:o=!0,iceServers:n,rootElement:s,applyLocalVideoOverlay:l=!0,mirrorLocalVideoOverlay:c=!1,stopCameraWhileMuted:v=!0,stopMicrophoneWhileMuted:m=!0,speakerId:p,destinationNumber:h,localStream:y,watchMediaPackets:b,watchMediaPacketsTimeout:S,disableUdpIceServers:k=!1}=e,C=Rt(e,["audio","video","iceServers","rootElement","applyLocalVideoOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId","destinationNumber","localStream","watchMediaPackets","watchMediaPacketsTimeout","disableUdpIceServers"]);["audio","video"].forEach(Q=>{Q in t&&w().warn(`The '${Q}' parameter on the RoomSession constructor is deprecated. Set it on the '.join()' function instead.`)});const $=(t==null?void 0:t.reattach)!==!1,{callIdKey:O}=bt(C.token),q={joined:({call_id:Q})=>{var ge;$&&O&&((ge=De())==null||ge.setItem(O,Q))},init:()=>{$&&de.on("room.subscribed",q.joined),de.options.prevCallId=q.getPrevCallId()},destroy:()=>{var Q;$&&(de.off("room.subscribed",q.joined),O&&((Q=De())==null||Q.removeItem(O)))},getPrevCallId:()=>{var Q,ge;if(!(!$||!O))return(ge=(Q=De())==null?void 0:Q.getItem(O))!=null?ge:void 0}},H=Rr(C),de=H.rooms.makeRoomObject({negotiateAudio:!0,negotiateVideo:!0,iceServers:n,rootElement:s,applyLocalVideoOverlay:l,mirrorLocalVideoOverlay:c,stopCameraWhileMuted:v,stopMicrophoneWhileMuted:m,speakerId:p,destinationNumber:h,localStream:y,watchMediaPackets:b,watchMediaPacketsTimeout:S,prevCallId:q.getPrevCallId(),disableUdpIceServers:k});de.once("destroy",()=>{de.emit("room.left",{reason:de.leaveReason}),q.destroy(),H.disconnect()}),H.session.once("session.disconnected",()=>{de.destroy()});const ce={join:Q=>new Promise(async(ge,oe)=>{var D,ie;try{de.attachPreConnectWorkers(),await H.connect();const U=(D=Q==null?void 0:Q.audio)!=null?D:r,ee=(ie=Q==null?void 0:Q.video)!=null?ie:o,Ge=H._sessionAuthorization;if(w().debug("getJoinMediaParams authorization?",Ge),Ge&&Ge.type==="video"){const Qe=yf(J({authorization:Ge,sendAudio:!!U,sendVideo:!!ee},Q));if(!bf(Qe))return H.disconnect(),oe(new Error(`Invalid arguments to join the room. The token used has join_as: '${Ge.join_as}'. 
${JSON.stringify(Q,null,2)}
`));w().debug("Set mediaOptions",Qe),de.updateMediaOptions({audio:Qe.mustSendAudio?U||!0:!1,video:Qe.mustSendVideo?ee||!0:!1,negotiateAudio:Qe.mustRecvAudio,negotiateVideo:Qe.mustRecvVideo})}de.once("room.subscribed",()=>{ge(de)}),q.init(),lg.forEach(Qe=>de.once(Qe,dg)),await de.join()}catch(U){w().error("RoomSession Join",U),H.disconnect(),oe(U)}})};return new Proxy(de,{get(Q,ge,oe){if(ge in ce)return ce[ge];if(!Q.active&&ag.includes(ge))throw new Error(`Tried to access the property/method "${ge}" before the room was connected. Please call roomSession.join() first.`);return Reflect.get(Q,ge,oe)}})},ug={};xr(ug,{checkCameraPermissions:()=>Qi,checkMicrophonePermissions:()=>Zi,checkPermissions:()=>Ar,checkSpeakerPermissions:()=>Za,createCameraDeviceWatcher:()=>Mp,createDeviceWatcher:()=>So,createMicrophoneAnalyzer:()=>Rp,createMicrophoneDeviceWatcher:()=>Ip,createSpeakerDeviceWatcher:()=>rl,enumerateDevices:()=>eo,enumerateDevicesByKind:()=>Xi,getCameraDevices:()=>wp,getCameraDevicesWithPermissions:()=>_p,getDevices:()=>or,getDevicesWithPermissions:()=>wo,getDisplayMedia:()=>el,getMicrophoneDevices:()=>Sp,getMicrophoneDevicesWithPermissions:()=>yp,getSpeakerDevices:()=>tl,getSpeakerDevicesWithPermissions:()=>bp,getSupportedConstraints:()=>Qa,getUserMedia:()=>rr,requestPermissions:()=>hp,setMediaElementSinkId:()=>Ki,stopStream:()=>Ji,stopTrack:()=>At,supportsGetDisplayMedia:()=>cp,supportsGetUserMedia:()=>dp,supportsMediaDevices:()=>Xa,supportsMediaOutput:()=>bo});const vg="/barbara_idle.mp4",mg="/barbara_talking.mp4",pg={class:"avatar-wrapper"},fg={class:"avatar-video",autoplay:"",muted:"",loop:"",playsinline:"",preload:"auto"},hg={class:"avatar-video",autoplay:"",muted:"",loop:"",playsinline:"",preload:"auto"},gg={class:"avatar-label"},_g={class:"status-text"},yg={__name:"BarbaraAvatar",props:{state:{type:String,default:"idle"}},setup(t){const e=t,r=st(()=>e.state||"idle"),o=st(()=>{switch(r.value){case"speaking":return"Barbara is speaking";case"listening":return"Barbara is listening";default:return"Barbara is idle"}}),n=st(()=>{switch(r.value){case"speaking":return"speaking";case"listening":return"listening";default:return"idle"}});return(s,l)=>(M(),I("div",pg,[L(a("video",fg,[...l[0]||(l[0]=[a("source",{src:vg,type:"video/mp4"},null,-1)])],512),[[Pn,r.value!=="speaking"]]),L(a("video",hg,[...l[1]||(l[1]=[a("source",{src:mg,type:"video/mp4"},null,-1)])],512),[[Pn,r.value==="speaking"]]),a("div",gg,[a("span",{class:Ie(["status-dot",n.value])},null,2),a("span",_g,B(o.value),1)])]))}},bg=di(yg,[["__scopeId","data-v-1fad8fae"]]),wg={class:"test-call-modal"},Sg={class:"modal-header"},kg={class:"modal-subtitle"},Cg={class:"modal-body"},Tg={class:"avatar-column"},Eg={class:"status-text"},Ig={key:0,class:"error-text"},Mg={class:"control-buttons"},Pg=["disabled"],Ag={class:"path-column"},xg={class:"path-card"},Rg={class:"path-header"},Lg={class:"mode-tag"},Og={class:"path-content"},Vg={key:0,class:"path-placeholder"},Dg={key:1,class:"path-display"},Ng={key:0,class:"summary-card"},$g={class:"summary-text"},Wg={__name:"TestCallModal",props:{show:{type:Boolean,default:!1},mode:{type:String,default:"full"},startNode:{type:String,default:"greet"},vertical:{type:String,default:"reverse_mortgage"}},emits:["close"],setup(t,{emit:e}){const r=t,o=e,n="webrtc:barbara-sip",s=j(!1),l=j(!1),c=j("idle"),v=j("Ready when you are."),m=j(""),p=j(""),h=j([]),y=j(null);let b=null,S=null,k=null;const C=st(()=>r.mode==="single"?"Test This Node":"Full Vertical"),E=st(()=>r.startNode.charAt(0).toUpperCase()+r.startNode.slice(1)),$=st(()=>h.value.join("  "));lt(()=>r.show,ie=>{ie||oe(),O()}),Bd(()=>{oe()});function O(){h.value=[],c.value="idle",v.value="Ready when you are.",m.value="",p.value=""}async function q(){(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(U=>U.stop())}async function H(){if(!(s.value||l.value)){s.value=!0,m.value="",p.value="",v.value="Requesting microphone access";try{await q(),v.value="Requesting guest token";const ie=await fetch("/api/test-call/token",{method:"POST"});if(!ie.ok)throw new Error("Token request failed");const{token:U}=await ie.json();if(!U)throw new Error("Token response missing token");v.value="Connecting to Barbara",b=await El({token:U,logLevel:"warn"});const ee=r.startNode||"greet";h.value=[ee],S=await b.dial({to:n,audio:!0,video:!1,rootElement:y.value||void 0,userVariables:{test_mode:"true",use_draft:"true",start_node:ee,stop_on_route:r.mode==="single"?"true":"false",vertical:r.vertical||"reverse_mortgage",source:"portal-test"}}),de(),await S.start(),l.value=!0,c.value="listening",v.value="Connected. Speak when you are ready."}catch(ie){console.error("[TestCall] startCall error",ie),m.value=(ie==null?void 0:ie.message)||"Unable to start test call.",await oe({resetStatus:!1})}finally{s.value=!1}}}function de(){if(!S)return;S.on("user_event",Me),S.on("call.state",(U={})=>{var Ge,Qe;const ee=((Ge=U==null?void 0:U.payload)==null?void 0:Ge.call_state)||(U==null?void 0:U.call_state)||(U==null?void 0:U.state)||((Qe=U==null?void 0:U.event)==null?void 0:Qe.call_state);["ending","ended","hangup"].includes(ee)&&ge("Call ended.")});const ie=U=>async()=>{console.log(`[TestCall] ${U} received`),await ge("Call disconnected.")};S.on("destroy",ie("destroy")),S.on("disconnected",ie("disconnected")),S.on("call.ended",ie("call.ended"))}function Me(ie){const U=(ie==null?void 0:ie.event)||ie;if(U!=null&&U.type)switch(U.type){case"node_transition":if(U.node_name){const ee=U.node_name.toLowerCase();h.value.includes(ee)?h.value[h.value.length-1]!==ee&&h.value.push(ee):h.value.push(ee)}v.value=`Route updated: ${$.value}`,ce();break;case"test_complete":p.value=U.summary||(U.path&&U.path.length?`Path taken: ${U.path.join("  ")}`:"Test completed."),v.value="Test complete.",ce(),l.value&&setTimeout(()=>Q(),1500);break;default:console.debug("[TestCall] Unhandled user_event",U)}}function ce(){c.value="speaking",k&&clearTimeout(k),k=window.setTimeout(()=>{c.value=l.value?"listening":"idle"},1800)}async function Q(){await ge("Call ended.")}async function ge(ie){await oe({resetStatus:!1}),v.value=ie}async function oe(ie={resetStatus:!0}){var U;if(k&&(clearTimeout(k),k=null),S){try{await S.hangup()}catch(ee){console.debug("[TestCall] hangup error",ee)}S=null}if(b){try{await((U=b.disconnect)==null?void 0:U.call(b))}catch(ee){console.debug("[TestCall] client disconnect error",ee)}b=null}l.value=!1,s.value=!1,c.value="idle",ie.resetStatus&&(v.value="Ready when you are.")}function D(){o("close")}return(ie,U)=>t.show?(M(),I("div",{key:0,class:"test-call-overlay",onClick:Le(D,["self"])},[a("div",wg,[a("header",Sg,[a("div",null,[U[0]||(U[0]=a("p",{class:"modal-eyebrow"},"Live Test",-1)),U[1]||(U[1]=a("h3",null,"Barbara Web Test",-1)),a("p",kg,[et(B(C.value)+"  Starts at ",1),a("strong",null,B(E.value),1)])]),a("button",{class:"btn-close-icon",onClick:D},"")]),a("div",Cg,[a("div",Tg,[ls(bg,{state:c.value},null,8,["state"]),a("p",Eg,B(v.value),1),m.value?(M(),I("p",Ig,B(m.value),1)):X("",!0),a("div",Mg,[l.value?(M(),I("button",{key:1,class:"btn-end",onClick:Q}," End Call ")):(M(),I("button",{key:0,class:"btn-start",disabled:s.value,onClick:H},B(s.value?"Connecting":"Start Test"),9,Pg))]),U[2]||(U[2]=a("p",{class:"hint"}," Browser mic & speakers required. Nothing is dialed out. ",-1))]),a("div",Ag,[a("div",xg,[a("div",Rg,[a("div",null,[U[3]||(U[3]=a("p",{class:"path-eyebrow"},"Node Path",-1)),a("h4",null,B(h.value.length?"Current Route":"Awaiting Barbara"),1)]),a("span",Lg,B(C.value),1)]),a("div",Og,[h.value.length?(M(),I("p",Dg,B($.value),1)):(M(),I("p",Vg," Node transitions will appear here in real time. "))])]),p.value?(M(),I("div",Ng,[U[4]||(U[4]=a("p",{class:"path-eyebrow"},"Summary",-1)),a("p",$g,B(p.value),1)])):X("",!0)])])]),a("div",{ref_key:"mediaContainer",ref:y,class:"sr-only","aria-hidden":"true"},null,512)])):X("",!0)}},Ug=di(Wg,[["__scopeId","data-v-4679880e"]]);async function jg(){const{data:t,error:e}=await V.from("phone_numbers").select("*").order("phone_number",{ascending:!0});if(e)throw console.error("Error fetching phone numbers:",e),e;return t||[]}const qg={class:"verticals-page"},Fg={class:"page-header"},Bg={class:"vertical-selector"},zg={key:0,class:"settings-tabs"},Hg=["onClick"],Gg={key:1,class:"main-content"},Kg=["onClick"],Jg={key:0,class:"version-badge"},Yg={key:1,class:"version-badge draft"},Xg={class:"version-number"},Qg={class:"version-date"},Zg=["onClick","disabled"],e_={class:"content-area"},t_={key:0,class:"tab-content"},r_={class:"theme-editor-section"},o_={class:"theme-header"},i_={class:"theme-header-buttons"},n_=["disabled","title"],s_=["disabled"],a_=["disabled"],l_={class:"structured-theme-editor"},d_={class:"section-toggle"},c_={key:0,class:"theme-section-content"},u_={class:"section-toggle"},v_={key:0,class:"theme-section-content"},m_={class:"section-toggle"},p_={key:0,class:"theme-section-content"},f_={class:"section-toggle"},h_={key:0,class:"theme-section-content"},g_={class:"section-toggle"},__={key:0,class:"theme-section-content"},y_={class:"section-toggle"},b_={key:0,class:"theme-section-content"},w_={class:"pronunciations-list"},S_=["onUpdate:modelValue"],k_=["onUpdate:modelValue"],C_=["onClick"],T_={class:"add-pronunciation"},E_=["disabled"],I_={key:1,class:"tab-content"},M_={class:"settings-form"},P_={class:"platform-switcher"},A_={key:0,class:"platform-config"},x_={class:"config-section"},R_={class:"form-group"},L_=["value"],O_={class:"config-section"},V_={class:"form-group"},D_=["value"],N_={class:"config-section"},$_={class:"form-group"},W_={key:0,value:""},U_=["value"],j_={class:"form-group"},q_=["disabled"],F_={key:0,value:""},B_=["value"],z_={class:"form-group"},H_={class:"parameters-section",style:{"margin-top":"24px","padding-top":"24px","border-top":"1px solid rgba(255, 255, 255, 0.1)"}},G_={class:"form-group"},K_={style:{"font-weight":"normal",color:"rgba(255, 255, 255, 0.6)","margin-left":"8px"}},J_={class:"slider-wrapper"},Y_={class:"form-group"},X_={style:{"font-weight":"normal",color:"rgba(255, 255, 255, 0.6)","margin-left":"8px"}},Q_={class:"slider-wrapper"},Z_={class:"form-group"},ey={style:{"font-weight":"normal",color:"rgba(255, 255, 255, 0.6)","margin-left":"8px"}},ty={class:"slider-wrapper"},ry={class:"config-section"},oy={class:"form-group"},iy={class:"form-group"},ny={class:"form-group"},sy={class:"form-group"},ay={class:"form-group"},ly={class:"form-group"},dy={style:{"font-weight":"normal",color:"rgba(255, 255, 255, 0.6)","margin-left":"8px"}},cy={class:"slider-wrapper"},uy={class:"form-group"},vy={class:"config-section"},my={class:"form-group"},py={class:"form-group"},fy={class:"form-group"},hy={class:"form-group"},gy={class:"form-actions"},_y=["disabled"],yy={key:1,class:"platform-config"},by={class:"form-group"},wy={key:0,class:"config-section"},Sy={class:"form-group"},ky=["value"],Cy={class:"form-group"},Ty={class:"form-group"},Ey={class:"form-group"},Iy={class:"form-group"},My={key:0,class:"form-group"},Py={key:1,class:"form-group"},Ay={key:2,class:"form-group"},xy={key:3,class:"form-group"},Ry={key:1,class:"config-section"},Ly={class:"form-group"},Oy=["value"],Vy={class:"form-group"},Dy={class:"form-group"},Ny={class:"form-group"},$y={class:"form-group"},Wy={class:"form-group"},Uy={class:"form-group"},jy={class:"form-group"},qy={key:2},Fy={class:"config-section"},By={class:"form-group"},zy={class:"form-group"},Hy=["disabled"],Gy={key:0,value:""},Ky=["value"],Jy={class:"form-group"},Yy={class:"form-group"},Xy={class:"form-group"},Qy={class:"form-group"},Zy={class:"form-group"},eb={class:"config-section"},tb={class:"form-group"},rb={class:"form-group"},ob=["disabled"],ib={key:0,value:""},nb=["value"],sb={class:"form-group"},ab={class:"config-section"},lb={class:"form-group"},db={class:"form-group"},cb=["disabled"],ub={key:0,value:""},vb=["value"],mb={class:"form-group"},pb=["disabled"],fb={key:0,value:""},hb=["value"],gb={key:0,class:"form-group"},_b={class:"form-group"},yb={class:"form-group"},bb={class:"config-section"},wb={class:"form-group"},Sb={key:0,class:"form-group"},kb={key:1,class:"form-group"},Cb={key:2,class:"form-group"},Tb={class:"form-group"},Eb={key:3,class:"form-group"},Ib={key:4,class:"form-group"},Mb={key:5,class:"form-group"},Pb={key:0,class:"config-section"},Ab={class:"form-group"},xb={class:"form-group"},Rb={class:"form-group"},Lb={class:"form-actions"},Ob=["disabled"],Vb=["disabled"],Db={key:2,class:"nodes-section"},Nb={class:"nodes-grid"},$b=["data-node"],Wb=["onClick"],Ub={class:"node-name"},jb=["title"],qb={class:"node-toggle"},Fb={key:0,class:"node-card-content"},Bb={class:"node-editor"},zb={class:"editor-field"},Hb=["value","onInput"],Gb={class:"editor-field"},Kb={class:"field-header"},Jb={style:{display:"flex",gap:"0.5rem","align-items":"center"}},Yb=["data-dropdown-node"],Xb=["onClick"],Qb={class:"dropdown-search"},Zb=["onUpdate:modelValue"],ew={class:"dropdown-options"},tw={class:"category-header"},rw=["onClick"],ow={class:"variable-name"},iw={class:"variable-desc"},nw=["onClick"],sw=["id","value","onInput","onFocus","onClick"],aw={class:"editor-field"},lw=["value","onInput"],dw={class:"editor-field"},cw=["value","onInput"],uw={class:"editor-field"},vw=["data-dropdown-node"],mw=["onClick"],pw={key:0},fw={key:1},hw={class:"dropdown-search"},gw=["onUpdate:modelValue"],_w={class:"dropdown-options"},yw={class:"dropdown-option select-all"},bw=["checked","onChange"],ww=["value","onUpdate:modelValue","onChange"],Sw={class:"editor-field"},kw=["data-dropdown-node"],Cw=["onClick"],Tw={key:0},Ew={key:1},Iw={class:"dropdown-search"},Mw=["onUpdate:modelValue"],Pw={class:"dropdown-options"},Aw={class:"dropdown-option select-all"},xw=["checked","onChange"],Rw={key:0,class:"tools-section"},Lw=["value","onUpdate:modelValue"],Ow={key:1,class:"tools-section"},Vw=["value","onUpdate:modelValue"],Dw={class:"editor-field"},Nw={style:{display:"inline-flex","align-items":"center",gap:"0.5rem","margin-top":"0.5rem",width:"fit-content"}},$w=["id","checked","onChange"],Ww=["for"],Uw={class:"editor-field"},jw={class:"fillers-section"},qw={class:"filler-group"},Fw={class:"filler-list"},Bw=["value","onInput"],zw=["onClick"],Hw=["onClick"],Gw={class:"filler-group"},Kw={class:"filler-list"},Jw=["value","onInput"],Yw=["onClick"],Xw=["onClick"],Qw={class:"node-actions"},Zw=["onClick"],eS=["onClick"],tS={key:0,class:"save-status-message"},rS={key:0,class:"preview-panel"},oS={class:"preview-header"},iS={class:"preview-content"},nS={key:2,class:"empty-state"},sS={key:0,class:"helper-form"},aS={class:"form-field"},lS={class:"form-field"},dS={class:"form-field"},cS={class:"form-field"},uS={class:"form-field"},vS={class:"quick-chips"},mS={class:"form-field"},pS={class:"form-field"},fS={class:"modal-actions"},hS=["disabled"],gS={key:1,class:"helper-result"},_S={class:"result-preview"},yS={key:0,class:"diff-display"},bS={key:1,class:"preview-text"},wS={class:"modal-actions"},SS={class:"modal-header"},kS={key:0,class:"helper-form"},CS={class:"form-field"},TS={class:"form-field"},ES={class:"scenario-checkboxes"},IS=["value","checked","onChange"],MS={class:"scenario-label"},PS={class:"scenario-name"},AS={class:"scenario-desc"},xS={class:"form-field"},RS={class:"form-field"},LS={class:"form-field"},OS={class:"modal-actions"},VS=["disabled"],DS={key:1,class:"helper-result"},NS={class:"result-preview"},$S={key:0,class:"diff-display"},WS={key:1,class:"preview-text"},US={key:0,class:"tool-reasoning"},jS={key:1,class:"suggested-scenarios"},qS={class:"tool-notice"},FS={class:"modal-actions"},BS={__name:"Verticals",setup(t){const e=["greet","verify","qualify","quote","answer","objections","book","goodbye"],r=j({}),o=j({}),n=j({}),s=j({}),l=j({}),c=j({}),v=j({}),m=j({}),p=j({}),h=j({}),y=j({}),b=j({}),S=j({}),k=j({}),C=j(!1),E=j(!1),$=j(null),O=j(!1),q=j(""),H=j([]),de=j([]),Me=j(""),ce=j({assistantName:"Barbara",company:"Equity Connect",productService:"",targetAudience:"",toneStyle:"",coreValues:"",restrictions:""}),Q=j({goal:"",callDirections:[],customScenarios:"",handling:"",infoGathering:"",transitions:""}),ge=["mark_ready_to_book","mark_has_objection","mark_objection_handled","mark_questions_answered","mark_qualification_result","mark_quote_presented","mark_wrong_person","clear_conversation_flags"],oe=["get_lead_context","verify_caller_identity","check_consent_dnc","update_lead_info","find_broker_by_territory","check_broker_availability","book_appointment","cancel_appointment","reschedule_appointment","set_manual_booking_required","search_knowledge","calculate_reverse_mortgage","assign_tracking_number","send_appointment_confirmation","verify_appointment_confirmation","mark_greeted","mark_verified","mark_qualified","mark_ready_to_book","mark_has_objection","mark_objection_handled","mark_questions_answered","mark_qualification_result","mark_quote_presented","mark_wrong_person","mark_handoff_complete","clear_conversation_flags","mark_phone_verified","mark_email_verified","mark_address_verified","mark_age_qualified","mark_homeowner_qualified","mark_primary_residence_qualified","mark_equity_qualified"],D=j("reverse_mortgage"),ie=j("theme"),U=j(null),ee=j(!1),Ge=j(window.innerWidth<768),Qe=j([]);j({});const ae=j({identity:"",output_rules:"",conversational_flow:"",tools:"",guardrails:""}),je=j(!1),Lr=j(null),Pe=j({identity:!1,output_rules:!1,conversational_flow:!1,tools:!1,guardrails:!1,pronunciations:!1}),St=j(null),it=j({replace:"",with:""});function ko(){var i;if(!it.value.replace||!it.value.with)return;if(Ke.value.pronunciations||(Ke.value.pronunciations=[]),Ke.value.pronunciations.some(f=>f.replace.toLowerCase()===it.value.replace.toLowerCase())){(i=window.$message)==null||i.warning("This word already has a pronunciation rule");return}Ke.value.pronunciations.push({replace:it.value.replace,with:it.value.with}),it.value={replace:"",with:""},je.value=!0}function Ml(u){!Ke.value.pronunciations||!Array.isArray(Ke.value.pronunciations)||(Ke.value.pronunciations.splice(u,1),je.value=!0)}function Gt(u){Object.keys(Pe.value).forEach(i=>{Pe.value[i]=i===u?!Pe.value[i]:!1}),St.value=u,Object.keys(Ze.value).forEach(i=>{Ze.value[i]=!1}),Pe.value[u]&&ht(()=>{$o()})}const Pl=st(()=>{const u=[];return ae.value.identity&&u.push(ae.value.identity),ae.value.output_rules&&u.push(`# Output rules

${ae.value.output_rules}`),ae.value.conversational_flow&&u.push(`# Conversational flow

${ae.value.conversational_flow}`),ae.value.tools&&u.push(`# Tools

${ae.value.tools}`),ae.value.guardrails&&u.push(`# Guardrails

${ae.value.guardrails}`),u.join(`

`)}),Or=st(()=>{if(je.value)return!0;for(const u of e)if(Mt.value[u])return!0;return!1}),Co=st(()=>{let u=0;je.value&&u++;for(const i of e)Mt.value[i]&&u++;return u});async function Al(){var u,i;if(Or.value){ee.value=!0;try{je.value&&await $l();for(const f of e)Mt.value[f]&&await td(f);(u=window.$message)==null||u.success(`Saved ${Co.value} change(s) as draft. Click "Publish" to activate.`)}catch(f){console.error("Error saving all:",f),(i=window.$message)==null||i.error("Failed to save changes: "+f.message)}finally{ee.value=!1}}}const xl={openai:[{value:"gpt-5",label:"GPT-5"},{value:"gpt-4o",label:"GPT-4o"},{value:"gpt-4o-mini",label:"GPT-4o Mini"}],anthropic:[{value:"claude-3-5-sonnet",label:"Claude 3.5 Sonnet"}],groq:[{value:"llama-3.1-70b-versatile",label:"Llama 3.1 70B Versatile"},{value:"llama-3.1-8b-instant",label:"Llama 3.1 8B Instant"}]},Rl={deepgram:[{value:"nova-2",label:"Nova-2"},{value:"nova-3",label:"Nova-3"}],openai:[{value:"whisper-1",label:"Whisper-1"},{value:"gpt-4o-transcribe",label:"GPT-4o Transcribe"}],assemblyai:[{value:"universal-streaming",label:"Universal Streaming"}],google:[{value:"latest_long",label:"Latest Long"},{value:"latest_short",label:"Latest Short"}]},Ll={elevenlabs:[{value:"rachel",label:"Rachel"},{value:"tiffany",label:"Tiffany"},{value:"domi",label:"Domi"},{value:"bella",label:"Bella"},{value:"antoni",label:"Antoni"},{value:"elli",label:"Elli"},{value:"josh",label:"Josh"},{value:"arnold",label:"Arnold"},{value:"adam",label:"Adam"},{value:"sam",label:"Sam"}],openai:[{value:"alloy",label:"Alloy"},{value:"echo",label:"Echo"},{value:"fable",label:"Fable"},{value:"onyx",label:"Onyx"},{value:"nova",label:"Nova"},{value:"shimmer",label:"Shimmer"}],google:[{value:"en-US-Neural2-A",label:"Neural2-A (Female)"},{value:"en-US-Neural2-B",label:"Neural2-B (Male)"},{value:"en-US-Neural2-C",label:"Neural2-C (Female)"},{value:"en-US-Neural2-D",label:"Neural2-D (Male)"},{value:"en-US-Neural2-E",label:"Neural2-E (Female)"},{value:"en-US-Neural2-F",label:"Neural2-F (Female)"}],speechify:[{value:"default",label:"Default"}]},Ke=j({models:{llm:{provider:"openai",model:"gpt-4o"},stt:{provider:"deepgram",model:"nova-3"},tts:{provider:"elevenlabs",voice:"rachel"}},vad:{enabled:!0,silence_ms:700},eos_timeout_ms:800,record_call:!0,telephony:{auto_answer:!1,ring_delay_ms:4e3},safety:{blocked_phrases:[],max_tool_depth:2},pronunciations:[]}),kt=j("signalwire"),P=j({vertical:"reverse_mortgage",language_code:"en-US",llm_model:"",stt_model:"",tts_engine:"elevenlabs",voice_name:"rachel",ai_volume:0,eleven_labs_stability:.5,eleven_labs_similarity:.75,end_of_speech_timeout:2e3,attention_timeout:8e3,transparent_barge:!1,initial_sleep_ms:0,energy_level:50,barge_confidence:.6,first_word_timeout:3e3,temperature:.7,top_p:1,frequency_penalty:0,presence_penalty:0,is_active:!0}),_=j({name:"Default Template",description:"",model_type:"pipeline",stt_provider:"deepgram",stt_model:"nova-3",stt_language:"en-US",tts_provider:"elevenlabs",tts_model:"eleven_turbo_v2_5",tts_voice_id:"EXAVITQu4vr4xnSDxMaL",tts_custom_voice_id:"",tts_speed:1,tts_stability:.5,llm_provider:"openai",llm_model:"gpt-4.1-mini",llm_temperature:.7,llm_max_tokens:4096,llm_top_p:1,llm_frequency_penalty:0,llm_presence_penalty:0,vad_enabled:!0,vad_threshold:.5,vad_prefix_padding_ms:300,vad_silence_duration_ms:550,turn_detector_enabled:!0,turn_detector_model:"english",min_endpointing_delay:500,max_endpointing_delay:6e3,turn_detection_type:"server_vad",audio_input_transcription:!0,audio_sample_rate:24e3,realtime_model:"gpt-realtime",realtime_voice:"alloy",realtime_temperature:.8,realtime_modalities:["text","audio"],realtime_turn_detection_type:"server_vad",realtime_vad_threshold:.5,realtime_prefix_padding_ms:300,realtime_silence_duration_ms:500,realtime_eagerness:"auto",gemini_model:"gemini-2.0-flash-exp",gemini_voice:"Puck",gemini_temperature:.8,gemini_instructions:"",gemini_modalities:["AUDIO"],gemini_enable_affective_dialog:!1,gemini_proactivity:!1,gemini_vertexai:!1}),Kt=j([]),Ct=j([]),ir=j([]),nr=j([]),Tt=j([]),Et=j([]),_t=j([]),It=j([]),Vt=j([]),Dt=j([]),Vr=j({});async function nn(){try{const{data:u,error:i}=await V.from("signalwire_available_llm_models").select("provider, model_name, display_name, context_window").eq("is_available",!0).order("provider",{ascending:!0}).order("display_name",{ascending:!0});if(i){console.warn("Could not load LLM models from DB, using fallback:",i);return}if(u&&u.length>0){const f={};u.forEach(g=>{f[g.provider]||(f[g.provider]=[]),f[g.provider].push({value:g.model_name,label:g.display_name||g.model_name})}),Vr.value=f,console.log("Loaded LLM models from DB:",Object.keys(f).length,"providers")}}catch(u){console.warn("Error loading LLM models from DB, using fallback:",u)}}const Ol=[{value:"inbound_known",label:"Inbound - Known Lead",desc:"Lead already in system, have their info"},{value:"inbound_unknown",label:"Inbound - Unknown Lead",desc:"New caller, no prior info"},{value:"outbound",label:"Outbound Call",desc:"We called them"},{value:"voicemail",label:"Voicemail",desc:"Reached voicemail instead of person"},{value:"wrong_person",label:"Wrong Person",desc:"Wrong number or spouse/family member answers"},{value:"call_screening",label:"Call Screening",desc:'Caller asks "who is this" or is suspicious'}],To={greet:{goal:"Warmly greet the caller, confirm you're speaking with the right person, build initial rapport",callDirections:["inbound_known","inbound_unknown","outbound","wrong_person","call_screening"],handling:"If inbound known: use {lead.first_name}. If unknown: ask for name. If wrong person: ask if {lead.first_name} is available. If screening: identify as Barbara from Equity Connect.",infoGathering:"Confirm caller identity, verify you're speaking with property owner",transitions:"Right person  verify. Wrong person available  re-greet. Wrong person unavailable  exit. Screening  verify after explanation."},verify:{goal:"Confirm caller identity and retrieve/verify their lead information",callDirections:["wrong_person","inbound_known","inbound_unknown"],handling:"If known: confirm name and pull context. If unknown: gather basic info. If wrong person: use mark_wrong_person tool.",infoGathering:"Full name, property address, phone, email",transitions:"Verified  qualify. Wrong person  exit or re-greet. Missing info  gather then qualify."},qualify:{goal:"Determine if lead meets basic eligibility for reverse mortgage",callDirections:["inbound_known","inbound_unknown"],handling:"If already qualified ({status.qualified} = true): skip to quote. If not: ask age (62+), confirm ownership, estimate equity.",infoGathering:"Age, homeownership status, approximate equity/mortgage balance",transitions:"Qualified  quote. Not qualified  exit gracefully. Has questions  answer."},quote:{goal:"Present equity estimate and gauge interest level",callDirections:["inbound_known"],handling:"Present {property.equity_formatted}, explain 50-60% accessibility. Use mark_quote_presented to log reaction (positive/skeptical/needs_more/not_interested).",infoGathering:"Gauge interest level, note concerns",transitions:"Interested  answer/book. Has objections  objections. Not interested  exit. Needs more  answer."},answer:{goal:"Answer questions about reverse mortgages using knowledge base",callDirections:["inbound_known"],handling:"Use search_knowledge for factual answers. Keep brief. If concerns arise  objections.",infoGathering:"What questions they have, remaining concerns",transitions:"Answered  book. Has objections  objections. Needs time  exit with callback."},objections:{goal:"Address concerns and objections empathetically",callDirections:["inbound_known"],handling:"Listen. Use search_knowledge for facts. Common: scams, losing home, heirs. Call mark_objection_handled when resolved.",infoGathering:"Type of objection, severity, remaining concerns",transitions:"Resolved  answer/book. Unresolved  exit with broker callback. Multiple  stay in loop."},book:{goal:"Schedule appointment between lead and assigned broker",callDirections:["inbound_known"],handling:"Use check_broker_availability to find times. Present 2-3 options. Use book_appointment to confirm. Call assign_tracking_number and mark_appointment_booked.",infoGathering:"Preferred date/time, time zone, contact details confirmation",transitions:"Booked  exit with confirmation. Can't find time  exit with callback. Hesitant  answer/objections."},exit:{goal:"End call professionally, confirm next steps if any",callDirections:["inbound_known","wrong_person","voicemail"],handling:"If booked: confirm details. If wrong person available: transition to greet. If VM: leave callback message. Thank caller.",infoGathering:"Confirm they have what they need",transitions:"Wrong person available  greet. Otherwise  end call. Save interaction before ending."}},Vl=[{name:"lead",label:"Lead Info",variables:[{key:"first_name",display:"$first_name",desc:"Lead first name"},{key:"last_name",display:"$last_name",desc:"Lead last name"},{key:"full_name",display:"$full_name",desc:"Lead full name"},{key:"lead_email",display:"$lead_email",desc:"Lead email address"},{key:"lead_phone",display:"$lead_phone",desc:"Lead phone number"},{key:"lead_age",display:"$lead_age",desc:"Lead age"}]},{name:"property",label:"Property Info",variables:[{key:"property_address",display:"$property_address",desc:"Full property address"},{key:"property_city",display:"$property_city",desc:"Property city"},{key:"property_state",display:"$property_state",desc:"Property state"},{key:"property_zip",display:"$property_zip",desc:"Property ZIP code"},{key:"property_value",display:"$property_value",desc:"Property value (number)"},{key:"estimated_equity",display:"$estimated_equity",desc:"Estimated equity"}]},{name:"broker",label:"Broker Info",variables:[{key:"broker_name",display:"$broker_name",desc:"Broker name"},{key:"broker_company",display:"$broker_company",desc:"Broker company name"},{key:"broker_phone",display:"$broker_phone",desc:"Broker phone number"},{key:"broker_email",display:"$broker_email",desc:"Broker email address"}]},{name:"call",label:"Call Info",variables:[{key:"call_direction",display:"$call_direction",desc:"Call direction (inbound/outbound)"}]},{name:"status",label:"Status Info",variables:[{key:"qualified",display:"$qualified",desc:"Is lead qualified (true/false)"},{key:"verified",display:"$verified",desc:"Is caller verified (true/false)"},{key:"quote_presented",display:"$quote_presented",desc:"Has quote been presented (true/false)"},{key:"appointment_booked",display:"$appointment_booked",desc:"Is appointment booked (true/false)"},{key:"ready_to_book",display:"$ready_to_book",desc:"Is caller ready to book (true/false)"}]}];st(()=>{const u=Ke.value.models.llm.provider;return Vr.value[u]&&Vr.value[u].length>0?Vr.value[u]:xl[u]||[]});const Dr=j({});async function sn(){try{const{data:u,error:i}=await V.from("signalwire_available_stt_models").select("provider, model_name, display_name, language_codes").eq("is_available",!0).order("provider",{ascending:!0}).order("display_name",{ascending:!0});if(i){console.warn("Could not load STT models from DB, using fallback:",i);return}if(u&&u.length>0){const f={};u.forEach(g=>{f[g.provider]||(f[g.provider]=[]),f[g.provider].push({value:g.model_name,label:g.display_name||g.model_name})}),Dr.value=f,console.log("Loaded STT models from DB:",Object.keys(f).length,"providers")}}catch(u){console.warn("Error loading STT models from DB, using fallback:",u)}}st(()=>{const u=Ke.value.models.stt.provider;return Dr.value[u]&&Dr.value[u].length>0?Dr.value[u]:Rl[u]||[]});const Nr=j({});async function an(){try{const{data:u,error:i}=await V.from("signalwire_available_voices").select("provider, voice_name, display_name, gender").eq("is_available",!0).order("provider",{ascending:!0}).order("display_name",{ascending:!0});if(i){console.warn("Could not load voices from DB, using fallback:",i);return}if(u&&u.length>0){const f={};u.forEach(g=>{f[g.provider]||(f[g.provider]=[]),f[g.provider].push({value:g.voice_name,label:g.display_name||g.voice_name})}),Nr.value=f,console.log("Loaded TTS voices from DB:",Object.keys(f).length,"providers")}}catch(u){console.warn("Error loading voices from DB, using fallback:",u)}}st(()=>{const u=Ke.value.models.tts.provider;return Nr.value[u]&&Nr.value[u].length>0?Nr.value[u]:Ll[u]||[]});const x=j({}),Mt=j({}),Ze=j({}),at=j({}),_e=j({}),pt=j({}),Nt=j([]),sr=j(null),Pt=j(!1),$r=j(null),$t=j("idle"),Wr=j(!1),Eo=j("full"),Io=j("greet"),Dl=[{key:"theme",label:"Vertical"},{key:"models",label:"Models & Voice"}];function Nl(){e.forEach(u=>{(!x.value[u]||!x.value[u].role&&!x.value[u].instructions)&&(x.value[u]={role:"",instructions:"",routing:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1}),"role"in x.value[u]||(x.value[u].role=""),"routing"in x.value[u]||(x.value[u].routing=""),Mt.value[u]===void 0&&(Mt.value[u]=!1),Ze.value[u]===void 0&&(Ze.value[u]=!1)})}async function ln(){var u;if(D.value){ee.value=!0;try{console.log("Loading theme for vertical:",D.value);let{data:i,error:f}=await V.from("theme_prompts").select("id, content_structured, content, config, version").eq("vertical",D.value).eq("is_active",!1).maybeSingle(),{data:g,error:d}={data:null,error:null};if(i)g=i,d=f;else{const T=await V.from("theme_prompts").select("id, content_structured, content, config, version").eq("vertical",D.value).eq("is_active",!0).maybeSingle();g=T.data,d=T.error}if(d&&d.code==="42703"){console.log("content_structured column not found, loading old format");const T=await V.from("theme_prompts").select("id, content, config, version").eq("vertical",D.value).eq("is_active",!0).maybeSingle();g=T.data,d=T.error}if(d)throw console.error("Supabase error loading theme:",d),d;if(console.log("Theme data loaded:",g),g){if(Lr.value=g.id,g.content_structured?(ae.value={identity:g.content_structured.identity||"",output_rules:g.content_structured.output_rules||"",conversational_flow:g.content_structured.conversational_flow||"",tools:g.content_structured.tools||"",guardrails:g.content_structured.guardrails||""},console.log("Loaded structured theme:",Object.keys(ae.value))):g.content?(console.log("Legacy theme format detected. Please migrate using database migration."),ae.value={identity:"",output_rules:"",conversational_flow:"",tools:"",guardrails:""}):ae.value={identity:"",output_rules:"",conversational_flow:"",tools:"",guardrails:""},g.config&&(Ke.value={...Ke.value,...g.config}),!g.version){const{error:T}=await V.from("theme_prompts").update({version:1}).eq("id",g.id);T&&console.error("Error initializing version:",T)}je.value=!1}else console.log("No theme found for vertical:",D.value),ae.value={identity:"",output_rules:"",conversational_flow:"",tools:"",guardrails:""},Lr.value=null;ht(()=>{$o()})}catch(i){console.error("Error loading theme:",i),console.error("Error details:",JSON.stringify(i,null,2)),i.code!=="PGRST116"&&((u=window.$message)==null||u.error("Failed to load theme: "+(i.message||"Unknown error")))}finally{ee.value=!1}}}async function $l(){var u,i;if(D.value){ee.value=!0;try{const{data:f,error:g}=await V.from("theme_prompts").select("version, id").eq("vertical",D.value).eq("is_active",!0).maybeSingle();if(g)throw g;const d=(f==null?void 0:f.version)||1,T=f==null?void 0:f.id,{data:N,error:R}=await V.from("prompts").select(`
        id,
        node_name,
        prompt_versions!inner (
          id,
          version_number,
          is_draft
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_draft",!0).not("node_name","is",null).limit(1);if(R)throw R;let W;const Z=N&&N.length>0;if(Z){const ue=N[0];W=(Array.isArray(ue.prompt_versions)?ue.prompt_versions[0]:ue.prompt_versions).version_number}else W=d+1;const{data:re,error:we}=await V.from("theme_prompts").select("id").eq("vertical",D.value).eq("is_active",!1).maybeSingle();if(we&&we.code!=="PGRST116")throw we;const Ae={content_structured:{identity:ae.value.identity||"",output_rules:ae.value.output_rules||"",conversational_flow:ae.value.conversational_flow||"",tools:ae.value.tools||"",guardrails:ae.value.guardrails||""},config:Ke.value,version:W,updated_at:new Date().toISOString(),is_active:!1};if(re){const{error:ue}=await V.from("theme_prompts").update(Ae).eq("id",re.id);if(ue)throw ue;Lr.value=re.id}else{const{data:ue,error:Ee}=await V.from("theme_prompts").insert({vertical:D.value,...Ae}).select().single();if(Ee)throw Ee;Lr.value=ue.id}const{data:Fe,error:Je}=await V.from("prompts").select(`
        id,
        node_name,
        prompt_versions!inner (
          id,
          version_number,
          content,
          is_active
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_active",!0).not("node_name","is",null);if(Je)throw Je;for(const ue of Fe||[]){const Ee=Array.isArray(ue.prompt_versions)?ue.prompt_versions[0]:ue.prompt_versions,me=(Ee==null?void 0:Ee.content)||{role:"",instructions:"",tools:[]};let Be=me;if(Z){const A=N.find(Y=>Y.node_name===ue.node_name);A&&(Be=(Array.isArray(A.prompt_versions)?A.prompt_versions[0]:A.prompt_versions).content||me)}const{data:xe,error:F}=await V.from("prompt_versions").select("id").eq("prompt_id",ue.id).eq("version_number",W).eq("is_draft",!0).maybeSingle();if(F)throw F;if(!xe){const{error:A}=await V.from("prompt_versions").insert({prompt_id:ue.id,version_number:W,content:Be,is_active:!1,is_draft:!0,created_by:"portal",change_summary:"Draft - theme updated; node content carried forward"});if(A)throw A}}je.value=!1,(u=window.$message)==null||u.success("Theme saved as draft!"),await Mo()}catch(f){console.error("Error saving theme:",f),(i=window.$message)==null||i.error("Failed to save theme: "+f.message)}finally{ee.value=!1}}}async function Wl(){var u,i,f,g,d;if(D.value){try{await fn()}catch{(u=window.$message)==null||u.error("Cannot publish: Routing validation failed. Please fix errors first.");return}if(!Pt.value){(i=window.$message)==null||i.warning("No draft version to publish");return}if(confirm("Publish this draft version? This will make it the active version and cannot be undone.")){ee.value=!0;try{const{data:T,error:N}=await V.from("prompts").select(`
        id,
        prompt_versions!inner (
          version_number,
          is_draft
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_draft",!0).not("node_name","is",null).limit(1);if(N)throw N;if(!T||T.length===0){(f=window.$message)==null||f.warning("No draft version found");return}const W=(Array.isArray(T[0].prompt_versions)?T[0].prompt_versions[0]:T[0].prompt_versions).version_number,{data:Z,error:re}=await V.from("theme_prompts").select("version").eq("vertical",D.value).eq("is_active",!0).maybeSingle();if(re)throw re;const we=(Z==null?void 0:Z.version)||1,{data:Ae,error:Fe}=await V.from("prompts").select(`
        id,
        prompt_versions!inner (
          id,
          is_active
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_active",!0).not("node_name","is",null);if(Fe)throw Fe;for(const A of Ae||[]){const Y=Array.isArray(A.prompt_versions)?A.prompt_versions:[A.prompt_versions];for(const Ce of Y)await V.from("prompt_versions").update({is_active:!1}).eq("id",Ce.id)}const{data:Je,error:ue}=await V.from("prompts").select("id").eq("vertical",D.value).not("node_name","is",null);if(ue)throw ue;for(const A of Je||[]){const{error:Y}=await V.from("prompt_versions").update({is_active:!0,is_draft:!1}).eq("prompt_id",A.id).eq("version_number",W).eq("is_draft",!0);if(Y)throw Y}const{data:Ee,error:me}=await V.from("prompts").select("id").eq("vertical",D.value).not("node_name","is",null);if(me)throw me;for(const A of Ee||[])await V.from("prompts").update({current_version:W}).eq("id",A.id);const{error:Be}=await V.from("theme_prompts").update({is_active:!1}).eq("vertical",D.value).eq("is_active",!0);if(Be)throw Be;const{data:xe,error:F}=await V.from("theme_prompts").select("id").eq("vertical",D.value).eq("version",W).eq("is_active",!1).maybeSingle();if(F)throw F;if(xe){const{error:A}=await V.from("theme_prompts").update({is_active:!0}).eq("id",xe.id);if(A)throw A}(g=window.$message)==null||g.success(`Draft published! Version v${W} is now active.`),Pt.value=!1,await ln(),await Ro()}catch(T){console.error("Error publishing draft:",T),(d=window.$message)==null||d.error("Failed to publish draft: "+T.message)}finally{ee.value=!1}}}}async function Mo(){if(!D.value){Pt.value=!1;return}try{const{data:u,error:i}=await V.from("prompt_versions").select(`
        id,
        prompts (
          id,
          vertical,
          node_name
        )
      `).eq("is_draft",!0).limit(100);i&&console.error("Error checking for draft nodes:",i);const f=u&&u.some(N=>{const R=Array.isArray(N.prompts)?N.prompts[0]:N.prompts;return R&&R.vertical===D.value&&R.node_name!==null}),{data:g,error:d}=await V.from("theme_prompts").select("id").eq("vertical",D.value).eq("is_active",!1).maybeSingle();d&&console.error("Error checking for draft theme:",d);const T=g!==null;Pt.value=f||T,console.log("checkForDraft result:",{hasDraftNodes:f,hasDraftTheme:T,hasDraft:Pt.value})}catch(u){console.error("Error checking for draft:",u),Pt.value=!1}}async function dn(){try{await Bl(),await zl();const{data:u}=await V.from("signalwire_available_llm_models").select("provider, model_name, model_id_full").eq("is_active",!0).maybeSingle();u&&(P.value.llm_model=u.model_id_full,console.log(" Loaded active SignalWire LLM:",u.model_id_full));const{data:i}=await V.from("signalwire_available_stt_models").select("provider, model_name, model_id_full").eq("is_active",!0).maybeSingle();i&&(P.value.stt_model=i.model_id_full,console.log(" Loaded active SignalWire STT:",i.model_id_full));const{data:f}=await V.from("signalwire_available_voices").select("provider, voice_name, voice_id, voice_id_full").eq("is_active",!0).maybeSingle();f&&(P.value.tts_engine=f.provider,P.value.voice_name=f.voice_id_full,console.log(" Loaded active SignalWire TTS:",f.provider,f.voice_id_full),await Ao())}catch(u){console.error(" Failed to load active SignalWire models:",u)}}async function Po(){console.log(" loadSignalWireConfig CALLED"),console.log(" Loading for vertical:",D.value,"language:",P.value.language_code);try{const{data:u,error:i}=await V.from("agent_voice_config").select("*").eq("vertical",D.value).eq("language_code",P.value.language_code).eq("is_active",!0).limit(1).single();if(i&&i.code!=="PGRST116"){console.error("Error loading SignalWire config:",i);return}console.log(" Loaded from agent_voice_config:",u);const{data:f,error:g}=await V.from("agent_params").select("end_of_speech_timeout, attention_timeout, transparent_barge, initial_sleep_ms, energy_level, barge_confidence, first_word_timeout, temperature, top_p, frequency_penalty, presence_penalty").eq("vertical",D.value).eq("language",P.value.language_code).eq("is_active",!0).limit(1).single();g&&g.code!=="PGRST116"&&console.error("Error loading agent_params:",g),console.log(" Loaded from agent_params:",f),u&&(P.value={...P.value,...u,vertical:D.value,ai_volume:u.ai_volume??0,eleven_labs_stability:u.eleven_labs_stability??.5,eleven_labs_similarity:u.eleven_labs_similarity??.75,end_of_speech_timeout:(f==null?void 0:f.end_of_speech_timeout)??u.end_of_speech_timeout??2500,attention_timeout:(f==null?void 0:f.attention_timeout)??u.attention_timeout??1e4,transparent_barge:(f==null?void 0:f.transparent_barge)??u.transparent_barge??!1,initial_sleep_ms:(f==null?void 0:f.initial_sleep_ms)??0,energy_level:(f==null?void 0:f.energy_level)??50,barge_confidence:(f==null?void 0:f.barge_confidence)??.6,first_word_timeout:(f==null?void 0:f.first_word_timeout)??3e3,temperature:(f==null?void 0:f.temperature)??.7,top_p:(f==null?void 0:f.top_p)??1,frequency_penalty:(f==null?void 0:f.frequency_penalty)??0,presence_penalty:(f==null?void 0:f.presence_penalty)??0},console.log(" Final merged signalwireConfig:",{end_of_speech_timeout:P.value.end_of_speech_timeout,attention_timeout:P.value.attention_timeout,transparent_barge:P.value.transparent_barge,initial_sleep_ms:P.value.initial_sleep_ms,energy_level:P.value.energy_level,barge_confidence:P.value.barge_confidence,first_word_timeout:P.value.first_word_timeout,temperature:P.value.temperature,top_p:P.value.top_p,frequency_penalty:P.value.frequency_penalty,presence_penalty:P.value.presence_penalty}),console.log(" Loaded SignalWire config. Behavior params from agent_params:",f),await Ao())}catch(u){console.error("Failed to load SignalWire config:",u)}}async function Ul(){var u,i;console.log(" saveSignalWireConfig CALLED"),console.log(" Current signalwireConfig:",JSON.stringify(P.value,null,2)),ee.value=!0;try{if(console.log(" Saving SignalWire configuration..."),console.log("Selected LLM:",P.value.llm_model),console.log("Selected STT:",P.value.stt_model),console.log("Selected TTS:",P.value.tts_engine,P.value.voice_name),console.log("Behavior params:",{end_of_speech_timeout:P.value.end_of_speech_timeout,attention_timeout:P.value.attention_timeout,transparent_barge:P.value.transparent_barge,initial_sleep_ms:P.value.initial_sleep_ms,energy_level:P.value.energy_level,barge_confidence:P.value.barge_confidence,first_word_timeout:P.value.first_word_timeout,temperature:P.value.temperature,top_p:P.value.top_p,frequency_penalty:P.value.frequency_penalty,presence_penalty:P.value.presence_penalty}),P.value.llm_model){await V.from("signalwire_available_llm_models").update({is_active:!1}).eq("is_active",!0);const{error:W}=await V.from("signalwire_available_llm_models").update({is_active:!0}).eq("model_id_full",P.value.llm_model);if(W)throw new Error(`LLM update failed: ${W.message}`);console.log(" LLM marked as active:",P.value.llm_model)}if(P.value.stt_model){await V.from("signalwire_available_stt_models").update({is_active:!1}).eq("is_active",!0);const{error:W}=await V.from("signalwire_available_stt_models").update({is_active:!0}).eq("model_id_full",P.value.stt_model);if(W)throw new Error(`STT update failed: ${W.message}`);console.log(" STT marked as active:",P.value.stt_model)}if(P.value.tts_engine&&P.value.voice_name){const W=P.value.voice_name;await V.from("signalwire_available_voices").update({is_active:!1}).eq("is_active",!0);const{error:Z}=await V.from("signalwire_available_voices").update({is_active:!0}).eq("voice_id_full",W);if(Z)throw new Error(`TTS update failed: ${Z.message}`);console.log(" TTS voice marked as active:",W)}const f={vertical:D.value,language_code:P.value.language_code,tts_engine:P.value.tts_engine,voice_name:P.value.voice_name,ai_volume:P.value.ai_volume??0,eleven_labs_stability:P.value.eleven_labs_stability??.5,eleven_labs_similarity:P.value.eleven_labs_similarity??.75,end_of_speech_timeout:P.value.end_of_speech_timeout??2500,attention_timeout:P.value.attention_timeout??1e4,transparent_barge:P.value.transparent_barge??!1,is_active:!0,updated_at:new Date().toISOString()},{data:g,error:d}=await V.from("agent_voice_config").upsert(f,{onConflict:"vertical,language_code"}).select().single();if(d)throw d;const T={vertical:D.value,language:P.value.language_code,end_of_speech_timeout:P.value.end_of_speech_timeout??2500,attention_timeout:P.value.attention_timeout??1e4,transparent_barge:P.value.transparent_barge??!1,initial_sleep_ms:P.value.initial_sleep_ms??0,energy_level:P.value.energy_level??50,barge_confidence:P.value.barge_confidence??.6,first_word_timeout:P.value.first_word_timeout??3e3,temperature:Number(P.value.temperature??.7),top_p:Number(P.value.top_p??1),frequency_penalty:Number(P.value.frequency_penalty??0),presence_penalty:Number(P.value.presence_penalty??0),is_active:!0,updated_at:new Date().toISOString()};console.log(" Saving agent_params with values:",{initial_sleep_ms:T.initial_sleep_ms,energy_level:T.energy_level,barge_confidence:T.barge_confidence,first_word_timeout:T.first_word_timeout,temperature:T.temperature,top_p:T.top_p,frequency_penalty:T.frequency_penalty,presence_penalty:T.presence_penalty});const{data:N,error:R}=await V.from("agent_params").upsert(T,{onConflict:"vertical,language"}).select();if(R)throw console.error(" Failed to save agent_params:",R),console.error(" Data attempted to save:",T),R;console.log(" agent_params saved successfully:",N),P.value={...P.value,...g},console.log(" SignalWire configuration saved successfully to both tables!"),alert(" SignalWire configuration saved! Changes will apply on next call."),(u=window.$message)==null||u.success(" SignalWire configuration saved successfully! Changes will apply on next call."),console.log(" SignalWire configuration saved to both agent_voice_config and agent_params")}catch(f){console.error(" Failed to save SignalWire config:",f),alert(" Failed to save SignalWire configuration: "+f.message),(i=window.$message)==null||i.error("Failed to save SignalWire configuration: "+f.message)}finally{ee.value=!1,console.log(" saveSignalWireConfig COMPLETE, loading set to false")}}const jl={amazon:"Amazon Polly",azure:"Microsoft Azure",cartesia:"Cartesia",deepgram:"Deepgram",elevenlabs:"ElevenLabs",gcloud:"Google Cloud",openai:"OpenAI",rime:"Rime"};async function ql(){try{const{data:u,error:i}=await V.from("signalwire_available_voices").select("provider").eq("is_available",!0);if(i){console.error("Failed to load SignalWire TTS engines:",i),Kt.value=[];return}const f=[...new Set((u||[]).map(g=>g.provider))];Kt.value=f.map(g=>({value:g,label:jl[g]||g.charAt(0).toUpperCase()+g.slice(1)})).sort((g,d)=>g.label.localeCompare(d.label)),console.log(` Loaded ${Kt.value.length} SignalWire TTS engines`)}catch(u){console.error("Error loading SignalWire TTS engines:",u),Kt.value=[]}}async function Ao(){const u=P.value.tts_engine;if(!u){Ct.value=[];return}try{const{data:i,error:f}=await V.from("signalwire_available_voices").select("voice_name, voice_id_full, display_name").eq("provider",u).eq("is_available",!0).order("display_name",{ascending:!0});if(f){console.error("Failed to load SignalWire voices:",f),Ct.value=[];return}Ct.value=(i||[]).map(g=>({value:g.voice_id_full,label:g.display_name})),console.log(` Loaded ${Ct.value.length} SignalWire voices for provider: ${u}`)}catch(i){console.error("Error loading SignalWire voices:",i),Ct.value=[]}}function Fl(){P.value.voice_name="",Ao()}async function Bl(){try{const{data:u,error:i}=await V.from("signalwire_available_llm_models").select("model_id_full, display_name").eq("is_available",!0).order("display_name",{ascending:!0});if(i){console.error("Failed to load SignalWire LLM models:",i),ir.value=[];return}ir.value=(u||[]).map(f=>({value:f.model_id_full,label:f.display_name})),console.log(` Loaded ${ir.value.length} SignalWire LLM models`)}catch(u){console.error("Error loading SignalWire LLM models:",u),ir.value=[]}}async function zl(){try{const{data:u,error:i}=await V.from("signalwire_available_stt_models").select("model_id_full, display_name").eq("is_available",!0).order("display_name",{ascending:!0});if(i){console.error("Failed to load SignalWire STT models:",i),nr.value=[];return}nr.value=(u||[]).map(f=>({value:f.model_id_full,label:f.display_name})),console.log(` Loaded ${nr.value.length} SignalWire STT models`)}catch(u){console.error("Error loading SignalWire STT models:",u),nr.value=[]}}async function Hl(){var u,i;console.log(" saveActiveComponents called"),console.log("livekitConfig:",_.value),ee.value=!0;try{if(_.value.stt_provider&&_.value.stt_model){const{data:f}=await V.from("livekit_available_stt_models").select("id").eq("provider",_.value.stt_provider).eq("model_id_full",_.value.stt_model).limit(1);f&&f.length>0?(console.log("Saving STT:",f[0].id,"model_id_full:",_.value.stt_model),await Gl(f[0].id)):console.warn(" STT model not found:",_.value.stt_provider,_.value.stt_model)}if(_.value.llm_provider&&_.value.llm_model){const{data:f}=await V.from("livekit_available_llm_models").select("id").eq("provider",_.value.llm_provider).eq("model_id_full",_.value.llm_model).limit(1);f&&f.length>0?(console.log("Saving LLM:",f[0].id,"model_id_full:",_.value.llm_model),await Kl(f[0].id)):console.warn(" LLM model not found:",_.value.llm_provider,_.value.llm_model)}if(_.value.tts_provider&&_.value.tts_voice_id&&_.value.tts_voice_id!=="custom"){const{data:f}=await V.from("livekit_available_voices").select("id").eq("provider",_.value.tts_provider).eq("voice_id_full",_.value.tts_voice_id).limit(1);f&&f.length>0?(console.log("Saving TTS:",f[0].id,"voice_id_full:",_.value.tts_voice_id),await Jl(f[0].id)):console.warn(" TTS voice not found:",_.value.tts_provider,_.value.tts_voice_id)}if(_.value.custom_voice_id){console.log("Saving custom voice:",_.value.custom_voice_id);const{data:f}=await V.from("livekit_available_voices").select("id").eq("voice_name","Custom Voice").eq("is_custom",!0).maybeSingle();if(f){const g=`elevenlabs/eleven_turbo_v2_5:${_.value.custom_voice_id}`,{error:d}=await V.from("livekit_available_voices").update({voice_id:_.value.custom_voice_id,voice_id_full:g,is_active:!0}).eq("id",f.id);if(d)throw d;await V.from("livekit_available_voices").update({is_active:!1}).neq("id",f.id).eq("is_active",!0),console.log("Custom voice updated:",_.value.custom_voice_id)}else{const g=`elevenlabs/eleven_turbo_v2_5:${_.value.custom_voice_id}`;await V.from("livekit_available_voices").update({is_active:!1}).eq("is_active",!0);const{data:d,error:T}=await V.from("livekit_available_voices").insert({provider:"elevenlabs",voice_id:_.value.custom_voice_id,voice_id_full:g,voice_name:"Custom Voice",display_name:"Custom Voice (ElevenLabs)",is_custom:!0,is_available:!0,is_active:!0,model:"eleven_turbo_v2_5"}).select().single();if(T)throw T;console.log("Custom voice created:",d)}}if(_.value.model_type==="openai_realtime"&&_.value.realtime_model){console.log("Saving OpenAI Realtime model:",_.value.realtime_model);const{data:f}=await V.from("livekit_available_realtime_models").select("id").eq("provider","openai-realtime").eq("model_id_full",_.value.realtime_model).limit(1);f&&f.length>0?(console.log("Activating OpenAI Realtime:",f[0].id,"model_id_full:",_.value.realtime_model),await cn(f[0].id)):console.warn(" OpenAI Realtime model not found:",_.value.realtime_model)}else if(_.value.model_type==="gemini_live"&&_.value.gemini_model){console.log("Saving Gemini Live model:",_.value.gemini_model);const{data:f}=await V.from("livekit_available_realtime_models").select("id").eq("provider","google-realtime").eq("model_id_full",_.value.gemini_model).limit(1);f&&f.length>0?(console.log("Activating Gemini Live:",f[0].id,"model_id_full:",_.value.gemini_model),await cn(f[0].id)):console.warn(" Gemini Live model not found:",_.value.gemini_model)}else _.value.model_type==="pipeline"&&await V.from("livekit_available_realtime_models").update({is_active:!1}).eq("is_active",!0);console.log(" Configuration saved successfully"),alert(" Configuration saved! Next call will use these settings."),(u=window.$message)==null||u.success(" Configuration saved! Next call will use these settings.")}catch(f){console.error(" Failed to save configuration:",f),alert(" Failed to save: "+f.message),(i=window.$message)==null||i.error("Failed to save configuration: "+f.message)}finally{ee.value=!1}}async function Gl(u){var i,f;try{await V.from("livekit_available_stt_models").update({is_active:!1}).eq("is_active",!0);const{error:g}=await V.from("livekit_available_stt_models").update({is_active:!0}).eq("id",u);if(g)throw g;(i=window.$message)==null||i.success("STT model activated!"),await sn()}catch(g){console.error("Failed to set active STT:",g),(f=window.$message)==null||f.error("Failed to activate STT model")}}async function Kl(u){var i,f;try{await V.from("livekit_available_llm_models").update({is_active:!1}).eq("is_active",!0);const{error:g}=await V.from("livekit_available_llm_models").update({is_active:!0}).eq("id",u);if(g)throw g;(i=window.$message)==null||i.success("LLM model activated!"),await nn()}catch(g){console.error("Failed to set active LLM:",g),(f=window.$message)==null||f.error("Failed to activate LLM model")}}async function Jl(u){var i,f;try{await V.from("livekit_available_voices").update({is_active:!1}).eq("is_active",!0);const{error:g}=await V.from("livekit_available_voices").update({is_active:!0}).eq("id",u);if(g)throw g;(i=window.$message)==null||i.success("TTS voice activated!"),await an()}catch(g){console.error("Failed to set active TTS:",g),(f=window.$message)==null||f.error("Failed to activate TTS voice")}}async function cn(u){try{await V.from("livekit_available_realtime_models").update({is_active:!1}).eq("is_active",!0);const{error:i}=await V.from("livekit_available_realtime_models").update({is_active:!0}).eq("id",u);if(i)throw i;console.log(" Realtime model activated:",u)}catch(i){throw console.error("Failed to set active Realtime:",i),i}}async function Yl(){try{const{data:u}=await V.from("livekit_available_stt_models").select("provider, model_name, model_id_full").eq("is_active",!0).maybeSingle();u&&(_.value.stt_provider=u.provider,_.value.stt_model=u.model_id_full,console.log(" Loaded active STT:",u.provider,u.model_id_full));const{data:i}=await V.from("livekit_available_llm_models").select("provider, model_name, model_id_full").eq("is_active",!0).maybeSingle();i&&(_.value.llm_provider=i.provider,_.value.llm_model=i.model_id_full,console.log(" Loaded active LLM:",i.provider,i.model_id_full));const{data:f}=await V.from("livekit_available_voices").select("provider, model, voice_id, voice_id_full, is_custom").eq("is_active",!0).maybeSingle();f&&(_.value.tts_provider=f.provider,_.value.tts_model=f.model,_.value.tts_voice_id=f.voice_id_full,f.is_custom&&(_.value.custom_voice_id=f.voice_id),console.log(" Loaded active TTS:",f.provider,f.voice_id_full));const{data:g}=await V.from("livekit_available_realtime_models").select("provider, model_name, model_id_full").eq("is_active",!0).maybeSingle();g?(g.provider==="openai-realtime"?(_.value.model_type="openai_realtime",_.value.realtime_model=g.model_id_full):g.provider==="google-realtime"&&(_.value.model_type="gemini_live",_.value.gemini_model=g.model_id_full),console.log(" Loaded active Realtime:",g.provider,g.model_id_full)):_.value.model_type="pipeline",_.value.model_type==="pipeline"?(await Ur(),await qr(),await jr(),_.value.tts_model&&await xo()):_.value.model_type==="openai_realtime"?await un():_.value.model_type==="gemini_live"&&await vn()}catch(u){console.error(" Failed to load active LiveKit models:",u)}}async function Ur(){const u=_.value.stt_provider;if(!u){Tt.value=[];return}try{const{data:i,error:f}=await V.from("livekit_available_stt_models").select("model_name, display_name, model_id_full, language_codes").eq("provider",u).eq("is_available",!0).order("display_name",{ascending:!0});if(f){console.error("Failed to load STT models from database:",f),Tt.value=[];return}Tt.value=(i||[]).map(g=>{var d;return{value:g.model_id_full,label:`${g.display_name} (${((d=g.language_codes)==null?void 0:d.join(", "))||"multi"})`}}),console.log(` Loaded ${Tt.value.length} STT models for provider: ${u}`)}catch(i){console.error("Error loading STT models:",i),Tt.value=[]}}async function jr(){const u=_.value.tts_provider;if(!u){Et.value=[];return}try{const{data:i,error:f}=await V.from("livekit_available_voices").select("model").eq("provider",u).eq("is_available",!0).eq("is_custom",!1).order("model",{ascending:!0});if(f){console.error("Failed to load TTS models from database:",f),Et.value=[];return}const g=[...new Set((i||[]).map(d=>d.model))];Et.value=g.map(d=>({value:d,label:d})),console.log(` Loaded ${Et.value.length} TTS models for provider: ${u}`),_.value.tts_model&&await xo()}catch(i){console.error("Error loading TTS models:",i),Et.value=[]}}async function xo(){const u=_.value.tts_provider,i=_.value.tts_model;if(!u||!i){_t.value=[];return}try{const{data:f,error:g}=await V.from("livekit_available_voices").select("voice_id, voice_name, display_name, voice_id_full, language_codes, is_custom").eq("provider",u).eq("model",i).eq("is_available",!0).eq("is_custom",!1).order("display_name",{ascending:!0});if(g){console.error("Failed to load TTS voices from database:",g),_t.value=[];return}_t.value=(f||[]).map(d=>{var T;return{value:d.voice_id_full,label:`${d.display_name} (${((T=d.language_codes)==null?void 0:T.join(", "))||"multi"})`}}),u==="elevenlabs"&&_t.value.push({value:"custom",label:" Custom Voice ID"}),console.log(` Loaded ${_t.value.length} TTS voices for ${u}/${i}`)}catch(f){console.error("Error loading TTS voices:",f),_t.value=[]}}async function qr(){const u=_.value.llm_provider;if(!u){It.value=[];return}try{const{data:i,error:f}=await V.from("livekit_available_llm_models").select("model_name, display_name, model_id_full, context_window, notes").eq("provider",u).eq("is_available",!0).order("display_name",{ascending:!0});if(f){console.error("Failed to load LLM models from database:",f),It.value=[];return}It.value=(i||[]).map(g=>{let d=g.display_name;return g.notes&&g.notes.includes("Realtime")&&(d+="  (Realtime Plugin)"),{value:g.model_id_full,label:d}}),console.log(` Loaded ${It.value.length} LLM models for provider: ${u}`)}catch(i){console.error("Error loading LLM models:",i),It.value=[]}}async function Xl(){_.value.model_type==="pipeline"?(_.value.stt_provider||(_.value.stt_provider="deepgram"),_.value.llm_provider||(_.value.llm_provider="openai"),_.value.tts_provider||(_.value.tts_provider="elevenlabs"),Ur(),qr(),jr()):_.value.model_type==="openai_realtime"?(await un(),!_.value.realtime_model&&Vt.value.length>0&&(_.value.realtime_model=Vt.value[0].model_id_full),_.value.realtime_voice||(_.value.realtime_voice="alloy"),_.value.realtime_temperature||(_.value.realtime_temperature=.8),_.value.realtime_modalities||(_.value.realtime_modalities=["text","audio"])):_.value.model_type==="gemini_live"&&(await vn(),!_.value.gemini_model&&Dt.value.length>0&&(_.value.gemini_model=Dt.value[0].model_id_full),_.value.gemini_voice||(_.value.gemini_voice="Puck"),_.value.gemini_temperature||(_.value.gemini_temperature=.8),_.value.gemini_modalities||(_.value.gemini_modalities=["AUDIO"]))}function Ql(){_.value.stt_model="",Ur()}function Zl(){_.value.tts_model="",_.value.tts_voice_id="",jr()}function ed(){_.value.llm_model="",qr()}async function un(){try{const{data:u,error:i}=await V.from("livekit_available_realtime_models").select("*").eq("provider","openai-realtime").eq("is_available",!0).order("model_name",{ascending:!0});if(i){console.error("Failed to load OpenAI Realtime models:",i),Vt.value=[];return}Vt.value=u||[],console.log(` Loaded ${Vt.value.length} OpenAI Realtime models`)}catch(u){console.error("Error loading OpenAI Realtime models:",u),Vt.value=[]}}async function vn(){try{const{data:u,error:i}=await V.from("livekit_available_realtime_models").select("*").eq("provider","google-realtime").eq("is_available",!0).order("model_name",{ascending:!0});if(i){console.error("Failed to load Gemini Live models:",i),Dt.value=[];return}Dt.value=u||[],console.log(` Loaded ${Dt.value.length} Gemini Live models`)}catch(u){console.error("Error loading Gemini Live models:",u),Dt.value=[]}}async function Ro(){var u,i,f,g,d,T,N,R;if(D.value){ee.value=!0;try{const{data:W,error:Z}=await V.from("theme_prompts").select("version").eq("vertical",D.value).eq("is_active",!0).maybeSingle();if(Z)throw Z;const re=(W==null?void 0:W.version)||1;console.log("loadNodePrompts: Loading nodes for vertical version:",re);const{data:we,error:Ae}=await V.from("prompts").select(`
        id,
        name,
        vertical,
        node_name,
        current_version,
        prompt_versions!inner (
          id,
          version_number,
          content,
          is_active,
          is_draft
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_draft",!0).not("node_name","is",null),{data:Fe,error:Je}=await V.from("prompts").select(`
        id,
        name,
        vertical,
        node_name,
        current_version,
        prompt_versions!inner (
          id,
          version_number,
          content,
          is_active,
          is_draft
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_active",!0).not("node_name","is",null);if(Ae)throw Ae;if(Je)throw Je;const ue=new Set((we||[]).map(A=>A.node_name)),Ee=[...we||[]];if(Fe)for(const A of Fe)ue.has(A.node_name)||Ee.push(A);const me=Ee,Be=null;console.log("loadNodePrompts: Loaded prompts:",me),console.log("loadNodePrompts: Number of prompts loaded:",(me==null?void 0:me.length)||0),console.log("loadNodePrompts: Prompt node_names:",(me==null?void 0:me.map(A=>A.node_name))||[]);const xe=me==null?void 0:me.find(A=>A.node_name==="greet");console.log("loadNodePrompts: Greet prompt in results?",!!xe),xe&&console.log("loadNodePrompts: Greet prompt details:",{id:xe.id,node_name:xe.node_name,hasPromptVersions:!!xe.prompt_versions,versionsCount:Array.isArray(xe.prompt_versions)?xe.prompt_versions.length:xe.prompt_versions?1:0});const F={};for(const A of me||[]){console.log("loadNodePrompts: Processing prompt:",A.node_name,"id:",A.id);let Y;if(Array.isArray(A.prompt_versions)?(Y=A.prompt_versions.find(Ce=>Ce.is_draft)||A.prompt_versions.find(Ce=>Ce.is_active),Y||(Y=[...A.prompt_versions].sort((Ce,We)=>(We.version_number||0)-(Ce.version_number||0))[0])):Y=A.prompt_versions,Y)if(console.log("loadNodePrompts: Adding to grouped:",A.node_name,"version:",Y.version_number),F[A.node_name]={id:A.id,vertical:A.vertical,node_name:A.node_name,name:A.name,version_number:Y.version_number,content:Y.content},console.log("loadNodePrompts: Grouped node",A.node_name,"version",Y.version_number,":",F[A.node_name]),Y.content){console.log("loadNodePrompts: Processing content for",A.node_name,":",{hasRole:!!Y.content.role,hasInstructions:!!Y.content.instructions,hasStepCriteria:!!Y.content.step_criteria,roleLength:((u=Y.content.role)==null?void 0:u.length)||0,instructionsLength:((i=Y.content.instructions)==null?void 0:i.length)||0,contentKeys:Object.keys(Y.content)});let Ce=[];const We=Y.content.tools;if(Array.isArray(We))Ce=We.flatMap(Se=>{if(typeof Se=="string"){const pe=Se.trim();if(pe.startsWith("[")&&pe.endsWith("]"))try{const ke=JSON.parse(pe);return Array.isArray(ke)?ke.filter(jt=>typeof jt=="string"):[]}catch{return pe!==""&&pe!=="[]"?[Se]:[]}return pe!==""&&pe!=="[]"?[Se]:[]}else if(Array.isArray(Se))return Se.filter(pe=>typeof pe=="string"&&pe.trim()!=="");return[]}).filter(Se=>typeof Se=="string"&&Se.trim()!==""&&Se!=="[]");else if(typeof We=="string"){const Se=We.trim();if(Se===""||Se==="[]")Ce=[];else try{const pe=JSON.parse(Se);Array.isArray(pe)?Ce=pe.flatMap(ke=>{if(typeof ke=="string"){if(ke.trim().startsWith("[")&&ke.trim().endsWith("]"))try{const jt=JSON.parse(ke.trim());return Array.isArray(jt)?jt.filter(jd=>typeof jd=="string"):[ke]}catch{return ke.trim()!==""&&ke.trim()!=="[]"?[ke]:[]}return ke.trim()!==""&&ke.trim()!=="[]"?[ke]:[]}else if(Array.isArray(ke))return ke.filter(jt=>typeof jt=="string"&&jt.trim()!=="");return[]}).filter(ke=>typeof ke=="string"&&ke.trim()!==""&&ke!=="[]"):Ce=[]}catch{Ce=Se.split(",").map(pe=>pe.trim()).filter(pe=>pe&&pe!=="[]"&&pe!=="")}}Array.isArray(Ce)||(Ce=[]),console.log("loadNodePrompts: Tools for",A.node_name,"- Raw:",We,"type:",typeof We,"isArray:",Array.isArray(We)),console.log("loadNodePrompts: Parsed toolsArray:",Ce,"length:",Ce.length);let Wt=[];const Ut=Y.content.valid_contexts;if(Array.isArray(Ut))Wt=Ut.filter(Se=>typeof Se=="string"&&Se.trim()!=="");else if(typeof Ut=="string"){const Se=Ut.trim();if(Se&&Se!=="[]")try{const pe=JSON.parse(Se);Wt=Array.isArray(pe)?pe.filter(ke=>typeof ke=="string"&&ke.trim()!==""):[]}catch{Wt=Se.split(",").map(pe=>pe.trim()).filter(pe=>pe&&pe!=="[]")}}x.value[A.node_name]||(x.value[A.node_name]={role:"",instructions:"",routing:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1});const nt=typeof Y.content.role=="string"?Y.content.role:Y.content.role||"",zr=typeof Y.content.instructions=="string"?Y.content.instructions:Y.content.instructions||"",In=typeof Y.content.step_criteria=="string"?Y.content.step_criteria:Y.content.step_criteria||"",Mn=typeof Y.content.routing=="string"?Y.content.routing:Y.content.routing||"";console.log("ROUTING DEBUG for",A.node_name,":",{rawRouting:Y.content.routing,routingValue:Mn,stepCriteriaValue:In}),x.value[A.node_name].role=nt,x.value[A.node_name].instructions=zr,x.value[A.node_name].routing=Mn,x.value[A.node_name].step_criteria=In,x.value[A.node_name].valid_contexts=[...Wt],x.value[A.node_name].tools=[...Ce],x.value[A.node_name].skip_user_turn=Y.content.skip_user_turn||!1,console.log("loadNodePrompts: Set nodeContent for",A.node_name,":",{role:((f=x.value[A.node_name].role)==null?void 0:f.substring(0,50))+"...",instructions:((g=x.value[A.node_name].instructions)==null?void 0:g.substring(0,50))+"...",instructionsLength:((d=x.value[A.node_name].instructions)==null?void 0:d.length)||0,stepCriteria:((T=x.value[A.node_name].step_criteria)==null?void 0:T.substring(0,50))+"...",toolsCount:((N=x.value[A.node_name].tools)==null?void 0:N.length)||0}),console.log("loadNodePrompts: Tools in nodeContent:",x.value[A.node_name].tools),console.log("loadNodePrompts: Tools array type:",Array.isArray(x.value[A.node_name].tools),"length:",x.value[A.node_name].tools.length),console.log("loadNodePrompts: Tools array contents:",JSON.stringify(x.value[A.node_name].tools))}else x.value[A.node_name]={role:"",instructions:"",routing:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1};else console.warn("loadNodePrompts: No matching version found for",A.node_name,"prompt:",A)}at.value[D.value]=F,console.log("loadNodePrompts: Final nodePrompts:",at.value[D.value]),console.log("loadNodePrompts: Greet node in grouped?","greet"in F),console.log("loadNodePrompts: Greet node data:",F.greet),console.log("loadNodePrompts: All nodes found:",Object.keys(F)),console.log("loadNodePrompts: nodeContent.greet after load:",x.value.greet)}catch(W){console.error("Error loading node prompts:",W),(R=window.$message)==null||R.error("Failed to load node prompts: "+W.message)}finally{ee.value=!1}}}async function ar(u){var i,f;if(!(!D.value||!u)){ee.value=!0;try{let g=(i=at.value[D.value])==null?void 0:i[u];if(!g){console.log("loadVersions: Loading",u,"from DB (not in initial batch)");const{data:N,error:R}=await V.from("prompts").select("id, name, vertical, node_name, current_version").eq("vertical",D.value).eq("node_name",u).limit(1).maybeSingle();if(R&&console.error("loadVersions: fallback query failed:",R),N)g={id:N.id,vertical:N.vertical,node_name:N.node_name,name:N.name,version_number:N.current_version,content:null},at.value[D.value]||(at.value[D.value]={}),at.value[D.value][u]=g;else{Nt.value=[],sr.value=null;return}}const{data:d,error:T}=await V.from("prompt_versions").select("*").eq("prompt_id",g.id).order("version_number",{ascending:!1});if(T)throw T;if(Nt.value=d||[],Nt.value.length>0){const N=Nt.value.find(R=>R.is_active)||Nt.value[0];await mn(N.id)}else sr.value=null}catch(g){console.error("Error loading versions:",g),(f=window.$message)==null||f.error("Failed to load versions: "+g.message)}finally{ee.value=!1}}}async function mn(u){var i;ee.value=!0;try{const{data:f,error:g}=await V.from("prompt_versions").select("*").eq("id",u).single();if(g)throw g;if(sr.value=f,U.value&&(await ht(),setTimeout(()=>{yt(U.value)},100)),f.content&&U.value){console.log("loadVersion: Loading content for",U.value,":",f.content);let d=[];const T=f.content.tools;if(Array.isArray(T))d=T.flatMap(W=>{if(typeof W=="string"){const Z=W.trim();if(Z.startsWith("[")&&Z.endsWith("]"))try{const re=JSON.parse(Z);return Array.isArray(re)?re.filter(we=>typeof we=="string"):[]}catch{return Z!==""&&Z!=="[]"?[W]:[]}return Z!==""&&Z!=="[]"?[W]:[]}else if(Array.isArray(W))return W.filter(Z=>typeof Z=="string"&&Z.trim()!=="");return[]}).filter(W=>typeof W=="string"&&W.trim()!==""&&W!=="[]");else if(typeof T=="string"){const W=T.trim();if(W===""||W==="[]")d=[];else try{const Z=JSON.parse(W);Array.isArray(Z)?d=Z.flatMap(re=>{if(typeof re=="string"){if(re.trim().startsWith("[")&&re.trim().endsWith("]"))try{const we=JSON.parse(re.trim());return Array.isArray(we)?we.filter(Ae=>typeof Ae=="string"):[re]}catch{return re.trim()!==""&&re.trim()!=="[]"?[re]:[]}return re.trim()!==""&&re.trim()!=="[]"?[re]:[]}else if(Array.isArray(re))return re.filter(we=>typeof we=="string"&&we.trim()!=="");return[]}).filter(re=>typeof re=="string"&&re.trim()!==""&&re!=="[]"):d=[]}catch{d=W.split(",").map(Z=>Z.trim()).filter(Z=>Z&&Z!=="[]"&&Z!=="")}}Array.isArray(d)||(d=[]),console.log("loadVersion: Tools for",U.value,"- Raw:",T,"type:",typeof T,"isArray:",Array.isArray(T)),console.log("loadVersion: Parsed toolsArray:",d,"length:",d.length);let N=[];const R=f.content.valid_contexts;if(Array.isArray(R))N=R.filter(W=>typeof W=="string"&&W.trim()!=="");else if(typeof R=="string"){const W=R.trim();if(W&&W!=="[]")try{const Z=JSON.parse(W);N=Array.isArray(Z)?Z.filter(re=>typeof re=="string"&&re.trim()!==""):[]}catch{N=W.split(",").map(Z=>Z.trim()).filter(Z=>Z&&Z!=="[]")}}x.value[U.value]||(x.value[U.value]={}),x.value[U.value].role=f.content.role||"",x.value[U.value].instructions=f.content.instructions||"",x.value[U.value].step_criteria=f.content.step_criteria||"",x.value[U.value].valid_contexts=[...N],x.value[U.value].tools=[...d],x.value[U.value].skip_user_turn=f.content.skip_user_turn||!1,console.log("loadVersion: Set nodeContent to:",x.value[U.value]),console.log("loadVersion: Tools in nodeContent:",x.value[U.value].tools),console.log("loadVersion: Tools array type:",Array.isArray(x.value[U.value].tools),"length:",x.value[U.value].tools.length),console.log("loadVersion: Tools array contents:",JSON.stringify(x.value[U.value].tools)),Mt.value[U.value]=!1,await ht(),setTimeout(()=>{yt(U.value)},150)}else console.log("loadVersion: No content in data or no selectedNode")}catch(f){console.error("Error loading version:",f),(i=window.$message)==null||i.error("Failed to load version: "+f.message)}finally{ee.value=!1}}async function td(u){var i,f,g,d,T,N;if(!(!D.value||!u)){if(!x.value[u]){(i=window.$message)==null||i.error("Node content is missing or invalid.");return}ee.value=!0,$t.value="validating";try{let R=[];Array.isArray(x.value[u].tools)?R=x.value[u].tools:typeof x.value[u].tools=="string"&&(R=x.value[u].tools.split(",").map(A=>A.trim()).filter(A=>A));const W=(f=at.value[D.value])==null?void 0:f[u],Z=(W==null?void 0:W.content)||{};let re=[];Array.isArray(x.value[u].valid_contexts)?re=x.value[u].valid_contexts:typeof x.value[u].valid_contexts=="string"&&(re=x.value[u].valid_contexts.split(",").map(A=>A.trim()).filter(A=>A));const we={...Z,instructions:x.value[u].instructions||"",routing:x.value[u].routing||"",step_criteria:x.value[u].step_criteria||"",valid_contexts:re,tools:R,skip_user_turn:x.value[u].skip_user_turn||!1};try{await rd(u,we)}catch(A){if(A instanceof TypeError&&A.message.includes("fetch"))console.warn("CLI validation service unavailable, skipping validation:",A),(g=window.$message)==null||g.warning("CLI validation service unavailable. Saving without validation.");else throw A}$t.value="validating";try{await fn()}catch(A){throw console.warn("Routing validation failed:",A),A}$t.value="saving";const{data:Ae,error:Fe}=await V.from("theme_prompts").select("version").eq("vertical",D.value).eq("is_active",!0).maybeSingle();if(Fe)throw Fe;const Je=(Ae==null?void 0:Ae.version)||1,{data:ue,error:Ee}=await V.from("prompts").select(`
        id,
        node_name,
        prompt_versions!inner (
          id,
          version_number,
          content,
          is_draft
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_draft",!0).not("node_name","is",null);if(Ee)throw Ee;let me;const Be=ue&&ue.length>0;if(Be){const A=ue[0];me=(Array.isArray(A.prompt_versions)?A.prompt_versions[0]:A.prompt_versions).version_number}else me=Je+1;const{data:xe,error:F}=await V.from("prompts").select(`
        id,
        node_name,
        prompt_versions!inner (
          id,
          version_number,
          content,
          is_active
        )
      `).eq("vertical",D.value).eq("prompt_versions.is_active",!0).not("node_name","is",null);if(F)throw F;for(const A of xe||[]){const Y=Array.isArray(A.prompt_versions)?A.prompt_versions[0]:A.prompt_versions,Ce=(Y==null?void 0:Y.content)||{role:"",instructions:"",tools:[]};let We;if(A.node_name===u)We=we;else if(Be){const nt=ue.find(zr=>zr.node_name===A.node_name);nt?We=(Array.isArray(nt.prompt_versions)?nt.prompt_versions[0]:nt.prompt_versions).content||Ce:We=Ce}else We=Ce;const{data:Wt,error:Ut}=await V.from("prompt_versions").select("id").eq("prompt_id",A.id).eq("version_number",me).eq("is_draft",!0).maybeSingle();if(Ut)throw Ut;if(Wt){const{error:nt}=await V.from("prompt_versions").update({content:We,change_summary:`Draft - ${A.node_name===u?"updated":"carried forward"} content`}).eq("id",Wt.id);if(nt)throw nt}else{const{error:nt}=await V.from("prompt_versions").insert({prompt_id:A.id,version_number:me,content:We,is_active:!1,is_draft:!0,created_by:"portal",change_summary:`Draft - ${A.node_name===u?"updated":"carried forward"} content`});if(nt)throw nt}}pt.value[u]&&await ud(u),Mt.value[u]=!1,(d=window.$message)==null||d.success(`Node "${u}" saved as draft!`),console.log("Node saved, checking for draft..."),await Mo(),console.log("After checkForDraft, hasDraft.value:",Pt.value),await Ro(),await ar(u)}catch(R){console.error("Error saving node:",R);const W=R instanceof Error?R.message:"Unknown error";$t.value==="validating"?(T=window.$message)==null||T.error(`CLI validation failed: ${W}`):(N=window.$message)==null||N.error("Failed to save node: "+W)}finally{ee.value=!1,$t.value="idle"}}}async function rd(u,i){var N;if(!D.value)throw new Error("No vertical selected for validation");const f="http://localhost:8080",g=((N=sr.value)==null?void 0:N.id)||"inline";let d;try{d=await fetch(`${f}/api/test-cli`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({versionId:g,vertical:D.value,nodeName:u,promptContent:i})})}catch(R){throw new TypeError(`Failed to fetch: ${R.message}`)}let T={};try{T=await d.json()}catch(R){console.error("[Verticals] Failed parsing CLI response",R)}if(!d.ok){const R=pn(T,d);throw new Error(R)}if(!(T!=null&&T.success)){const R=pn(T);throw new Error(R)}}function pn(u={},i=null){var f,g;if(u!=null&&u.errorCode){const d=((f=u==null?void 0:u.details)==null?void 0:f.missingContexts)||[],T=((g=u==null?void 0:u.details)==null?void 0:g.emptyContexts)||[],N=[];return d.length&&N.push(`${d.join(", ")} ${d.length===1?"context is missing":"contexts are missing"} in Supabase`),T.length&&N.push(`${T.join(", ")} ${T.length===1?"context is empty":"contexts are empty"}`),N.length?`Guardrail blocked save: ${N.join("; ")}.`:u.error||"Context guardrail blocked this save."}return u!=null&&u.error?u.error:i?`HTTP ${i.status}: ${i.statusText}`:"CLI validation failed"}async function fn(){var i;if(!D.value)return;const u="http://localhost:8080";try{const f=await fetch(`${u}/api/validate-routing`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vertical:D.value})});let g={};try{g=await f.json()}catch(d){console.error("[Verticals] Failed parsing routing validation response",d);return}if(!f.ok||!g.success){const{errorMessages:d,hasAutoFixes:T}=od(g.errors||{},g.fixes||{});if(d.length>0){let N=` Routing configuration issues found:

${d.join(`

`)}

`;T&&(N+=` These issues can be auto-fixed. Click "Auto-Fix" to automatically add missing tools and valid_contexts.

`),N+="These issues may cause calls to hang or disconnect.",window.__routingValidationFixes=g.fixes||{},window.__routingValidationErrors=g.errors||{};const R=new Error(N);throw R.canAutoFix=T,R}else{const N=g.error||(f.statusText?`${f.status} ${f.statusText}`:"Unknown validation error");throw console.warn("[Verticals] Validation failed with unformatted error:",N),new Error(` Routing validation failed: ${N}`)}}else console.log("[Verticals] Routing validation passed - all contexts configured correctly"),window.__routingValidationFixes=null,window.__routingValidationErrors=null}catch(f){if(f.message&&f.message.includes("Routing configuration issues"))throw f;console.warn("[Verticals] Routing validation service error (non-blocking):",f.message),(i=window.$message)==null||i.warning({message:"Routing validation unavailable",description:"Could not validate routing configuration. Save will proceed, but please verify manually.",duration:5e3})}}function od(u,i={}){if(!u||Object.keys(u).length===0)return{errorMessages:[],hasAutoFixes:!1};const f=[];let g=!1;for(const[d,T]of Object.entries(u))if(Array.isArray(T)&&T.length>0){const N=i[d]||{};let R=`${d.toUpperCase()}:
`;R+=T.map(Z=>`   ${Z}`).join(`
`);const W=[];N.missing_tools&&N.missing_tools.length>0&&(W.push(`     ADD TOOLS: ${N.missing_tools.join(", ")}`),g=!0),N.missing_valid_contexts&&N.missing_valid_contexts.length>0&&(W.push(`     ADD VALID_CONTEXTS: ${N.missing_valid_contexts.join(", ")}`),g=!0),N.invalid_tools&&N.invalid_tools.length>0&&(W.push(`     REMOVE INVALID TOOLS: ${N.invalid_tools.join(", ")}`),g=!0),N.invalid_targets&&N.invalid_targets.length>0&&(W.push(`     REMOVE INVALID TARGETS: ${N.invalid_targets.join(", ")}`),g=!0),W.length>0&&(R+=`
`+W.join(`
`)),f.push(R)}else typeof T=="string"&&f.push(`${d.toUpperCase()}: ${T}`);return{errorMessages:f,hasAutoFixes:g}}async function id(u){var f,g,d;if(!D.value||!U.value)return;const i=Nt.value.find(T=>T.id===u);if(i){if(!i.is_draft||i.is_active){(f=window.$message)==null||f.error("Can only delete draft versions that have not been deployed");return}if(confirm(`Are you sure you want to delete draft v${i.version_number}? This cannot be undone.`)){ee.value=!0;try{const{error:T}=await V.from("prompt_versions").delete().eq("id",u);if(T)throw T;(g=window.$message)==null||g.success(`Draft v${i.version_number} deleted successfully`),await ar(U.value)}catch(T){console.error("Error deleting version:",T),(d=window.$message)==null||d.error("Failed to delete version: "+T.message)}finally{ee.value=!1}}}}async function nd(u){var i;if(Object.keys(Ze.value).forEach(f=>{Ze.value[f]=f===u?!Ze.value[f]:!1}),Object.keys(Pe.value).forEach(f=>{Pe.value[f]=!1}),St.value=null,Ze.value[u]){U.value=u,x.value[u]||(x.value[u]={instructions:"",tools:[]});let f=(i=at.value[D.value])==null?void 0:i[u];if(console.log("Toggle node:",u,"NodePrompt:",f),!f){console.warn("Toggle node: NodePrompt not found in nodePrompts, attempting to load from database...");try{const{data:g,error:d}=await V.from("prompts").select(`
            id,
            name,
            vertical,
            node_name,
            current_version,
            prompt_versions!inner (
              id,
              version_number,
              content,
              is_active,
              is_draft
            )
          `).eq("vertical",D.value).eq("node_name",u).eq("prompt_versions.is_active",!0).eq("prompt_versions.is_draft",!1).limit(1).maybeSingle();if(d)throw d;if(g){const T=Array.isArray(g.prompt_versions)?g.prompt_versions.find(N=>N.is_active&&!N.is_draft)||g.prompt_versions[0]:g.prompt_versions;T&&(f={id:g.id,vertical:g.vertical,node_name:g.node_name,name:g.name,version_number:T.version_number,content:T.content},at.value[D.value]||(at.value[D.value]={}),at.value[D.value][u]=f,console.log("Toggle node: Successfully loaded node from database:",f))}}catch(g){console.error("Toggle node: Failed to load node from database:",g)}}if(f&&f.content){const g=f.content;console.log("Loading content from nodePrompt:",g);let d=[];if(Array.isArray(g.tools))d=g.tools.flatMap(R=>{if(Array.isArray(R))return R;if(typeof R=="string")try{const W=JSON.parse(R);return Array.isArray(W)?W:[R]}catch{return[R]}return[R]}).filter(R=>R&&R!=="[]"&&typeof R=="string"&&R.trim()!=="");else if(typeof g.tools=="string")if(g.tools==="[]"||g.tools.trim()==="[]")d=[];else try{const R=JSON.parse(g.tools);d=Array.isArray(R)?R:[]}catch{d=g.tools.split(",").map(R=>R.trim()).filter(R=>R&&R!=="[]")}let T=[];if(Array.isArray(g.valid_contexts))T=g.valid_contexts.filter(R=>typeof R=="string"&&R.trim()!=="");else if(typeof g.valid_contexts=="string")if(g.valid_contexts==="[]"||g.valid_contexts.trim()==="[]")T=[];else try{const R=JSON.parse(g.valid_contexts);T=Array.isArray(R)?R:[]}catch{T=g.valid_contexts.split(",").map(R=>R.trim()).filter(R=>R&&R!=="[]")}const N={role:g.role||"",instructions:g.instructions||"",step_criteria:g.step_criteria||"",valid_contexts:[...T],tools:[...d],skip_user_turn:g.skip_user_turn||!1};x.value[u]=N,console.log("Set nodeContent for",u,":",x.value[u])}else x.value[u]||(console.log("No content found, initializing empty for",u),x.value[u]={instructions:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1});await ar(u),await ht(),setTimeout(()=>{yt(u)},100)}}function qe(u){Mt.value[u]=!0}function sd(u){return{greet:"First contact - Welcome the caller, introduce Barbara, and set friendly tone",verify:"Gather basic info - Collect property details and homeowner qualifications (age 62+, equity)",qualify:"Assess fit - Determine if reverse mortgage meets their needs and goals",educate:"Explain product - Answer questions about how reverse mortgages work",schedule:"Book appointment - Connect with licensed broker for detailed consultation",confirm:"Appointment details - Verify scheduled time and send confirmation",followup:"Post-call actions - Handle callbacks, answer follow-up questions",goodbye:"Natural farewell - Polite goodbye, allows last-minute questions before ending"}[u]||"Configure this conversation node"}function hn(u,i){x.value[u]||(x.value[u]={instructions:"",tools:[]}),x.value[u].instructions=i,qe(u)}function ad(u,i){x.value[u]||(x.value[u]={instructions:"",routing:"",tools:[]}),x.value[u].routing=i,qe(u)}function ld(u,i){x.value[u]||(x.value[u]={role:"",instructions:"",tools:[]}),x.value[u].role=i,qe(u)}function dd(u,i){x.value[u]||(x.value[u]={instructions:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1}),x.value[u].step_criteria=i,qe(u)}function cd(u,i){_e.value[u]||(_e.value[u]={isolated:!1,enter_fillers:[],exit_fillers:[]}),_e.value[u].isolated=i,pt.value[u]=!0,qe(u)}async function ud(u){const i=_e.value[u];if(!(!i||!pt.value[u]))try{const{data:f,error:g}=await V.from("contexts_config").select("id").eq("context_name",u).eq("vertical",D.value).maybeSingle();if(g&&g.code!=="PGRST116")throw g;if(f){const{error:d}=await V.from("contexts_config").update({isolated:i.isolated,enter_fillers:i.enter_fillers||[],exit_fillers:i.exit_fillers||[],updated_at:new Date().toISOString()}).eq("id",f.id);if(d)throw d}else{const{error:d}=await V.from("contexts_config").insert({vertical:D.value,context_name:u,isolated:i.isolated,enter_fillers:i.enter_fillers||[],exit_fillers:i.exit_fillers||[]});if(d)throw d}pt.value[u]=!1,console.log(`Context config saved for ${u}`)}catch(f){throw console.error("Error saving context config:",f),f}}async function vd(){if(D.value)try{const{data:u,error:i}=await V.from("contexts_config").select("context_name, isolated, enter_fillers, exit_fillers").eq("vertical",D.value);if(i)throw i;const f={};for(const g of u||[])f[g.context_name]={isolated:g.isolated||!1,enter_fillers:g.enter_fillers||[],exit_fillers:g.exit_fillers||[]};_e.value=f,console.log("Loaded context configs:",f)}catch(u){console.error("Error loading context configs:",u)}}function Fr(u){_e.value[u]||(_e.value[u]={isolated:!1,enter_fillers:[],exit_fillers:[]})}function md(u){Fr(u),_e.value[u].enter_fillers||(_e.value[u].enter_fillers=[]),_e.value[u].enter_fillers.push(""),pt.value[u]=!0,qe(u)}function pd(u,i){var f;(f=_e.value[u])!=null&&f.enter_fillers&&(_e.value[u].enter_fillers.splice(i,1),pt.value[u]=!0,qe(u))}function fd(u,i,f){Fr(u),_e.value[u].enter_fillers||(_e.value[u].enter_fillers=[]),_e.value[u].enter_fillers[i]=f,pt.value[u]=!0,qe(u)}function hd(u){Fr(u),_e.value[u].exit_fillers||(_e.value[u].exit_fillers=[]),_e.value[u].exit_fillers.push(""),pt.value[u]=!0,qe(u)}function gd(u,i){var f;(f=_e.value[u])!=null&&f.exit_fillers&&(_e.value[u].exit_fillers.splice(i,1),pt.value[u]=!0,qe(u))}function _d(u,i,f){Fr(u),_e.value[u].exit_fillers||(_e.value[u].exit_fillers=[]),_e.value[u].exit_fillers[i]=f,pt.value[u]=!0,qe(u)}function zS(u,i){}function gn(u,i){!r.value[u]||!i||h.value[u]||(h.value[u]=!0,requestAnimationFrame(()=>{try{const f=i.querySelector(".tools-dropdown-trigger");if(!f){h.value[u]=!1;return}const g=f.getBoundingClientRect(),d=window.innerHeight,T=300,N=d-g.bottom,R=g.top,W=N<T&&R>N;p.value[u]={dropUp:W,style:{position:"fixed",top:W?"auto":`${g.bottom+4}px`,bottom:W?`${d-g.top+4}px`:"auto",left:`${g.left}px`,width:`${g.width}px`,zIndex:1e4}}}finally{h.value[u]=!1}}))}function yd(u){r.value[u]=!r.value[u],r.value[u]?(m.value[u]||(m.value[u]=""),setTimeout(()=>{const i=document.querySelector(`[data-dropdown-node="${u}"]`);i&&gn(u,i)},10)):delete p.value[u]}function Lo(u){const i=m.value[u]||"",f=ge.filter(g=>oe.includes(g)||ge.includes(g));return i?f.filter(g=>g.toLowerCase().includes(i.toLowerCase())):f}function Oo(u){const i=m.value[u]||"",f=oe.filter(g=>!ge.includes(g)&&g!=="get_lead_context");return i?f.filter(g=>g.toLowerCase().includes(i.toLowerCase())):f}function _n(u){return[...Lo(u),...Oo(u)]}function yn(u){var g;const i=(g=x.value[u])==null?void 0:g.tools;if(!Array.isArray(i))return 0;const f=[...ge,...oe];return i.filter(d=>f.includes(d)).length}function bn(u){var g;const i=((g=x.value[u])==null?void 0:g.tools)||[];if(!Array.isArray(i))return!1;const f=_n(u);return f.length>0&&f.every(d=>i.includes(d))}function bd(u){x.value[u]||(x.value[u]={instructions:"",tools:[]}),Array.isArray(x.value[u].tools)||(x.value[u].tools=[]);const i=_n(u);bn(u)?i.forEach(g=>{const d=x.value[u].tools.indexOf(g);d>-1&&x.value[u].tools.splice(d,1)}):i.forEach(g=>{x.value[u].tools.includes(g)||x.value[u].tools.push(g)}),qe(u)}function wd(u){y.value[u]=!y.value[u],y.value[u]?(b.value[u]||(b.value[u]=""),setTimeout(()=>{const i=document.querySelector(`[data-dropdown-node="${u}"][data-dropdown-type="context"]`);i&&Cd(u,i)},10)):delete S.value[u]}function Vo(u){const i=b.value[u]||"",f=e;return i?f.filter(g=>g.toLowerCase().includes(i.toLowerCase())):f}function wn(u){var g;const i=((g=x.value[u])==null?void 0:g.valid_contexts)||[];if(!Array.isArray(i))return!1;const f=Vo(u);return f.length>0&&f.every(d=>i.includes(d))}function Sd(u){x.value[u]||(x.value[u]={instructions:"",step_criteria:"",valid_contexts:[],tools:[],skip_user_turn:!1}),Array.isArray(x.value[u].valid_contexts)||(x.value[u].valid_contexts=[]);const i=Vo(u);wn(u)?i.forEach(g=>{const d=x.value[u].valid_contexts.indexOf(g);d>-1&&x.value[u].valid_contexts.splice(d,1)}):i.forEach(g=>{x.value[u].valid_contexts.includes(g)||x.value[u].valid_contexts.push(g)}),qe(u)}function kd(u,i){i&&(k.value[u]=i)}function Cd(u,i){if(!y.value[u]||!i)return;const f=i.querySelector(".tools-dropdown-trigger");if(!f)return;const g=f.getBoundingClientRect(),d=window.innerHeight,T=300,N=d-g.bottom,R=g.top,W=N<T&&R>N;S.value[u]={dropUp:W,style:{position:"fixed",top:W?"auto":`${g.bottom+4}px`,bottom:W?`${d-g.top+4}px`:"auto",left:`${g.left}px`,width:`${g.width}px`,zIndex:1e4}}}function Td(u,i){const f=n.value[u]||"";if(!f)return i;const g=f.toLowerCase();return i.filter(d=>d.key.toLowerCase().includes(g)||d.desc.toLowerCase().includes(g)||d.display.toLowerCase().includes(g))}function Ed(u){o.value[u]=!o.value[u],o.value[u]?(n.value[u]||(n.value[u]=""),ht(()=>{const i=l.value[u];i&&Id(u,i)})):delete s.value[u]}function Id(u,i){if(!o.value[u]||!i)return;const f=i.querySelector(".variable-button");if(!f)return;const g=f.getBoundingClientRect(),d=window.innerHeight,T=300,N=d-g.bottom,R=g.top,W=N<T&&R>N;s.value[u]={dropUp:W,style:{position:"fixed",top:W?"auto":`${g.bottom+4}px`,bottom:W?`${d-g.top+4}px`:"auto",left:`${g.left}px`,width:"300px",maxHeight:`${T}px`,overflowY:"auto",zIndex:1e4}}}function Md(u,i){i&&(l.value[u]=i)}function Pd(u,i){i&&(c.value[u]=i)}function Do(u,i){const f=i.target;v.value[u]={start:f.selectionStart,end:f.selectionEnd}}function Ad(u,i){var R;const f=c.value[u];if(!f)return;const g=`$${i}`,d=((R=x.value[u])==null?void 0:R.instructions)||"",T=f.selectionStart||d.length,N=d.slice(0,T)+g+d.slice(T);hn(u,N),ht(()=>{const W=T+g.length;f.setSelectionRange(W,W),f.focus()}),o.value[u]=!1,delete s.value[u]}function xd(){ce.value={assistantName:"Barbara",company:"Equity Connect",productService:"",targetAudience:"",toneStyle:"",coreValues:"",restrictions:""},q.value="",H.value=[],C.value=!0}function lr(){C.value=!1,q.value="",H.value=[]}async function Sn(){if(!ce.value.productService.trim()){window.alert("Please fill in the product/service field");return}{window.alert("OpenAI API key not found. Add VITE_OPENAI_API_KEY to portal/.env.local and restart dev server.");return}}function Rd(){ae.value.identity=q.value,je.value=!0,lr()}function Ld(u){$.value=u;const i=To[u];i?Q.value={goal:i.goal,callDirections:i.callDirections||[],customScenarios:"",handling:i.handling||"",infoGathering:i.infoGathering||"",transitions:i.transitions||""}:Q.value={goal:"",callDirections:[],customScenarios:"",handling:"",infoGathering:"",transitions:""},q.value="",H.value=[],de.value=[],Me.value="",E.value=!0}function dr(){E.value=!1,$.value=null,q.value="",H.value=[],de.value=[],Me.value=""}function Od(u){const i=Q.value.callDirections.indexOf(u);i>-1?Q.value.callDirections.splice(i,1):Q.value.callDirections.push(u)}function Vd(){const u=To[$.value];u&&(Q.value={goal:u.goal,callDirections:u.callDirections||[],customScenarios:"",handling:u.handling||"",infoGathering:u.infoGathering||"",transitions:u.transitions||""})}async function kn(){if(!Q.value.goal.trim()){window.alert("Please fill in the goal field");return}{window.alert("OpenAI API key not found. Add VITE_OPENAI_API_KEY to portal/.env.local");return}}function Dd(){x.value[$.value]||(x.value[$.value]={instructions:"",tools:[]}),x.value[$.value].instructions=q.value,qe($.value),dr()}function Nd(u){var d;const i=x.value[u],g=`${Pl.value||"[Theme not loaded]"}

---

=== CALL CONTEXT (preview) ===
Call Type: inbound
Direction: Inbound
Phone: +15551234567
Lead Status: Known (ID: preview-123)
Lead Name: John Smith
Qualified: Yes
Property: 123 Main St, Los Angeles, CA
Est. Equity: $450,000
Assigned Broker: Walter White (ABC Mortgage)
===================

---

## Instructions
${i.instructions||"[No instructions defined]"}

## Tools
${i.tools||"[No tools defined]"}`;$r.value=g,Ge.value&&window.scrollTo({top:((d=document.querySelector(".preview-panel"))==null?void 0:d.offsetTop)||0,behavior:"smooth"})}function $d(u){u&&(Eo.value="single",Io.value=u,Wr.value=!0)}function Cn(){Eo.value="full",Io.value="greet",Wr.value=!0}function Wd(u){if(!u)return"";const i=new Date(u);return i.toLocaleDateString()+" "+i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}async function Tn(){if(D.value)if(Nl(),await ln(),await Ro(),await vd(),await Mo(),e.length>0){const u=e[0];U.value=u,await ar(u)}else U.value=null}function No(){Ge.value=window.innerWidth<768}lt(U,u=>{u&&ar(u)}),lt(ae,()=>{ht(()=>{$o()})},{deep:!0}),lt(Ze,(u,i)=>{ht(()=>{Object.keys(u).forEach(f=>{u[f]&&(!i||!i[f])&&setTimeout(()=>{yt(f)},150)})})},{deep:!0}),lt(()=>x.value,()=>{U.value&&Ze.value[U.value]&&ht(()=>{setTimeout(()=>{yt(U.value)},50)})},{deep:!0});function $o(){document.querySelectorAll(".theme-field-auto").forEach(i=>{i.style.height="auto",i.style.height=i.scrollHeight+"px"})}function yt(u){if(!u)return;const i=document.querySelector(`[data-node="${u}"]`);if(!i)return;const f=i.querySelectorAll(".editor-field textarea");f.length!==0&&f.forEach((g,d)=>{const T=x.value[u];T&&(d===0&&T.role!==void 0?g.value=T.role||"":d===1&&T.instructions!==void 0?g.value=T.instructions||"":d===2&&T.step_criteria!==void 0&&(g.value=T.step_criteria||""));const N=g.scrollTop;g.style.height="auto",g.offsetHeight;const R=window.getComputedStyle(g),W=parseInt(R.getPropertyValue("line-height"))||20,Z=parseInt(R.getPropertyValue("padding-top"))||12,re=parseInt(R.getPropertyValue("padding-bottom"))||12,we=Z+re,Ae=parseInt(R.getPropertyValue("border-top-width"))||1,Fe=parseInt(R.getPropertyValue("border-bottom-width"))||1,Je=Ae+Fe,Ee=parseInt(g.getAttribute("rows")||"3")*W+we+Je,me=g.scrollHeight,Be=Math.max(me,Ee);g.style.height=Be+"px",g.scrollTop=N})}function En(u){const i=u.target;i.closest(".node-card-header")||i.closest(".tools-dropdown-panel")||i.closest(".variable-dropdown-panel")||(i.closest(".tools-dropdown-wrapper")||Object.keys(r.value).forEach(f=>{r.value[f]=!1}),i.closest('[data-dropdown-type="context"]')||Object.keys(y.value).forEach(f=>{y.value[f]=!1,delete S.value[f]}),i.closest(".variable-dropdown-wrapper")||Object.keys(o.value).forEach(f=>{o.value[f]=!1,delete s.value[f]}))}async function Ud(){try{Qe.value=await jg()}catch(u){console.error("Failed to load phone numbers:",u)}}zd(async()=>{window.addEventListener("resize",No),No(),document.addEventListener("click",En),window.addEventListener("scroll",Br,!0),window.addEventListener("resize",Br),await sn(),await nn(),await an(),await ql(),await dn(),console.log(" onMounted: Loading SignalWire config for default vertical"),await Po(),await Ud(),await Yl(),await Tn()}),lt(D,async()=>{kt.value==="signalwire"&&(P.value.vertical=D.value,await Po())}),lt(kt,async u=>{console.log(" Platform changed to:",u),u==="signalwire"&&(console.log(" Loading SignalWire config..."),await dn(),await Po())}),lt(()=>_.value.tts_model,async()=>{_.value.tts_model&&_.value.tts_provider&&await xo()}),lt(()=>_.value.stt_provider,async()=>{_.value.stt_provider&&_.value.model_type==="pipeline"&&await Ur()}),lt(()=>_.value.tts_provider,async()=>{_.value.tts_provider&&_.value.model_type==="pipeline"&&await jr()}),lt(()=>_.value.llm_provider,async()=>{_.value.llm_provider&&_.value.model_type==="pipeline"&&await qr()});let Wo=null;function Br(){Wo&&clearTimeout(Wo),Wo=setTimeout(()=>{Object.keys(r.value).forEach(u=>{if(r.value[u]&&!h.value[u]){const i=document.querySelector(`[data-dropdown-node="${u}"]`);i&&gn(u,i)}})},16)}return Hd(()=>{window.removeEventListener("resize",No),document.removeEventListener("click",En),window.removeEventListener("scroll",Br,!0),window.removeEventListener("resize",Br)}),(u,i)=>{var f,g;return M(),I(fe,null,[a("div",qg,[a("header",Fg,[i[118]||(i[118]=a("h1",{class:"page-title"},"BarbGraph Vertical Manager",-1)),a("div",Bg,[i[117]||(i[117]=a("label",{for:"vertical-select"},"Vertical:",-1)),L(a("select",{id:"vertical-select","onUpdate:modelValue":i[0]||(i[0]=d=>D.value=d),onChange:Tn},[...i[116]||(i[116]=[a("option",{value:""},"-- Select Vertical --",-1),a("option",{value:"reverse_mortgage"},"Reverse Mortgage",-1),a("option",{value:"solar"},"Solar",-1),a("option",{value:"hvac"},"HVAC",-1)])],544),[[ye,D.value]])])]),D.value?(M(),I("div",zg,[(M(),I(fe,null,be(Dl,d=>a("button",{key:d.key,class:Ie(["tab-button",{active:ie.value===d.key}]),onClick:T=>ie.value=d.key},B(d.label),11,Hg)),64))])):X("",!0),D.value?(M(),I("div",Gg,[a("aside",{class:Ie(["versions-bar",{mobile:Ge.value}])},[i[119]||(i[119]=a("div",{class:"versions-header"},[a("h3",null,"Versions")],-1)),a("div",{class:Ie(["versions-list",{horizontal:Ge.value}])},[(M(!0),I(fe,null,be(Nt.value,d=>{var T;return M(),I("button",{key:d.id,class:Ie(["version-item",{active:((T=sr.value)==null?void 0:T.id)===d.id}]),onClick:N=>mn(d.id)},[d.is_active?(M(),I("span",Jg,"Active")):d.is_draft?(M(),I("span",Yg,"Draft")):X("",!0),a("span",Xg,"v"+B(d.version_number),1),a("span",Qg,B(Wd(d.created_at)),1),d.is_draft&&!d.is_active?(M(),I("button",{key:2,class:"btn-delete",onClick:Le(N=>id(d.id),["stop"]),disabled:ee.value,title:"Delete draft"},"  ",8,Zg)):X("",!0)],10,Kg)}),128))],2)],2),a("div",e_,[ie.value==="theme"?(M(),I("div",t_,[a("div",r_,[a("div",o_,[i[120]||(i[120]=a("h2",null,"Theme",-1)),a("div",i_,[a("button",{class:"btn-save-all",onClick:Al,disabled:ee.value||!Or.value,title:Or.value?`Save ${Co.value} change(s) as draft`:"No changes to save"},"  Save"+B(Or.value?` (${Co.value})`:""),9,n_),a("button",{class:"btn-publish",onClick:Wl,disabled:ee.value||!Pt.value,title:"Publish draft version to make it active"},"  Publish ",8,s_),a("button",{class:"btn-test",onClick:Cn,disabled:ee.value},"  Test ",8,a_),a("button",{class:"btn-ai-helper",onClick:xd,title:"AI Theme Generator"},"  AI Helper ")])]),a("div",l_,[a("div",{class:Ie(["theme-section",{active:St.value==="identity"}])},[a("div",{class:"theme-section-header",onClick:i[1]||(i[1]=d=>Gt("identity"))},[i[121]||(i[121]=a("span",{class:"section-label"},[et(" Identity "),a("span",{class:"tooltip-indicator",title:"Who is Barbara? One sentence defining her role."},"*")],-1)),a("span",d_,B(Pe.value.identity?"":"+"),1)]),Pe.value.identity?(M(),I("div",c_,[L(a("textarea",{"onUpdate:modelValue":i[2]||(i[2]=d=>ae.value.identity=d),class:"theme-field theme-field-auto",placeholder:"You are Barbara, a warm and professional voice assistant helping homeowners...",onInput:i[3]||(i[3]=d=>je.value=!0)},null,544),[[K,ae.value.identity]])])):X("",!0)],2),a("div",{class:Ie(["theme-section",{active:St.value==="output_rules"}])},[a("div",{class:"theme-section-header",onClick:i[4]||(i[4]=d=>Gt("output_rules"))},[i[122]||(i[122]=a("span",{class:"section-label"},[et(" Output Rules "),a("span",{class:"tooltip-indicator",title:"TTS formatting rules: numbers, brevity, no markdown, etc."},"*")],-1)),a("span",u_,B(Pe.value.output_rules?"":"+"),1)]),Pe.value.output_rules?(M(),I("div",v_,[L(a("textarea",{"onUpdate:modelValue":i[5]||(i[5]=d=>ae.value.output_rules=d),class:"theme-field theme-field-auto",placeholder:`- Respond in plain text only. Never use JSON, markdown, lists...
- Keep replies brief: one to three sentences...
- Spell out numbers...`,onInput:i[6]||(i[6]=d=>je.value=!0)},null,544),[[K,ae.value.output_rules]])])):X("",!0)],2),a("div",{class:Ie(["theme-section",{active:St.value==="conversational_flow"}])},[a("div",{class:"theme-section-header",onClick:i[7]||(i[7]=d=>Gt("conversational_flow"))},[i[123]||(i[123]=a("span",{class:"section-label"},[et(" Conversational Flow "),a("span",{class:"tooltip-indicator",title:"How should Barbara guide the conversation?"},"*")],-1)),a("span",m_,B(Pe.value.conversational_flow?"":"+"),1)]),Pe.value.conversational_flow?(M(),I("div",p_,[L(a("textarea",{"onUpdate:modelValue":i[8]||(i[8]=d=>ae.value.conversational_flow=d),class:"theme-field theme-field-auto",placeholder:`- Help the caller accomplish their objective efficiently...
- Provide guidance in small steps...
- Summarize key results...`,onInput:i[9]||(i[9]=d=>je.value=!0)},null,544),[[K,ae.value.conversational_flow]])])):X("",!0)],2),a("div",{class:Ie(["theme-section",{active:St.value==="tools"}])},[a("div",{class:"theme-section-header",onClick:i[10]||(i[10]=d=>Gt("tools"))},[i[124]||(i[124]=a("span",{class:"section-label"},[et(" Tools "),a("span",{class:"tooltip-indicator",title:"General tool usage guidelines (not specific tool definitions)."},"*")],-1)),a("span",f_,B(Pe.value.tools?"":"+"),1)]),Pe.value.tools?(M(),I("div",h_,[L(a("textarea",{"onUpdate:modelValue":i[11]||(i[11]=d=>ae.value.tools=d),class:"theme-field theme-field-auto",placeholder:`- Use available tools as needed, or upon user request...
- Collect required information first...
- Speak outcomes clearly...`,onInput:i[12]||(i[12]=d=>je.value=!0)},null,544),[[K,ae.value.tools]])])):X("",!0)],2),a("div",{class:Ie(["theme-section",{active:St.value==="guardrails"}])},[a("div",{class:"theme-section-header",onClick:i[13]||(i[13]=d=>Gt("guardrails"))},[i[125]||(i[125]=a("span",{class:"section-label"},[et(" Guardrails "),a("span",{class:"tooltip-indicator",title:"Safety limits, scope boundaries, privacy rules."},"*")],-1)),a("span",g_,B(Pe.value.guardrails?"":"+"),1)]),Pe.value.guardrails?(M(),I("div",__,[L(a("textarea",{"onUpdate:modelValue":i[14]||(i[14]=d=>ae.value.guardrails=d),class:"theme-field theme-field-auto",placeholder:`- Stay within safe, lawful, and appropriate use...
- For medical, legal, or financial topics, provide general info only...
- Protect privacy...`,onInput:i[15]||(i[15]=d=>je.value=!0)},null,544),[[K,ae.value.guardrails]])])):X("",!0)],2),a("div",{class:Ie(["theme-section",{active:St.value==="pronunciations"}])},[a("div",{class:"theme-section-header",onClick:i[16]||(i[16]=d=>Gt("pronunciations"))},[i[126]||(i[126]=a("span",{class:"section-label"},[et(" Pronunciations "),a("span",{class:"tooltip-indicator",title:"TTS pronunciation rules for acronyms and industry terms. Maps words to phonetic spellings."},"*")],-1)),a("span",y_,B(Pe.value.pronunciations?"":"+"),1)]),Pe.value.pronunciations?(M(),I("div",b_,[i[129]||(i[129]=a("p",{class:"section-description"},'Define how the TTS engine should pronounce specific words (e.g., "HECM"  "heck-em").',-1)),a("div",w_,[(M(!0),I(fe,null,be(Ke.value.pronunciations,(d,T)=>(M(),I("div",{key:T,class:"pronunciation-item"},[L(a("input",{type:"text","onUpdate:modelValue":N=>d.replace=N,placeholder:"Word (e.g., HECM)",class:"pron-input pron-replace",onInput:i[17]||(i[17]=N=>je.value=!0)},null,40,S_),[[K,d.replace]]),i[127]||(i[127]=a("span",{class:"pron-arrow"},"",-1)),L(a("input",{type:"text","onUpdate:modelValue":N=>d.with=N,placeholder:"Say as (e.g., heck-em)",class:"pron-input pron-with",onInput:i[18]||(i[18]=N=>je.value=!0)},null,40,k_),[[K,d.with]]),a("button",{class:"btn-remove-pron",onClick:N=>Ml(T),title:"Remove"},"",8,C_)]))),128))]),a("div",T_,[L(a("input",{type:"text","onUpdate:modelValue":i[19]||(i[19]=d=>it.value.replace=d),placeholder:"Word to replace",class:"pron-input pron-replace",onKeyup:An(ko,["enter"])},null,544),[[K,it.value.replace]]),i[128]||(i[128]=a("span",{class:"pron-arrow"},"",-1)),L(a("input",{type:"text","onUpdate:modelValue":i[20]||(i[20]=d=>it.value.with=d),placeholder:"Phonetic spelling",class:"pron-input pron-with",onKeyup:An(ko,["enter"])},null,544),[[K,it.value.with]]),a("button",{class:"btn-add-pron",onClick:ko,disabled:!it.value.replace||!it.value.with},"+ Add",8,E_)])])):X("",!0)],2)]),i[130]||(i[130]=a("div",{class:"editor-actions"},null,-1))])])):X("",!0),ie.value==="models"?(M(),I("div",I_,[a("div",M_,[i[286]||(i[286]=a("h2",null,"Models & Voice Configuration",-1)),a("div",P_,[a("button",{class:Ie(["platform-tab",{active:kt.value==="signalwire"}]),onClick:i[21]||(i[21]=d=>kt.value="signalwire")}," SignalWire ",2),a("button",{class:Ie(["platform-tab",{active:kt.value==="livekit"}]),onClick:i[22]||(i[22]=d=>kt.value="livekit")}," LiveKit ",2)]),kt.value==="signalwire"?(M(),I("div",A_,[i[183]||(i[183]=a("h3",null,"SignalWire AI Configuration",-1)),i[184]||(i[184]=a("small",{class:"form-hint"},"Configure LLM, STT, and TTS models for SignalWire AI. Select from available models and save to mark as active.",-1)),a("div",x_,[i[134]||(i[134]=a("h4",null,"Language Model (LLM)",-1)),a("div",R_,[i[132]||(i[132]=a("label",null,"LLM Model",-1)),L(a("select",{"onUpdate:modelValue":i[23]||(i[23]=d=>P.value.llm_model=d)},[i[131]||(i[131]=a("option",{value:""},"-- Select LLM Model --",-1)),(M(!0),I(fe,null,be(ir.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,L_))),128))],512),[[ye,P.value.llm_model]]),i[133]||(i[133]=a("small",{class:"form-hint"},"Select the LLM model for conversation intelligence",-1))])]),a("div",O_,[i[138]||(i[138]=a("h4",null,"Speech-to-Text (STT)",-1)),a("div",V_,[i[136]||(i[136]=a("label",null,"STT Model",-1)),L(a("select",{"onUpdate:modelValue":i[24]||(i[24]=d=>P.value.stt_model=d)},[i[135]||(i[135]=a("option",{value:""},"-- Select STT Model --",-1)),(M(!0),I(fe,null,be(nr.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,D_))),128))],512),[[ye,P.value.stt_model]]),i[137]||(i[137]=a("small",{class:"form-hint"},"Select the speech recognition model",-1))])]),a("div",N_,[i[155]||(i[155]=a("h4",null,"Text-to-Speech (TTS)",-1)),a("div",$_,[i[139]||(i[139]=a("label",null,"TTS Engine",-1)),L(a("select",{"onUpdate:modelValue":i[25]||(i[25]=d=>P.value.tts_engine=d),onChange:Fl},[Kt.value.length===0?(M(),I("option",W_,"Loading engines...")):X("",!0),(M(!0),I(fe,null,be(Kt.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,U_))),128))],544),[[ye,P.value.tts_engine]]),i[140]||(i[140]=a("small",{class:"form-hint"},"Select the TTS provider for voice synthesis",-1))]),a("div",j_,[i[141]||(i[141]=a("label",null,"Voice Name",-1)),L(a("select",{"onUpdate:modelValue":i[26]||(i[26]=d=>P.value.voice_name=d),disabled:Ct.value.length===0},[Ct.value.length===0?(M(),I("option",F_,"Select TTS Engine first")):X("",!0),(M(!0),I(fe,null,be(Ct.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,B_))),128))],8,q_),[[ye,P.value.voice_name]]),i[142]||(i[142]=a("small",{class:"form-hint"},"Format: provider.voice_name (e.g., elevenlabs.rachel)",-1))]),a("div",z_,[i[144]||(i[144]=a("label",null,"Language",-1)),L(a("select",{"onUpdate:modelValue":i[27]||(i[27]=d=>P.value.language_code=d)},[...i[143]||(i[143]=[a("option",{value:"en-US"},"English (US)",-1),a("option",{value:"es-US"},"Spanish (US)",-1),a("option",{value:"es-MX"},"Spanish (Mexico)",-1)])],512),[[ye,P.value.language_code]])]),a("div",H_,[i[154]||(i[154]=a("h4",{style:{"margin-bottom":"16px","font-size":"16px",color:"#fff","font-weight":"600"}},"TTS Parameters",-1)),a("div",G_,[a("label",null,[i[145]||(i[145]=et(" AI Volume ",-1)),a("span",K_,B(P.value.ai_volume??0),1)]),a("div",J_,[a("div",{class:"slider-fill",style:qt({width:((P.value.ai_volume??0)+50)/100*100+"%"})},null,4),L(a("input",{type:"range","onUpdate:modelValue":i[28]||(i[28]=d=>P.value.ai_volume=d),min:"-50",max:"50",step:"1"},null,512),[[K,P.value.ai_volume,void 0,{number:!0}]])]),i[146]||(i[146]=a("div",{style:{display:"flex","justify-content":"space-between","font-size":"12px",color:"rgba(255, 255, 255, 0.5)","margin-top":"4px"}},[a("span",null,"-50 (Quiet)"),a("span",null,"0 (Normal)"),a("span",null,"50 (Loud)")],-1)),i[147]||(i[147]=a("small",{class:"form-hint"},"SignalWire AI-level volume control. Applies to all TTS providers.",-1))]),P.value.tts_engine==="elevenlabs"?(M(),I(fe,{key:0},[a("div",Y_,[a("label",null,[i[148]||(i[148]=et(" Stability ",-1)),a("span",X_,B((P.value.eleven_labs_stability??.5).toFixed(2)),1)]),a("div",Q_,[a("div",{class:"slider-fill",style:qt({width:(P.value.eleven_labs_stability??.5)/1*100+"%"})},null,4),L(a("input",{type:"range","onUpdate:modelValue":i[29]||(i[29]=d=>P.value.eleven_labs_stability=d),min:"0",max:"1",step:"0.01"},null,512),[[K,P.value.eleven_labs_stability,void 0,{number:!0}]])]),i[149]||(i[149]=a("div",{style:{display:"flex","justify-content":"space-between","font-size":"12px",color:"rgba(255, 255, 255, 0.5)","margin-top":"4px"}},[a("span",null,"0.0 (More Variation)"),a("span",null,"0.5 (Balanced)"),a("span",null,"1.0 (More Consistent)")],-1)),i[150]||(i[150]=a("small",{class:"form-hint"},"Voice consistency. Lower = more variation, Higher = more consistent.",-1))]),a("div",Z_,[a("label",null,[i[151]||(i[151]=et(" Similarity Boost ",-1)),a("span",ey,B((P.value.eleven_labs_similarity??.75).toFixed(2)),1)]),a("div",ty,[a("div",{class:"slider-fill",style:qt({width:(P.value.eleven_labs_similarity??.75)/1*100+"%"})},null,4),L(a("input",{type:"range","onUpdate:modelValue":i[30]||(i[30]=d=>P.value.eleven_labs_similarity=d),min:"0",max:"1",step:"0.01"},null,512),[[K,P.value.eleven_labs_similarity,void 0,{number:!0}]])]),i[152]||(i[152]=a("div",{style:{display:"flex","justify-content":"space-between","font-size":"12px",color:"rgba(255, 255, 255, 0.5)","margin-top":"4px"}},[a("span",null,"0.0 (Less Similar)"),a("span",null,"0.75 (Default)"),a("span",null,"1.0 (Most Similar)")],-1)),i[153]||(i[153]=a("small",{class:"form-hint"},"How closely output matches original voice. Higher = closer to original.",-1))])],64)):X("",!0)])]),a("div",ry,[i[171]||(i[171]=a("h4",null,"Agent Behavior",-1)),i[172]||(i[172]=a("small",{class:"form-hint"},"Control conversation pacing and interruption handling",-1)),a("div",oy,[i[156]||(i[156]=a("label",null,"End of Speech Timeout (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[31]||(i[31]=d=>P.value.end_of_speech_timeout=d),min:"1000",max:"5000",step:"100",placeholder:"2000"},null,512),[[K,P.value.end_of_speech_timeout,void 0,{number:!0}]]),i[157]||(i[157]=a("small",{class:"form-hint"},"How long to wait for silence before considering speech ended (1000-5000ms). Higher = more patience for seniors.",-1))]),a("div",iy,[i[158]||(i[158]=a("label",null,"Attention Timeout (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[32]||(i[32]=d=>P.value.attention_timeout=d),min:"5000",max:"60000",step:"1000",placeholder:"8000"},null,512),[[K,P.value.attention_timeout,void 0,{number:!0}]]),i[159]||(i[159]=a("small",{class:"form-hint"},"How long to wait before prompting inactive caller (5000-60000ms)",-1))]),a("div",ny,[a("label",null,[L(a("input",{type:"checkbox","onUpdate:modelValue":i[33]||(i[33]=d=>P.value.transparent_barge=d)},null,512),[[ft,P.value.transparent_barge]]),i[160]||(i[160]=et(" Transparent Barge ",-1))]),i[161]||(i[161]=a("small",{class:"form-hint"},"When enabled, AI waits for caller to finish speaking before responding (recommended for better conversation control)",-1))]),a("div",sy,[i[162]||(i[162]=a("label",null,"Initial Sleep (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[34]||(i[34]=d=>P.value.initial_sleep_ms=d),min:"0",max:"5000",step:"100",placeholder:"0"},null,512),[[K,P.value.initial_sleep_ms,void 0,{number:!0}]]),i[163]||(i[163]=a("small",{class:"form-hint"},"Delay before listening starts (0-5000ms). Use for initial greeting buffer.",-1))]),a("div",ay,[i[164]||(i[164]=a("label",null,"Energy Level",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[35]||(i[35]=d=>P.value.energy_level=d),min:"0",max:"255",step:"5",placeholder:"50"},null,512),[[K,P.value.energy_level,void 0,{number:!0}]]),i[165]||(i[165]=a("small",{class:"form-hint"},"Minimum audio level to detect speech (0-255). Lower = detects quieter speech.",-1))]),a("div",ly,[a("label",null,[i[166]||(i[166]=et(" Barge Confidence ",-1)),a("span",dy,B((P.value.barge_confidence??.6).toFixed(2)),1)]),a("div",cy,[a("div",{class:"slider-fill",style:qt({width:(P.value.barge_confidence??.6)/1*100+"%"})},null,4),L(a("input",{type:"range","onUpdate:modelValue":i[36]||(i[36]=d=>P.value.barge_confidence=d),min:"0",max:"1",step:"0.05"},null,512),[[K,P.value.barge_confidence,void 0,{number:!0}]])]),i[167]||(i[167]=a("div",{style:{display:"flex","justify-content":"space-between","font-size":"12px",color:"rgba(255, 255, 255, 0.5)","margin-top":"4px"}},[a("span",null,"0.0 (Very Sensitive)"),a("span",null,"0.6 (Default)"),a("span",null,"1.0 (Less Sensitive)")],-1)),i[168]||(i[168]=a("small",{class:"form-hint"},"Speech detection confidence threshold. Lower = more responsive to barge-in.",-1))]),a("div",uy,[i[169]||(i[169]=a("label",null,"First Word Timeout (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[37]||(i[37]=d=>P.value.first_word_timeout=d),min:"1000",max:"10000",step:"500",placeholder:"3000"},null,512),[[K,P.value.first_word_timeout,void 0,{number:!0}]]),i[170]||(i[170]=a("small",{class:"form-hint"},"How long to wait for first word before timeout (1000-10000ms)",-1))])]),a("div",vy,[i[181]||(i[181]=a("h4",null,"LLM Behavior",-1)),i[182]||(i[182]=a("small",{class:"form-hint"},"Fine-tune language model response characteristics",-1)),a("div",my,[i[173]||(i[173]=a("label",null,"Temperature",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[38]||(i[38]=d=>P.value.temperature=d),min:"0",max:"2",step:"0.1",placeholder:"0.7"},null,512),[[K,P.value.temperature,void 0,{number:!0}]]),i[174]||(i[174]=a("small",{class:"form-hint"},"Controls randomness. Lower (0.1-0.3) = more focused/deterministic. Higher (0.7-1.0) = more creative/varied. Default: 0.7",-1))]),a("div",py,[i[175]||(i[175]=a("label",null,"Top P (Nucleus Sampling)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[39]||(i[39]=d=>P.value.top_p=d),min:"0",max:"1",step:"0.05",placeholder:"1.0"},null,512),[[K,P.value.top_p,void 0,{number:!0}]]),i[176]||(i[176]=a("small",{class:"form-hint"},"Controls diversity via nucleus sampling. 0.1 = only top 10% probable tokens. 1.0 = consider all tokens. Default: 1.0",-1))]),a("div",fy,[i[177]||(i[177]=a("label",null,"Frequency Penalty",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[40]||(i[40]=d=>P.value.frequency_penalty=d),min:"-2",max:"2",step:"0.1",placeholder:"0.0"},null,512),[[K,P.value.frequency_penalty,void 0,{number:!0}]]),i[178]||(i[178]=a("small",{class:"form-hint"},"Reduces repetition of frequently used words. Positive values decrease repetition. Range: -2.0 to 2.0. Default: 0.0",-1))]),a("div",hy,[i[179]||(i[179]=a("label",null,"Presence Penalty",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[41]||(i[41]=d=>P.value.presence_penalty=d),min:"-2",max:"2",step:"0.1",placeholder:"0.0"},null,512),[[K,P.value.presence_penalty,void 0,{number:!0}]]),i[180]||(i[180]=a("small",{class:"form-hint"},"Encourages discussing new topics. Positive values increase likelihood of new topics. Range: -2.0 to 2.0. Default: 0.0",-1))])]),a("div",gy,[a("button",{class:"btn-save",onClick:Ul,disabled:ee.value}," Save SignalWire Configuration ",8,_y)])])):X("",!0),kt.value==="livekit"?(M(),I("div",yy,[i[284]||(i[284]=a("h3",null,"LiveKit AI Template Configuration",-1)),i[285]||(i[285]=a("small",{class:"form-hint"},"Full control over STT, TTS, and LLM providers with your own API keys. Or use Realtime models for bundled STT+LLM+TTS.",-1)),a("div",by,[i[186]||(i[186]=a("label",null,"Model Type",-1)),L(a("select",{"onUpdate:modelValue":i[42]||(i[42]=d=>_.value.model_type=d),onChange:Xl},[...i[185]||(i[185]=[a("option",{value:"pipeline"},"STT-LLM-TTS Pipeline (Separate Providers)",-1),a("option",{value:"openai_realtime"},"OpenAI Realtime (Bundled STT+LLM+TTS)",-1),a("option",{value:"gemini_live"},"Gemini Live (Bundled STT+LLM+TTS)",-1)])],544),[[ye,_.value.model_type]]),i[187]||(i[187]=a("small",{class:"form-hint"},"Realtime models combine STT, LLM, and TTS into a single model for lower latency. Requires API keys.",-1))]),_.value.model_type==="openai_realtime"?(M(),I("div",wy,[i[206]||(i[206]=a("h4",null,"OpenAI Realtime API",-1)),i[207]||(i[207]=a("small",{class:"form-hint"},"Bundled STT, LLM, and TTS in a single realtime model. Requires OPENAI_API_KEY.",-1)),a("div",Sy,[i[189]||(i[189]=a("label",null,"Model",-1)),L(a("select",{"onUpdate:modelValue":i[43]||(i[43]=d=>_.value.realtime_model=d)},[i[188]||(i[188]=a("option",{value:""},"Select a model...",-1)),(M(!0),I(fe,null,be(Vt.value,d=>(M(),I("option",{key:d.model_id_full,value:d.model_id_full},B(d.display_name)+" ("+B(d.model_name)+") ",9,ky))),128))],512),[[ye,_.value.realtime_model]])]),a("div",Cy,[i[191]||(i[191]=a("label",null,"Voice",-1)),L(a("select",{"onUpdate:modelValue":i[44]||(i[44]=d=>_.value.realtime_voice=d)},[...i[190]||(i[190]=[Uo('<option value="alloy" data-v-2ad75f01>Alloy</option><option value="echo" data-v-2ad75f01>Echo</option><option value="fable" data-v-2ad75f01>Fable</option><option value="onyx" data-v-2ad75f01>Onyx</option><option value="nova" data-v-2ad75f01>Nova</option><option value="shimmer" data-v-2ad75f01>Shimmer</option><option value="ash" data-v-2ad75f01>Ash</option><option value="ballad" data-v-2ad75f01>Ballad</option><option value="coral" data-v-2ad75f01>Coral</option><option value="sage" data-v-2ad75f01>Sage</option><option value="verse" data-v-2ad75f01>Verse</option><option value="charon" data-v-2ad75f01>Charon</option><option value="juniper" data-v-2ad75f01>Juniper</option><option value="lime" data-v-2ad75f01>Lime</option><option value="river" data-v-2ad75f01>River</option><option value="ember" data-v-2ad75f01>Ember</option><option value="marin" data-v-2ad75f01>Marin</option><option value="cove" data-v-2ad75f01>Cove</option>',18)])],512),[[ye,_.value.realtime_voice]])]),a("div",Ty,[i[192]||(i[192]=a("label",null,"Temperature",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[45]||(i[45]=d=>_.value.realtime_temperature=d),min:"0.6",max:"1.2",step:"0.1"},null,512),[[K,_.value.realtime_temperature,void 0,{number:!0}]]),i[193]||(i[193]=a("small",{class:"form-hint"},"0.6-1.2 (default: 0.8)",-1))]),a("div",Ey,[i[195]||(i[195]=a("label",null,"Modalities",-1)),L(a("select",{"onUpdate:modelValue":i[46]||(i[46]=d=>_.value.realtime_modalities=d),multiple:""},[...i[194]||(i[194]=[a("option",{value:"text"},"Text",-1),a("option",{value:"audio"},"Audio",-1)])],512),[[ye,_.value.realtime_modalities]]),i[196]||(i[196]=a("small",{class:"form-hint"},"Select both for full realtime, or just 'text' to use with separate TTS",-1))]),a("div",Iy,[i[198]||(i[198]=a("label",null,"Turn Detection Type",-1)),L(a("select",{"onUpdate:modelValue":i[47]||(i[47]=d=>_.value.realtime_turn_detection_type=d)},[...i[197]||(i[197]=[a("option",{value:"server_vad"},"Server VAD (Default)",-1),a("option",{value:"semantic_vad"},"Semantic VAD",-1)])],512),[[ye,_.value.realtime_turn_detection_type]])]),_.value.realtime_turn_detection_type==="server_vad"?(M(),I("div",My,[i[199]||(i[199]=a("label",null,"VAD Threshold",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[48]||(i[48]=d=>_.value.realtime_vad_threshold=d),min:"0",max:"1",step:"0.1"},null,512),[[K,_.value.realtime_vad_threshold,void 0,{number:!0}]]),i[200]||(i[200]=a("small",{class:"form-hint"},"Higher = less sensitive to background noise",-1))])):X("",!0),_.value.realtime_turn_detection_type==="server_vad"?(M(),I("div",Py,[i[201]||(i[201]=a("label",null,"Prefix Padding (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[49]||(i[49]=d=>_.value.realtime_prefix_padding_ms=d),min:"0",max:"1000"},null,512),[[K,_.value.realtime_prefix_padding_ms,void 0,{number:!0}]])])):X("",!0),_.value.realtime_turn_detection_type==="server_vad"?(M(),I("div",Ay,[i[202]||(i[202]=a("label",null,"Silence Duration (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[50]||(i[50]=d=>_.value.realtime_silence_duration_ms=d),min:"0",max:"5000"},null,512),[[K,_.value.realtime_silence_duration_ms,void 0,{number:!0}]]),i[203]||(i[203]=a("small",{class:"form-hint"},"Shorter = faster turn detection",-1))])):X("",!0),_.value.realtime_turn_detection_type==="semantic_vad"?(M(),I("div",xy,[i[205]||(i[205]=a("label",null,"Eagerness",-1)),L(a("select",{"onUpdate:modelValue":i[51]||(i[51]=d=>_.value.realtime_eagerness=d)},[...i[204]||(i[204]=[a("option",{value:"auto"},"Auto (Medium)",-1),a("option",{value:"low"},"Low (Let users take their time)",-1),a("option",{value:"medium"},"Medium (Balanced)",-1),a("option",{value:"high"},"High (Respond quickly)",-1)])],512),[[ye,_.value.realtime_eagerness]])])):X("",!0)])):X("",!0),_.value.model_type==="gemini_live"?(M(),I("div",Ry,[i[226]||(i[226]=a("h4",null,"Gemini Live API",-1)),i[227]||(i[227]=a("small",{class:"form-hint"},"Bundled STT, LLM, and TTS in a single realtime model. Requires GOOGLE_API_KEY or GOOGLE_APPLICATION_CREDENTIALS.",-1)),a("div",Ly,[i[209]||(i[209]=a("label",null,"Model",-1)),L(a("select",{"onUpdate:modelValue":i[52]||(i[52]=d=>_.value.gemini_model=d)},[i[208]||(i[208]=a("option",{value:""},"Select a model...",-1)),(M(!0),I(fe,null,be(Dt.value,d=>(M(),I("option",{key:d.model_id_full,value:d.model_id_full},B(d.display_name)+" ("+B(d.model_name)+") ",9,Oy))),128))],512),[[ye,_.value.gemini_model]])]),a("div",Vy,[i[211]||(i[211]=a("label",null,"Voice",-1)),L(a("select",{"onUpdate:modelValue":i[53]||(i[53]=d=>_.value.gemini_voice=d)},[...i[210]||(i[210]=[Uo('<option value="Puck" data-v-2ad75f01>Puck (Default)</option><option value="Charon" data-v-2ad75f01>Charon</option><option value="Kore" data-v-2ad75f01>Kore</option><option value="Fenrir" data-v-2ad75f01>Fenrir</option><option value="Aoede" data-v-2ad75f01>Aoede</option>',5)])],512),[[ye,_.value.gemini_voice]]),i[212]||(i[212]=a("small",{class:"form-hint"},"See Gemini docs for full voice list",-1))]),a("div",Dy,[i[213]||(i[213]=a("label",null,"Temperature",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[54]||(i[54]=d=>_.value.gemini_temperature=d),min:"0",max:"2",step:"0.1"},null,512),[[K,_.value.gemini_temperature,void 0,{number:!0}]]),i[214]||(i[214]=a("small",{class:"form-hint"},"0.0 = deterministic, 2.0 = creative",-1))]),a("div",Ny,[i[215]||(i[215]=a("label",null,"Instructions",-1)),L(a("textarea",{"onUpdate:modelValue":i[55]||(i[55]=d=>_.value.gemini_instructions=d),rows:"3",placeholder:"System instructions for tone and behavior"},null,512),[[K,_.value.gemini_instructions]]),i[216]||(i[216]=a("small",{class:"form-hint"},"System instructions to control model output and tone",-1))]),a("div",$y,[i[218]||(i[218]=a("label",null,"Modalities",-1)),L(a("select",{"onUpdate:modelValue":i[56]||(i[56]=d=>_.value.gemini_modalities=d),multiple:""},[...i[217]||(i[217]=[a("option",{value:"AUDIO"},"Audio",-1),a("option",{value:"TEXT"},"Text",-1)])],512),[[ye,_.value.gemini_modalities]]),i[219]||(i[219]=a("small",{class:"form-hint"},"Select AUDIO for full realtime, or TEXT to use with separate TTS",-1))]),a("div",Wy,[i[220]||(i[220]=a("label",null,"Enable Affective Dialog",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[57]||(i[57]=d=>_.value.gemini_enable_affective_dialog=d)},null,512),[[ft,_.value.gemini_enable_affective_dialog]]),i[221]||(i[221]=a("small",{class:"form-hint"},"Enable emotional understanding on supported models",-1))]),a("div",Uy,[i[222]||(i[222]=a("label",null,"Proactivity",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[58]||(i[58]=d=>_.value.gemini_proactivity=d)},null,512),[[ft,_.value.gemini_proactivity]]),i[223]||(i[223]=a("small",{class:"form-hint"},"Enable proactive audio (model can choose not to respond)",-1))]),a("div",jy,[i[224]||(i[224]=a("label",null,"Use Vertex AI",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[59]||(i[59]=d=>_.value.gemini_vertexai=d)},null,512),[[ft,_.value.gemini_vertexai]]),i[225]||(i[225]=a("small",{class:"form-hint"},"Use Vertex AI instead of Gemini API (requires GOOGLE_APPLICATION_CREDENTIALS)",-1))])])):X("",!0),_.value.model_type==="pipeline"?(M(),I("div",qy,[a("div",Fy,[i[238]||(i[238]=a("h4",null,"Language Model (LLM)",-1)),a("div",By,[i[229]||(i[229]=a("label",null,"LLM Provider",-1)),L(a("select",{"onUpdate:modelValue":i[60]||(i[60]=d=>_.value.llm_provider=d),onChange:ed},[...i[228]||(i[228]=[Uo('<option value="openai" data-v-2ad75f01>OpenAI</option><option value="google" data-v-2ad75f01>Google (Gemini)</option><option value="qwen" data-v-2ad75f01>Qwen</option><option value="moonshotai" data-v-2ad75f01>Kimi (Moonshot AI)</option><option value="deepseek-ai" data-v-2ad75f01>DeepSeek</option>',5)])],544),[[ye,_.value.llm_provider]]),i[230]||(i[230]=a("small",{class:"form-hint"},"LiveKit Inference supports these providers. For Anthropic and others, use plugins with your own API keys.",-1))]),a("div",zy,[i[231]||(i[231]=a("label",null,"LLM Model",-1)),L(a("select",{"onUpdate:modelValue":i[61]||(i[61]=d=>_.value.llm_model=d),disabled:It.value.length===0},[It.value.length===0?(M(),I("option",Gy,"Select LLM Provider first")):X("",!0),(M(!0),I(fe,null,be(It.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,Ky))),128))],8,Hy),[[ye,_.value.llm_model]])]),a("div",Jy,[i[232]||(i[232]=a("label",null,"Temperature",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[62]||(i[62]=d=>_.value.llm_temperature=d),min:"0",max:"2",step:"0.1"},null,512),[[K,_.value.llm_temperature,void 0,{number:!0}]]),i[233]||(i[233]=a("small",{class:"form-hint"},"0.0 = deterministic, 2.0 = creative",-1))]),a("div",Yy,[i[234]||(i[234]=a("label",null,"Max Tokens",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[63]||(i[63]=d=>_.value.llm_max_tokens=d),min:"1",max:"8192"},null,512),[[K,_.value.llm_max_tokens,void 0,{number:!0}]])]),a("div",Xy,[i[235]||(i[235]=a("label",null,"Top P",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[64]||(i[64]=d=>_.value.llm_top_p=d),min:"0",max:"1",step:"0.1"},null,512),[[K,_.value.llm_top_p,void 0,{number:!0}]])]),a("div",Qy,[i[236]||(i[236]=a("label",null,"Frequency Penalty",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[65]||(i[65]=d=>_.value.llm_frequency_penalty=d),min:"-2",max:"2",step:"0.1"},null,512),[[K,_.value.llm_frequency_penalty,void 0,{number:!0}]])]),a("div",Zy,[i[237]||(i[237]=a("label",null,"Presence Penalty",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[66]||(i[66]=d=>_.value.llm_presence_penalty=d),min:"-2",max:"2",step:"0.1"},null,512),[[K,_.value.llm_presence_penalty,void 0,{number:!0}]])])]),a("div",eb,[i[245]||(i[245]=a("h4",null,"Speech-to-Text (STT)",-1)),a("div",tb,[i[240]||(i[240]=a("label",null,"STT Provider",-1)),L(a("select",{"onUpdate:modelValue":i[67]||(i[67]=d=>_.value.stt_provider=d),onChange:Ql},[...i[239]||(i[239]=[a("option",{value:"deepgram"},"Deepgram",-1),a("option",{value:"assemblyai"},"AssemblyAI",-1),a("option",{value:"cartesia"},"Cartesia",-1)])],544),[[ye,_.value.stt_provider]]),i[241]||(i[241]=a("small",{class:"form-hint"},"LiveKit Inference STT providers. For OpenAI and Google Cloud, use plugins with your own API keys.",-1))]),a("div",rb,[i[242]||(i[242]=a("label",null,"STT Model",-1)),L(a("select",{"onUpdate:modelValue":i[68]||(i[68]=d=>_.value.stt_model=d),disabled:Tt.value.length===0},[Tt.value.length===0?(M(),I("option",ib,"Select STT Provider first")):X("",!0),(M(!0),I(fe,null,be(Tt.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,nb))),128))],8,ob),[[ye,_.value.stt_model]])]),a("div",sb,[i[244]||(i[244]=a("label",null,"STT Language",-1)),L(a("select",{"onUpdate:modelValue":i[69]||(i[69]=d=>_.value.stt_language=d)},[...i[243]||(i[243]=[a("option",{value:"en-US"},"English (US)",-1),a("option",{value:"es-US"},"Spanish (US)",-1),a("option",{value:"es-MX"},"Spanish (Mexico)",-1)])],512),[[ye,_.value.stt_language]])])]),a("div",ab,[i[258]||(i[258]=a("h4",null,"Text-to-Speech (TTS)",-1)),a("div",lb,[i[247]||(i[247]=a("label",null,"TTS Provider",-1)),L(a("select",{"onUpdate:modelValue":i[70]||(i[70]=d=>_.value.tts_provider=d),onChange:Zl},[...i[246]||(i[246]=[a("option",{value:"elevenlabs"},"ElevenLabs",-1),a("option",{value:"cartesia"},"Cartesia",-1),a("option",{value:"inworld"},"Inworld",-1),a("option",{value:"rime"},"Rime",-1)])],544),[[ye,_.value.tts_provider]]),i[248]||(i[248]=a("small",{class:"form-hint"},"LiveKit Inference TTS providers. For OpenAI, Google Cloud, Amazon Polly, and Azure, use plugins with your own API keys.",-1))]),a("div",db,[i[249]||(i[249]=a("label",null,"TTS Model",-1)),L(a("select",{"onUpdate:modelValue":i[71]||(i[71]=d=>_.value.tts_model=d),disabled:Et.value.length===0},[Et.value.length===0?(M(),I("option",ub,"Select TTS Provider first")):X("",!0),(M(!0),I(fe,null,be(Et.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,vb))),128))],8,cb),[[ye,_.value.tts_model]])]),a("div",mb,[i[250]||(i[250]=a("label",null,"TTS Voice ID",-1)),L(a("select",{"onUpdate:modelValue":i[72]||(i[72]=d=>_.value.tts_voice_id=d),disabled:_t.value.length===0},[_t.value.length===0?(M(),I("option",fb,"Select TTS Model first")):X("",!0),(M(!0),I(fe,null,be(_t.value,d=>(M(),I("option",{key:d.value,value:d.value},B(d.label),9,hb))),128))],8,pb),[[ye,_.value.tts_voice_id]]),i[251]||(i[251]=a("small",{class:"form-hint"},'Standard voices or select "Custom Voice ID" to use your own cloned/professional voice.',-1))]),_.value.tts_voice_id==="custom"?(M(),I("div",gb,[i[252]||(i[252]=a("label",null,"Custom Voice ID",-1)),L(a("input",{type:"text","onUpdate:modelValue":i[73]||(i[73]=d=>_.value.tts_custom_voice_id=d),placeholder:"Enter your ElevenLabs voice ID (e.g., 6aDn1KB0hjpdcocrUkmq)"},null,512),[[K,_.value.tts_custom_voice_id]]),i[253]||(i[253]=a("small",{class:"form-hint"},"Enter the voice ID from your ElevenLabs dashboard. Supports cloned voices, professional voices, and custom voices.",-1))])):X("",!0),a("div",_b,[i[254]||(i[254]=a("label",null,"TTS Speed",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[74]||(i[74]=d=>_.value.tts_speed=d),min:"0.5",max:"2.0",step:"0.1"},null,512),[[K,_.value.tts_speed,void 0,{number:!0}]]),i[255]||(i[255]=a("small",{class:"form-hint"},"1.0 = normal speed",-1))]),a("div",yb,[i[256]||(i[256]=a("label",null,"TTS Stability",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[75]||(i[75]=d=>_.value.tts_stability=d),min:"0",max:"1",step:"0.1"},null,512),[[K,_.value.tts_stability,void 0,{number:!0}]]),i[257]||(i[257]=a("small",{class:"form-hint"},"0.0 = more variation, 1.0 = more consistent",-1))])]),a("div",bb,[i[276]||(i[276]=a("h4",null,"Voice Activity & Turn Detection",-1)),i[277]||(i[277]=a("small",{class:"form-hint"},"Silero VAD detects speech vs silence. Turn Detector uses VAD + language context for intelligent end-of-turn detection. Both enabled by default for best performance.",-1)),a("div",wb,[i[259]||(i[259]=a("label",null,"Enable VAD (Voice Activity Detection)",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[76]||(i[76]=d=>_.value.vad_enabled=d)},null,512),[[ft,_.value.vad_enabled]]),i[260]||(i[260]=a("small",{class:"form-hint"},"Recommended: ON. Detects when user is speaking vs silent.",-1))]),_.value.vad_enabled?(M(),I("div",Sb,[i[261]||(i[261]=a("label",null,"VAD Threshold",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[77]||(i[77]=d=>_.value.vad_threshold=d),min:"0",max:"1",step:"0.05"},null,512),[[K,_.value.vad_threshold,void 0,{number:!0}]]),i[262]||(i[262]=a("small",{class:"form-hint"},"Default: 0.5. Higher = less sensitive to background noise.",-1))])):X("",!0),_.value.vad_enabled?(M(),I("div",kb,[i[263]||(i[263]=a("label",null,"VAD Prefix Padding (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[78]||(i[78]=d=>_.value.vad_prefix_padding_ms=d),min:"0",max:"1000",step:"50"},null,512),[[K,_.value.vad_prefix_padding_ms,void 0,{number:!0}]]),i[264]||(i[264]=a("small",{class:"form-hint"},"Default: 300ms. Audio padding before speech starts.",-1))])):X("",!0),_.value.vad_enabled?(M(),I("div",Cb,[i[265]||(i[265]=a("label",null,"VAD Silence Duration (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[79]||(i[79]=d=>_.value.vad_silence_duration_ms=d),min:"0",max:"5000",step:"100"},null,512),[[K,_.value.vad_silence_duration_ms,void 0,{number:!0}]]),i[266]||(i[266]=a("small",{class:"form-hint"},"Default: 550ms. How long to wait after speech ends.",-1))])):X("",!0),a("div",Tb,[i[267]||(i[267]=a("label",null,"Enable Turn Detector",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[80]||(i[80]=d=>_.value.turn_detector_enabled=d)},null,512),[[ft,_.value.turn_detector_enabled]]),i[268]||(i[268]=a("small",{class:"form-hint"},"Recommended: ON. Uses language context to improve end-of-turn detection.",-1))]),_.value.turn_detector_enabled?(M(),I("div",Eb,[i[270]||(i[270]=a("label",null,"Turn Detector Model",-1)),L(a("select",{"onUpdate:modelValue":i[81]||(i[81]=d=>_.value.turn_detector_model=d)},[...i[269]||(i[269]=[a("option",{value:"english"},"English-only (faster, 66MB)",-1),a("option",{value:"multilingual"},"Multilingual (14 languages, 281MB)",-1)])],512),[[ye,_.value.turn_detector_model]]),i[271]||(i[271]=a("small",{class:"form-hint"},"English-only is faster. Multilingual supports ES, FR, DE, IT, PT, NL, ZH, JA, KO, ID, TR, RU, HI.",-1))])):X("",!0),_.value.turn_detector_enabled?(M(),I("div",Ib,[i[272]||(i[272]=a("label",null,"Min Endpointing Delay (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[82]||(i[82]=d=>_.value.min_endpointing_delay=d),min:"100",max:"2000",step:"100"},null,512),[[K,_.value.min_endpointing_delay,void 0,{number:!0}]]),i[273]||(i[273]=a("small",{class:"form-hint"},"Default: 500ms. Time to wait before considering turn complete.",-1))])):X("",!0),_.value.turn_detector_enabled?(M(),I("div",Mb,[i[274]||(i[274]=a("label",null,"Max Endpointing Delay (ms)",-1)),L(a("input",{type:"number","onUpdate:modelValue":i[83]||(i[83]=d=>_.value.max_endpointing_delay=d),min:"1000",max:"10000",step:"500"},null,512),[[K,_.value.max_endpointing_delay,void 0,{number:!0}]]),i[275]||(i[275]=a("small",{class:"form-hint"},"Default: 6000ms. Max time to wait when model indicates user will continue.",-1))])):X("",!0)]),_.value.model_type==="pipeline"?(M(),I("div",Pb,[i[283]||(i[283]=a("h4",null,"Audio Settings",-1)),a("div",Ab,[i[279]||(i[279]=a("label",null,"Turn Detection Type",-1)),L(a("select",{"onUpdate:modelValue":i[84]||(i[84]=d=>_.value.turn_detection_type=d)},[...i[278]||(i[278]=[a("option",{value:"server_vad"},"Server VAD",-1),a("option",{value:"client_vad"},"Client VAD",-1)])],512),[[ye,_.value.turn_detection_type]])]),a("div",xb,[i[280]||(i[280]=a("label",null,"Audio Input Transcription",-1)),L(a("input",{type:"checkbox","onUpdate:modelValue":i[85]||(i[85]=d=>_.value.audio_input_transcription=d)},null,512),[[ft,_.value.audio_input_transcription]])]),a("div",Rb,[i[282]||(i[282]=a("label",null,"Audio Sample Rate",-1)),L(a("select",{"onUpdate:modelValue":i[86]||(i[86]=d=>_.value.audio_sample_rate=d)},[...i[281]||(i[281]=[a("option",{value:"16000"},"16 kHz",-1),a("option",{value:"24000"},"24 kHz",-1),a("option",{value:"48000"},"48 kHz",-1)])],512),[[ye,_.value.audio_sample_rate]])])])):X("",!0)])):X("",!0),a("div",Lb,[a("button",{class:"btn-save",onClick:Hl,disabled:ee.value},"  Save Configuration ",8,Ob),a("button",{class:"btn-test",onClick:Cn,disabled:ee.value},"  Test ",8,Vb)])])):X("",!0)])])):X("",!0),ie.value==="theme"?(M(),I("div",Db,[i[307]||(i[307]=a("div",{class:"nodes-header"},[a("h2",null,"Nodes")],-1)),a("div",Nb,[(M(),I(fe,null,be(e,d=>{var T,N,R,W,Z,re,we,Ae,Fe,Je,ue,Ee,me,Be,xe;return a("div",{key:d,class:Ie(["node-card",{expanded:Ze.value[d],active:U.value===d}]),"data-node":d},[a("div",{class:"node-card-header",onClick:Le(F=>nd(d),["stop"])},[a("span",Ub,[et(B(d.charAt(0).toUpperCase()+d.slice(1))+" ",1),a("span",{class:"tooltip-indicator",title:sd(d)},"*",8,jb)]),a("span",qb,B(Ze.value[d]?"":"+"),1)],8,Wb),Ze.value[d]?(M(),I("div",Fb,[a("div",Bb,[a("div",zb,[i[287]||(i[287]=a("label",null,"Role & Objective",-1)),a("textarea",{value:((T=x.value[d])==null?void 0:T.role)||"",onInput:F=>{ld(d,F.target.value),yt(d)},placeholder:"You are Barbara, a [role description] assistant...",rows:"3"},null,40,Hb),i[288]||(i[288]=a("small",{class:"field-hint"},"Define the AI's identity and primary goal for this conversation phase. Be specific to this node's purpose.",-1))]),a("div",Gb,[a("div",Kb,[i[290]||(i[290]=a("label",null,"Instructions",-1)),a("div",Jb,[a("div",{class:Ie(["variable-dropdown-wrapper",{open:o.value[d],"drop-up":(N=s.value[d])==null?void 0:N.dropUp}]),"data-dropdown-node":d,ref_for:!0,ref:F=>Md(d,F)},[a("button",{type:"button",class:"variable-button",onClick:Le(F=>Ed(d),["stop"]),title:"Insert variable"},[...i[289]||(i[289]=[a("span",{class:"variable-icon"},"",-1)])],8,Xb),o.value[d]?(M(),I("div",{key:0,class:"variable-dropdown-panel",style:qt((R=s.value[d])==null?void 0:R.style)},[a("div",Qb,[L(a("input",{type:"text","onUpdate:modelValue":F=>n.value[d]=F,placeholder:"Search variables...",class:"search-input",onClick:i[87]||(i[87]=Le(()=>{},["stop"]))},null,8,Zb),[[K,n.value[d]]])]),a("div",ew,[(M(),I(fe,null,be(Vl,F=>a("div",{class:"variable-category",key:F.name},[a("div",tw,B(F.label),1),(M(!0),I(fe,null,be(Td(d,F.variables),A=>(M(),I("div",{key:A.key,class:"variable-option",onClick:Le(Y=>Ad(d,A.key),["stop"])},[a("span",ow,B(A.display),1),a("span",iw,B(A.desc),1)],8,rw))),128))])),64))])],4)):X("",!0)],10,Yb),a("button",{class:"btn-ai-helper-small",onClick:Le(F=>Ld(d),["stop"]),title:"AI Node Generator"},"  ",8,nw)])]),a("textarea",{id:`instructions-${d}`,ref_for:!0,ref:F=>Pd(d,F),value:((W=x.value[d])==null?void 0:W.instructions)||"",onInput:F=>{hn(d,F.target.value),Do(d,F),yt(d)},onFocus:F=>Do(d,F),onClick:F=>Do(d,F),placeholder:"What should Barbara do?",rows:"6"},null,40,sw)]),a("div",aw,[i[291]||(i[291]=a("label",null,"Routing",-1)),a("textarea",{value:((Z=x.value[d])==null?void 0:Z.routing)||"",onInput:F=>{ad(d,F.target.value),yt(d)},placeholder:` If caller asks question: Route to ANSWER
 If ready to book: Route to BOOK
 If not interested: Route to GOODBYE`,rows:"4"},null,40,lw),i[292]||(i[292]=a("small",{class:"field-hint"},"When to leave this node and where to go. Agent combines this with Instructions.",-1))]),a("div",dw,[i[293]||(i[293]=a("label",null,"Step Criteria",-1)),a("textarea",{value:((re=x.value[d])==null?void 0:re.step_criteria)||"",onInput:F=>{dd(d,F.target.value),yt(d)},placeholder:"When is this step complete?",rows:"3"},null,40,cw)]),a("div",uw,[i[296]||(i[296]=a("label",null,"Valid Contexts",-1)),a("div",{class:Ie(["tools-dropdown-wrapper",{open:y.value[d],"drop-up":(we=S.value[d])==null?void 0:we.dropUp}]),"data-dropdown-node":d,"data-dropdown-type":"context",ref_for:!0,ref:F=>kd(d,F)},[a("button",{type:"button",class:"tools-dropdown-trigger",onClick:F=>wd(d)},[!((Ae=x.value[d])!=null&&Ae.valid_contexts)||x.value[d].valid_contexts.length===0?(M(),I("span",pw," Select contexts... ")):(M(),I("span",fw,B(x.value[d].valid_contexts.length)+" context"+B(x.value[d].valid_contexts.length!==1?"s":"")+" selected ",1)),i[294]||(i[294]=a("span",{class:"dropdown-arrow"},"",-1))],8,mw),y.value[d]?(M(),I("div",{key:0,class:"tools-dropdown-panel",style:qt((Fe=S.value[d])==null?void 0:Fe.style)},[a("div",hw,[L(a("input",{type:"text","onUpdate:modelValue":F=>b.value[d]=F,placeholder:"Search contexts...",class:"search-input",onClick:i[88]||(i[88]=Le(()=>{},["stop"]))},null,8,gw),[[K,b.value[d]]])]),a("div",_w,[a("label",yw,[a("input",{type:"checkbox",checked:wn(d),onChange:F=>Sd(d),onClick:i[89]||(i[89]=Le(()=>{},["stop"]))},null,40,bw),i[295]||(i[295]=a("span",null,"Select all",-1))]),(M(!0),I(fe,null,be(Vo(d),F=>(M(),I("label",{key:F,class:"dropdown-option",onClick:i[90]||(i[90]=Le(()=>{},["stop"]))},[L(a("input",{type:"checkbox",value:F,"onUpdate:modelValue":A=>x.value[d].valid_contexts=A,onChange:A=>qe(d)},null,40,ww),[[ft,x.value[d].valid_contexts]]),a("span",null,B(F.charAt(0).toUpperCase()+F.slice(1)),1)]))),128))])],4)):X("",!0)],10,vw)]),a("div",Sw,[i[301]||(i[301]=a("label",null,"Tools",-1)),a("div",{class:Ie(["tools-dropdown-wrapper",{open:r.value[d],"drop-up":(Je=p.value[d])==null?void 0:Je.dropUp}]),"data-dropdown-node":d,ref_for:!0,ref:F=>void 0},[a("button",{type:"button",class:"tools-dropdown-trigger",onClick:F=>yd(d)},[!((ue=x.value[d])!=null&&ue.tools)||x.value[d].tools.length===0?(M(),I("span",Tw," Select tools... ")):(M(),I("span",Ew,B(yn(d))+" tool"+B(yn(d)!==1?"s":"")+" selected ",1)),i[297]||(i[297]=a("span",{class:"dropdown-arrow"},"",-1))],8,Cw),r.value[d]?(M(),I("div",{key:0,class:"tools-dropdown-panel",style:qt((Ee=p.value[d])==null?void 0:Ee.style)},[a("div",Iw,[L(a("input",{type:"text","onUpdate:modelValue":F=>m.value[d]=F,placeholder:"Search tools...",class:"search-input",onClick:i[91]||(i[91]=Le(()=>{},["stop"]))},null,8,Mw),[[K,m.value[d]]])]),a("div",Pw,[a("label",Aw,[a("input",{type:"checkbox",checked:bn(d),onChange:F=>bd(d),onClick:i[92]||(i[92]=Le(()=>{},["stop"]))},null,40,xw),i[298]||(i[298]=a("span",null,"Select all",-1))]),Lo(d).length>0?(M(),I("div",Rw,[i[299]||(i[299]=a("div",{class:"tools-section-header"},"Flow Tools",-1)),(M(!0),I(fe,null,be(Lo(d),F=>(M(),I("label",{key:F,class:"dropdown-option flow-tool",onClick:i[93]||(i[93]=Le(()=>{},["stop"]))},[L(a("input",{type:"checkbox",value:F,"onUpdate:modelValue":A=>x.value[d].tools=A},null,8,Lw),[[ft,x.value[d].tools]]),a("span",null,B(F),1)]))),128))])):X("",!0),Oo(d).length>0?(M(),I("div",Ow,[i[300]||(i[300]=a("div",{class:"tools-section-header"},"Optional Tools",-1)),(M(!0),I(fe,null,be(Oo(d),F=>(M(),I("label",{key:F,class:"dropdown-option",onClick:i[94]||(i[94]=Le(()=>{},["stop"]))},[L(a("input",{type:"checkbox",value:F,"onUpdate:modelValue":A=>x.value[d].tools=A},null,8,Vw),[[ft,x.value[d].tools]]),a("span",null,B(F),1)]))),128))])):X("",!0)])],4)):X("",!0)],10,kw)]),a("div",Dw,[i[302]||(i[302]=a("label",null,"Context Isolation",-1)),a("div",Nw,[a("input",{type:"checkbox",id:`isolated-${d}`,checked:((me=_e.value[d])==null?void 0:me.isolated)||!1,onChange:F=>{cd(d,F.target.checked)},style:{width:"auto","flex-shrink":"0"}},null,40,$w),a("label",{for:`isolated-${d}`,style:{margin:"0","font-weight":"normal",cursor:"pointer","white-space":"nowrap"}}," Fresh conversation history when entering this context ",8,Ww)])]),a("div",Uw,[i[305]||(i[305]=a("label",null,"Transition Fillers",-1)),i[306]||(i[306]=a("p",{class:"field-hint"},"Phrases spoken when entering/exiting this context (random selection)",-1)),a("div",jw,[a("div",qw,[i[303]||(i[303]=a("span",{class:"filler-label"},"Enter:",-1)),a("div",Fw,[(M(!0),I(fe,null,be(((Be=_e.value[d])==null?void 0:Be.enter_fillers)||[],(F,A)=>(M(),I("div",{key:"enter-"+A,class:"filler-item"},[a("input",{type:"text",value:F,onInput:Y=>fd(d,A,Y.target.value),placeholder:"e.g. Let me check that..."},null,40,Bw),a("button",{onClick:Y=>pd(d,A),class:"btn-remove-filler"},"",8,zw)]))),128)),a("button",{onClick:F=>md(d),class:"btn-add-filler"},"+ Add Enter Filler",8,Hw)])]),a("div",Gw,[i[304]||(i[304]=a("span",{class:"filler-label"},"Exit:",-1)),a("div",Kw,[(M(!0),I(fe,null,be(((xe=_e.value[d])==null?void 0:xe.exit_fillers)||[],(F,A)=>(M(),I("div",{key:"exit-"+A,class:"filler-item"},[a("input",{type:"text",value:F,onInput:Y=>_d(d,A,Y.target.value),placeholder:"e.g. Going back to..."},null,40,Jw),a("button",{onClick:Y=>gd(d,A),class:"btn-remove-filler"},"",8,Yw)]))),128)),a("button",{onClick:F=>hd(d),class:"btn-add-filler"},"+ Add Exit Filler",8,Xw)])])])]),a("div",Qw,[a("button",{class:"btn-preview",onClick:F=>Nd(d)}," Preview ",8,Zw),a("button",{class:"btn-test",onClick:Le(F=>$d(d),["stop"])},"  Test This Node ",8,eS),$t.value!=="idle"&&U.value===d?(M(),I("span",tS,B($t.value==="validating"?"Validating via CLI":"Saving"),1)):X("",!0)])])])):X("",!0)],10,$b)}),64))])])):X("",!0)]),!Ge.value&&$r.value?(M(),I("aside",rS,[a("div",oS,[i[308]||(i[308]=a("h3",null,"Preview",-1)),a("button",{class:"btn-close",onClick:i[95]||(i[95]=d=>$r.value=null)},"")]),a("div",iS,[a("pre",null,B($r.value),1)])])):X("",!0)])):(M(),I("div",nS,[...i[309]||(i[309]=[a("p",null,"Please select a vertical to begin managing BarbGraph prompts.",-1)])])),C.value?(M(),I("div",{key:3,class:"modal-overlay",onClick:lr},[a("div",{class:"modal-content ai-helper-modal",onClick:i[107]||(i[107]=Le(()=>{},["stop"]))},[a("div",{class:"modal-header"},[i[310]||(i[310]=a("h3",null," AI Theme Generator",-1)),a("button",{class:"btn-close-icon",onClick:lr},"")]),q.value?(M(),I("div",gS,[a("div",_S,[i[318]||(i[318]=a("h4",null,"Generated Theme:",-1)),H.value.length>0?(M(),I("div",yS,[(M(!0),I(fe,null,be(H.value,(d,T)=>(M(),I("span",{key:T,class:Ie({"diff-added":d.added,"diff-removed":d.removed,"diff-unchanged":!d.added&&!d.removed})},B(d.value),3))),128))])):(M(),I("pre",bS,B(q.value),1))]),a("div",wS,[a("button",{class:"btn-cancel",onClick:lr},"Cancel"),a("button",{class:"btn-regenerate",onClick:i[106]||(i[106]=d=>{q.value="",Sn()})}," Regenerate"),a("button",{class:"btn-accept",onClick:Rd}," Accept & Insert")])])):(M(),I("div",sS,[a("div",aS,[i[311]||(i[311]=a("label",null,"Who is the AI assistant? *",-1)),L(a("input",{"onUpdate:modelValue":i[96]||(i[96]=d=>ce.value.assistantName=d),placeholder:"e.g., Barbara"},null,512),[[K,ce.value.assistantName]])]),a("div",lS,[i[312]||(i[312]=a("label",null,"Company name *",-1)),L(a("input",{"onUpdate:modelValue":i[97]||(i[97]=d=>ce.value.company=d),placeholder:"e.g., Equity Connect"},null,512),[[K,ce.value.company]])]),a("div",dS,[i[313]||(i[313]=a("label",null,"What product/service? * (be specific)",-1)),L(a("textarea",{"onUpdate:modelValue":i[98]||(i[98]=d=>ce.value.productService=d),placeholder:"e.g., Government-insured reverse mortgages (HECM) for seniors 62+",rows:"3"},null,512),[[K,ce.value.productService]])]),a("div",cS,[i[314]||(i[314]=a("label",null,"Target audience?",-1)),L(a("input",{"onUpdate:modelValue":i[99]||(i[99]=d=>ce.value.targetAudience=d),placeholder:"e.g., Homeowners 62+, seniors"},null,512),[[K,ce.value.targetAudience]])]),a("div",uS,[i[315]||(i[315]=a("label",null,"Tone and style?",-1)),a("div",vS,[a("button",{type:"button",class:"chip",onClick:i[100]||(i[100]=d=>ce.value.toneStyle="Warm and patient")},"Warm and patient"),a("button",{type:"button",class:"chip",onClick:i[101]||(i[101]=d=>ce.value.toneStyle="Professional and friendly")},"Professional"),a("button",{type:"button",class:"chip",onClick:i[102]||(i[102]=d=>ce.value.toneStyle="Conversational and empathetic")},"Conversational")]),L(a("input",{"onUpdate:modelValue":i[103]||(i[103]=d=>ce.value.toneStyle=d),placeholder:"e.g., Warm, patient, senior-friendly"},null,512),[[K,ce.value.toneStyle]])]),a("div",mS,[i[316]||(i[316]=a("label",null,"Core values?",-1)),L(a("textarea",{"onUpdate:modelValue":i[104]||(i[104]=d=>ce.value.coreValues=d),placeholder:"e.g., Honesty, education over sales, patience",rows:"2"},null,512),[[K,ce.value.coreValues]])]),a("div",pS,[i[317]||(i[317]=a("label",null,"Any restrictions?",-1)),L(a("textarea",{"onUpdate:modelValue":i[105]||(i[105]=d=>ce.value.restrictions=d),placeholder:"e.g., Never pressure, be patient with seniors",rows:"2"},null,512),[[K,ce.value.restrictions]])]),a("div",fS,[a("button",{class:"btn-cancel",onClick:lr},"Cancel"),a("button",{class:"btn-generate",onClick:Sn,disabled:O.value||!ce.value.productService.trim()},B(O.value?"Generating...":" Generate Theme"),9,hS)])]))])])):X("",!0),E.value?(M(),I("div",{key:4,class:"modal-overlay",onClick:dr},[a("div",{class:"modal-content ai-helper-modal node-helper",onClick:i[114]||(i[114]=Le(()=>{},["stop"]))},[a("div",SS,[a("h3",null," AI Node Generator - "+B($.value),1),a("button",{class:"btn-close-icon",onClick:dr},"")]),q.value?(M(),I("div",DS,[a("div",NS,[i[326]||(i[326]=a("h4",null,"Generated Instructions:",-1)),H.value.length>0?(M(),I("div",$S,[(M(!0),I(fe,null,be(H.value,(d,T)=>(M(),I("span",{key:T,class:Ie({"diff-added":d.added,"diff-removed":d.removed,"diff-unchanged":!d.added&&!d.removed})},B(d.value),3))),128))])):(M(),I("pre",WS,B(q.value),1))]),Me.value?(M(),I("div",US,[i[327]||(i[327]=a("h5",null," Tool Selection Reasoning:",-1)),a("p",null,B(Me.value),1)])):X("",!0),de.value.length>0?(M(),I("div",jS,[i[328]||(i[328]=a("h5",null," AI Suggested Additional Scenarios:",-1)),a("ul",null,[(M(!0),I(fe,null,be(de.value,d=>(M(),I("li",{key:d},B(d),1))),128))])])):X("",!0),a("p",qS," "+B(((g=(f=x.value[$.value])==null?void 0:f.tools)==null?void 0:g.length)||0)+" tools auto-selected in Tools dropdown",1),a("div",FS,[a("button",{class:"btn-cancel",onClick:dr},"Cancel"),a("button",{class:"btn-regenerate",onClick:i[113]||(i[113]=d=>{q.value="",kn()})}," Regenerate"),a("button",{class:"btn-accept",onClick:Dd}," Accept & Insert")])])):(M(),I("div",kS,[To[$.value]?(M(),I("button",{key:0,class:"btn-quick-fill",onClick:Vd},"  Quick Fill with Template ")):X("",!0),a("div",CS,[i[319]||(i[319]=a("label",null,"What is the goal of this step? *",-1)),L(a("textarea",{"onUpdate:modelValue":i[108]||(i[108]=d=>Q.value.goal=d),placeholder:"e.g., Warmly greet caller, confirm identity, build rapport",rows:"2"},null,512),[[K,Q.value.goal]])]),a("div",TS,[i[320]||(i[320]=a("label",null,"What call scenarios can happen?",-1)),a("div",ES,[(M(),I(fe,null,be(Ol,d=>a("label",{key:d.value,class:"scenario-checkbox"},[a("input",{type:"checkbox",value:d.value,checked:Q.value.callDirections.includes(d.value),onChange:T=>Od(d.value)},null,40,IS),a("div",MS,[a("span",PS,B(d.label),1),a("span",AS,B(d.desc),1)])])),64))]),L(a("textarea",{"onUpdate:modelValue":i[109]||(i[109]=d=>Q.value.customScenarios=d),placeholder:"+ Add custom scenarios (e.g., caller is confused, language barrier, etc.)",rows:"2",style:{"margin-top":"0.5rem"}},null,512),[[K,Q.value.customScenarios]])]),a("div",xS,[i[321]||(i[321]=a("label",null,"How should each scenario be handled?",-1)),L(a("textarea",{"onUpdate:modelValue":i[110]||(i[110]=d=>Q.value.handling=d),placeholder:"AI will auto-suggest, or describe custom handling...",rows:"3"},null,512),[[K,Q.value.handling]]),i[322]||(i[322]=a("span",{class:"field-hint"},"AI will suggest handling based on scenarios",-1))]),a("div",RS,[i[323]||(i[323]=a("label",null,"What information needs to be gathered?",-1)),L(a("textarea",{"onUpdate:modelValue":i[111]||(i[111]=d=>Q.value.infoGathering=d),placeholder:"e.g., Confirm name, verify property address",rows:"2"},null,512),[[K,Q.value.infoGathering]])]),a("div",LS,[i[324]||(i[324]=a("label",null,"Where can this step transition to?",-1)),L(a("textarea",{"onUpdate:modelValue":i[112]||(i[112]=d=>Q.value.transitions=d),placeholder:"e.g., Success  verify, Wrong person  exit",rows:"2"},null,512),[[K,Q.value.transitions]]),i[325]||(i[325]=a("span",{class:"field-hint"},"AI will suggest transitions based on scenarios",-1))]),a("div",OS,[a("button",{class:"btn-cancel",onClick:dr},"Cancel"),a("button",{class:"btn-generate",onClick:kn,disabled:O.value||!Q.value.goal.trim()},B(O.value?"Generating...":" Generate Instructions"),9,VS)])]))])])):X("",!0)]),ls(Ug,{show:Wr.value,mode:Eo.value,"start-node":Io.value,vertical:D.value,onClose:i[115]||(i[115]=d=>Wr.value=!1)},null,8,["show","mode","start-node","vertical"])],64)}}},JS=di(BS,[["__scopeId","data-v-2ad75f01"]]);export{JS as default};
